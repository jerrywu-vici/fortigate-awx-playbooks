---
# =============================================================================
# FortiGate DHCP Reserved Address Create/Update Playbook v3.0
# 
# åŠŸèƒ½èªªæ˜ï¼š
# 1. æ”¯æ´æ–°å¢DHCP reserved-addressé…ç½®
# 2. æ”¯æ´ä¿®æ”¹æ—¢æœ‰DHCP reserved-addressé…ç½®  
# 3. è‡ªå‹•æª¢æ¸¬MACåœ°å€è¡çªï¼Œé¿å…é‡è¤‡åˆ†é…
# 4. æ™ºèƒ½åˆ¤æ–·æ–°å¢æˆ–æ›´æ–°æ“ä½œ
# 
# ä½œè€…ï¼šVICI Network Team
# ç‰ˆæœ¬ï¼šv3.0 - Create/UpdateåŠŸèƒ½
# =============================================================================

- name: FortiGate DHCP Reserved Address Create/Update v3.0
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # =======================================================================
    # è®Šæ•¸å®šç¾©å€
    # =======================================================================
    
    # ç”¨æˆ¶è¼¸å…¥åƒæ•¸ï¼ˆå¾AWX Surveyç²å–ï¼‰
    target_ip: "{{ ip_param }}"
    target_mac: "{{ mac_param }}"
    target_description: "{{ desc_param }}"
    
    # FortiGateç³»çµ±åƒæ•¸
    dhcp_server_id: "{{ server_id | default('3') }}"
    
    # FortiGateé€£æ¥åƒæ•¸ï¼ˆå¾AWX Credentialè‡ªå‹•æ³¨å…¥ï¼‰
    fortigate_host: "{{ fortigate_host }}"
    fortigate_token: "{{ fortigate_access_token }}"
    vdom_name: "{{ fortigate_vdom | default('root') }}"
    
  tasks:
    # =======================================================================
    # æ­¥é©Ÿ1ï¼šåƒæ•¸é©—è­‰
    # =======================================================================
    
    - name: "ğŸ” Validate AWX Credential Parameters"
      ansible.builtin.fail:
        msg: |
          âŒ ç¼ºå°‘å¿…è¦çš„FortiGate Credentialåƒæ•¸ï¼è«‹ç¢ºä¿å·²æ­£ç¢ºè¨­å®šFortiGate Credentialã€‚
      when: fortigate_host is not defined or fortigate_token is not defined

    - name: "ğŸ“‹ Display Input Parameters"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ“‹ FortiGate DHCP Create/Update åŠŸèƒ½
          ==========================================
          ğŸ¯ ç›®æ¨™IPåœ°å€: {{ target_ip }}
          ğŸ”— ç›®æ¨™MACåœ°å€: {{ target_mac }}
          ğŸ“ ç›®æ¨™æè¿°: {{ target_description }}
          ğŸ·ï¸  DHCP Server ID: {{ dhcp_server_id }}
          ğŸŒ FortiGate Host: {{ fortigate_host }}
          ğŸ  VDOM: {{ vdom_name }}
          ==========================================

    # =======================================================================
    # æ­¥é©Ÿ2ï¼šç²å–ç•¶å‰DHCPé…ç½®
    # =======================================================================
    
    - name: "ğŸ” Get Current DHCP Reserved Addresses"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: false
        status_code: 200
      register: existing_reservations

    - name: "ğŸ“Š Display Current Configuration"
      ansible.builtin.debug:
        msg: |
          ğŸ” DHCPé…ç½®ç²å–çµæœï¼š
          - æŸ¥è©¢æˆåŠŸ: {{ existing_reservations.status == 200 }}
          - ä¿ç•™ä½å€æ•¸é‡: {{ existing_reservations.json.results | length }}
          
          ğŸ“‹ ç•¶å‰æ‰€æœ‰reserved-addressé…ç½®ï¼š
          {% if existing_reservations.json.results | length > 0 %}
          {% for addr in existing_reservations.json.results %}
          - ID: {{ addr.id }}, IP: {{ addr.ip }}, MAC: {{ addr.mac }}, æè¿°: {{ addr.description | default('ç„¡') }}
          {% endfor %}
          {% else %}
          ï¼ˆç›®å‰æ²’æœ‰ä»»ä½•reserved-addressé…ç½®ï¼‰
          {% endif %}

    # =======================================================================
    # æ­¥é©Ÿ3ï¼šMACè¡çªæª¢æ¸¬
    # =======================================================================

    - name: "ğŸ” MAC Conflict Detection"
      ansible.builtin.set_fact:
        mac_conflict_object: "{{ item }}"
      loop: "{{ existing_reservations.json.results }}"
      when:
        - mac_conflict_object is not defined
        - item.mac.lower() == target_mac.lower()
      loop_control:
        label: "æª¢æŸ¥ MAC {{ item.mac }}"

    - name: "ğŸ“‹ MAC Conflict Detection Result"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ” MACè¡çªæª¢æ¸¬åˆ†æçµæœ
          ==========================================
          {% if mac_conflict_object is defined %}
          âš ï¸  æ‰¾åˆ°æ—¢æœ‰MACé…ç½®:
             - ID: {{ mac_conflict_object.id }}
             - IP: {{ mac_conflict_object.ip }}
             - MAC: {{ mac_conflict_object.mac }}
             - æè¿°: {{ mac_conflict_object.description | default('ç„¡') }}
          
          ğŸš« MACè¡çªç‹€æ…‹: {{ 'æ˜¯' if (mac_conflict_object.ip != target_ip) else 'å¦' }}
          {% else %}
          â„¹ï¸  æœªæ‰¾åˆ°æ—¢æœ‰MACé…ç½®
          ğŸš« MACè¡çªç‹€æ…‹: å¦
          {% endif %}
          ==========================================

    - name: "ğŸš« Stop Execution - MAC Conflict"
      ansible.builtin.fail:
        msg: |
          âŒâŒâŒ MACè¡çªæª¢æ¸¬å¤±æ•—ï¼âŒâŒâŒ
          
          ğŸ”´ è¡çªè©³æƒ…ï¼š
          - ç›®æ¨™MAC: {{ target_mac }}
          - ç›®æ¨™IP: {{ target_ip }}
          - è¡çªåŸå› : MAC {{ target_mac }} å·²è¢«åˆ†é…çµ¦ IP {{ mac_conflict_object.ip }}
          
          ğŸ’¡ è§£æ±ºæ–¹æ¡ˆï¼š
          1. ä½¿ç”¨ä¸åŒçš„MACåœ°å€
          2. æˆ–è€…ç¢ºèªæ˜¯å¦è¦æ›´æ–°æ—¢æœ‰IP {{ mac_conflict_object.ip }} çš„é…ç½®
          
          âš ï¸  ç‚ºé¿å…ç¶²è·¯è¡çªï¼Œæ“ä½œå·²çµ‚æ­¢ï¼
      when: mac_conflict_object is defined and mac_conflict_object.ip != target_ip

    # =======================================================================
    # æ­¥é©Ÿ4ï¼šå°‹æ‰¾ç›®æ¨™IPé…ç½®
    # =======================================================================
    
    - name: "ğŸ” Find Target IP Configuration"
      ansible.builtin.set_fact:
        target_object_list: "{{ existing_reservations.json.results | selectattr('ip', 'equalto', target_ip) | list }}"

    - name: "ğŸ¯ Determine Operation Type"
      ansible.builtin.set_fact:
        operation_type: >-
          {%- if target_object_list | length > 0 -%}
            æ›´æ–°æ—¢æœ‰é…ç½®
          {%- else -%}
            å‰µå»ºæ–°é…ç½®
          {%- endif -%}
        needs_update: >-
          {%- if target_object_list | length == 0 -%}
            true
          {%- else -%}
            {{
              (target_object_list[0].mac != target_mac) or
              (target_object_list[0].description | default('') != target_description)
            }}
          {%- endif -%}
        target_object: "{{ target_object_list[0] if target_object_list | length > 0 else {} }}"

    - name: "ğŸ“‹ Display Operation Plan"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ“‹ æ“ä½œåŸ·è¡Œè¨ˆç•«
          ==========================================
          ğŸ¯ æ“ä½œé¡å‹: {{ operation_type }}
          ğŸ”„ éœ€è¦æ›´æ–°: {{ 'æ˜¯' if needs_update else 'å¦' }}
          
          {% if target_object_list | length > 0 %}
          ğŸ“Š æ—¢æœ‰é…ç½®:
          - ID: {{ target_object.id }}
          - IP: {{ target_object.ip }}
          - MAC: {{ target_object.mac }}
          - æè¿°: {{ target_object.description | default('ç„¡') }}
          {% endif %}
          
          {% if needs_update %}
          ğŸ“ å°‡è¦åŸ·è¡Œçš„{{ operation_type }}ï¼š
          - IPåœ°å€: {{ target_ip }}
          - MACåœ°å€: {{ target_mac }}
          - æè¿°: {{ target_description }}
          {% else %}
          â„¹ï¸  é…ç½®å·²ç¬¦åˆç›®æ¨™ç‹€æ…‹ï¼Œç„¡éœ€æ›´æ–°
          {% endif %}
          ==========================================

    # =======================================================================
    # æ­¥é©Ÿ5ï¼šåŸ·è¡Œæ“ä½œ
    # =======================================================================

    - name: "âœ… Configuration Already Up-to-Date"
      ansible.builtin.debug:
        msg: |
          âœ…âœ…âœ… é…ç½®æª¢æŸ¥å®Œæˆ âœ…âœ…âœ…
          
          ğŸ‰ ç•¶å‰é…ç½®å·²ç¬¦åˆç›®æ¨™ç‹€æ…‹ï¼š
          - IP: {{ target_ip }}
          - MAC: {{ target_mac }}
          - æè¿°: {{ target_description }}
          
          ğŸ’¡ ç„¡éœ€åŸ·è¡Œä»»ä½•è®Šæ›´æ“ä½œï¼
      when: not needs_update

    - name: "ğŸ”§ Update Existing DHCP Reserved Address"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address/{{ target_object.id }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          mac: "{{ target_mac }}"
          description: "{{ target_description }}"
        body_format: json
        validate_certs: false
        status_code: 200
      register: update_result
      when: needs_update and target_object_list | length > 0

    - name: "ğŸ†• Create New DHCP Reserved Address"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address"
        method: POST
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          ip: "{{ target_ip }}"
          mac: "{{ target_mac }}"
          description: "{{ target_description }}"
        body_format: json
        validate_certs: false
        status_code: 200
      register: create_result
      when: needs_update and target_object_list | length == 0

    # =======================================================================
    # æ­¥é©Ÿ6ï¼šçµæœé¡¯ç¤º
    # =======================================================================

    - name: "ğŸ‰ Update Operation Complete"
      ansible.builtin.debug:
        msg: |
          âœ…âœ…âœ… æ›´æ–°æ—¢æœ‰é…ç½®æˆåŠŸï¼âœ…âœ…âœ…
          
          ğŸ“‹ æ›´æ–°è©³æƒ…ï¼š
          - ç›®æ¨™IP: {{ target_ip }}
          - æ›´æ–°å¾ŒMAC: {{ target_mac }}
          - æ›´æ–°å¾Œæè¿°: {{ target_description }}
          - DHCP Server ID: {{ dhcp_server_id }}
          
          ğŸ¯ FortiGateé…ç½®å·²æˆåŠŸæ›´æ–°ï¼
      when: 
        - needs_update
        - target_object_list | length > 0
        - update_result is defined
        - update_result.json.revision_changed | default(false)

    - name: "ğŸ‰ Create Operation Complete"
      ansible.builtin.debug:
        msg: |
          âœ…âœ…âœ… å‰µå»ºæ–°é…ç½®æˆåŠŸï¼âœ…âœ…âœ…
          
          ğŸ“‹ å‰µå»ºè©³æƒ…ï¼š
          - æ–°IP: {{ target_ip }}
          - MAC: {{ target_mac }}
          - æè¿°: {{ target_description }}
          - DHCP Server ID: {{ dhcp_server_id }}
          
          ğŸ¯ FortiGateé…ç½®å·²æˆåŠŸå‰µå»ºï¼
      when: 
        - needs_update
        - target_object_list | length == 0
        - create_result is defined
        - create_result.json.revision_changed | default(false)

    - name: "ğŸ“Š Final Execution Summary"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ“Š FortiGate DHCP Create/Update åŸ·è¡Œæ‘˜è¦
          ==========================================
          ğŸ¯ ç›®æ¨™é…ç½®:
             - IP: {{ target_ip }}
             - MAC: {{ target_mac }}
             - æè¿°: {{ target_description }}
          
          ğŸ”§ åŸ·è¡Œçµæœ:
             {% if not needs_update %}
             - ç‹€æ…‹: â„¹ï¸  ç„¡éœ€è®Šæ›´ï¼ˆé…ç½®å·²æ˜¯æœ€æ–°ï¼‰
             {% elif target_object_list | length > 0 and update_result is defined and update_result.json.revision_changed | default(false) %}
             - ç‹€æ…‹: âœ… æ›´æ–°æ—¢æœ‰é…ç½®æˆåŠŸ
             - ç›®æ¨™ID: {{ target_object.id }}
             {% elif target_object_list | length == 0 and create_result is defined and create_result.json.revision_changed | default(false) %}
             - ç‹€æ…‹: âœ… å‰µå»ºæ–°é…ç½®æˆåŠŸ
             {% else %}
             - ç‹€æ…‹: âš ï¸  æœªåŸ·è¡Œæ“ä½œæˆ–æ“ä½œå¤±æ•—
             {% endif %}
          
          ğŸ“… åŸ·è¡Œæ™‚é–“: {{ ansible_date_time.iso8601 | default('æœªçŸ¥') }}
          ==========================================
