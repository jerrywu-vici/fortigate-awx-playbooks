---
# =============================================================================
# FortiGate DHCP Reserved Address Delete + Firewall Address Delete Preview v5.1
# ç”¨é€”ï¼šé è¦½è¦åˆªé™¤çš„MACé…ç½®ï¼ˆDHCP + Firewall Addressï¼‰
# åŠŸèƒ½ï¼š1. DHCP MACé‚„åŸç‚ºReserved 2. Firewall Addresså¾Groupç§»é™¤ä¸¦åˆªé™¤
# ä¿®æ­£ï¼šè™•ç†FortiGate APIä¸­macaddrç‚ºlisté¡å‹çš„å•é¡Œ
# è¼¸å‡ºï¼šé¡¯ç¤ºDHCPå’ŒFirewallå…©å€‹åŠŸèƒ½çš„è®Šæ›´é è¦½ï¼Œè¨­å®šworkflowè®Šæ•¸
# =============================================================================

- name: FortiGate DHCP + Firewall Delete Preview For Workflow v5.1
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    # Survey åƒæ•¸
    target_mac: "{{ delete_mac_param }}"
    target_dhcp_server_id: "{{ server_id | default('3') }}"
    
    # Server ID å°æ‡‰é—œä¿‚
    server_mapping:
      "2":
        dhcp_description: "vlan40_PC"
        address_group: "Group_40_PC-Allow-MAC"
      "12":
        dhcp_description: "vlan22_FIC_WAN"  
        address_group: "Group_22_FIC_Allow-MAC"
    
    # API é€£æ¥åƒæ•¸
    api_retries: "{{ fortigate_api_retries | default('3') | int }}"
    api_delay: "{{ fortigate_api_delay | default('5') | int }}"
    backup_enabled: "{{ fortigate_backup_enabled | default(true) | bool }}"
    connection_timeout: "{{ fortigate_timeout | default('30') | int }}"
    validate_certs: "{{ fortigate_validate_certs | default(false) | bool }}"
    
  tasks:
    # è¨˜éŒ„é–‹å§‹æ™‚é–“
    - name: "â° Record Start Time"
      ansible.builtin.set_fact:
        preview_start_time: "{{ ansible_date_time.epoch | int }}"

    # åƒæ•¸é©—è­‰
    - name: "ğŸ” Validate Credentials"
      ansible.builtin.fail:
        msg: "ç¼ºå°‘FortiGate Credentialåƒæ•¸: {{ missing_params | join(', ') }}"
      vars:
        required_params:
          - fortigate_host
          - fortigate_access_token
        missing_params: "{{ required_params | select('undefined') | list }}"
      when: 
        - fortigate_host is not defined or 
          fortigate_access_token is not defined

    # Surveyåƒæ•¸é©—è­‰
    - name: "ğŸ” Validate Survey Parameters"
      ansible.builtin.fail:
        msg: "ç¼ºå°‘Surveyåƒæ•¸: {{ missing_survey_params | join(', ') }}"
      vars:
        required_survey_params:
          - delete_mac_param
          - server_id
        missing_survey_params: "{{ required_survey_params | select('undefined') | list }}"
      when: delete_mac_param is not defined or server_id is not defined

    # Server ID é©—è­‰
    - name: "ğŸ” Validate Server ID"
      ansible.builtin.fail:
        msg: "ä¸æ”¯æ´çš„DHCP Server ID: {{ target_dhcp_server_id }}ã€‚æ”¯æ´çš„ID: {{ server_mapping.keys() | list | join(', ') }}"
      when: target_dhcp_server_id not in server_mapping

    # è¨­å®šServerå°æ‡‰è³‡è¨Š
    - name: "ğŸ”§ Set Server Mapping Info"
      ansible.builtin.set_fact:
        server_info: "{{ server_mapping[target_dhcp_server_id] }}"
        target_address_group: "{{ server_mapping[target_dhcp_server_id].address_group }}"

    # MACæ ¼å¼é©—è­‰
    - name: "ğŸ” Validate MAC Address Format"
      ansible.builtin.set_fact:
        mac_valid: "{{ target_mac | regex_search('^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$') is not none }}"

    - name: "âŒ Invalid MAC Format"
      ansible.builtin.fail:
        msg: "MACåœ°å€æ ¼å¼éŒ¯èª¤: {{ target_mac }}ã€‚æ­£ç¢ºæ ¼å¼: xx:xx:xx:xx:xx:xx æˆ– xx-xx-xx-xx-xx-xx"
      when: not mac_valid

    # æ­£è¦åŒ–MACåœ°å€æ ¼å¼
    - name: "ğŸ”§ Normalize MAC Address"
      ansible.builtin.set_fact:
        normalized_mac: "{{ target_mac | replace('-', ':') | lower }}"

    # APIé€£ç·šæ¸¬è©¦
    - name: "ğŸ”Œ Test FortiGate API Connection"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system/global"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: api_test
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"

    # FortiGateç‰ˆæœ¬å–å¾—
    - name: "âœ… API Connection Status"
      ansible.builtin.debug:
        msg: "âœ… APIé€£ç·šæˆåŠŸ | FortiGateç‰ˆæœ¬: {{ fortigate_version }}"
      vars:
        fortigate_version: "{{ api_test.json.results.version | default(api_test.json.version | default('æœªçŸ¥')) }}"

    # é¡¯ç¤ºé è¦½åƒæ•¸
    - name: "ğŸ“‹ FortiGate DHCP + Firewall Delete Preview v5.1"
      ansible.builtin.debug:
        msg: "===========================================" 

    - name: "ğŸ“‹ Preview Parameters"
      ansible.builtin.debug:
        msg: "ğŸ” æ•´åˆé è¦½æ¨¡å¼ | ç›®æ¨™MAC: {{ normalized_mac }} | DHCP Server: {{ target_dhcp_server_id }} ({{ server_info.dhcp_description }}) | Address Group: {{ target_address_group }} | Host: {{ fortigate_host }}"

    # ==================== DHCP åŠŸèƒ½é è¦½ ====================
    - name: "ğŸ“Š DHCP Preview Section"
      ansible.builtin.debug:
        msg: "==================== DHCP é è¦½ ===================="

    # ç²å–DHCPé…ç½®
    - name: "ğŸ” Get Current DHCP Reserved Addresses"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ target_dhcp_server_id }}/reserved-address"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: existing_reservations
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"

    # æœå°‹DHCPç›®æ¨™MAC
    - name: "ğŸ” Search for Target MAC in DHCP"
      ansible.builtin.set_fact:
        dhcp_target_object: "{{ item }}"
      loop: "{{ existing_reservations.json.results }}"
      when:
        - dhcp_target_object is not defined
        - item.mac.lower() == normalized_mac

    # DHCP MACæœªæ‰¾åˆ°çš„è™•ç†
    - name: "âš ï¸ DHCP Target MAC Not Found"
      ansible.builtin.debug:
        msg: "âš ï¸ DHCPä¸­æœªæ‰¾åˆ°MAC: {{ normalized_mac }}ï¼Œå°‡è·³éDHCPæ“ä½œ"
      when: dhcp_target_object is not defined

    # DHCPé è¦½çµæœ
    - name: "ğŸ“Š DHCP Current Configuration"
      ansible.builtin.debug:
        msg: "ğŸ“Š DHCPç•¶å‰ | ID: {{ dhcp_target_object.id }} | IP: {{ dhcp_target_object.ip }} | MAC: {{ dhcp_target_object.mac }} | æè¿°: {{ dhcp_target_object.description | default('ç©ºç™½') }}"
      when: dhcp_target_object is defined

    # è¨ˆç®—DHCPé‚„åŸMAC
    - name: "ğŸ§® Calculate DHCP Reserved MAC"
      ansible.builtin.set_fact:
        ip_fourth_octet: "{{ dhcp_target_object.ip.split('.')[3] }}"
        first_digit: "{{ dhcp_target_object.ip.split('.')[3][0] }}"
        last_two_digits: "{{ dhcp_target_object.ip.split('.')[3][1:] }}"
        dhcp_reserved_mac: "ff:ff:ff:ff:f{{ dhcp_target_object.ip.split('.')[3][0] }}:{{ dhcp_target_object.ip.split('.')[3][1:] }}"
      when: dhcp_target_object is defined

    - name: "ğŸ”„ DHCP After Delete Configuration" 
      ansible.builtin.debug:
        msg: "ğŸ”„ DHCPé‚„åŸ | ID: {{ dhcp_target_object.id }} | IP: {{ dhcp_target_object.ip }} | MAC: {{ dhcp_reserved_mac }} | æè¿°: Reserved"
      when: dhcp_target_object is defined

    # ==================== Firewall åŠŸèƒ½é è¦½ ====================
    - name: "ğŸ”¥ Firewall Preview Section"
      ansible.builtin.debug:
        msg: "==================== Firewall é è¦½ ===================="

    # ç²å–æ‰€æœ‰MACé¡å‹çš„Address
    - name: "ğŸ” Get All MAC Type Firewall Addresses"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/firewall/address?filter=type==mac"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: firewall_addresses
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"

    # é¡¯ç¤ºFirewall Addressesèª¿è©¦è³‡è¨Š
    - name: "ğŸ” Debug Firewall Addresses Structure"
      ansible.builtin.debug:
        msg: "ğŸ” èª¿è©¦ | Addressæ•¸é‡: {{ firewall_addresses.json.results | length }} | ç¬¬ä¸€å€‹Addressçµæ§‹: {{ firewall_addresses.json.results[0] | default('ç„¡è³‡æ–™') }}"
      when: firewall_addresses.json.results | length > 0

    # æœå°‹ç›®æ¨™MACå°æ‡‰çš„Address Objectï¼ˆä¿®æ­£ç‰ˆï¼‰
    - name: "ğŸ” Search for Target MAC in Firewall Addresses"
      ansible.builtin.set_fact:
        firewall_target_object: "{{ item }}"
        found_macaddr: "{{ actual_macaddr }}"
      loop: "{{ firewall_addresses.json.results }}"
      vars:
        # è™•ç†macaddrå¯èƒ½æ˜¯å­—ä¸²æˆ–åˆ—è¡¨çš„æƒ…æ³
        actual_macaddr: "{{ item.macaddr if item.macaddr is string else (item.macaddr | first if item.macaddr | length > 0 else '') }}"
      when:
        - firewall_target_object is not defined
        - item.name is defined
        - item.name.startswith('MAC_')
        - item.macaddr is defined
        - actual_macaddr | lower == normalized_mac

    # Firewall Addressæœªæ‰¾åˆ°çš„è™•ç†
    - name: "âš ï¸ Firewall Target Address Not Found"
      ansible.builtin.debug:
        msg: "âš ï¸ Firewallä¸­æœªæ‰¾åˆ°MAC: {{ normalized_mac }} å°æ‡‰çš„Address Objectï¼ˆåç¨±éœ€ä»¥MAC_é–‹é ­ï¼‰ï¼Œå°‡è·³éFirewallæ“ä½œ"
      when: firewall_target_object is not defined

    # é¡¯ç¤ºæ‰€æœ‰MAC_é–‹é ­çš„Addressä»¥ä¾›èª¿è©¦
    - name: "ğŸ” List All MAC_ Addresses for Debug"
      ansible.builtin.debug:
        msg: "ğŸ” MAC_åœ°å€ {{ ansible_loop.index }}/{{ mac_addresses | length }} | Name: {{ item.name }} | MAC: {{ actual_mac }} | Type: {{ item.type }}"
      loop: "{{ mac_addresses }}"
      loop_control:
        extended: true
      vars:
        mac_addresses: "{{ firewall_addresses.json.results | selectattr('name', 'defined') | selectattr('name', 'match', '^MAC_.*') | list }}"
        actual_mac: "{{ item.macaddr if item.macaddr is string else (item.macaddr | first if item.macaddr | length > 0 else 'N/A') }}"
      when: 
        - firewall_target_object is not defined
        - mac_addresses | length > 0

    # Firewall Addressæ‰¾åˆ°æ™‚çš„é è¦½
    - name: "ğŸ“Š Firewall Target Address Found"
      ansible.builtin.debug:
        msg: "ğŸ“Š Firewallç›®æ¨™ | Name: {{ firewall_target_object.name }} | MAC: {{ found_macaddr }} | Comment: {{ firewall_target_object.comment | default('ç„¡') }}"
      when: firewall_target_object is defined

    # ç²å–Address Groupé…ç½®
    - name: "ğŸ” Get Address Group Configuration"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/firewall/addrgrp/{{ target_address_group }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: address_group_config
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: firewall_target_object is defined

    # æª¢æŸ¥Addressæ˜¯å¦åœ¨Groupä¸­
    - name: "ğŸ” Check Address in Group"
      ansible.builtin.set_fact:
        address_in_group: "{{ firewall_target_object.name in address_group_config.json.results.member }}"
        original_group_members: "{{ address_group_config.json.results.member }}"
        updated_group_members: "{{ address_group_config.json.results.member | difference([firewall_target_object.name]) }}"
      when: 
        - firewall_target_object is defined
        - address_group_config is defined

    - name: "ğŸ“Š Address Group Current Status"
      ansible.builtin.debug:
        msg: "ğŸ“Š Address Group | åç¨±: {{ target_address_group }} | ç›®æ¨™Addressåœ¨Groupä¸­: {{ 'YES' if address_in_group else 'NO' }} | ç•¶å‰Membersæ•¸: {{ original_group_members | length }}"
      when: firewall_target_object is defined

    - name: "ğŸ”„ Address Group After Remove"
      ansible.builtin.debug:
        msg: "ğŸ”„ ç§»é™¤å¾Œ | Group: {{ target_address_group }} | ç§»é™¤Member: {{ firewall_target_object.name }} | å‰©é¤˜Membersæ•¸: {{ updated_group_members | length }}"
      when: 
        - firewall_target_object is defined
        - address_in_group

    # ==================== æ•´åˆé è¦½ç¸½çµ ====================
    - name: "ğŸ“Š Integrated Preview Summary"
      ansible.builtin.debug:
        msg: "==================== æ•´åˆé è¦½ç¸½çµ ===================="

    - name: "ğŸ“Š Operations Summary"
      ansible.builtin.debug:
        msg: "ğŸ“Š æ“ä½œç¸½è¦½ | DHCPæ“ä½œ: {{ 'YES' if dhcp_target_object is defined else 'SKIP' }} | Firewallæ“ä½œ: {{ 'YES' if firewall_target_object is defined else 'SKIP' }} | Addressåœ¨Groupä¸­: {{ 'YES' if (firewall_target_object is defined and address_in_group) else 'NO' }}"

    # è¨˜éŒ„åŸå§‹é…ç½®å‚™ä»½
    - name: "ğŸ’¾ Record Original Configuration for Backup"
      ansible.builtin.set_fact:
        integrated_backup_info:
          timestamp: "{{ ansible_date_time.iso8601 }}"
          dhcp_config: "{{ dhcp_target_object | default({}) }}"
          firewall_config: "{{ firewall_target_object | default({}) }}"
          address_group_config:
            name: "{{ target_address_group }}"
            original_members: "{{ original_group_members | default([]) }}"
            updated_members: "{{ updated_group_members | default([]) }}"
          server_info: "{{ server_info }}"
          purpose: "è¨˜éŒ„DHCPå’ŒFirewallè®Šæ›´å‰çš„åŸå§‹é…ç½®"
      when: backup_enabled

    # è¨ˆç®—é è¦½æ™‚é–“
    - name: "â±ï¸ Calculate Preview Time"
      ansible.builtin.set_fact:
        current_time: "{{ ansible_date_time.epoch | int }}"
        preview_time_used: "{{ (ansible_date_time.epoch | int) - (preview_start_time | int) }}"

    - name: "â±ï¸ Preview Time Summary"
      ansible.builtin.debug:
        msg: "â±ï¸ é è¦½ç”¨æ™‚: {{ preview_time_used }}s"

    # æœ€çµ‚è­¦å‘Š
    - name: "âš ï¸ Configuration Change Warning"
      ansible.builtin.debug:
        msg: "âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ°¸ä¹…ä¿®æ”¹FortiGateçš„DHCPå’ŒFirewallé…ç½®ï¼è«‹åœ¨Approval Nodeä¸­ä»”ç´°ç¢ºèªå¾Œå†æ‰¹å‡†åŸ·è¡Œã€‚"

    # è¨­å®šworkflowè®Šæ•¸ï¼ˆæ•´åˆç‰ˆï¼‰
    - name: "ğŸ“¤ Set Integrated Workflow Variables"
      ansible.builtin.set_stats:
        data:
          # DHCP ç›¸é—œè®Šæ•¸
          wf_dhcp_enabled: "{{ dhcp_target_object is defined }}"
          wf_dhcp_target_id: "{{ dhcp_target_object.id | default('') }}"
          wf_dhcp_target_ip: "{{ dhcp_target_object.ip | default('') }}"
          wf_dhcp_original_mac: "{{ dhcp_target_object.mac | default('') }}"
          wf_dhcp_reserved_mac: "{{ dhcp_reserved_mac | default('') }}"
          wf_dhcp_original_desc: "{{ dhcp_target_object.description | default('') }}"
          wf_ip_fourth_octet: "{{ ip_fourth_octet | default('') }}"
          wf_first_digit: "{{ first_digit | default('') }}"
          wf_last_two_digits: "{{ last_two_digits | default('') }}"
          # Firewall ç›¸é—œè®Šæ•¸
          wf_firewall_enabled: "{{ firewall_target_object is defined }}"
          wf_firewall_address_name: "{{ firewall_target_object.name | default('') }}"
          wf_firewall_address_mac: "{{ found_macaddr | default('') }}"
          wf_firewall_address_comment: "{{ firewall_target_object.comment | default('') }}"
          wf_address_group_name: "{{ target_address_group }}"
          wf_address_in_group: "{{ address_in_group | default(false) }}"
          wf_original_group_members: "{{ original_group_members | default([]) | to_json }}"
          wf_updated_group_members: "{{ updated_group_members | default([]) | to_json }}"
          # å…±ç”¨è®Šæ•¸
          wf_server_id: "{{ target_dhcp_server_id }}"
          wf_delete_mac: "{{ normalized_mac }}"
          wf_server_info: "{{ server_info | to_json }}"
          wf_backup_info: "{{ integrated_backup_info | default({}) | to_json }}"
          wf_vdom_name: "{{ fortigate_vdom | default('root') }}"
          wf_preview_version: "v5.1"

    - name: "ğŸ¯ Integrated Preview Complete"
      ansible.builtin.debug:
        msg: "ğŸ¯ æ•´åˆé è¦½å®Œæˆ | ç­‰å¾…äººå·¥ç¢ºèª | MAC {{ normalized_mac }} | DHCP: {{ 'YES' if dhcp_target_object is defined else 'SKIP' }} | Firewall: {{ 'YES' if firewall_target_object is defined else 'SKIP' }} | ç‰ˆæœ¬: v5.1"
