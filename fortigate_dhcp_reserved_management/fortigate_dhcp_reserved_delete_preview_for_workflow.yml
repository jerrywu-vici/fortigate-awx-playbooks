---
# =============================================================================
# FortiGate DHCP Reserved Address Delete Preview For Workflow Playbook v5.0
# ç”¨é€”ï¼šé è¦½è¦åˆªé™¤çš„MACé…ç½®ï¼Œè¨ˆç®—é‚„åŸå¾Œçš„MACåœ°å€ï¼Œä½¿ç”¨FortiOSæ¨¡å¡Šå„ªåŒ–
# è¼¸å‡ºï¼šé¡¯ç¤ºç•¶å‰é…ç½®å’Œé è¨ˆè®Šæ›´å…§å®¹ï¼Œè¨­å®šworkflowè®Šæ•¸ï¼ŒåŒ…æ‹¬è¡¨æ ¼è¼¸å‡º
# =============================================================================

- name: FortiGate DHCP Delete Preview For Workflow v5.0
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    target_mac_list: "{{ delete_mac_param.split(',') | map('trim') | list }}"  # æ”¯æ´æ‰¹æ¬¡MAC
    target_dhcp_server_id: "{{ server_id | default('3') }}"
    api_retries: "{{ fortigate_api_retries | default('3') | int }}"
    api_delay: "{{ fortigate_api_delay | default('5') | int }}"
    backup_enabled: "{{ fortigate_backup_enabled | default(true) | bool }}"
    connection_timeout: "{{ fortigate_timeout | default('30') | int }}"
    validate_certs: "{{ fortigate_validate_certs | default(true) | bool }}"  # é è¨­true

  tasks:
    - name: "â° Record Start Time"
      ansible.builtin.set_fact:
        preview_start_time: "{{ ansible_date_time.epoch | int }}"

    - name: "ğŸ” Validate Credentials"
      ansible.builtin.fail:
        msg: "ç¼ºå°‘FortiGate Credentialåƒæ•¸"
      when: fortigate_host is not defined or fortigate_access_token is not defined

    - name: "ğŸ” Validate MAC Format"
      ansible.builtin.set_fact:
        normalized_macs: "{{ target_mac_list | map('regex_replace', '-', ':') | map('lower') | list }}"
        valid_macs: "{{ normalized_macs | map('regex_search', '^([0-9a-fa-f]{2}:){5}[0-9a-fa-f]{2}$') | select('defined') | list }}"
      failed_when: normalized_macs | length != valid_macs | length

    - name: "ğŸ”Œ Test FortiGate Connection"
      fortinet.fortios.fortios_monitor_fact:
        access_token: "{{ fortigate_access_token }}"
        vdom: "{{ fortigate_vdom | default('root') }}"
        selector: "system_global"
      register: api_test

    - name: "âœ… API Connection Status"
      ansible.builtin.debug:
        msg: "âœ… APIé€£ç·šæˆåŠŸ | FortiGateç‰ˆæœ¬: {{ api_test.facts.version | default('æœªçŸ¥') }}"

    - name: "ğŸ” Get Current DHCP Reservations"
      fortinet.fortios.fortios_system_dhcp_server:
        access_token: "{{ fortigate_access_token }}"
        vdom: "{{ fortigate_vdom }}"
        state: gather
        system_dhcp_server:
          id: "{{ target_dhcp_server_id }}"
      register: existing_reservations

    - name: "ğŸ’¾ Backup Configuration"
      fortinet.fortios.fortios_config:
        access_token: "{{ fortigate_access_token }}"
        vdom: "{{ fortigate_vdom }}"
        config: "backup"
        backup_path: "{{ fortigate_backup_path | default('/tmp') }}"
        backup_filename: "dhcp_preview_backup_{{ ansible_date_time.epoch }}.conf"
      when: backup_enabled

    - name: "ğŸ§® Process Each MAC"
      ansible.builtin.set_fact:
        processed_configs: "{{ processed_configs | default([]) + [item] }}"
      loop: "{{ normalized_macs }}"
      vars:
        target_object: "{{ existing_reservations.system_dhcp_server.reserved_address | selectattr('mac', 'equalto', item) | first | default(none) }}"
      when: target_object is defined
      with_items:
        - id: "{{ target_object.id }}"
          ip: "{{ target_object.ip }}"
          original_mac: "{{ target_object.mac }}"
          original_desc: "{{ target_object.description | default('') }}"
          ip_fourth_octet: "{{ target_object.ip.split('.')[-1] | int }}"
          first_digit: "{{ target_object.ip.split('.')[-1][0] if target_object.ip.split('.')[-1] | length == 3 else '0' }}"  # è™•ç†<100
          last_two_digits: "{{ target_object.ip.split('.')[-1][1:] if target_object.ip.split('.')[-1] | length == 3 else (target_object.ip.split('.')[-1] | int).to_string.zfill(2) }}"
          reserved_mac: "ff:ff:ff:ff:f{{ first_digit }}:{{ last_two_digits }}"
          already_reserved: "{{ target_object.mac.lower() == reserved_mac and target_object.description | default('') | lower == 'reserved' }}"
          ip_range_valid: "{{ ip_fourth_octet >= 100 and ip_fourth_octet <= 250 }}"

    - name: "ğŸ“Š Generate Preview Table"
      ansible.builtin.template:
        src: preview_table.j2  # å‡è¨­æœ‰Jinjaæ¨¡æ¿ç”ŸæˆMarkdownè¡¨æ ¼
        dest: "/tmp/preview_table.md"
      vars:
        configs: "{{ processed_configs }}"

    - name: "ğŸ“¤ Set Workflow Variables"
      ansible.builtin.set_stats:
        data:
          wf_processed_configs: "{{ processed_configs | to_json }}"
          wf_server_id: "{{ target_dhcp_server_id }}"
          wf_backup_info: "{{ backup_info | default({}) | to_json }}"
          wf_preview_version: "v5.0"

    - name: "ğŸ¯ Preview Complete"
      ansible.builtin.debug:
        msg: "ğŸ¯ é è¦½å®Œæˆ | ç­‰å¾…ç¢ºèª"
