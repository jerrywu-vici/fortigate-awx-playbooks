---
# =============================================================================
# FortiGate DHCP Reserved Address Delete Preview For Workflow Playbook v4.1
# ç”¨é€”ï¼šé è¦½è¦åˆªé™¤çš„MACé…ç½®ï¼Œè¨ˆç®—é‚„åŸå¾Œçš„MACåœ°å€
# å„ªåŒ–ï¼šAPIé€£ç·šæ¸¬è©¦ã€MACæ ¼å¼é©—è­‰ã€åŸ·è¡Œæ™‚é–“ä¼°ç®—ã€å¢å¼·éŒ¯èª¤è™•ç†
# ä¿®æ­£ï¼šè§£æ±ºè®Šæ•¸éè¿´å¼•ç”¨å•é¡Œ
# è¼¸å‡ºï¼šé¡¯ç¤ºç•¶å‰é…ç½®å’Œé è¨ˆè®Šæ›´å…§å®¹ï¼Œè¨­å®šworkflowè®Šæ•¸
# =============================================================================

- name: FortiGate DHCP Delete Preview For Workflow v4.1
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    # ç›´æ¥ä½¿ç”¨å‚³å…¥çš„åƒæ•¸ï¼Œé¿å…éè¿´å¼•ç”¨
    target_mac: "{{ delete_mac_param }}"
    target_dhcp_server_id: "{{ server_id | default('3') }}"
    api_retries: "{{ fortigate_api_retries | default('3') | int }}"
    api_delay: "{{ fortigate_api_delay | default('5') | int }}"
    backup_enabled: "{{ fortigate_backup_enabled | default(true) | bool }}"
    connection_timeout: "{{ fortigate_timeout | default('30') | int }}"
    validate_certs: "{{ fortigate_validate_certs | default(false) | bool }}"
    
  tasks:
    # è¨˜éŒ„é–‹å§‹æ™‚é–“
    - name: "â° Record Start Time"
      ansible.builtin.set_fact:
        preview_start_time: "{{ ansible_date_time.epoch }}"

    # åƒæ•¸é©—è­‰
    - name: "ğŸ” Validate Credentials"
      ansible.builtin.fail:
        msg: "ç¼ºå°‘FortiGate Credentialåƒæ•¸: {{ missing_params | join(', ') }}"
      vars:
        required_params:
          - fortigate_host
          - fortigate_access_token
        missing_params: "{{ required_params | select('undefined') | list }}"
      when: 
        - fortigate_host is not defined or 
          fortigate_access_token is not defined

    # Surveyåƒæ•¸é©—è­‰
    - name: "ğŸ” Validate Survey Parameters"
      ansible.builtin.fail:
        msg: "ç¼ºå°‘Surveyåƒæ•¸: {{ missing_survey_params | join(', ') }}"
      vars:
        required_survey_params:
          - delete_mac_param
        missing_survey_params: "{{ required_survey_params | select('undefined') | list }}"
      when: delete_mac_param is not defined

    # MACæ ¼å¼é©—è­‰
    - name: "ğŸ” Validate MAC Address Format"
      ansible.builtin.set_fact:
        mac_valid: "{{ target_mac | regex_search('^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$') is not none }}"

    - name: "âŒ Invalid MAC Format"
      ansible.builtin.fail:
        msg: "MACåœ°å€æ ¼å¼éŒ¯èª¤: {{ target_mac }}ã€‚æ­£ç¢ºæ ¼å¼: xx:xx:xx:xx:xx:xx æˆ– xx-xx-xx-xx-xx-xx"
      when: not mac_valid

    # æ­£è¦åŒ–MACåœ°å€æ ¼å¼
    - name: "ğŸ”§ Normalize MAC Address"
      ansible.builtin.set_fact:
        normalized_mac: "{{ target_mac | replace('-', ':') | lower }}"

    # APIé€£ç·šæ¸¬è©¦
    - name: "ğŸ”Œ Test FortiGate API Connection"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system/global"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: api_test
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"

    - name: "âœ… API Connection Status"
      ansible.builtin.debug:
        msg: "âœ… APIé€£ç·šæˆåŠŸ | å›æ‡‰æ™‚é–“: {{ api_test.elapsed }}s | FortiGateç‰ˆæœ¬: {{ api_test.json.results.version | default('æœªçŸ¥') }}"

    # é¡¯ç¤ºé è¦½åƒæ•¸
    - name: "ğŸ“‹ FortiGate DHCP Delete Preview v4.1"
      ansible.builtin.debug:
        msg: "===========================================" 

    - name: "ğŸ“‹ Preview Parameters"
      ansible.builtin.debug:
        msg: "ğŸ” é è¦½æ¨¡å¼ | ç›®æ¨™MAC: {{ normalized_mac }} | DHCP Server: {{ target_dhcp_server_id }} | Host: {{ fortigate_host }} | VDOM: {{ fortigate_vdom | default('root') }}"

    # ç²å–DHCPé…ç½®
    - name: "ğŸ” Get Current DHCP Reserved Addresses"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ target_dhcp_server_id }}/reserved-address"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: existing_reservations
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"

    # çµ±è¨ˆè³‡è¨Š
    - name: "ğŸ“Š DHCP Server Statistics"
      ansible.builtin.debug:
        msg: "ğŸ“Š çµ±è¨ˆ | DHCP Server {{ target_dhcp_server_id }} | ç¸½é…ç½®æ•¸: {{ existing_reservations.json.results | length }} | APIå›æ‡‰æ™‚é–“: {{ existing_reservations.elapsed }}s"

    # é¡¯ç¤ºç•¶å‰é…ç½®
    - name: "ğŸ“Š Current DHCP Server {{ target_dhcp_server_id }} Configurations"
      ansible.builtin.debug:
        msg: "ğŸ“‹ ç•¶å‰é…ç½® {{ ansible_loop.index }}/{{ existing_reservations.json.results | length }} - ID: {{ item.id }} | IP: {{ item.ip }} | MAC: {{ item.mac }} | æè¿°: {{ item.description | default('ç„¡') }}"
      loop: "{{ existing_reservations.json.results }}"
      loop_control:
        extended: true
      when: existing_reservations.json.results | length > 0

    - name: "ğŸ“Š No Configurations Found"
      ansible.builtin.debug:
        msg: "âš ï¸ DHCP Server {{ target_dhcp_server_id }} ç›®å‰æ²’æœ‰ä»»ä½•reserved-addressé…ç½®"
      when: existing_reservations.json.results | length == 0

    # æœå°‹ç›®æ¨™MAC
    - name: "ğŸ” Search for Target MAC"
      ansible.builtin.set_fact:
        target_object: "{{ item }}"
      loop: "{{ existing_reservations.json.results }}"
      when:
        - target_object is not defined
        - item.mac.lower() == normalized_mac

    # MACæœªæ‰¾åˆ°æ™‚çš„éŒ¯èª¤è™•ç†
    - name: "âŒ Target MAC Not Found"
      ansible.builtin.debug:
        msg: "âŒ æœªæ‰¾åˆ°MAC: {{ normalized_mac }} åœ¨DHCP Server {{ target_dhcp_server_id }} ä¸­"
      when: target_object is not defined

    - name: "âŒ Available MAC Addresses"
      ansible.builtin.debug:
        msg: "ğŸ“‹ å¯ç”¨MAC {{ ansible_loop.index }}/{{ existing_reservations.json.results | length }} - {{ item.mac }} (IP: {{ item.ip }}, æè¿°: {{ item.description | default('ç„¡') }})"
      loop: "{{ existing_reservations.json.results }}"
      loop_control:
        extended: true
      when: 
        - target_object is not defined
        - existing_reservations.json.results | length > 0

    - name: "ğŸ’¡ MAC Search Suggestions"
      ansible.builtin.debug:
        msg: "ğŸ’¡ å»ºè­°ï¼šè«‹æª¢æŸ¥MACåœ°å€æ ¼å¼ï¼Œæˆ–å¾ä¸Šæ–¹å¯ç”¨MACæ¸…å–®ä¸­é¸æ“‡æ­£ç¢ºçš„MACåœ°å€"
      when: target_object is not defined

    - name: "âŒ Stop Execution - MAC Not Found"
      ansible.builtin.fail:
        msg: "æ“ä½œçµ‚æ­¢ï¼šæœªæ‰¾åˆ°æŒ‡å®šçš„MACåœ°å€ {{ normalized_mac }}"
      when: target_object is not defined

    # è¨ˆç®—é‚„åŸMAC
    - name: "ğŸ§® Calculate Reserved MAC Address"
      ansible.builtin.set_fact:
        ip_fourth_octet: "{{ target_object.ip.split('.')[3] }}"
        first_digit: "{{ target_object.ip.split('.')[3][0] }}"
        last_two_digits: "{{ target_object.ip.split('.')[3][1:] }}"
        reserved_mac: "ff:ff:ff:ff:f{{ target_object.ip.split('.')[3][0] }}:{{ target_object.ip.split('.')[3][1:] }}"
      when: target_object is defined

    # é©—è­‰IPç¬¬å››ç¢¼ç¯„åœ
    - name: "ğŸ” Validate IP Fourth Octet Range"
      ansible.builtin.set_fact:
        ip_range_valid: "{{ ip_fourth_octet | int >= 100 and ip_fourth_octet | int <= 250 }}"
      when: target_object is defined

    - name: "âš ï¸ IP Range Warning"
      ansible.builtin.debug:
        msg: "âš ï¸ è­¦å‘Šï¼šIPç¬¬å››ç¢¼ {{ ip_fourth_octet }} ä¸åœ¨é æœŸç¯„åœ(100-250)å…§ï¼ŒMACè¨ˆç®—å¯èƒ½ä¸æ­£ç¢º"
      when: 
        - target_object is defined
        - not ip_range_valid

    # é¡¯ç¤ºè¨ˆç®—éç¨‹
    - name: "ğŸ§® MAC Calculation Process"
      ansible.builtin.debug:
        msg: "ğŸ§® MACè¨ˆç®— | IP: {{ target_object.ip }} | ç¬¬å››ç¢¼: {{ ip_fourth_octet }} | ç¬¬ä¸€ä½: {{ first_digit }} | å¾Œå…©ä½: {{ last_two_digits }}"

    - name: "ğŸ§® MAC Calculation Result"
      ansible.builtin.debug:
        msg: "ğŸ”§ MACæ ¼å¼: ff:ff:ff:ff:f{{ first_digit }}:{{ last_two_digits }} | çµæœ: {{ reserved_mac }}"

    # æª¢æŸ¥æ˜¯å¦å·²æ˜¯Reservedç‹€æ…‹
    - name: "ğŸ” Check if Already Reserved"
      ansible.builtin.set_fact:
        already_reserved: "{{ target_object.mac.lower() == reserved_mac and (target_object.description | default('') | lower == 'reserved') }}"
      when: target_object is defined

    - name: "âš ï¸ Already Reserved Warning"
      ansible.builtin.debug:
        msg: "âš ï¸ æ³¨æ„ï¼šæ­¤é…ç½®å·²ç¶“æ˜¯Reservedç‹€æ…‹ï¼ŒåŸ·è¡Œæ“ä½œå°‡ä¸æœƒæœ‰ä»»ä½•è®Šæ›´"
      when: 
        - target_object is defined
        - already_reserved

    # å‰µå»ºå‚™ä»½ï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
    - name: "ğŸ’¾ Create Configuration Backup"
      ansible.builtin.set_fact:
        backup_info:
          timestamp: "{{ ansible_date_time.iso8601 }}"
          original_config:
            id: "{{ target_object.id }}"
            ip: "{{ target_object.ip }}"
            mac: "{{ target_object.mac }}"
            description: "{{ target_object.description | default('') }}"
          dhcp_server_id: "{{ target_dhcp_server_id }}"
      when: 
        - target_object is defined
        - backup_enabled

    - name: "ğŸ’¾ Backup Information"
      ansible.builtin.debug:
        msg: "ğŸ’¾ å‚™ä»½ | ç‹€æ…‹: {{ 'å•Ÿç”¨' if backup_enabled else 'åœç”¨' }} | æ™‚é–“: {{ backup_info.timestamp | default('ç„¡') }}"
      when: 
        - target_object is defined
        - backup_enabled

    # è¨ˆç®—åŸ·è¡Œæ™‚é–“ä¼°ç®—
    - name: "â±ï¸ Execution Time Estimation"
      ansible.builtin.set_fact:
        estimated_execution_time: "{{ (api_test.elapsed + existing_reservations.elapsed) * 2 + 5 }}"
      when: target_object is defined

    - name: "â±ï¸ Time Estimation"
      ansible.builtin.debug:
        msg: "â±ï¸ ä¼°ç®— | é è¦½ç”¨æ™‚: {{ ((ansible_date_time.epoch | int) - (preview_start_time | int)) }}s | é è¨ˆåŸ·è¡Œç”¨æ™‚: {{ estimated_execution_time | round(1) }}s"
      when: target_object is defined

    # é¡¯ç¤ºé è¦½çµæœ
    - name: "âœ… Target Configuration Found"
      ansible.builtin.debug:
        msg: "âœ… æ‰¾åˆ°ç›®æ¨™MACé…ç½® ========================================="

    - name: "ğŸ“Š Current Configuration"
      ansible.builtin.debug:
        msg: "ğŸ“Š ç•¶å‰ | ID: {{ target_object.id }} | IP: {{ target_object.ip }} | MAC: {{ target_object.mac }} | æè¿°: {{ target_object.description | default('ç©ºç™½') }}"

    - name: "ğŸ”„ After Delete Configuration" 
      ansible.builtin.debug:
        msg: "ğŸ”„ é‚„åŸ | ID: {{ target_object.id }} | IP: {{ target_object.ip }} | MAC: {{ reserved_mac }} | æè¿°: Reserved"

    - name: "ğŸ“ MAC Restore Rule"
      ansible.builtin.debug:
        msg: "ğŸ“ è¦å‰‡ | IPç¬¬å››ç¢¼ {{ ip_fourth_octet }} â†’ MAC ff:ff:ff:ff:f{{ first_digit }}:{{ last_two_digits }} | æè¿°çµ±ä¸€ç‚ºReserved"

    - name: "ğŸ”„ Change Summary"
      ansible.builtin.debug:
        msg: "ğŸ”„ ç•°å‹• | MACè®Šæ›´: {{ 'YES' if target_object.mac.lower() != reserved_mac else 'NO' }} | æè¿°è®Šæ›´: {{ 'YES' if (target_object.description | default('') | lower) != 'reserved' else 'NO' }} | å·²Reserved: {{ 'YES' if already_reserved else 'NO' }}"

    - name: "âš ï¸ Configuration Change Warning"
      ansible.builtin.debug:
        msg: "âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ°¸ä¹…ä¿®æ”¹FortiGateé…ç½®ï¼è«‹åœ¨Approval Nodeä¸­ä»”ç´°ç¢ºèªå¾Œå†æ‰¹å‡†åŸ·è¡Œã€‚"

    # è¨­å®šworkflowè®Šæ•¸ï¼ˆå¢å¼·ç‰ˆï¼‰
    - name: "ğŸ“¤ Set Enhanced Workflow Variables"
      ansible.builtin.set_stats:
        data:
          wf_target_id: "{{ target_object.id }}"
          wf_target_ip: "{{ target_object.ip }}"
          wf_original_mac: "{{ target_object.mac }}"
          wf_reserved_mac: "{{ reserved_mac }}"
          wf_original_desc: "{{ target_object.description | default('') }}"
          wf_server_id: "{{ target_dhcp_server_id }}"
          wf_delete_mac: "{{ normalized_mac }}"
          wf_ip_fourth_octet: "{{ ip_fourth_octet }}"
          wf_first_digit: "{{ first_digit }}"
          wf_last_two_digits: "{{ last_two_digits }}"
          wf_already_reserved: "{{ already_reserved }}"
          wf_ip_range_valid: "{{ ip_range_valid }}"
          wf_backup_info: "{{ backup_info | default({}) }}"
          wf_estimated_time: "{{ estimated_execution_time | default(0) }}"
          wf_vdom_name: "{{ fortigate_vdom | default('root') }}"
          wf_preview_version: "v4.1"

    - name: "ğŸ¯ Preview Complete"
      ansible.builtin.debug:
        msg: "ğŸ¯ é è¦½å®Œæˆ | ç­‰å¾…äººå·¥ç¢ºèª | MAC {{ normalized_mac }} â†’ {{ reserved_mac }} | IP {{ target_object.ip }} | ç‰ˆæœ¬: v4.1"
