---
# =============================================================================
# FortiGate DHCP Reserved Address Delete Execute For Workflow Playbook v5.0
# ç”¨é€”ï¼šåŸ·è¡ŒMACåˆªé™¤ï¼Œå°‡é…ç½®é‚„åŸç‚ºReservedç‹€æ…‹ï¼Œä½¿ç”¨FortiOSæ¨¡å¡Šå„ªåŒ–
# è¼¸å…¥ï¼šæ¥æ”¶Previewçš„workflowè®Šæ•¸
# è¼¸å‡ºï¼šåŸ·è¡Œçµæœå’Œæ‘˜è¦ï¼ŒåŒ…æ‹¬é‚„åŸæ©Ÿåˆ¶
# =============================================================================

- name: FortiGate DHCP Delete Execute For Workflow v5.0
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    processed_configs: "{{ (wf_processed_configs | default('[]')) | from_json }}"
    dhcp_server_id: "{{ wf_server_id }}"
    fortigate_host: "{{ fortigate_host }}"
    fortigate_access_token: "{{ fortigate_access_token }}"
    validate_certs: "{{ fortigate_validate_certs | default(true) | bool }}"

  tasks:
    - name: "â° Record Start Time"
      ansible.builtin.set_fact:
        execution_start_time: "{{ ansible_date_time.epoch | int }}"

    - name: "ğŸ” Validate Workflow Parameters"
      ansible.builtin.fail:
        msg: "ç¼ºå°‘Workflowåƒæ•¸"
      when: processed_configs | length == 0

    - name: "ğŸ”Œ Test FortiGate Connection"
      fortinet.fortios.fortios_monitor_fact:
        access_token: "{{ fortigate_access_token }}"
        vdom: "{{ wf_vdom_name | default('root') }}"
        selector: "system_global"
      register: api_test

    - name: "ğŸ” Pre-execution Verification"
      fortinet.fortios.fortios_system_dhcp_server:
        access_token: "{{ fortigate_access_token }}"
        vdom: "{{ wf_vdom_name }}"
        state: gather
        system_dhcp_server:
          id: "{{ dhcp_server_id }}"
      register: pre_config

    - name: "ğŸ”§ Execute Updates"
      fortinet.fortios.fortios_system_dhcp_server:
        access_token: "{{ fortigate_access_token }}"
        vdom: "{{ wf_vdom_name }}"
        state: present
        system_dhcp_server:
          id: "{{ dhcp_server_id }}"
          reserved_address:
            - id: "{{ item.id }}"
              ip: "{{ item.ip }}"
              mac: "{{ item.reserved_mac }}"
              description: "Reserved"
      loop: "{{ processed_configs }}"
      when: not item.already_reserved
      register: update_results

    - name: "ğŸ” Post-execution Verification"
      fortinet.fortios.fortios_system_dhcp_server:
        access_token: "{{ fortigate_access_token }}"
        vdom: "{{ wf_vdom_name }}"
        state: gather
        system_dhcp_server:
          id: "{{ dhcp_server_id }}"
      register: post_config
      when: update_results.changed

    - name: "âŒ Rollback on Failure"
      fortinet.fortios.fortios_config:
        access_token: "{{ fortigate_access_token }}"
        vdom: "{{ wf_vdom_name }}"
        config: "restore"
        backup_path: "{{ fortigate_backup_path }}/dhcp_preview_backup_{{ execution_start_time }}.conf"
      when: update_results.failed | default(false)

    - name: "ğŸ“Š Execution Summary"
      ansible.builtin.debug:
        msg: "âœ… åŸ·è¡Œå®Œæˆ | è®Šæ›´æ•¸: {{ update_results.changed | length }}"

    - name: "â±ï¸ Time Summary"
      ansible.builtin.set_fact:
        execution_time: "{{ (ansible_date_time.epoch | int) - execution_start_time }}"
      ansible.builtin.debug:
        msg: "â±ï¸ ç”¨æ™‚: {{ execution_time }}s"
