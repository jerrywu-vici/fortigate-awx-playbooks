---
# =============================================================================
# FortiGate DHCP Reserved Address Delete Execute For Workflow Playbook v4.6
# ç”¨é€”ï¼šåŸ·è¡Œå¯¦éš›çš„MACåˆªé™¤æ“ä½œï¼Œå°‡é…ç½®é‚„åŸç‚ºReservedç‹€æ…‹
# å„ªåŒ–ï¼šæ”¯æ´VDOMã€ç«¯å£ã€å¼·åŒ–é…ç½®ä¸€è‡´æ€§æª¢æŸ¥ã€è¡¨æ ¼è¼¸å‡ºã€å›æ»¾æç¤º
# =============================================================================

- name: FortiGate DHCP Delete Execute For Workflow v4.6
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    target_id: "{{ wf_target_id }}"
    target_ip: "{{ wf_target_ip }}"
    original_mac: "{{ wf_original_mac }}"
    reserved_mac: "{{ wf_reserved_mac }}"
    original_desc: "{{ wf_original_desc }}"
    dhcp_server_id: "{{ wf_server_id }}"
    delete_mac: "{{ wf_delete_mac }}"
    ip_fourth_octet: "{{ wf_ip_fourth_octet }}"
    first_digit: "{{ wf_first_digit }}"
    last_two_digits: "{{ wf_last_two_digits }}"
    already_reserved: "{{ (wf_already_reserved | default('false')) | bool }}"
    ip_range_valid: "{{ (wf_ip_range_valid | default('true')) | bool }}"
    backup_info: "{{ (wf_backup_info | default('{}')) | from_json }}"
    vdom_name: "{{ wf_vdom_name | default('root') }}"
    preview_version: "{{ wf_preview_version | default('unknown') }}"
    fortigate_host: "{{ fortigate_host }}"
    fortigate_token: "{{ fortigate_access_token }}"
    api_retries: "{{ fortigate_api_retries | default('5') | int }}"
    api_delay: "{{ fortigate_api_delay | default('10') | int }}"
    backup_enabled: "{{ fortigate_backup_enabled | default(true) | bool }}"
    connection_timeout: "{{ fortigate_timeout | default('30') | int }}"
    validate_certs: "{{ fortigate_validate_certs | default(false) | bool }}"
    api_base_url: "https://{{ fortigate_host }}:{{ fortigate_api_port }}/api/v2/cmdb"

  tasks:
    - name: "â° Record Execution Start Time"
      ansible.builtin.set_fact:
        execution_start_time: "{{ ansible_date_time.epoch | int }}"

    - name: "ğŸ” Validate Workflow Parameters"
      ansible.builtin.fail:
        msg: "å¾Workflowæ¥æ”¶åƒæ•¸å¤±æ•—ï¼ç¼ºå°‘: {{ missing_wf_params | join(', ') }}ã€‚æ­¤Job Templateåƒ…æ‡‰åœ¨Workflowä¸­åŸ·è¡Œã€‚"
      vars:
        required_wf_params:
          - wf_target_id
          - wf_target_ip
          - wf_reserved_mac
          - wf_server_id
        missing_wf_params: "{{ required_wf_params | select('undefined') | list }}"
      when: target_id is not defined or target_ip is not defined or reserved_mac is not defined or dhcp_server_id is not defined

    - name: "ğŸ” Validate Credentials"
      ansible.builtin.fail:
        msg: "ç¼ºå°‘FortiGate Credentialåƒæ•¸ï¼è«‹ç¢ºèªJob Templateå·²æ­£ç¢ºè¨­å®šCredentialã€‚"
      when: fortigate_host is not defined or fortigate_token is not defined

    - name: "ğŸ” Version Compatibility Check"
      ansible.builtin.fail:
        msg: "ç‰ˆæœ¬ä¸ç›¸å®¹ï¼Previewç‰ˆæœ¬: {{ preview_version }} | Executeç‰ˆæœ¬: v4.6"
      when: preview_version != 'v4.6'

    - name: "ğŸ”Œ Test FortiGate API Connection"
      ansible.builtin.uri:
        url: "{{ api_base_url }}/system/global"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: api_connection_test
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"

    - name: "âœ… API Connection Status"
      ansible.builtin.debug:
        msg: "âœ… APIé€£ç·šæˆåŠŸ | FortiGateç‰ˆæœ¬: {{ api_connection_test.json.results.version | default('æœªçŸ¥') }} | VDOM: {{ vdom_name }}"

    - name: "ğŸ” Pre-execution Configuration Verification"
      ansible.builtin.uri:
        url: "{{ api_base_url }}/system.dhcp/server/{{ dhcp_server_id }}/reserved-address/{{ target_id }}?vdom={{ vdom_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: pre_execution_config
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"

    - name: "ğŸ” Configuration Consistency Check"
      ansible.builtin.set_fact:
        current_config: "{{ pre_execution_config.json.results | first }}"
        config_consistent: "{{ 
          current_config.ip == target_ip and 
          current_config.mac.lower() == original_mac.lower() 
        }}"

    - name: "âŒ Stop Execution - Configuration Changed"
      ansible.builtin.fail:
        msg: "æ“ä½œçµ‚æ­¢ï¼šé…ç½®åœ¨Previewå¾Œå·²è¢«ä¿®æ”¹ï¼ç•¶å‰MAC: {{ current_config.mac }} vs é æœŸ: {{ original_mac }}ã€‚è«‹é‡æ–°åŸ·è¡ŒPreviewã€‚"
      when: not config_consistent

    - name: "ğŸ“‹ FortiGate DHCP Delete Execute v4.6"
      ansible.builtin.debug:
        msg: "==========================================="

    - name: "ğŸš€ Execute Parameters"
      ansible.builtin.debug:
        msg: "ğŸš€ åŸ·è¡Œæ¨¡å¼ | å·²é€šéäººå·¥ç¢ºèª | ç›®æ¨™ID: {{ target_id }} | IP: {{ target_ip }} | Server: {{ dhcp_server_id }} | VDOM: {{ vdom_name }}"

    - name: "ğŸ“Š Configuration Change (Table View)"
      ansible.builtin.debug:
        msg: |-
          | Field | Original | New |
          |-------|----------|-----|
          | MAC   | {{ original_mac }} | {{ reserved_mac }} |
          | Description | {{ original_desc | default('ç©ºç™½') }} | Reserved |

    - name: "â­ï¸ Skip Already Reserved Configuration"
      ansible.builtin.debug:
        msg: "â­ï¸ è·³éï¼šé…ç½®å·²ç¶“æ˜¯Reservedç‹€æ…‹ï¼Œç„¡éœ€åŸ·è¡Œè®Šæ›´"
      when: already_reserved

    - name: "ğŸ§® MAC Calculation Verification"
      ansible.builtin.debug:
        msg: "ğŸ§® é©—è­‰ | IPç¬¬å››ç¢¼: {{ ip_fourth_octet }} | åˆ†è§£: {{ first_digit }}+{{ last_two_digits }} | MAC: {{ reserved_mac }} | IPç¯„åœæœ‰æ•ˆ: {{ ip_range_valid }}"

    - name: "ğŸ’¾ Original Configuration Backup"
      ansible.builtin.debug:
        msg: "ğŸ’¾ åŸå§‹é…ç½®å‚™ä»½ | ç‹€æ…‹: {{ 'å¯ç”¨' if backup_info != {} else 'ç„¡' }} | ç”¨é€”: {{ backup_info.purpose | default('è¨˜éŒ„åŸå§‹é…ç½®ä¾›å›æ»¾åƒè€ƒ') }} | è¨˜éŒ„æ™‚é–“: {{ backup_info.timestamp | default('ç„¡') }} | å›æ»¾è…³æœ¬: {{ backup_info.rollback_script | default('ç„¡') }}"

    - name: "âš ï¸ Final Confirmation"
      ansible.builtin.debug:
        msg: "âš ï¸ å³å°‡åŸ·è¡ŒFortiGate APIå‘¼å« | é…ç½®ID: {{ target_id }} | æ­¤æ“ä½œå°‡æ°¸ä¹…ä¿®æ”¹é…ç½®"
      when: not already_reserved

    - name: "ğŸ”§ Execute MAC Delete Operation"
      ansible.builtin.uri:
        url: "{{ api_base_url }}/system.dhcp/server/{{ dhcp_server_id }}/reserved-address/{{ target_id }}?vdom={{ vdom_name }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          ip: "{{ target_ip }}"
          mac: "{{ reserved_mac }}"
          description: "Reserved"
        body_format: json
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: delete_result
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: not already_reserved

    - name: "â­ï¸ Skipped Operation Result"
      ansible.builtin.set_fact:
        delete_result:
          status: 200
          skipped: true
          msg: "Configuration already in Reserved state"
      when: already_reserved

    - name: "ğŸ” Post-execution Verification"
      ansible.builtin.uri:
        url: "{{ api_base_url }}/system.dhcp/server/{{ dhcp_server_id }}/reserved-address/{{ target_id }}?vdom={{ vdom_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: post_execution_config
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: delete_result.status == 200

    - name: "âœ… Verification Result"
      ansible.builtin.set_fact:
        post_config: "{{ post_execution_config.json.results | first }}"
        verification_passed: "{{ 
          post_config.mac.lower() == reserved_mac.lower() and 
          post_config.description.lower() == 'reserved' 
        }}"
      when: post_execution_config.json.results | length > 0

    - name: "âœ… Configuration Verification"
      ansible.builtin.debug:
        msg: "{{ 'âœ… é…ç½®é©—è­‰é€šé' if verification_passed else 'âŒ é…ç½®é©—è­‰å¤±æ•—' }} | ç•¶å‰MAC: {{ post_config.mac | default('æœªçŸ¥') }} | ç•¶å‰æè¿°: {{ post_config.description | default('æœªçŸ¥') }}"

    - name: "ğŸ‰ Operation Success Status"
      ansible.builtin.debug:
        msg: "âœ… MACåˆªé™¤æ“ä½œæˆåŠŸ | HTTPç‹€æ…‹: {{ delete_result.status }} | è·³éåŸ·è¡Œ: {{ delete_result.skipped | default(false) }}"
      when: delete_result.status == 200

    - name: "âŒ Operation Failed"
      ansible.builtin.fail:
        msg: "âŒ MACåˆªé™¤æ“ä½œå¤±æ•— | HTTPç‹€æ…‹: {{ delete_result.status | default('æœªçŸ¥') }} | éŒ¯èª¤: {{ delete_result.msg | default('æœªçŸ¥') }}"
      when: delete_result.status != 200

    - name: "â±ï¸ Calculate Execution Statistics"
      ansible.builtin.set_fact:
        actual_execution_time: "{{ (ansible_date_time.epoch | int) - execution_start_time | int }}"

    - name: "ğŸ“Š Final Result (Table View)"
      ansible.builtin.debug:
        msg: |-
          | Status | MAC Change | IP | Time Used |
          |--------|------------|----|-----------|
          | {{ 'âœ…æˆåŠŸ' if delete_result.status == 200 else 'âŒå¤±æ•—' }} | {{ delete_mac }} â†’ {{ reserved_mac }} | {{ target_ip }} | {{ actual_execution_time }}s |

    - name: "ğŸ“… Completion Time"
      ansible.builtin.debug:
        msg: "ğŸ“… å®Œæˆæ™‚é–“: {{ ansible_date_time.iso8601 }} | ç‰ˆæœ¬: v4.6"
