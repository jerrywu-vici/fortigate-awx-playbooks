---
# =============================================================================
# FortiGate DHCP Reserved Address Delete Execute For Workflow Playbook  
# ç”¨é€”ï¼šåŸ·è¡Œå¯¦éš›çš„MACåˆªé™¤æ“ä½œï¼Œå°‡é…ç½®é‚„åŸç‚ºReservedç‹€æ…‹
# è¼¸å…¥ï¼šæ¥æ”¶Previewæ­¥é©Ÿçš„workflowè®Šæ•¸
# è¼¸å‡ºï¼šåŸ·è¡Œçµæœå’Œæ“ä½œæ‘˜è¦
# =============================================================================

- name: FortiGate DHCP Delete Execute For Workflow v3.4
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # æ¥æ”¶workflowè®Šæ•¸
    target_id: "{{ wf_target_id }}"
    target_ip: "{{ wf_target_ip }}"
    original_mac: "{{ wf_original_mac }}"
    reserved_mac: "{{ wf_reserved_mac }}"
    original_desc: "{{ wf_original_desc }}"
    dhcp_server_id: "{{ wf_server_id }}"
    delete_mac: "{{ wf_delete_mac }}"
    ip_fourth_octet: "{{ wf_ip_fourth_octet }}"
    first_digit: "{{ wf_first_digit }}"
    last_two_digits: "{{ wf_last_two_digits }}"
    
    # FortiGateé€£æ¥åƒæ•¸
    fortigate_host: "{{ fortigate_host }}"
    fortigate_token: "{{ fortigate_access_token }}"
    vdom_name: "{{ fortigate_vdom | default('root') }}"
    
  tasks:
    # åƒæ•¸é©—è­‰
    - name: "ğŸ” Validate Workflow Parameters"
      ansible.builtin.fail:
        msg: "å¾Workflowæ¥æ”¶åƒæ•¸å¤±æ•—ï¼æ­¤Job Templateåƒ…æ‡‰åœ¨Workflowä¸­åŸ·è¡Œã€‚"
      when: 
        - target_id is not defined or target_ip is not defined or reserved_mac is not defined

    # é¡¯ç¤ºåŸ·è¡Œåƒæ•¸ï¼ˆå–®è¡Œæ ¼å¼ï¼‰
    - name: "ğŸ“‹ FortiGate DHCP Delete Execute v3.4"
      ansible.builtin.debug:
        msg: "===========================================" 

    - name: "ğŸš€ Execute Parameters"
      ansible.builtin.debug:
        msg: "ğŸš€ åŸ·è¡Œæ¨¡å¼ | å·²é€šéäººå·¥ç¢ºèª | ç›®æ¨™ID: {{ target_id }} | IP: {{ target_ip }} | Server: {{ dhcp_server_id }}"

    - name: "ğŸ“Š Configuration Change"
      ansible.builtin.debug:
        msg: "ğŸ“Š è®Šæ›´ | MAC: {{ original_mac }} â†’ {{ reserved_mac }} | æè¿°: '{{ original_desc }}' â†’ 'Reserved'"

    # MACè¨ˆç®—é©—è­‰
    - name: "ğŸ§® MAC Calculation Verification"
      ansible.builtin.debug:
        msg: "ğŸ§® é©—è­‰ | IPç¬¬å››ç¢¼: {{ ip_fourth_octet }} | åˆ†è§£: {{ first_digit }}+{{ last_two_digits }} | MAC: {{ reserved_mac }}"

    - name: "âœ… MAC Calculation Status"
      ansible.builtin.debug:
        msg: "{{ 'âœ… MACè¨ˆç®—æ­£ç¢º' if reserved_mac == 'ff:ff:ff:ff:f' + first_digit + ':' + last_two_digits else 'âŒ MACè¨ˆç®—éŒ¯èª¤' }}"

    # åŸ·è¡Œå‰æœ€çµ‚ç¢ºèª
    - name: "âš ï¸ Final Confirmation"
      ansible.builtin.debug:
        msg: "âš ï¸ å³å°‡åŸ·è¡ŒFortiGate APIå‘¼å« | é…ç½®ID: {{ target_id }} | æ­¤æ“ä½œå°‡æ°¸ä¹…ä¿®æ”¹é…ç½®"

    # åŸ·è¡ŒAPIå‘¼å«
    - name: "ğŸ”§ Execute MAC Delete Operation"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address/{{ target_id }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          ip: "{{ target_ip }}"
          mac: "{{ reserved_mac }}"
          description: "Reserved"
        body_format: json
        validate_certs: false
        status_code: 200
      register: delete_result

    # æˆåŠŸçµæœé¡¯ç¤º
    - name: "ğŸ‰ Operation Success Status"
      ansible.builtin.debug:
        msg: "âœ… MACåˆªé™¤æ“ä½œæˆåŠŸ | HTTPç‹€æ…‹: {{ delete_result.status }} | é…ç½®å·²è®Šæ›´: {{ delete_result.json.revision_changed | default(false) }}"
      when: 
        - delete_result is defined
        - delete_result.status == 200

    - name: "ğŸ‰ Configuration Changes"
      ansible.builtin.debug:
        msg: "ğŸ‰ è®Šæ›´å®Œæˆ | ID: {{ target_id }} | IP: {{ target_ip }} | MAC: {{ original_mac }}â†’{{ reserved_mac }} | æè¿°: Reserved"
      when: 
        - delete_result is defined
        - delete_result.status == 200

    # å¤±æ•—çµæœé¡¯ç¤º
    - name: "âŒ Operation Failed"
      ansible.builtin.debug:
        msg: "âŒ MACåˆªé™¤æ“ä½œå¤±æ•— | HTTPç‹€æ…‹: {{ delete_result.status | default('æœªçŸ¥') }} | éŒ¯èª¤: {{ delete_result.msg | default('æœªçŸ¥') }}"
      when: 
        - delete_result is defined 
        - delete_result.status != 200

    # æœ€çµ‚æ‘˜è¦
    - name: "ğŸ“Š Workflow Summary"
      ansible.builtin.debug:
        msg: "=========================================="

    - name: "ğŸ“Š Final Result"
      ansible.builtin.debug:
        msg: "ğŸ“Š æœ€çµ‚çµæœ | MACåˆªé™¤: {{ 'âœ…æˆåŠŸ' if (delete_result.status == 200) else 'âŒå¤±æ•—' }} | {{ delete_mac }}â†’{{ reserved_mac }} | IP: {{ target_ip }}"

    - name: "ğŸ“Š Rule Applied"
      ansible.builtin.debug:
        msg: "ğŸ“Š å¥—ç”¨è¦å‰‡ | IPç¬¬å››ç¢¼{{ ip_fourth_octet }} â†’ MAC f{{ first_digit }}:{{ last_two_digits }} | æè¿°è¨­ç‚ºReserved"

    - name: "ğŸ“… Completion Time"
      ansible.builtin.debug:
        msg: "ğŸ“… å®Œæˆæ™‚é–“: {{ ansible_date_time.iso8601 | default('æœªçŸ¥') }}"
