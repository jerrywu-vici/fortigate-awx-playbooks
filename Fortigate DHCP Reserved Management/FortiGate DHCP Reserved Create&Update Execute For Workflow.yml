---
# =============================================================================
# FortiGate DHCP Reserved Address Create&Update + Firewall Address Management Execute v2.2
# ç”¨é€”ï¼šåŸ·è¡Œä¸‰éšæ®µæ“ä½œï¼šDHCP + Address Object + Address Group
# åŠŸèƒ½ï¼šä¾åºåŸ·è¡Œä¸‰éšæ®µæ“ä½œï¼Œå…·å‚™å®Œæ•´çš„éŒ¯èª¤è™•ç†å’Œå›æ»¾æ©Ÿåˆ¶
# è¼¸å…¥ï¼šæ¥æ”¶Previewæ­¥é©Ÿçš„workflowè®Šæ•¸
# è¼¸å‡ºï¼šä¸‰éšæ®µåŸ·è¡Œçµæœå’Œæ“ä½œæ‘˜è¦
# ç‰ˆæœ¬ï¼šv2.2 - ä½¿ç”¨pauseæ¨¡çµ„ä¿®æ­£è¼¸å‡ºæ–·è¡Œå•é¡Œ
# =============================================================================

- name: FortiGate DHCP + Firewall Address Management Execute For Workflow v2.2
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    # æ¥æ”¶workflowè®Šæ•¸ - ç›®æ¨™é…ç½®
    target_ip: "{{ wf_target_ip }}"
    target_mac: "{{ wf_target_mac }}"
    target_description: "{{ wf_target_description }}"
    server_id: "{{ wf_server_id }}"
    
    # æ¥æ”¶workflowè®Šæ•¸ - éšæ®µ1: DHCP
    dhcp_operation_type: "{{ wf_dhcp_operation_type }}"
    dhcp_needs_operation: "{{ (wf_dhcp_needs_operation | default('false')) | bool }}"
    dhcp_existing_object: "{{ (wf_dhcp_existing_object | default('{}')) | from_json }}"
    
    # æ¥æ”¶workflowè®Šæ•¸ - éšæ®µ2: Address
    address_name: "{{ wf_address_name }}"
    address_operation_type: "{{ wf_address_operation_type }}"
    address_needs_operation: "{{ (wf_address_needs_operation | default('false')) | bool }}"
    address_existing_object: "{{ (wf_address_existing_object | default('{}')) | from_json }}"
    address_exists: "{{ (wf_address_exists | default('false')) | bool }}"
    
    # æ¥æ”¶workflowè®Šæ•¸ - éšæ®µ3: Group
    group_name: "{{ wf_group_name }}"
    group_needs_operation: "{{ (wf_group_needs_operation | default('false')) | bool }}"
    address_in_group: "{{ (wf_address_in_group | default('false')) | bool }}"
    original_group_members: "{{ (wf_original_group_members | default('[]')) | from_json }}"
    updated_group_members: "{{ (wf_updated_group_members | default('[]')) | from_json }}"
    
    # æ¥æ”¶workflowè®Šæ•¸ - ç³»çµ±è³‡è¨Š
    server_info: "{{ (wf_server_info | default('{}')) | from_json }}"
    backup_info: "{{ (wf_backup_info | default('{}')) | from_json }}"
    three_stage_operations: "{{ (wf_three_stage_operations | default('false')) | bool }}"
    preview_version: "{{ wf_preview_version | default('unknown') }}"
    
    # FortiGateé€£æ¥åƒæ•¸
    fortigate_host: "{{ fortigate_host }}"
    fortigate_token: "{{ fortigate_access_token }}"
    api_retries: "{{ fortigate_api_retries | default('3') | int }}"
    api_delay: "{{ fortigate_api_delay | default('5') | int }}"
    connection_timeout: "{{ fortigate_timeout | default('30') | int }}"
    validate_certs: "{{ fortigate_validate_certs | default(false) | bool }}"
    
  tasks:
    # è¨˜éŒ„é–‹å§‹æ™‚é–“
    - name: "â° Record Execution Start Time"
      ansible.builtin.set_fact:
        execution_start_time: "{{ ansible_date_time.epoch | int }}"
        stage1_completed: false
        stage2_completed: false
        stage3_completed: false

    # ==================== åƒæ•¸é©—è­‰å€å¡Š ====================
    - name: "ğŸ” Validate Workflow Parameters"
      ansible.builtin.fail:
        msg: |
          âŒ å¾Workflowæ¥æ”¶åƒæ•¸å¤±æ•—ï¼ç¼ºå°‘é—œéµåƒæ•¸
          
          æ­¤Job Templateåƒ…æ‡‰åœ¨Workflowä¸­åŸ·è¡Œ
          è«‹ç¢ºèªPreviewæ­¥é©Ÿå·²æ­£ç¢ºå®Œæˆ
      when: 
        - target_ip is not defined or 
          target_mac is not defined or
          address_name is not defined or
          group_name is not defined or
          preview_version is not defined

    - name: "ğŸ” Validate FortiGate Credentials"
      ansible.builtin.fail:
        msg: |
          âŒ ç¼ºå°‘FortiGate Credentialåƒæ•¸ï¼
          
          è«‹ç¢ºèªJob Templateå·²æ­£ç¢ºè¨­å®šCredential
          æª¢æŸ¥é …ç›®:
          - FortiGate Host
          - API Access Token
      when: 
        - fortigate_host is not defined or 
          fortigate_access_token is not defined

    - name: "ğŸ” Validate Three-Stage Operations Flag"
      ansible.builtin.fail:
        msg: |
          âŒ éä¸‰éšæ®µæ“ä½œæ¨¡å¼
          
          æ­¤Execute Playbookå°ˆç‚ºä¸‰éšæ®µæ“ä½œè¨­è¨ˆ
          è«‹ç¢ºèªä½¿ç”¨æ­£ç¢ºçš„Preview Playbook v2.2
      when: not three_stage_operations

    - name: "ğŸ” Version Compatibility Check"
      ansible.builtin.debug:
        msg: "ğŸ” ç‰ˆæœ¬æª¢æŸ¥ | Previewç‰ˆæœ¬: {{ preview_version }} | Executeç‰ˆæœ¬: v2.2 | ç›¸å®¹æ€§: {{ 'âœ…' if preview_version in ['v2.2'] else 'âš ï¸' }}"

    # ==================== API é€£æ¥é©—è­‰ ====================
    - name: "ğŸ”Œ Test FortiGate API Connection"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system/global"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: api_connection_test
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"

    - name: "âœ… API Connection Established"
      ansible.builtin.debug:
        msg: "âœ… APIé€£ç·šæˆåŠŸ | FortiGateç‰ˆæœ¬: {{ fortigate_version }}"
      vars:
        fortigate_version: "{{ api_connection_test.json.results.version | default(api_connection_test.json.version | default('æœªçŸ¥')) }}"

    # ==================== åŸ·è¡Œè³‡è¨Šé¡¯ç¤º ====================
    - name: "ğŸ“‹ Three-Stage Execution Information Header"
      ansible.builtin.debug:
        msg: "==================== FortiGate DHCP Reserved Create&Update Execute v2.2 ===================="

    - name: "ğŸš€ Execute Parameters Summary"
      ansible.builtin.debug:
        msg: |
          ğŸš€ ä¸‰éšæ®µæ•´åˆåŸ·è¡Œæ¨¡å¼ v2.2 | å·²é€šéäººå·¥ç¢ºèª
          
          åŸºæœ¬åƒæ•¸:
          - IP: {{ target_ip }}
          - MAC: {{ target_mac }}
          - æè¿°: {{ target_description }}
          - DHCP Server: {{ server_id }}
          
          ä¸‰éšæ®µæ“ä½œç‹€æ…‹:
          - éšæ®µ1 (DHCP): {{ 'å•Ÿç”¨' if dhcp_needs_operation else 'è·³é' }} ({{ dhcp_operation_type }})
          - éšæ®µ2 (Address): {{ 'å•Ÿç”¨' if address_needs_operation else 'è·³é' }} ({{ address_operation_type }})
          - éšæ®µ3 (Group): {{ 'å•Ÿç”¨' if group_needs_operation else 'è·³é' }} (ADD_MEMBER)

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1

    - name: "ğŸ“Š Operations Overview"
      ansible.builtin.debug:
        msg: |
          ğŸ“Š æ“ä½œæ¦‚è¦½ v2.2
          
          DHCP Server: {{ server_info.dhcp_description | default('N/A') }}
          Address Object: {{ address_name }}
          Address Group: {{ group_name }}
          åŸ·è¡Œç­–ç•¥: é †åºåŸ·è¡Œï¼Œå¤±æ•—å³å›æ»¾

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1

    # ==================== ç„¡éœ€æ“ä½œè™•ç† ====================
    - name: "â„¹ï¸ No Operations Required"
      ansible.builtin.debug:
        msg: |
          â„¹ï¸ æ‰€æœ‰éšæ®µéƒ½ç„¡éœ€åŸ·è¡Œæ“ä½œ v2.2
          
          ç•¶å‰é…ç½®å·²ç¬¦åˆç›®æ¨™ç‹€æ…‹:
          - DHCP Reserved Address: å·²æ­£ç¢ºé…ç½®
          - Firewall Address Object: å·²æ­£ç¢ºé…ç½®
          - Address Group Member: å·²åŒ…å«ç›®æ¨™Address
      when: 
        - not dhcp_needs_operation
        - not address_needs_operation
        - not group_needs_operation

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1
      when: 
        - not dhcp_needs_operation
        - not address_needs_operation
        - not group_needs_operation

    # ==================== éšæ®µ1: DHCP æ“ä½œåŸ·è¡Œå€å¡Š ====================
    - name: "ğŸ“Š Stage 1: DHCP Operation Section Header"
      ansible.builtin.debug:
        msg: "==================== éšæ®µ1: DHCP Reserved Address æ“ä½œ ===================="
      when: dhcp_needs_operation

    - name: "ğŸ” Stage 1: Pre-execution Verification"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ server_id }}/reserved-address{{ '/' + (dhcp_existing_object.id | string) if dhcp_operation_type == 'UPDATE' else '' }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: [200, 404]
        timeout: "{{ connection_timeout }}"
      register: dhcp_pre_verification
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: dhcp_needs_operation

    - name: "ğŸ”§ Stage 1: Execute DHCP CREATE Operation"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ server_id }}/reserved-address"
        method: POST
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          ip: "{{ target_ip }}"
          mac: "{{ target_mac }}"
          description: "{{ target_description }}"
        body_format: json
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: dhcp_create_result
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: 
        - dhcp_needs_operation
        - dhcp_operation_type == "CREATE"

    - name: "ğŸ”§ Stage 1: Execute DHCP UPDATE Operation"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ server_id }}/reserved-address/{{ dhcp_existing_object.id | string }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          ip: "{{ target_ip }}"
          mac: "{{ target_mac }}"
          description: "{{ target_description }}"
        body_format: json
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: dhcp_update_result
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: 
        - dhcp_needs_operation
        - dhcp_operation_type == "UPDATE"

    - name: "ğŸ‰ Stage 1: DHCP Operation Success"
      ansible.builtin.set_fact:
        stage1_completed: true
        dhcp_created_id: "{{ dhcp_create_result.json.mkey if dhcp_operation_type == 'CREATE' else dhcp_existing_object.id }}"
      when: 
        - dhcp_needs_operation
        - (dhcp_create_result.status == 200 if dhcp_operation_type == 'CREATE' else dhcp_update_result.status == 200)

    - name: "âœ… Stage 1: DHCP Operation Success Message"
      ansible.builtin.debug:
        msg: |
          âœ… éšæ®µ1: DHCP {{ dhcp_operation_type }}æ“ä½œæˆåŠŸ
          
          é…ç½®è©³æƒ…:
          {% if dhcp_operation_type == 'UPDATE' %}
          - é…ç½®ID: {{ dhcp_existing_object.id | string }}
          {% else %}
          - é…ç½®ID: {{ dhcp_created_id | string }}
          {% endif %}
          - IPåœ°å€: {{ target_ip }}
          - MACåœ°å€: {{ target_mac }}
          - æè¿°: {{ target_description }}
          - DHCP Server: {{ server_id }}
      when: stage1_completed

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1
      when: stage1_completed

    - name: "âŒ Stage 1: DHCP Operation Failed"
      ansible.builtin.fail:
        msg: |
          âŒ éšæ®µ1: DHCP {{ dhcp_operation_type }}æ“ä½œå¤±æ•—
          
          éŒ¯èª¤è©³æƒ…:
          - HTTPç‹€æ…‹: {{ (dhcp_create_result.status if dhcp_operation_type == 'CREATE' else dhcp_update_result.status) | default('æœªçŸ¥') }}
          - éŒ¯èª¤è¨Šæ¯: {{ ((dhcp_create_result.json.cli_error if dhcp_operation_type == 'CREATE' else dhcp_update_result.json.cli_error) | default([dhcp_create_result.msg if dhcp_operation_type == 'CREATE' else dhcp_update_result.msg | default('æœªçŸ¥')])) | join(', ') }}
          
          ä¸‰éšæ®µæ“ä½œå·²çµ‚æ­¢ï¼Œç„¡éœ€å›æ»¾
      when: 
        - dhcp_needs_operation
        - (dhcp_create_result.status != 200 if dhcp_operation_type == 'CREATE' else dhcp_update_result.status != 200)

    # ==================== éšæ®µ2: Address Object æ“ä½œåŸ·è¡Œå€å¡Š ====================
    - name: "ğŸ”¥ Stage 2: Address Object Operation Section Header"
      ansible.builtin.debug:
        msg: "==================== éšæ®µ2: Firewall Address Object æ“ä½œ ===================="
      when: address_needs_operation

    - name: "ğŸ”§ Stage 2: Execute Address CREATE Operation"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/firewall/address"
        method: POST
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          name: "{{ address_name }}"
          type: "mac"
          comment: "{{ target_ip }}"
          macaddr:
            - macaddr: "{{ target_mac }}"
        body_format: json
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: address_create_result
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: 
        - address_needs_operation
        - address_operation_type == "CREATE"

    - name: "ğŸ”§ Stage 2: Execute Address UPDATE Operation"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/firewall/address/{{ address_name }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          name: "{{ address_name }}"
          type: "mac"
          comment: "{{ target_ip }}"
          macaddr:
            - macaddr: "{{ target_mac }}"
        body_format: json
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: address_update_result
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: 
        - address_needs_operation
        - address_operation_type == "UPDATE"

    - name: "ğŸ‰ Stage 2: Address Operation Success"
      ansible.builtin.set_fact:
        stage2_completed: true
      when: 
        - address_needs_operation
        - (address_create_result.status == 200 if address_operation_type == 'CREATE' else address_update_result.status == 200)

    - name: "âœ… Stage 2: Address Operation Success Message"
      ansible.builtin.debug:
        msg: |
          âœ… éšæ®µ2: Address Object {{ address_operation_type }}æ“ä½œæˆåŠŸ
          
          é…ç½®è©³æƒ…:
          - Name: {{ address_name }}
          - Type: mac
          - Comment: {{ target_ip }}
          - MAC Address: {{ target_mac }}
      when: stage2_completed

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1
      when: stage2_completed

    - name: "âŒ Stage 2: Address Operation Failed - Initiating Rollback"
      block:
        - name: "ğŸ”„ Rollback Stage 1: Restore DHCP Configuration"
          ansible.builtin.uri:
            url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ server_id }}/reserved-address/{{ dhcp_rollback_id }}"
            method: "{{ dhcp_rollback_method }}"
            headers:
              Authorization: "Bearer {{ fortigate_token }}"
            body: "{{ dhcp_rollback_body }}"
            body_format: json
            validate_certs: "{{ validate_certs }}"
            status_code: [200, 404]
            timeout: "{{ connection_timeout }}"
          register: dhcp_rollback_result
          vars:
            dhcp_rollback_id: "{{ dhcp_created_id if dhcp_operation_type == 'CREATE' else dhcp_existing_object.id }}"
            dhcp_rollback_method: "{{ 'DELETE' if dhcp_operation_type == 'CREATE' else 'PUT' }}"
            dhcp_rollback_body: "{{ {} if dhcp_operation_type == 'CREATE' else dhcp_existing_object }}"
          when: stage1_completed
          ignore_errors: true

        - name: "âŒ Stage 2 Failed with Rollback Status"
          ansible.builtin.fail:
            msg: |
              âŒ éšæ®µ2: Address Object {{ address_operation_type }}æ“ä½œå¤±æ•—
              
              éŒ¯èª¤è©³æƒ…:
              - HTTPç‹€æ…‹: {{ (address_create_result.status if address_operation_type == 'CREATE' else address_update_result.status) | default('æœªçŸ¥') }}
              - éŒ¯èª¤è¨Šæ¯: {{ ((address_create_result.json.cli_error if address_operation_type == 'CREATE' else address_update_result.json.cli_error) | default(['æœªçŸ¥'])) | join(', ') }}
              
              å›æ»¾ç‹€æ…‹:
              {% if stage1_completed %}
              - éšæ®µ1 DHCPé…ç½®å›æ»¾: {{ 'âœ…æˆåŠŸ' if dhcp_rollback_result.status in [200, 404] else 'âŒå¤±æ•—' }}
              {% endif %}
      when: 
        - address_needs_operation
        - (address_create_result.status != 200 if address_operation_type == 'CREATE' else address_update_result.status != 200)

    # ==================== éšæ®µ3: Address Group æ“ä½œåŸ·è¡Œå€å¡Š ====================
    - name: "ğŸ‘¥ Stage 3: Address Group Operation Section Header"
      ansible.builtin.debug:
        msg: "==================== éšæ®µ3: Address Group Member æ“ä½œ ===================="
      when: group_needs_operation

    - name: "ğŸ”§ Stage 3: Execute Group Member ADD Operation"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/firewall/addrgrp/{{ group_name }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          member: "{{ updated_group_members }}"
        body_format: json
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: group_add_result
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: group_needs_operation

    - name: "ğŸ‰ Stage 3: Group Operation Success"
      ansible.builtin.set_fact:
        stage3_completed: true
      when: 
        - group_needs_operation
        - group_add_result.status == 200

    - name: "âœ… Stage 3: Group Operation Success Message"
      ansible.builtin.debug:
        msg: |
          âœ… éšæ®µ3: Address Group Member åŠ å…¥æ“ä½œæˆåŠŸ
          
          é…ç½®è©³æƒ…:
          - Group Name: {{ group_name }}
          - æ–°å¢Member: {{ address_name }}
          - åŸMembersæ•¸: {{ original_group_members | length }}
          - æ–°Membersæ•¸: {{ updated_group_members | length }}
      when: stage3_completed

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1
      when: stage3_completed

    - name: "âŒ Stage 3: Group Operation Failed - Initiating Full Rollback"
      block:
        - name: "ğŸ”„ Rollback Stage 2: Delete Address Object"
          ansible.builtin.uri:
            url: "https://{{ fortigate_host }}/api/v2/cmdb/firewall/address/{{ address_name }}"
            method: DELETE
            headers:
              Authorization: "Bearer {{ fortigate_token }}"
            validate_certs: "{{ validate_certs }}"
            status_code: [200, 404]
            timeout: "{{ connection_timeout }}"
          register: address_rollback_result
          when: stage2_completed and address_operation_type == "CREATE"
          ignore_errors: true

        - name: "ğŸ”„ Rollback Stage 2: Restore Address Object"
          ansible.builtin.uri:
            url: "https://{{ fortigate_host }}/api/v2/cmdb/firewall/address/{{ address_name }}"
            method: PUT
            headers:
              Authorization: "Bearer {{ fortigate_token }}"
            body: "{{ address_existing_object }}"
            body_format: json
            validate_certs: "{{ validate_certs }}"
            status_code: [200, 404]
            timeout: "{{ connection_timeout }}"
          register: address_rollback_result
          when: stage2_completed and address_operation_type == "UPDATE"
          ignore_errors: true

        - name: "ğŸ”„ Rollback Stage 1: Restore DHCP Configuration"
          ansible.builtin.uri:
            url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ server_id }}/reserved-address/{{ dhcp_rollback_id }}"
            method: "{{ dhcp_rollback_method }}"
            headers:
              Authorization: "Bearer {{ fortigate_token }}"
            body: "{{ dhcp_rollback_body }}"
            body_format: json
            validate_certs: "{{ validate_certs }}"
            status_code: [200, 404]
            timeout: "{{ connection_timeout }}"
          register: dhcp_rollback_result
          vars:
            dhcp_rollback_id: "{{ dhcp_created_id if dhcp_operation_type == 'CREATE' else dhcp_existing_object.id }}"
            dhcp_rollback_method: "{{ 'DELETE' if dhcp_operation_type == 'CREATE' else 'PUT' }}"
            dhcp_rollback_body: "{{ {} if dhcp_operation_type == 'CREATE' else dhcp_existing_object }}"
          when: stage1_completed
          ignore_errors: true

        - name: "âŒ Stage 3 Failed with Full Rollback Status"
          ansible.builtin.fail:
            msg: |
              âŒ éšæ®µ3: Address Group Member åŠ å…¥æ“ä½œå¤±æ•—
              
              éŒ¯èª¤è©³æƒ…:
              - HTTPç‹€æ…‹: {{ group_add_result.status | default('æœªçŸ¥') }}
              - éŒ¯èª¤è¨Šæ¯: {{ group_add_result.json.cli_error | default(['æœªçŸ¥']) | join(', ') }}
              
              å®Œæ•´å›æ»¾ç‹€æ…‹:
              {% if stage2_completed %}
              - éšæ®µ2 Address Objectå›æ»¾: {{ 'âœ…æˆåŠŸ' if address_rollback_result.status in [200, 404] else 'âŒå¤±æ•—' }}
              {% endif %}
              {% if stage1_completed %}
              - éšæ®µ1 DHCPé…ç½®å›æ»¾: {{ 'âœ…æˆåŠŸ' if dhcp_rollback_result.status in [200, 404] else 'âŒå¤±æ•—' }}
              {% endif %}
      when: 
        - group_needs_operation
        - group_add_result.status != 200

    # ==================== æ“ä½œå¾Œé©—è­‰å€å¡Š ====================
    - name: "ğŸ” Post-execution Verification Section Header"
      ansible.builtin.debug:
        msg: "==================== ä¸‰éšæ®µæ“ä½œå¾Œé©—è­‰ ===================="
      when: stage1_completed or stage2_completed or stage3_completed

    - name: "ğŸ” Verify Stage 1: DHCP Configuration"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ server_id }}/reserved-address?filter=ip=={{ target_ip }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: dhcp_verification
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: stage1_completed

    - name: "ğŸ” Verify Stage 2: Address Object"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/firewall/address/{{ address_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: [200, 404]
        timeout: "{{ connection_timeout }}"
      register: address_verification
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: stage2_completed

    - name: "ğŸ” Verify Stage 3: Address Group"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/firewall/addrgrp/{{ group_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: group_verification
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: stage3_completed

    - name: "âœ… Three-Stage Verification Results"
      ansible.builtin.debug:
        msg: |
          âœ… ä¸‰éšæ®µæ“ä½œé©—è­‰çµæœ v2.2
          
          {% if stage1_completed and dhcp_verification is defined %}
          éšæ®µ1 (DHCP): âœ…é©—è­‰é€šé | æ‰¾åˆ°é…ç½®: {{ dhcp_verification.json.results | length }} ç­†
          {% endif %}
          {% if stage2_completed and address_verification is defined %}
          éšæ®µ2 (Address): {{ 'âœ…é©—è­‰é€šé' if address_verification.status == 200 else 'âš ï¸æœªæ‰¾åˆ°é…ç½®' }}
          {% endif %}
          {% if stage3_completed and group_verification is defined %}
          éšæ®µ3 (Group): âœ…é©—è­‰é€šé | Membersæ•¸: {{ (group_verification.json.results | first).member | length }} | Addresså·²åŠ å…¥: {{ address_name in (group_verification.json.results | first).member | map(attribute='name') | list }}
          {% endif %}

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1

    # ==================== è¨ˆç®—åŸ·è¡Œæ™‚é–“ ====================
    - name: "â±ï¸ Calculate Execution Statistics"
      ansible.builtin.set_fact:
        execution_time_used: "{{ (ansible_date_time.epoch | int) - (execution_start_time | int) }}"

    - name: "â±ï¸ Execution Time Summary"
      ansible.builtin.debug:
        msg: "â±ï¸ åŸ·è¡Œç”¨æ™‚: {{ execution_time_used }}s | ç‰ˆæœ¬: v2.2"

    # ==================== æœ€çµ‚æ‘˜è¦å€å¡Š ====================
    - name: "ğŸ“Š Final Summary Section Header"
      ansible.builtin.debug:
        msg: "==================== ä¸‰éšæ®µæ“ä½œæœ€çµ‚æ‘˜è¦ ===================="

    - name: "ğŸ“Š Three-Stage Operation Results Summary"
      ansible.builtin.debug:
        msg: |
          ğŸ“Š ä¸‰éšæ®µæ•´åˆæ“ä½œçµæœæ‘˜è¦ v2.2
          
          ç›®æ¨™é…ç½®:
          - IPåœ°å€: {{ target_ip }}
          - MACåœ°å€: {{ target_mac }}
          - æè¿°: {{ target_description }}
          - Addressåç¨±: {{ address_name }}
          - Groupåç¨±: {{ group_name }}
          
          åŸ·è¡Œçµæœ:
          - éšæ®µ1 (DHCP): {{ stage1_status }}
          - éšæ®µ2 (Address Object): {{ stage2_status }}
          - éšæ®µ3 (Address Group): {{ stage3_status }}
          
          {{ overall_status }}
      vars:
        stage1_status: >-
          {%- if not dhcp_needs_operation -%}
            â­ï¸è·³é
          {%- elif stage1_completed -%}
            âœ…{{ dhcp_operation_type }}æˆåŠŸ
          {%- else -%}
            âŒå¤±æ•—
          {%- endif -%}
        stage2_status: >-
          {%- if not address_needs_operation -%}
            â­ï¸è·³é
          {%- elif stage2_completed -%}
            âœ…{{ address_operation_type }}æˆåŠŸ
          {%- else -%}
            âŒå¤±æ•—
          {%- endif -%}
        stage3_status: >-
          {%- if not group_needs_operation -%}
            â­ï¸è·³é
          {%- elif stage3_completed -%}
            âœ…ADD_MEMBERæˆåŠŸ
          {%- else -%}
            âŒå¤±æ•—
          {%- endif -%}
        overall_status: >-
          {%- if stage1_completed and stage2_completed and stage3_completed -%}
            ğŸ‰ æ‰€æœ‰éšæ®µæ“ä½œæˆåŠŸå®Œæˆï¼FortiGateæ•´åˆé…ç½®å·²å°±ç·’ã€‚
          {%- elif not dhcp_needs_operation and not address_needs_operation and not group_needs_operation -%}
            â„¹ï¸ æ‰€æœ‰é…ç½®å·²æ˜¯æœ€æ–°ç‹€æ…‹ï¼Œç„¡éœ€åŸ·è¡Œä»»ä½•æ“ä½œã€‚
          {%- else -%}
            âš ï¸ éƒ¨åˆ†éšæ®µåŸ·è¡Œå¤±æ•—ï¼Œå·²åŸ·è¡Œç›¸æ‡‰çš„å›æ»¾æ“ä½œã€‚
          {%- endif -%}

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1

    - name: "ğŸ“Š Environment Configuration Details"
      ansible.builtin.debug:
        msg: |
          ğŸ“Š ç’°å¢ƒé…ç½®è©³æƒ… v2.2
          
          DHCP Server: {{ server_id }} ({{ server_info.dhcp_description | default('N/A') }})
          Address Group: {{ group_name }}
          {% if backup_info.timestamp is defined %}
          å‚™ä»½æ™‚é–“: {{ backup_info.timestamp }}
          {% endif %}
          {% if backup_info.ip_range is defined %}
          è‡ªå®šç¾©IPç¯„åœ: {{ backup_info.ip_range.start }} - {{ backup_info.ip_range.end }}
          ç¶²æ®µå‰ç¶´: {{ backup_info.ip_range.network_prefix }}
          APIåŸå§‹ç¯„åœ: {{ backup_info.ip_range.api_original_start }} - {{ backup_info.ip_range.api_original_end }}
          {% endif %}
          åŸ·è¡Œæ¨¡å¼: ä¸‰éšæ®µæ•´åˆè‡ªå‹•åŒ–
          ç‰ˆæœ¬: v2.2

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1

    - name: "ğŸ“… Completion Information"
      ansible.builtin.debug:
        msg: "ğŸ“… å®Œæˆæ™‚é–“: {{ ansible_date_time.iso8601 }} | ä¸‰éšæ®µæ•´åˆæ“ä½œ | ç‰ˆæœ¬: v2.2"
