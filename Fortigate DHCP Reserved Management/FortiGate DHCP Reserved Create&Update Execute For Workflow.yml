---
# =============================================================================
# FortiGate DHCP Reserved Address Create&Update + Firewall Address Management Execute v2.2
# ç”¨é€”ï¼šåŸ·è¡Œä¸‰éšæ®µæ“ä½œï¼šDHCP + Address Object + Address Group
# åŠŸèƒ½ï¼šä¾åºåŸ·è¡Œä¸‰éšæ®µæ“ä½œï¼Œå…·å‚™å®Œæ•´çš„éŒ¯èª¤è™•ç†å’Œå›æ»¾æ©Ÿåˆ¶
# è¼¸å…¥ï¼šæ¥æ”¶Previewæ­¥é©Ÿçš„workflowè®Šæ•¸
# è¼¸å‡ºï¼šä¸‰éšæ®µåŸ·è¡Œçµæœå’Œæ“ä½œæ‘˜è¦
# ç‰ˆæœ¬ï¼šv2.2 - ä½¿ç”¨pauseæ¨¡çµ„ä¿®æ­£è¼¸å‡ºæ–·è¡Œå•é¡Œ
# =============================================================================

- name: FortiGate DHCP + Firewall Address Management Execute For Workflow v2.2
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    # æ¥æ”¶workflowè®Šæ•¸ - ç›®æ¨™é…ç½®
    target_ip: "{{ wf_target_ip }}"
    target_mac: "{{ wf_target_mac }}"
    target_description: "{{ wf_target_description }}"
    server_id: "{{ wf_server_id }}"
    
    # æ¥æ”¶workflowè®Šæ•¸ - éšæ®µ1: DHCP
    dhcp_operation_type: "{{ wf_dhcp_operation_type }}"
    dhcp_needs_operation: "{{ (wf_dhcp_needs_operation | default('false')) | bool }}"
    dhcp_existing_object: "{{ (wf_dhcp_existing_object | default('{}')) | from_json }}"
    
    # æ¥æ”¶workflowè®Šæ•¸ - éšæ®µ2: Address
    address_name: "{{ wf_address_name }}"
    address_operation_type: "{{ wf_address_operation_type }}"
    address_needs_operation: "{{ (wf_address_needs_operation | default('false')) | bool }}"
    address_existing_object: "{{ (wf_address_existing_object | default('{}')) | from_json }}"
    address_exists: "{{ (wf_address_exists | default('false')) | bool }}"
    
    # æ¥æ”¶workflowè®Šæ•¸ - éšæ®µ3: Group
    group_name: "{{ wf_group_name }}"
    group_needs_operation: "{{ (wf_group_needs_operation | default('false')) | bool }}"
    address_in_group: "{{ (wf_address_in_group | default('false')) | bool }}"
    original_group_members: "{{ (wf_original_group_members | default('[]')) | from_json }}"
    updated_group_members: "{{ (wf_updated_group_members | default('[]')) | from_json }}"
    
    # æ¥æ”¶workflowè®Šæ•¸ - ç³»çµ±è³‡è¨Š
    server_info: "{{ (wf_server_info | default('{}')) | from_json }}"
    backup_info: "{{ (wf_backup_info | default('{}')) | from_json }}"
    three_stage_operations: "{{ (wf_three_stage_operations | default('false')) | bool }}"
    preview_version: "{{ wf_preview_version | default('unknown') }}"
    
    # FortiGateé€£æ¥åƒæ•¸
    fortigate_host: "{{ fortigate_host }}"
    fortigate_token: "{{ fortigate_access_token }}"
    api_retries: "{{ fortigate_api_retries | default('3') | int }}"
    api_delay: "{{ fortigate_api_delay | default('5') | int }}"
    connection_timeout: "{{ fortigate_timeout | default('30') | int }}"
    validate_certs: "{{ fortigate_validate_certs | default(false) | bool }}"
    
  tasks:
    # è¨˜éŒ„é–‹å§‹æ™‚é–“
    - name: "â° Record Execution Start Time"
      ansible.builtin.set_fact:
        execution_start_time: "{{ ansible_date_time.epoch | int }}"
        stage1_completed: false
        stage2_completed: false
        stage3_completed: false

    # ==================== åƒæ•¸é©—è­‰å€å¡Š ====================
    - name: "ğŸ” Validate Workflow Parameters"
      ansible.builtin.fail:
        msg: |
          âŒ å¾Workflowæ¥æ”¶åƒæ•¸å¤±æ•—ï¼ç¼ºå°‘é—œéµåƒæ•¸
          
          æ­¤Job Templateåƒ…æ‡‰åœ¨Workflowä¸­åŸ·è¡Œ
          è«‹ç¢ºèªPreviewæ­¥é©Ÿå·²æ­£ç¢ºå®Œæˆ
      when: 
        - target_ip is not defined or 
          target_mac is not defined or
          address_name is not defined or
          group_name is not defined or
          preview_version is not defined

    - name: "ğŸ” Validate FortiGate Credentials"
      ansible.builtin.fail:
        msg: |
          âŒ ç¼ºå°‘FortiGate Credentialåƒæ•¸ï¼
          
          è«‹ç¢ºèªJob Templateå·²æ­£ç¢ºè¨­å®šCredential
          æª¢æŸ¥é …ç›®:
          - FortiGate Host
          - API Access Token
      when: 
        - fortigate_host is not defined or 
          fortigate_access_token is not defined

    - name: "ğŸ” Validate Three-Stage Operations Flag"
      ansible.builtin.fail:
        msg: |
          âŒ éä¸‰éšæ®µæ“ä½œæ¨¡å¼
          
          æ­¤Execute Playbookå°ˆç‚ºä¸‰éšæ®µæ“ä½œè¨­è¨ˆ
          è«‹ç¢ºèªä½¿ç”¨æ­£ç¢ºçš„Preview Playbook v2.2
      when: not three_stage_operations

    - name: "ğŸ” Version Compatibility Check"
      ansible.builtin.debug:
        msg: "ğŸ” ç‰ˆæœ¬æª¢æŸ¥ | Previewç‰ˆæœ¬: {{ preview_version }} | Executeç‰ˆæœ¬: v2.2 | ç›¸å®¹æ€§: {{ 'âœ…' if preview_version in ['v2.2'] else 'âš ï¸' }}"

    # ==================== API é€£æ¥é©—è­‰ ====================
    - name: "ğŸ”Œ Test FortiGate API Connection"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system/global"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: api_connection_test
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"

    - name: "âœ… API Connection Established"
      ansible.builtin.debug:
        msg: "âœ… APIé€£ç·šæˆåŠŸ | FortiGateç‰ˆæœ¬: {{ fortigate_version }}"
      vars:
        fortigate_version: "{{ api_connection_test.json.results.version | default(api_connection_test.json.version | default('æœªçŸ¥')) }}"

    # ==================== åŸ·è¡Œè³‡è¨Šé¡¯ç¤º ====================
    - name: "ğŸ“‹ Three-Stage Execution Information Header"
      ansible.builtin.debug:
        msg: "==================== FortiGate DHCP Reserved Create&Update Execute v2.2 ===================="

    - name: "ğŸš€ Execute Parameters Summary"
      ansible.builtin.debug:
        msg: |
          ğŸš€ ä¸‰éšæ®µæ•´åˆåŸ·è¡Œæ¨¡å¼ v2.2 | å·²é€šéäººå·¥ç¢ºèª
          
          åŸºæœ¬åƒæ•¸:
          - IP: {{ target_ip }}
          - MAC: {{ target_mac }}
          - æè¿°: {{ target_description }}
          - DHCP Server: {{ server_id }}
          
          ä¸‰éšæ®µæ“ä½œç‹€æ…‹:
          - éšæ®µ1 (DHCP): {{ 'å•Ÿç”¨' if dhcp_needs_operation else 'è·³é' }} ({{ dhcp_operation_type }})
          - éšæ®µ2 (Address): {{ 'å•Ÿç”¨' if address_needs_operation else 'è·³é' }} ({{ address_operation_type }})
          - éšæ®µ3 (Group): {{ 'å•Ÿç”¨' if group_needs_operation else 'è·³é' }} (ADD_MEMBER)

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1

    - name: "ğŸ“Š Operations Overview"
      ansible.builtin.debug:
        msg: |
          ğŸ“Š æ“ä½œæ¦‚è¦½ v2.2
          
          DHCP Server: {{ server_info.dhcp_description | default('N/A') }}
          Address Object: {{ address_name }}
          Address Group: {{ group_name }}
          åŸ·è¡Œç­–ç•¥: é †åºåŸ·è¡Œï¼Œå¤±æ•—å³å›æ»¾

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1

    - name: "â„¹ï¸ No Operations Required"
      ansible.builtin.debug:
        msg: |
          â„¹ï¸ æ‰€æœ‰éšæ®µéƒ½ç„¡éœ€åŸ·è¡Œæ“ä½œ v2.2
          
          ç•¶å‰é…ç½®å·²ç¬¦åˆç›®æ¨™ç‹€æ…‹:
          - DHCP Reserved Address: å·²æ­£ç¢ºé…ç½®
          - Firewall Address Object: å·²æ­£ç¢ºé…ç½®
          - Address Group Member: å·²åŒ…å«ç›®æ¨™Address
      when: 
        - not dhcp_needs_operation
        - not address_needs_operation
        - not group_needs_operation

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1
      when: 
        - not dhcp_needs_operation
        - not address_needs_operation
        - not group_needs_operation

    # å„éšæ®µæˆåŠŸè¨Šæ¯ä¹Ÿæ¡ç”¨ç›¸åŒæ¨¡å¼
    - name: "âœ… Stage 1: DHCP Operation Success Message"
      ansible.builtin.debug:
        msg: |
          âœ… éšæ®µ1: DHCP {{ dhcp_operation_type }}æ“ä½œæˆåŠŸ
          
          é…ç½®è©³æƒ…:
          {% if dhcp_operation_type == 'UPDATE' %}
          - é…ç½®ID: {{ dhcp_existing_object.id | string }}
          {% else %}
          - é…ç½®ID: {{ dhcp_created_id | string }}
          {% endif %}
          - IPåœ°å€: {{ target_ip }}
          - MACåœ°å€: {{ target_mac }}
          - æè¿°: {{ target_description }}
          - DHCP Server: {{ server_id }}
      when: stage1_completed

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1
      when: stage1_completed

    # æœ€çµ‚æ‘˜è¦
    - name: "ğŸ“Š Three-Stage Operation Results Summary"
      ansible.builtin.debug:
        msg: |
          ğŸ“Š ä¸‰éšæ®µæ•´åˆæ“ä½œçµæœæ‘˜è¦ v2.2
          
          ç›®æ¨™é…ç½®:
          - IPåœ°å€: {{ target_ip }}
          - MACåœ°å€: {{ target_mac }}
          - æè¿°: {{ target_description }}
          - Addressåç¨±: {{ address_name }}
          - Groupåç¨±: {{ group_name }}
          
          åŸ·è¡Œçµæœ:
          - éšæ®µ1 (DHCP): {{ stage1_status }}
          - éšæ®µ2 (Address Object): {{ stage2_status }}
          - éšæ®µ3 (Address Group): {{ stage3_status }}
          
          {{ overall_status }}
      vars:
        # ... (è®Šæ•¸å®šç¾©åŒå‰)

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1
