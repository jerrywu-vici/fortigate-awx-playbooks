---
# =============================================================================
# FortiGate DHCP Reserved Address Create&Update Execute v1.0
# ç”¨é€”ï¼šåŸ·è¡Œå¯¦éš›çš„DHCP Reserved Addresså‰µå»ºæˆ–æ›´æ–°æ“ä½œ
# åŠŸèƒ½ï¼šæ ¹æ“šPreviewçµæœåŸ·è¡ŒCREATEæˆ–UPDATEæ“ä½œ
# è¼¸å…¥ï¼šæ¥æ”¶Previewæ­¥é©Ÿçš„workflowè®Šæ•¸
# è¼¸å‡ºï¼šåŸ·è¡Œçµæœå’Œæ“ä½œæ‘˜è¦
# ç‰ˆæœ¬ï¼šv1.0 - çµ±ä¸€è¨­è¨ˆæ¶æ§‹ï¼Œå„ªåŒ–è¼¸å‡ºæ ¼å¼
# =============================================================================

- name: FortiGate DHCP Reserved Create&Update Execute For Workflow v1.0
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    # æ¥æ”¶workflowè®Šæ•¸ - ç›®æ¨™é…ç½®
    target_ip: "{{ wf_target_ip }}"
    target_mac: "{{ wf_target_mac }}"
    target_description: "{{ wf_target_description }}"
    server_id: "{{ wf_server_id }}"
    
    # æ¥æ”¶workflowè®Šæ•¸ - æ“ä½œæ§åˆ¶
    operation_type: "{{ wf_operation_type }}"
    needs_operation: "{{ (wf_needs_operation | default('false')) | bool }}"
    existing_object: "{{ (wf_existing_object | default('{}')) | from_json }}"
    
    # æ¥æ”¶workflowè®Šæ•¸ - ç³»çµ±è³‡è¨Š
    server_info: "{{ (wf_server_info | default('{}')) | from_json }}"
    backup_info: "{{ (wf_backup_info | default('{}')) | from_json }}"
    preview_version: "{{ wf_preview_version | default('unknown') }}"
    
    # FortiGateé€£æ¥åƒæ•¸
    fortigate_host: "{{ fortigate_host }}"
    fortigate_token: "{{ fortigate_access_token }}"
    api_retries: "{{ fortigate_api_retries | default('3') | int }}"
    api_delay: "{{ fortigate_api_delay | default('5') | int }}"
    connection_timeout: "{{ fortigate_timeout | default('30') | int }}"
    validate_certs: "{{ fortigate_validate_certs | default(false) | bool }}"
    
  tasks:
    # ==================== åƒæ•¸é©—è­‰å€å¡Š ====================
    - name: "ğŸ” Validate Workflow Parameters"
      ansible.builtin.fail:
        msg: |
          âŒ å¾Workflowæ¥æ”¶åƒæ•¸å¤±æ•—ï¼ç¼ºå°‘é—œéµåƒæ•¸
          
          æ­¤Job Templateåƒ…æ‡‰åœ¨Workflowä¸­åŸ·è¡Œ
          è«‹ç¢ºèªPreviewæ­¥é©Ÿå·²æ­£ç¢ºå®Œæˆ
      when: 
        - target_ip is not defined or 
          target_mac is not defined or
          operation_type is not defined or
          preview_version is not defined

    - name: "ğŸ” Validate FortiGate Credentials"
      ansible.builtin.fail:
        msg: |
          âŒ ç¼ºå°‘FortiGate Credentialåƒæ•¸ï¼
          
          è«‹ç¢ºèªJob Templateå·²æ­£ç¢ºè¨­å®šCredential
          æª¢æŸ¥é …ç›®:
          - FortiGate Host
          - API Access Token
      when: 
        - fortigate_host is not defined or 
          fortigate_access_token is not defined

    # ==================== API é€£æ¥é©—è­‰ ====================
    - name: "ğŸ”Œ Test FortiGate API Connection"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system/global"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: api_connection_test
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"

    - name: "âœ… API Connection Established"
      ansible.builtin.debug:
        msg: "âœ… APIé€£ç·šæˆåŠŸ | FortiGateç‰ˆæœ¬: {{ fortigate_version }}"
      vars:
        fortigate_version: "{{ api_connection_test.json.results.version | default(api_connection_test.json.version | default('æœªçŸ¥')) }}"

    # ==================== åŸ·è¡Œè³‡è¨Šé¡¯ç¤º ====================
    - name: "ğŸ“‹ Execution Information Header"
      ansible.builtin.debug:
        msg: "==================== FortiGate DHCP Reserved Create&Update Execute v1.0 ===================="

    - name: "ğŸš€ Execute Parameters Summary"
      ansible.builtin.debug:
        msg: "ğŸš€ Create&UpdateåŸ·è¡Œæ¨¡å¼ | å·²é€šéäººå·¥ç¢ºèª | æ“ä½œé¡å‹: {{ operation_type }} | éœ€è¦åŸ·è¡Œ: {{ needs_operation }} | IP: {{ target_ip }} | MAC: {{ target_mac }}"

    - name: "ğŸ“Š Operations Overview"
      ansible.builtin.debug:
        msg: "ğŸ“Š æ“ä½œæ¦‚è¦½ | DHCP Server: {{ server_info.dhcp_description | default('N/A') }} | æè¿°: {{ target_description }}"

    # ==================== ç„¡éœ€æ“ä½œè™•ç† ====================
    - name: "â„¹ï¸ No Operation Required"
      ansible.builtin.debug:
        msg: |
          â„¹ï¸ é…ç½®å·²æ˜¯æœ€æ–°ç‹€æ…‹ï¼Œç„¡éœ€åŸ·è¡Œä»»ä½•æ“ä½œ
          
          ç•¶å‰é…ç½®:
          - IPåœ°å€: {{ target_ip }}
          - MACåœ°å€: {{ target_mac }}
          - æè¿°: {{ target_description }}
      when: not needs_operation

    # ==================== åŸ·è¡Œå‰é©—è­‰å€å¡Š ====================
    - name: "ğŸ” Pre-execution Verification Section Header"
      ansible.builtin.debug:
        msg: "==================== åŸ·è¡Œå‰é©—è­‰ ===================="
      when: needs_operation

    - name: "ğŸ” Verify Current Configuration State"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ server_id }}/reserved-address{{ '/' + (existing_object.id | string) if operation_type == 'UPDATE' else '' }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: [200, 404]
        timeout: "{{ connection_timeout }}"
      register: pre_execution_verification
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: needs_operation

    # UPDATE æ¨¡å¼çš„ä¸€è‡´æ€§æª¢æŸ¥
    - name: "ğŸ” UPDATE Configuration Consistency Check"
      ansible.builtin.set_fact:
        config_consistent: "{{ 
          (pre_execution_verification.json.results | first).ip == existing_object.ip and 
          (pre_execution_verification.json.results | first).mac.lower() == existing_object.mac.lower() 
        }}"
      when: 
        - needs_operation
        - operation_type == "UPDATE"
        - pre_execution_verification.status == 200

    - name: "âŒ Configuration Changed During Review"
      ansible.builtin.fail:
        msg: |
          âŒ é…ç½®åœ¨å¯©æ ¸æœŸé–“å·²è¢«ä¿®æ”¹
          
          æª¢æ¸¬åˆ°é…ç½®ä¸ä¸€è‡´:
          - åŸå§‹IP: {{ existing_object.ip }}
          - åŸå§‹MAC: {{ existing_object.mac }}
          
          è§£æ±ºæ–¹æ¡ˆ: è«‹é‡æ–°åŸ·è¡ŒPreviewæ­¥é©Ÿç¢ºèªæœ€æ–°ç‹€æ…‹
      when: 
        - needs_operation
        - operation_type == "UPDATE"
        - pre_execution_verification.status == 200
        - not config_consistent

    # ==================== CREATE æ“ä½œåŸ·è¡Œå€å¡Š ====================
    - name: "ğŸ†• CREATE Operation Section Header"
      ansible.builtin.debug:
        msg: "==================== CREATE æ“ä½œåŸ·è¡Œ ===================="
      when: 
        - needs_operation
        - operation_type == "CREATE"

    - name: "ğŸ”§ Execute CREATE Operation"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ server_id }}/reserved-address"
        method: POST
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          ip: "{{ target_ip }}"
          mac: "{{ target_mac }}"
          description: "{{ target_description }}"
        body_format: json
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: create_result
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: 
        - needs_operation
        - operation_type == "CREATE"

    - name: "ğŸ‰ CREATE Operation Success"
      ansible.builtin.debug:
        msg: |
          âœ… CREATEæ“ä½œæˆåŠŸå®Œæˆ
          
          é…ç½®è©³æƒ…:
          - IPåœ°å€: {{ target_ip }}
          - MACåœ°å€: {{ target_mac }}
          - æè¿°: {{ target_description }}
          - DHCP Server: {{ server_id }}
      when: 
        - needs_operation
        - operation_type == "CREATE"
        - create_result.status == 200

    - name: "âŒ CREATE Operation Failed"
      ansible.builtin.fail:
        msg: |
          âŒ CREATEæ“ä½œå¤±æ•—
          
          éŒ¯èª¤è©³æƒ…:
          - HTTPç‹€æ…‹: {{ create_result.status | default('æœªçŸ¥') }}
          - éŒ¯èª¤è¨Šæ¯: {{ create_result.json.cli_error | default([create_result.msg | default('æœªçŸ¥')]) | join(', ') }}
          
          è«‹æª¢æŸ¥:
          1. IPåœ°å€æ˜¯å¦åœ¨DHCPç¯„åœå…§
          2. MACåœ°å€æ ¼å¼æ˜¯å¦æ­£ç¢º
          3. æ˜¯å¦æœ‰é‡è¤‡é…ç½®
      when: 
        - needs_operation
        - operation_type == "CREATE"
        - create_result.status != 200

    # ==================== UPDATE æ“ä½œåŸ·è¡Œå€å¡Š ====================
    - name: "ğŸ”„ UPDATE Operation Section Header"
      ansible.builtin.debug:
        msg: "==================== UPDATE æ“ä½œåŸ·è¡Œ ===================="
      when: 
        - needs_operation
        - operation_type == "UPDATE"

    - name: "ğŸ”§ Execute UPDATE Operation"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ server_id }}/reserved-address/{{ existing_object.id | string }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          ip: "{{ target_ip }}"
          mac: "{{ target_mac }}"
          description: "{{ target_description }}"
        body_format: json
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: update_result
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: 
        - needs_operation
        - operation_type == "UPDATE"

    - name: "ğŸ‰ UPDATE Operation Success"
      ansible.builtin.debug:
        msg: |
          âœ… UPDATEæ“ä½œæˆåŠŸå®Œæˆ
          
          é…ç½®è©³æƒ…:
          - é…ç½®ID: {{ existing_object.id | string }}
          - IPåœ°å€: {{ target_ip }}
          - MACåœ°å€: {{ target_mac }}
          - æè¿°: {{ target_description }}
      when: 
        - needs_operation
        - operation_type == "UPDATE"
        - update_result.status == 200

    - name: "âŒ UPDATE Operation Failed"
      ansible.builtin.fail:
        msg: |
          âŒ UPDATEæ“ä½œå¤±æ•—
          
          éŒ¯èª¤è©³æƒ…:
          - é…ç½®ID: {{ existing_object.id | string }}
          - HTTPç‹€æ…‹: {{ update_result.status | default('æœªçŸ¥') }}
          - éŒ¯èª¤è¨Šæ¯: {{ update_result.json.cli_error | default([update_result.msg | default('æœªçŸ¥')]) | join(', ') }}
          
          è«‹æª¢æŸ¥:
          1. é…ç½®æ˜¯å¦ä»ç„¶å­˜åœ¨
          2. MACåœ°å€æ ¼å¼æ˜¯å¦æ­£ç¢º
          3. æ¬Šé™æ˜¯å¦å……è¶³
      when: 
        - needs_operation
        - operation_type == "UPDATE"
        - update_result.status != 200

    # ==================== æ“ä½œå¾Œé©—è­‰å€å¡Š ====================
    - name: "ğŸ” Post-execution Verification Section Header"
      ansible.builtin.debug:
        msg: "==================== æ“ä½œå¾Œé©—è­‰ ===================="
      when: needs_operation

    - name: "ğŸ” Verify Operation Result"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ server_id }}/reserved-address?filter=ip=={{ target_ip }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: post_verification
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: 
        - needs_operation
        - (create_result.status == 200 if operation_type == 'CREATE' else update_result.status == 200)

- name: "âœ… Operation Verification Result"
      ansible.builtin.debug:
        msg: "âœ… æ“ä½œé©—è­‰é€šé | æ‰¾åˆ°é…ç½®: {{ post_verification.json.results | length }} ç­† | ç•¶å‰MAC: {{ (post_verification.json.results | first).mac }} | ç•¶å‰æè¿°: {{ (post_verification.json.results | first).description }}"
      when: 
        - needs_operation
        - post_verification is defined
        - post_verification.json.results | length > 0

    # ==================== æœ€çµ‚æ‘˜è¦å€å¡Š ====================
    - name: "ğŸ“Š Final Summary Section Header"
      ansible.builtin.debug:
        msg: "==================== æœ€çµ‚æ‘˜è¦ ===================="

    - name: "ğŸ“Š Operation Results Summary"
      ansible.builtin.debug:
        msg: |
          ğŸ“Š {{ operation_type }}æ“ä½œçµæœæ‘˜è¦
          
          åŸºæœ¬è³‡è¨Š:
          - IPåœ°å€: {{ target_ip }}
          - MACåœ°å€: {{ target_mac }}
          - åŸ·è¡Œç‹€æ…‹: {{ operation_status }}
          
          {% if needs_operation and operation_type == 'CREATE' and create_result.status == 200 %}
          âœ… æ–°é…ç½®å·²æˆåŠŸå‰µå»º
          {% elif needs_operation and operation_type == 'UPDATE' and update_result.status == 200 %}
          âœ… æ—¢æœ‰é…ç½®å·²æˆåŠŸæ›´æ–°
          {% elif not needs_operation %}
          â„¹ï¸ é…ç½®å·²æ˜¯æœ€æ–°ç‹€æ…‹ï¼Œç„¡éœ€è®Šæ›´
          {% else %}
          âŒ æ“ä½œåŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥éŒ¯èª¤è¨Šæ¯
          {% endif %}
      vars:
        operation_status: >-
          {%- if not needs_operation -%}
            â„¹ï¸ç„¡éœ€è®Šæ›´
          {%- elif operation_type == 'CREATE' and create_result.status == 200 -%}
            âœ…å‰µå»ºæˆåŠŸ
          {%- elif operation_type == 'UPDATE' and update_result.status == 200 -%}
            âœ…æ›´æ–°æˆåŠŸ
          {%- else -%}
            âŒæ“ä½œå¤±æ•—
          {%- endif -%}

    - name: "ğŸ“Š Configuration Details"
      ansible.builtin.debug:
        msg: |
          ğŸ“Š é…ç½®ç’°å¢ƒè³‡è¨Š
          
          DHCP Server: {{ server_id }} ({{ server_info.dhcp_description | default('N/A') }})
          æè¿°è³‡è¨Š: {{ target_description }}
          {% if backup_info.timestamp is defined %}
          å‚™ä»½æ™‚é–“: {{ backup_info.timestamp }}
          {% endif %}

    - name: "ğŸ“… Completion Information"
      ansible.builtin.debug:
        msg: "ğŸ“… å®Œæˆæ™‚é–“: {{ ansible_date_time.iso8601 }} | ç‰ˆæœ¬: v1.0"
