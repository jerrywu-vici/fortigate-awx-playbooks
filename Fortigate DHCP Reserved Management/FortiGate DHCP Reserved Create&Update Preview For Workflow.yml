---
# =============================================================================
# FortiGate DHCP Reserved Address Create&Update Preview v6.0
# ç”¨é€”ï¼šé è¦½DHCP Reserved Addressçš„å‰µå»ºæˆ–æ›´æ–°æ“ä½œ
# åŠŸèƒ½ï¼šæ™ºèƒ½æª¢æ¸¬è¡çªã€åˆ†æç¾æœ‰é…ç½®ã€åˆ¤æ–·æ“ä½œé¡å‹ã€é©—è­‰IPç¯„åœ
# è¼¸å‡ºï¼šé¡¯ç¤ºé…ç½®è®Šæ›´é è¦½ï¼Œè¨­å®šworkflowè®Šæ•¸
# ç‰ˆæœ¬ï¼šv6.0 - çµ±ä¸€è¨­è¨ˆæ¶æ§‹ï¼Œå„ªåŒ–ä»£ç¢¼çµæ§‹ï¼ŒåŠ å…¥IPç¯„åœé©—è­‰
# =============================================================================

- name: FortiGate DHCP Reserved Create&Update Preview For Workflow v6.0
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    # Survey åƒæ•¸
    target_ip: "{{ ip_param }}"
    target_mac: "{{ mac_param }}"
    target_description: "{{ desc_param }}"
    target_dhcp_server_id: "{{ server_id }}"
    
    # Server ID å°æ‡‰é—œä¿‚ (åƒ…ä¿ç•™ä½¿ç”¨çš„2å’Œ12)
    server_mapping:
      "2":
        dhcp_description: "vlan40_PC"
      "12":
        dhcp_description: "vlan22_FIC_WAN"
    
    # API é€£æ¥åƒæ•¸
    api_retries: "{{ fortigate_api_retries | default('3') | int }}"
    api_delay: "{{ fortigate_api_delay | default('5') | int }}"
    backup_enabled: "{{ fortigate_backup_enabled | default(true) | bool }}"
    connection_timeout: "{{ fortigate_timeout | default('30') | int }}"
    validate_certs: "{{ fortigate_validate_certs | default(false) | bool }}"
    
  tasks:
    # ==================== åƒæ•¸é©—è­‰å€å¡Š ====================
    - name: "ğŸ” Validate FortiGate Credentials"
      ansible.builtin.fail:
        msg: "ç¼ºå°‘FortiGate Credentialåƒæ•¸: {{ missing_params | join(', ') }}"
      vars:
        required_params:
          - fortigate_host
          - fortigate_access_token
        missing_params: "{{ required_params | select('undefined') | list }}"
      when: 
        - fortigate_host is not defined or 
          fortigate_access_token is not defined

    - name: "ğŸ” Validate Survey Parameters"
      ansible.builtin.fail:
        msg: "ç¼ºå°‘Surveyåƒæ•¸: {{ missing_survey_params | join(', ') }}"
      vars:
        required_survey_params:
          - ip_param
          - mac_param
          - desc_param
          - server_id
        missing_survey_params: "{{ required_survey_params | select('undefined') | list }}"
      when: 
        - ip_param is not defined or 
          mac_param is not defined or 
          desc_param is not defined or 
          server_id is not defined

    - name: "ğŸ” Validate Server ID"
      ansible.builtin.fail:
        msg: "ä¸æ”¯æ´çš„DHCP Server ID: {{ target_dhcp_server_id }}ã€‚æ”¯æ´çš„ID: {{ server_mapping.keys() | list | join(', ') }}"
      when: target_dhcp_server_id not in server_mapping

    # ==================== åˆå§‹è¨­å®šå€å¡Š ====================
    - name: "ğŸ”§ Set Server Mapping Information"
      ansible.builtin.set_fact:
        server_info: "{{ server_mapping[target_dhcp_server_id] }}"

    - name: "ğŸ” Validate IP Address Format"
      ansible.builtin.set_fact:
        ip_valid: "{{ target_ip | ansible.utils.ipaddr }}"

    - name: "âŒ IP Address Format Error"
      ansible.builtin.fail:
        msg: "IPåœ°å€æ ¼å¼éŒ¯èª¤: {{ target_ip }}ã€‚è«‹ä½¿ç”¨æ­£ç¢ºçš„IPv4æ ¼å¼ï¼Œä¾‹å¦‚ï¼š192.168.1.100"
      when: not ip_valid

    - name: "ğŸ” Validate MAC Address Format"
      ansible.builtin.set_fact:
        mac_valid: "{{ target_mac | regex_search('^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$') is not none }}"

    - name: "âŒ MAC Address Format Error"
      ansible.builtin.fail:
        msg: "MACåœ°å€æ ¼å¼éŒ¯èª¤: {{ target_mac }}ã€‚æ­£ç¢ºæ ¼å¼: xx:xx:xx:xx:xx:xx æˆ– xx-xx-xx-xx-xx-xx"
      when: not mac_valid

    - name: "ğŸ”§ Normalize MAC Address Format"
      ansible.builtin.set_fact:
        normalized_mac: "{{ target_mac | replace('-', ':') | lower }}"

    # ==================== API é€£æ¥é©—è­‰ ====================
    - name: "ğŸ”Œ Test FortiGate API Connection"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system/global"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: api_test
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"

    - name: "âœ… API Connection Established"
      ansible.builtin.debug:
        msg: "âœ… APIé€£ç·šæˆåŠŸ | FortiGateç‰ˆæœ¬: {{ fortigate_version }}"
      vars:
        fortigate_version: "{{ api_test.json.results.version | default(api_test.json.version | default('æœªçŸ¥')) }}"

    # ==================== DHCP Server é…ç½®æª¢æŸ¥ ====================
    - name: "ğŸ” Get DHCP Server Configuration"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ target_dhcp_server_id }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: dhcp_server_config
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"

    - name: "ğŸ” Validate IP Range"
      ansible.builtin.set_fact:
        server_config: "{{ dhcp_server_config.json.results | first }}"
        ip_range_start: "{{ (dhcp_server_config.json.results | first)['ip-range'][0]['start-ip'] }}"
        ip_range_end: "{{ (dhcp_server_config.json.results | first)['ip-range'][0]['end-ip'] }}"

    - name: "ğŸ” Check IP Within Range"
      ansible.builtin.set_fact:
        ip_in_range: "{{ target_ip | ansible.utils.ipaddr and target_ip | ansible.utils.ipaddr >= ip_range_start | ansible.utils.ipaddr and target_ip | ansible.utils.ipaddr <= ip_range_end | ansible.utils.ipaddr }}"

    - name: "âŒ IP Out of Range Error"
      ansible.builtin.fail:
        msg: |
          âŒ IPåœ°å€è¶…å‡ºDHCP Serverç¯„åœï¼
          è©³æƒ…ï¼š
          - ç›®æ¨™IP: {{ target_ip }}
          - DHCP Server ID: {{ target_dhcp_server_id }} ({{ server_info.dhcp_description }})
          - å…è¨±ç¯„åœ: {{ ip_range_start }} - {{ ip_range_end }}
          
          è§£æ±ºæ–¹æ¡ˆï¼š
          1. é¸æ“‡ç¯„åœå…§çš„IPåœ°å€
          2. æˆ–è€…é¸æ“‡æ­£ç¢ºçš„DHCP Server ID
      when: not ip_in_range

    # ==================== é è¦½è³‡è¨Šé¡¯ç¤º ====================
    - name: "ğŸ“‹ Preview Information Header"
      ansible.builtin.debug:
        msg: "==================== FortiGate DHCP Reserved Create&Update Preview v6.0 ===================="

    - name: "ğŸ“‹ Preview Parameters Summary"
      ansible.builtin.debug:
        msg: "ğŸ” Create&Updateé è¦½æ¨¡å¼ | ç›®æ¨™IP: {{ target_ip }} | ç›®æ¨™MAC: {{ normalized_mac }} | æè¿°: {{ target_description }} | DHCP Server: {{ target_dhcp_server_id }} ({{ server_info.dhcp_description }}) | IPç¯„åœ: {{ ip_range_start }}-{{ ip_range_end }}"

    # ==================== DHCP é…ç½®åˆ†æå€å¡Š ====================
    - name: "ğŸ“Š DHCP Configuration Analysis Section Header"
      ansible.builtin.debug:
        msg: "==================== DHCP é…ç½®åˆ†æ ===================="

    - name: "ğŸ” Get Current DHCP Reserved Addresses"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ target_dhcp_server_id }}/reserved-address"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: existing_reservations
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"

    - name: "ğŸ” DHCP Configuration Information"
      ansible.builtin.debug:
        msg: "ğŸ” åˆ†æDHCPé…ç½® | ç¸½è¨ˆ: {{ existing_reservations.json.results | length }} ç­† | ç›®æ¨™IP: {{ target_ip }} | ç›®æ¨™MAC: {{ normalized_mac }}"

    # ==================== MAC è¡çªæª¢æ¸¬å€å¡Š ====================
    - name: "ğŸ” MAC Conflict Detection"
      ansible.builtin.set_fact:
        mac_conflict_object: "{{ item }}"
      loop: "{{ existing_reservations.json.results }}"
      when:
        - mac_conflict_object is not defined
        - item.mac.lower() == normalized_mac.lower()
      no_log: true

    - name: "âŒ MAC Conflict Detected"
      ansible.builtin.fail:
        msg: |
          âŒ MACè¡çªæª¢æ¸¬å¤±æ•—ï¼
          è¡çªè©³æƒ…ï¼š
          - ç›®æ¨™MAC: {{ normalized_mac }}
          - ç›®æ¨™IP: {{ target_ip }}
          - è¡çªåŸå› : MAC {{ normalized_mac }} å·²è¢«åˆ†é…çµ¦ IP {{ mac_conflict_object.ip }}
          - æ—¢æœ‰é…ç½®: ID {{ mac_conflict_object.id }}, æè¿°: {{ mac_conflict_object.description | default('ç„¡') }}
          
          è§£æ±ºæ–¹æ¡ˆï¼š
          1. ä½¿ç”¨ä¸åŒçš„MACåœ°å€
          2. æˆ–è€…ä¿®æ”¹ç›®æ¨™IPç‚º {{ mac_conflict_object.ip }}
      when: 
        - mac_conflict_object is defined 
        - mac_conflict_object.ip != target_ip

    # ==================== IP é…ç½®åˆ†æå€å¡Š ====================
    - name: "ğŸ” Find Target IP Configuration"
      ansible.builtin.set_fact:
        target_ip_objects: "{{ existing_reservations.json.results | selectattr('ip', 'equalto', target_ip) | list }}"

    - name: "ğŸ¯ Determine Operation Type"
      ansible.builtin.set_fact:
        operation_type: >-
          {%- if target_ip_objects | length > 0 -%}
            UPDATE
          {%- else -%}
            CREATE
          {%- endif -%}
        existing_object: "{{ target_ip_objects[0] if target_ip_objects | length > 0 else {} }}"
        needs_operation: >-
          {%- if target_ip_objects | length == 0 -%}
            true
          {%- else -%}
            {{
              (target_ip_objects[0].mac.lower() != normalized_mac.lower()) or
              (target_ip_objects[0].description | default('') != target_description)
            }}
          {%- endif -%}

    # ==================== é…ç½®è®Šæ›´é è¦½å€å¡Š ====================
    - name: "ğŸ“Š Configuration Change Preview Section Header"
      ansible.builtin.debug:
        msg: "==================== é…ç½®è®Šæ›´é è¦½ ===================="

    - name: "ğŸ“Š Operation Analysis Result"
      ansible.builtin.debug:
        msg: "ğŸ“Š æ“ä½œåˆ†æ | æ“ä½œé¡å‹: {{ operation_type }} | éœ€è¦åŸ·è¡Œ: {{ 'æ˜¯' if needs_operation else 'å¦' }} | æª¢æŸ¥é…ç½®æ•¸: {{ existing_reservations.json.results | length }}"

    - name: "ğŸ“Š Current Configuration Display"
      ansible.builtin.debug:
        msg: "ğŸ“Š ç•¶å‰é…ç½® | ID: {{ existing_object.id }} | IP: {{ existing_object.ip }} | MAC: {{ existing_object.mac }} | æè¿°: {{ existing_object.description | default('ç©ºç™½') }}"
      when: existing_object | length > 0

    - name: "ğŸ”„ After Operation Configuration Preview"
      ansible.builtin.debug:
        msg: "ğŸ”„ {{ operation_type }}å¾Œé è¦½ | IP: {{ target_ip }} | MAC: {{ normalized_mac }} | æè¿°: {{ target_description }}"
      when: needs_operation

    - name: "â„¹ï¸ No Operation Required"
      ansible.builtin.debug:
        msg: "â„¹ï¸ é…ç½®æª¢æŸ¥å®Œæˆ | ç•¶å‰é…ç½®å·²ç¬¦åˆç›®æ¨™ç‹€æ…‹ï¼Œç„¡éœ€åŸ·è¡Œä»»ä½•è®Šæ›´æ“ä½œ"
      when: not needs_operation

    # ==================== é…ç½®å‚™ä»½è¨˜éŒ„ ====================
    - name: "ğŸ’¾ Record Original Configuration for Backup"
      ansible.builtin.set_fact:
        create_update_backup_info:
          timestamp: "{{ ansible_date_time.iso8601 }}"
          operation_type: "{{ operation_type }}"
          target_config:
            ip: "{{ target_ip }}"
            mac: "{{ normalized_mac }}"
            description: "{{ target_description }}"
          existing_config: "{{ existing_object | default({}) }}"
          server_info: "{{ server_info }}"
          ip_range:
            start: "{{ ip_range_start }}"
            end: "{{ ip_range_end }}"
          needs_operation: "{{ needs_operation }}"
          purpose: "è¨˜éŒ„DHCP Reserved Address {{ operation_type }}å‰çš„é…ç½®ç‹€æ…‹"
      when: backup_enabled

    # ==================== æ“ä½œè­¦å‘Š ====================
    - name: "âš ï¸ Configuration Change Warning"
      ansible.builtin.debug:
        msg: "âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°‡{{ 'å‰µå»ºæ–°çš„' if operation_type == 'CREATE' else 'ä¿®æ”¹æ—¢æœ‰çš„' }}FortiGate DHCP Reserved Addressé…ç½®ï¼è«‹åœ¨Approval Nodeä¸­ä»”ç´°ç¢ºèªå¾Œå†æ‰¹å‡†åŸ·è¡Œã€‚"
      when: needs_operation

    # ==================== Workflow è®Šæ•¸è¨­å®š ====================
    - name: "ğŸ“¤ Set Create&Update Workflow Variables"
      ansible.builtin.set_stats:
        data:
          # ç›®æ¨™é…ç½®è®Šæ•¸
          wf_target_ip: "{{ target_ip }}"
          wf_target_mac: "{{ normalized_mac }}"
          wf_target_description: "{{ target_description }}"
          wf_server_id: "{{ target_dhcp_server_id }}"
          # æ“ä½œæ§åˆ¶è®Šæ•¸
          wf_operation_type: "{{ operation_type }}"
          wf_needs_operation: "{{ needs_operation }}"
          wf_existing_object: "{{ existing_object | to_json }}"
          # ç³»çµ±è³‡è¨Šè®Šæ•¸
          wf_server_info: "{{ server_info | to_json }}"
          wf_backup_info: "{{ create_update_backup_info | default({}) | to_json }}"
          wf_preview_version: "v6.0"

    - name: "ğŸ¯ Create&Update Preview Complete"
      ansible.builtin.debug:
        msg: "ğŸ¯ Create&Updateé è¦½å®Œæˆ | æ“ä½œé¡å‹: {{ operation_type }} | éœ€è¦åŸ·è¡Œ: {{ 'æ˜¯' if needs_operation else 'å¦' }} | IP: {{ target_ip }} | MAC: {{ normalized_mac }} | ç‰ˆæœ¬: v6.0"
