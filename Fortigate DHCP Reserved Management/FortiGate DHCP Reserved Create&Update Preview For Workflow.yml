---
# =============================================================================
# FortiGate DHCP Reserved Address Create&Update + Firewall Address Management Preview v2.2
# ç”¨é€”ï¼šé è¦½DHCP Reserved Address + Firewall Address Object + Address Groupçš„ä¸‰éšæ®µæ“ä½œ
# åŠŸèƒ½ï¼šæ™ºèƒ½æª¢æ¸¬è¡çªã€åˆ†æç¾æœ‰é…ç½®ã€åˆ¤æ–·æ“ä½œé¡å‹ã€é©—è­‰IPç¯„åœã€Addressé‡è¤‡æª¢æŸ¥
# è¼¸å‡ºï¼šé¡¯ç¤ºä¸‰éšæ®µé…ç½®è®Šæ›´é è¦½ï¼Œè¨­å®šworkflowè®Šæ•¸
# ç‰ˆæœ¬ï¼šv2.2 - ä½¿ç”¨pauseæ¨¡çµ„ä¿®æ­£è¼¸å‡ºæ–·è¡Œå•é¡Œ
# =============================================================================

- name: FortiGate DHCP + Firewall Address Management Preview For Workflow v2.2
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    # Survey åƒæ•¸
    target_ip: "{{ ip_param }}"
    target_mac: "{{ mac_param }}"
    target_description: "{{ desc_param }}"
    target_dhcp_server_id: "{{ server_id }}"
    
    # Server ID å°æ‡‰é—œä¿‚ (æ–°å¢ Address Group å°æ‡‰)
    server_mapping:
      "2":
        dhcp_description: "vlan40_PC"
        address_group: "Group_40_PC-Allow-MAC"
      "12":
        dhcp_description: "vlan22_FIC_WAN"
        address_group: "Group_22_FIC_Allow-MAC"
    
    # è‡ªå®šç¾©IPç¯„åœè¦å‰‡
    custom_ip_range_mapping:
      "2":
        start_suffix: "150"
        end_suffix: "240"
      "12":
        start_suffix: "151"
        end_suffix: "190"
    
    # API é€£æ¥åƒæ•¸
    api_retries: "{{ fortigate_api_retries | default('3') | int }}"
    api_delay: "{{ fortigate_api_delay | default('5') | int }}"
    backup_enabled: "{{ fortigate_backup_enabled | default(true) | bool }}"
    connection_timeout: "{{ fortigate_timeout | default('30') | int }}"
    validate_certs: "{{ fortigate_validate_certs | default(false) | bool }}"
    
  tasks:
    # è¨˜éŒ„é–‹å§‹æ™‚é–“
    - name: "â° Record Preview Start Time"
      ansible.builtin.set_fact:
        preview_start_time: "{{ ansible_date_time.epoch | int }}"

    # ==================== åƒæ•¸é©—è­‰å€å¡Š ====================
    - name: "ğŸ” Validate FortiGate Credentials"
      ansible.builtin.fail:
        msg: |
          âŒ ç¼ºå°‘FortiGate Credentialåƒæ•¸: {{ missing_params | join(', ') }}
          
          è«‹ç¢ºèªJob Templateå·²æ­£ç¢ºè¨­å®šFortiGate Credential
      vars:
        required_params:
          - fortigate_host
          - fortigate_access_token
        missing_params: "{{ required_params | select('undefined') | list }}"
      when: 
        - fortigate_host is not defined or 
          fortigate_access_token is not defined

    - name: "ğŸ” Validate Survey Parameters"
      ansible.builtin.fail:
        msg: |
          âŒ ç¼ºå°‘Surveyåƒæ•¸: {{ missing_survey_params | join(', ') }}
          
          è«‹ç¢ºèªå·²æ­£ç¢ºå¡«å¯«æ‰€æœ‰å¿…è¦åƒæ•¸
      vars:
        required_survey_params:
          - ip_param
          - mac_param
          - desc_param
          - server_id
        missing_survey_params: "{{ required_survey_params | select('undefined') | list }}"
      when: 
        - ip_param is not defined or 
          mac_param is not defined or 
          desc_param is not defined or 
          server_id is not defined

    - name: "ğŸ” Validate Server ID"
      ansible.builtin.fail:
        msg: |
          âŒ ä¸æ”¯æ´çš„DHCP Server ID: {{ target_dhcp_server_id }}
          
          æ”¯æ´çš„ID: {{ server_mapping.keys() | list | join(', ') }}
          è«‹é¸æ“‡æ­£ç¢ºçš„Server ID
      when: target_dhcp_server_id not in server_mapping

    # ==================== åˆå§‹è¨­å®šå€å¡Š ====================
    - name: "ğŸ”§ Set Server Mapping Information"
      ansible.builtin.set_fact:
        server_info: "{{ server_mapping[target_dhcp_server_id] }}"
        target_address_group: "{{ server_mapping[target_dhcp_server_id].address_group }}"
        target_address_name: "MAC_{{ target_description }}"

    - name: "ğŸ” Validate IP Address Format"
      ansible.builtin.set_fact:
        ip_valid: "{{ target_ip | ansible.utils.ipaddr }}"

    - name: "âŒ IP Address Format Error"
      ansible.builtin.fail:
        msg: |
          âŒ IPåœ°å€æ ¼å¼éŒ¯èª¤: {{ target_ip }}
          
          è«‹ä½¿ç”¨æ­£ç¢ºçš„IPv4æ ¼å¼ï¼Œä¾‹å¦‚ï¼š192.168.1.100
      when: not ip_valid

    - name: "ğŸ” Validate MAC Address Format"
      ansible.builtin.set_fact:
        mac_valid: "{{ target_mac | regex_search('^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$') is not none }}"

    - name: "âŒ MAC Address Format Error"
      ansible.builtin.fail:
        msg: |
          âŒ MACåœ°å€æ ¼å¼éŒ¯èª¤: {{ target_mac }}
          
          æ­£ç¢ºæ ¼å¼: xx:xx:xx:xx:xx:xx æˆ– xx-xx-xx-xx-xx-xx
          ç¯„ä¾‹: 00:11:22:33:44:55
      when: not mac_valid

    - name: "ğŸ”§ Normalize MAC Address Format"
      ansible.builtin.set_fact:
        normalized_mac: "{{ target_mac | replace('-', ':') | lower }}"

    # ==================== API é€£æ¥é©—è­‰ ====================
    - name: "ğŸ”Œ Test FortiGate API Connection"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system/global"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: api_test
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"

    - name: "âœ… API Connection Established"
      ansible.builtin.debug:
        msg: "âœ… APIé€£ç·šæˆåŠŸ | FortiGateç‰ˆæœ¬: {{ fortigate_version }}"
      vars:
        fortigate_version: "{{ api_test.json.results.version | default(api_test.json.version | default('æœªçŸ¥')) }}"

    # ==================== DHCP Server é…ç½®æª¢æŸ¥ ====================
    - name: "ğŸ” Get DHCP Server Configuration"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ target_dhcp_server_id }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: dhcp_server_config
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"

    - name: "ğŸ” Extract API Network Prefix"
      ansible.builtin.set_fact:
        server_config: "{{ dhcp_server_config.json.results | first }}"
        api_ip_range_start: "{{ (dhcp_server_config.json.results | first)['ip-range'][0]['start-ip'] }}"
        api_ip_range_end: "{{ (dhcp_server_config.json.results | first)['ip-range'][0]['end-ip'] }}"
        ip_network_prefix: "{{ (dhcp_server_config.json.results | first)['ip-range'][0]['start-ip'].split('.')[0:3] | join('.') }}"

    - name: "ğŸ”§ Apply Custom IP Range Rules"
      ansible.builtin.set_fact:
        ip_range_start: "{{ ip_network_prefix }}.{{ custom_ip_range_mapping[target_dhcp_server_id].start_suffix }}"
        ip_range_end: "{{ ip_network_prefix }}.{{ custom_ip_range_mapping[target_dhcp_server_id].end_suffix }}"

    - name: "ğŸ” Check IP Within Custom Range"
      ansible.builtin.set_fact:
        ip_in_range: "{{ target_ip | ansible.utils.ipaddr and target_ip | ansible.utils.ipaddr >= ip_range_start | ansible.utils.ipaddr and target_ip | ansible.utils.ipaddr <= ip_range_end | ansible.utils.ipaddr }}"

    - name: "âŒ IP Out of Range Error"
      ansible.builtin.fail:
        msg: |
          âŒ IPåœ°å€è¶…å‡ºDHCP Serverè‡ªå®šç¾©ç¯„åœï¼
          
          è©³æƒ…ï¼š
          - ç›®æ¨™IP: {{ target_ip }}
          - DHCP Server ID: {{ target_dhcp_server_id }} ({{ server_info.dhcp_description }})
          - è‡ªå®šç¾©å…è¨±ç¯„åœ: {{ ip_range_start }} - {{ ip_range_end }}
          - ç¶²æ®µå‰ç¶´: {{ ip_network_prefix }} (å¾APIè®€å–)
          - APIåŸå§‹ç¯„åœ: {{ api_ip_range_start }} - {{ api_ip_range_end }}
          
          è§£æ±ºæ–¹æ¡ˆï¼š
          1. é¸æ“‡è‡ªå®šç¾©ç¯„åœå…§çš„IPåœ°å€
          2. æˆ–è€…é¸æ“‡æ­£ç¢ºçš„DHCP Server ID
      when: not ip_in_range

    # ==================== é è¦½è³‡è¨Šé¡¯ç¤º ====================
    - name: "ğŸ“‹ Three-Stage Preview Information Header"
      ansible.builtin.debug:
        msg: "==================== FortiGate DHCP Reserved Create&Update Preview v2.2 ===================="

    - name: "ğŸ“‹ Three-Stage Preview Parameters Summary"
      ansible.builtin.debug:
        msg: |
          ğŸ” ä¸‰éšæ®µæ•´åˆé è¦½æ¨¡å¼ v2.2
          
          è¼¸å…¥åƒæ•¸:
          - ç›®æ¨™IP: {{ target_ip }}
          - ç›®æ¨™MAC: {{ normalized_mac }}
          - æè¿°: {{ target_description }}
          - DHCP Server: {{ target_dhcp_server_id }} ({{ server_info.dhcp_description }})
          - è‡ªå®šç¾©IPç¯„åœ: {{ ip_range_start }}-{{ ip_range_end }}
          - APIåŸå§‹ç¯„åœ: {{ api_ip_range_start }}-{{ api_ip_range_end }}
          
          ä¸‰éšæ®µæ“ä½œ:
          - éšæ®µ1: DHCP Reserved Address
          - éšæ®µ2: Firewall Address Object ({{ target_address_name }})
          - éšæ®µ3: Address Group Member ({{ target_address_group }})

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1

    # ==================== ä¸‰éšæ®µé…ç½®è®Šæ›´é è¦½å€å¡Š ====================
    - name: "ğŸ“Š Stage 1: DHCP Operation Analysis"
      ansible.builtin.debug:
        msg: |
          ğŸ“Š éšæ®µ1: DHCP æ“ä½œåˆ†æ
          
          æ“ä½œé¡å‹: {{ dhcp_operation_type }}
          éœ€è¦åŸ·è¡Œ: {{ 'æ˜¯' if dhcp_needs_operation else 'å¦' }}
          æª¢æŸ¥é…ç½®æ•¸: {{ existing_reservations.json.results | length }}
          {% if dhcp_existing_object | length > 0 %}
          
          ç•¶å‰é…ç½®:
          - ID: {{ dhcp_existing_object.id }}
          - IP: {{ dhcp_existing_object.ip }}
          - MAC: {{ dhcp_existing_object.mac }}
          - æè¿°: {{ dhcp_existing_object.description | default('ç©ºç™½') }}
          {% endif %}
          {% if dhcp_needs_operation %}
          
          {{ dhcp_operation_type }}å¾Œé è¦½:
          - IP: {{ target_ip }}
          - MAC: {{ normalized_mac }}
          - æè¿°: {{ target_description }}
          {% endif %}

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1

    - name: "ğŸ“Š Stage 2: Address Object Operation Analysis"
      ansible.builtin.debug:
        msg: |
          ğŸ“Š éšæ®µ2: Address Object æ“ä½œåˆ†æ
          
          Address Name: {{ target_address_name }}
          æ“ä½œé¡å‹: {{ address_operation_type }}
          éœ€è¦åŸ·è¡Œ: {{ 'æ˜¯' if address_needs_operation else 'å¦' }}
          {% if address_exists %}
          
          ç•¶å‰é…ç½®:
          - Name: {{ address_existing_object.name }}
          - Type: {{ address_existing_object.type }}
          - Comment: {{ address_existing_object.comment }}  
          - MAC: {{ address_existing_object.macaddr[0].macaddr if address_existing_object.macaddr is defined else 'æœªçŸ¥' }}
          {% endif %}
          {% if address_needs_operation %}
          
          {{ address_operation_type }}å¾Œé è¦½:
          - Name: {{ target_address_name }}
          - Type: mac
          - Comment: {{ target_ip }}
          - MAC: {{ normalized_mac }}
          {% endif %}

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1

    - name: "ğŸ“Š Stage 3: Address Group Operation Analysis"
      ansible.builtin.debug:
        msg: |
          ğŸ“Š éšæ®µ3: Address Group æ“ä½œåˆ†æ
          
          Group Name: {{ target_address_group }}
          Addressåœ¨Groupä¸­: {{ 'æ˜¯' if address_in_group else 'å¦' }}
          éœ€è¦åŸ·è¡Œ: {{ 'æ˜¯' if group_needs_operation else 'å¦' }}
          ç•¶å‰Membersæ•¸: {{ original_group_members | length }}
          {% if group_needs_operation %}
          æ“ä½œå¾ŒMembersæ•¸: {{ updated_group_members | length }}
          {% endif %}

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1

    # ==================== æ•´åˆæ“ä½œæ‘˜è¦ ====================
    - name: "ğŸ“Š Integrated Operations Summary"
      ansible.builtin.debug:
        msg: |
          ğŸ“Š ä¸‰éšæ®µæ“ä½œç¸½è¦½ v2.2
          
          éšæ®µ1 (DHCP): {{ 'âœ…éœ€è¦åŸ·è¡Œ' if dhcp_needs_operation else 'â­ï¸è·³é' }} ({{ dhcp_operation_type }})
          éšæ®µ2 (Address): {{ 'âœ…éœ€è¦åŸ·è¡Œ' if address_needs_operation else 'â­ï¸è·³é' }} ({{ address_operation_type }})
          éšæ®µ3 (Group): {{ 'âœ…éœ€è¦åŸ·è¡Œ' if group_needs_operation else 'â­ï¸è·³é' }} (ADD_MEMBER)
          
          åŸ·è¡Œæ¢ä»¶: å‰ä¸€éšæ®µæˆåŠŸæ‰åŸ·è¡Œä¸‹ä¸€éšæ®µ
          å›æ»¾æ©Ÿåˆ¶: å¾ŒçºŒéšæ®µå¤±æ•—æœƒå›æ»¾å‰é¢æ‰€æœ‰å·²å®Œæˆçš„é…ç½®

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1

    - name: "â„¹ï¸ No Operations Required"
      ansible.builtin.debug:
        msg: |
          â„¹ï¸ æ‰€æœ‰éšæ®µæª¢æŸ¥å®Œæˆ v2.2
          
          ç›®å‰æ‰€æœ‰é…ç½®éƒ½å·²ç¬¦åˆç›®æ¨™ç‹€æ…‹ï¼Œç„¡éœ€åŸ·è¡Œä»»ä½•è®Šæ›´æ“ä½œ:
          - DHCP Reserved Address: å·²æ­£ç¢ºé…ç½®
          - Firewall Address Object: å·²æ­£ç¢ºé…ç½®  
          - Address Group Member: å·²åŒ…å«ç›®æ¨™Address
      when: 
        - not dhcp_needs_operation
        - not address_needs_operation  
        - not group_needs_operation

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1
      when: 
        - not dhcp_needs_operation
        - not address_needs_operation  
        - not group_needs_operation

    - name: "âš ï¸ Three-Stage Configuration Change Warning"
      ansible.builtin.debug:
        msg: |
          âš ï¸ ä¸‰éšæ®µæ“ä½œè­¦å‘Š v2.2
          
          æ­¤æ“ä½œå°‡ä¾åºåŸ·è¡Œä»¥ä¸‹é…ç½®è®Šæ›´ï¼š
          {% if dhcp_needs_operation %}
          1. {{ 'å‰µå»ºæ–°çš„' if dhcp_operation_type == 'CREATE' else 'ä¿®æ”¹æ—¢æœ‰çš„' }}DHCP Reserved Address
          {% endif %}
          {% if address_needs_operation %}
          2. {{ 'å‰µå»ºæ–°çš„' if address_operation_type == 'CREATE' else 'ä¿®æ”¹æ—¢æœ‰çš„' }}Firewall Address Object
          {% endif %}
          {% if group_needs_operation %}
          3. å°‡Address ObjectåŠ å…¥Address Groupæˆå“¡
          {% endif %}
          
          è«‹åœ¨Approval Nodeä¸­ä»”ç´°ç¢ºèªæ‰€æœ‰éšæ®µçš„è®Šæ›´å¾Œå†æ‰¹å‡†åŸ·è¡Œï¼
      when: dhcp_needs_operation or address_needs_operation or group_needs_operation

    - name: "â¸ï¸ Format Output Pause"
      ansible.builtin.pause:
        seconds: 1
      when: dhcp_needs_operation or address_needs_operation or group_needs_operation

    - name: "ğŸ¯ Three-Stage Preview Complete"
      ansible.builtin.debug:
        msg: |
          ğŸ¯ ä¸‰éšæ®µæ•´åˆé è¦½å®Œæˆ | ç‰ˆæœ¬: v2.2
          
          æ‘˜è¦:
          - éšæ®µ1 (DHCP): {{ dhcp_operation_type }} | {{ 'éœ€è¦åŸ·è¡Œ' if dhcp_needs_operation else 'è·³é' }}
          - éšæ®µ2 (Address): {{ address_operation_type }} | {{ 'éœ€è¦åŸ·è¡Œ' if address_needs_operation else 'è·³é' }}
          - éšæ®µ3 (Group): ADD_MEMBER | {{ 'éœ€è¦åŸ·è¡Œ' if group_needs_operation else 'è·³é' }}
          
          ç›®æ¨™: {{ target_ip }} | {{ normalized_mac }} | {{ target_description }}
          ç­‰å¾…äººå·¥ç¢ºèª...
