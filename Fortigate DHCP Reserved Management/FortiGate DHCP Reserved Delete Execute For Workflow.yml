---
# =============================================================================
# FortiGate DHCP Reserved Address Delete + Firewall Address Delete Execute v6.0
# ç”¨é€”ï¼šåŸ·è¡Œå¯¦éš›çš„MACåˆªé™¤æ“ä½œï¼ˆDHCP + Firewall Addressï¼‰
# åŠŸèƒ½ï¼š1. DHCP MACé‚„åŸç‚ºReserved 2. Firewall Addresså¾Groupç§»é™¤ä¸¦åˆªé™¤
# åŸ·è¡Œé †åºï¼šDHCPé‚„åŸ â†’ Address Groupç§»é™¤ â†’ Address Objectåˆªé™¤
# è¼¸å…¥ï¼šæ¥æ”¶Previewæ­¥é©Ÿçš„workflowè®Šæ•¸ï¼ˆåŒ…å«DHCPå’ŒFirewallè³‡è¨Šï¼‰
# è¼¸å‡ºï¼šåŸ·è¡Œçµæœå’Œæ“ä½œæ‘˜è¦
# ç‰ˆæœ¬ï¼šv6.0 - å„ªåŒ–ä»£ç¢¼çµæ§‹ï¼Œçµ±ä¸€ç‰ˆæœ¬è™Ÿ
# =============================================================================

- name: FortiGate DHCP Reserved Delete Execute For Workflow v6.0
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    # æ¥æ”¶workflowè®Šæ•¸ - DHCPç›¸é—œ
    dhcp_enabled: "{{ (wf_dhcp_enabled | default('false')) | bool }}"
    dhcp_target_id: "{{ wf_dhcp_target_id }}"
    dhcp_target_ip: "{{ wf_dhcp_target_ip }}"
    dhcp_original_mac: "{{ wf_dhcp_original_mac }}"
    dhcp_reserved_mac: "{{ wf_dhcp_reserved_mac }}"
    dhcp_original_desc: "{{ wf_dhcp_original_desc }}"
    ip_fourth_octet: "{{ wf_ip_fourth_octet }}"
    first_digit: "{{ wf_first_digit }}"
    last_two_digits: "{{ wf_last_two_digits }}"
    
    # æ¥æ”¶workflowè®Šæ•¸ - Firewallç›¸é—œ
    firewall_enabled: "{{ (wf_firewall_enabled | default('false')) | bool }}"
    firewall_address_name: "{{ wf_firewall_address_name }}"
    firewall_address_mac: "{{ wf_firewall_address_mac }}"
    firewall_address_comment: "{{ wf_firewall_address_comment }}"
    address_group_name: "{{ wf_address_group_name }}"
    address_in_group: "{{ (wf_address_in_group | default('false')) | bool }}"
    original_group_members: "{{ (wf_original_group_members | default('[]')) | from_json }}"
    updated_group_members: "{{ (wf_updated_group_members | default('[]')) | from_json }}"
    
    # æ¥æ”¶workflowè®Šæ•¸ - å…±ç”¨
    server_id: "{{ wf_server_id }}"
    delete_mac: "{{ wf_delete_mac }}"
    server_info: "{{ (wf_server_info | default('{}')) | from_json }}"
    backup_info: "{{ (wf_backup_info | default('{}')) | from_json }}"
    vdom_name: "{{ wf_vdom_name | default('root') }}"
    preview_version: "{{ wf_preview_version | default('unknown') }}"
    
    # FortiGateé€£æ¥åƒæ•¸
    fortigate_host: "{{ fortigate_host }}"
    fortigate_token: "{{ fortigate_access_token }}"
    api_retries: "{{ fortigate_api_retries | default('3') | int }}"
    api_delay: "{{ fortigate_api_delay | default('5') | int }}"
    backup_enabled: "{{ fortigate_backup_enabled | default(true) | bool }}"
    connection_timeout: "{{ fortigate_timeout | default('30') | int }}"
    validate_certs: "{{ fortigate_validate_certs | default(false) | bool }}"
    
  tasks:
    # ==================== åƒæ•¸é©—è­‰å€å¡Š ====================
    - name: "ğŸ” Validate Workflow Parameters"
      ansible.builtin.fail:
        msg: "å¾Workflowæ¥æ”¶åƒæ•¸å¤±æ•—ï¼ç¼ºå°‘é—œéµåƒæ•¸ã€‚æ­¤Job Templateåƒ…æ‡‰åœ¨Workflowä¸­åŸ·è¡Œã€‚"
      when: 
        - server_id is not defined or 
          delete_mac is not defined or
          preview_version is not defined

    - name: "ğŸ” Validate FortiGate Credentials"
      ansible.builtin.fail:
        msg: "ç¼ºå°‘FortiGate Credentialåƒæ•¸ï¼è«‹ç¢ºèªJob Templateå·²æ­£ç¢ºè¨­å®šCredentialã€‚"
      when: 
        - fortigate_host is not defined or 
          fortigate_access_token is not defined

    # ==================== API é€£æ¥é©—è­‰ ====================
    - name: "ğŸ”Œ Test FortiGate API Connection"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system/global"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: api_connection_test
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"

    - name: "âœ… API Connection Established"
      ansible.builtin.debug:
        msg: "âœ… APIé€£ç·šæˆåŠŸ | FortiGateç‰ˆæœ¬: {{ fortigate_version }}"
      vars:
        fortigate_version: "{{ api_connection_test.json.results.version | default(api_connection_test.json.version | default('æœªçŸ¥')) }}"

    # ==================== åŸ·è¡Œè³‡è¨Šé¡¯ç¤º ====================
    - name: "ğŸ“‹ Execution Information Header"
      ansible.builtin.debug:
        msg: "==================== FortiGate DHCP + Firewall Delete Execute v6.0 ===================="

    - name: "ğŸš€ Execute Parameters Summary"
      ansible.builtin.debug:
        msg: "ğŸš€ æ•´åˆåŸ·è¡Œæ¨¡å¼ | å·²é€šéäººå·¥ç¢ºèª | MAC: {{ delete_mac }} | DHCP: {{ 'ON' if dhcp_enabled else 'OFF' }} | Firewall: {{ 'ON' if firewall_enabled else 'OFF' }} | Server: {{ server_id }}"

    - name: "ğŸ“Š Operations Overview"
      ansible.builtin.debug:
        msg: "ğŸ“Š æ“ä½œæ¦‚è¦½ | DHCP Server: {{ server_info.dhcp_description | default('N/A') }} | Address Group: {{ address_group_name }} | Address Object: {{ firewall_address_name | default('N/A') }} | Addressåœ¨Groupä¸­: {{ address_in_group }}"

    # ==================== DHCP åŸ·è¡Œå€å¡Š ====================
    - name: "ğŸ“Š DHCP Execution Section Header"
      ansible.builtin.debug:
        msg: "==================== DHCP åŸ·è¡Œå€å¡Š ===================="
      when: dhcp_enabled

    - name: "ğŸ” DHCP Pre-execution Verification"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ server_id }}/reserved-address/{{ dhcp_target_id }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: dhcp_pre_execution_config
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: dhcp_enabled

    - name: "ğŸ” DHCP Configuration Consistency Check"
      ansible.builtin.set_fact:
        dhcp_config_consistent: "{{ 
          (dhcp_pre_execution_config.json.results | first).ip == dhcp_target_ip and 
          (dhcp_pre_execution_config.json.results | first).mac.lower() == dhcp_original_mac.lower() 
        }}"
      when: dhcp_enabled

    - name: "âŒ DHCP Configuration Changed"
      ansible.builtin.fail:
        msg: "DHCPæ“ä½œçµ‚æ­¢ï¼šé…ç½®åœ¨Previewå¾Œå·²è¢«ä¿®æ”¹ï¼Œè«‹é‡æ–°åŸ·è¡ŒPreviewæ­¥é©Ÿ"
      when: 
        - dhcp_enabled
        - not dhcp_config_consistent

    - name: "ğŸ”§ Execute DHCP MAC Delete Operation"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ server_id }}/reserved-address/{{ dhcp_target_id }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          ip: "{{ dhcp_target_ip }}"
          mac: "{{ dhcp_reserved_mac }}"
          description: "Reserved"
        body_format: json
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: dhcp_result
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: dhcp_enabled

    - name: "ğŸ‰ DHCP Operation Success"
      ansible.builtin.debug:
        msg: "âœ… DHCPæ“ä½œæˆåŠŸ | ID: {{ dhcp_target_id }} | IP: {{ dhcp_target_ip }} | MAC: {{ dhcp_original_mac }}â†’{{ dhcp_reserved_mac }}"
      when: 
        - dhcp_enabled
        - dhcp_result.status == 200

    - name: "âŒ DHCP Operation Failed"
      ansible.builtin.fail:
        msg: "âŒ DHCPæ“ä½œå¤±æ•—ï¼Œåœæ­¢å¾ŒçºŒFirewallæ“ä½œ | HTTPç‹€æ…‹: {{ dhcp_result.status | default('æœªçŸ¥') }} | éŒ¯èª¤: {{ dhcp_result.msg | default('æœªçŸ¥') }}"
      when: 
        - dhcp_enabled
        - dhcp_result.status != 200

    - name: "â­ï¸ DHCP Operation Skipped"
      ansible.builtin.debug:
        msg: "â­ï¸ DHCPæ“ä½œå·²è·³éï¼ˆPreviewä¸­æœªæ‰¾åˆ°ç›®æ¨™MACï¼‰"
      when: not dhcp_enabled

    # ==================== Firewall åŸ·è¡Œå€å¡Š ====================
    - name: "ğŸ”¥ Firewall Execution Section Header"
      ansible.builtin.debug:
        msg: "==================== Firewall åŸ·è¡Œå€å¡Š ===================="
      when: firewall_enabled

    - name: "ğŸ“‹ Firewall Execution Plan"
      ansible.builtin.debug:
        msg: "ğŸ“‹ åŸ·è¡Œè¨ˆåŠƒ | Step 1: {{ 'å¾Groupç§»é™¤Member' if address_in_group else 'è·³éGroupæ›´æ–°' }} | Step 2: åˆªé™¤Address Object | Address: {{ firewall_address_name }}"
      when: firewall_enabled

    # Step 1: Firewall Address Group æ›´æ–°ï¼ˆç§»é™¤memberï¼‰
    - name: "ğŸ”§ Remove Address from Address Group"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/firewall/addrgrp/{{ address_group_name }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          member: "{{ updated_group_members }}"
        body_format: json
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: group_update_result
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: 
        - firewall_enabled
        - address_in_group

    - name: "ğŸ‰ Address Group Update Success"
      ansible.builtin.debug:
        msg: "âœ… Address Groupæ›´æ–°æˆåŠŸ | Group: {{ address_group_name }} | ç§»é™¤Member: {{ firewall_address_name }} | å‰©é¤˜Members: {{ updated_group_members | length }}"
      when: 
        - firewall_enabled
        - address_in_group
        - group_update_result.status == 200

    - name: "âŒ Address Group Update Failed"
      ansible.builtin.fail:
        msg: "âŒ Address Groupæ›´æ–°å¤±æ•—ï¼Œåœæ­¢Addressåˆªé™¤ | Group: {{ address_group_name }} | HTTPç‹€æ…‹: {{ group_update_result.status | default('æœªçŸ¥') }} | éŒ¯èª¤: {{ group_update_result.json.cli_error | default([group_update_result.msg | default('æœªçŸ¥')]) | join(', ') }}"
      when: 
        - firewall_enabled
        - address_in_group
        - group_update_result.status != 200

    - name: "â„¹ï¸ Address Not in Group - Skip Group Update"
      ansible.builtin.debug:
        msg: "â„¹ï¸ Address {{ firewall_address_name }} ä¸åœ¨ Group {{ address_group_name }} ä¸­ï¼Œè·³éGroupæ›´æ–°ï¼Œç›´æ¥é€²è¡ŒAddressåˆªé™¤"
      when: 
        - firewall_enabled
        - not address_in_group

    # Step 2: åŸ·è¡Œ Firewall Address åˆªé™¤
    - name: "ğŸ”§ Execute Firewall Address Delete"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/firewall/address/{{ firewall_address_name }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: address_delete_result
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: 
        - firewall_enabled
        - (not address_in_group) or (address_in_group and group_update_result.status == 200)

    - name: "ğŸ‰ Firewall Address Delete Success"
      ansible.builtin.debug:
        msg: "âœ… Addressåˆªé™¤æˆåŠŸ | Name: {{ firewall_address_name }} | MAC: {{ firewall_address_mac }} | Comment: {{ firewall_address_comment }}"
      when: 
        - firewall_enabled
        - address_delete_result.status == 200

    - name: "âŒ Firewall Address Delete Failed"
      ansible.builtin.debug:
        msg: "âŒ Addressåˆªé™¤å¤±æ•— | Name: {{ firewall_address_name }} | HTTPç‹€æ…‹: {{ address_delete_result.status | default('æœªçŸ¥') }} | éŒ¯èª¤: {{ address_delete_result.json.cli_error | default([address_delete_result.msg | default('æœªçŸ¥')]) | join(', ') }}"
      when: 
        - firewall_enabled
        - address_delete_result.status != 200

    - name: "â­ï¸ Firewall Operation Skipped"
      ansible.builtin.debug:
        msg: "â­ï¸ Firewallæ“ä½œå·²è·³éï¼ˆPreviewä¸­æœªæ‰¾åˆ°ç›®æ¨™Address Objectï¼‰"
      when: not firewall_enabled

    # ==================== æ“ä½œå¾Œé©—è­‰å€å¡Š ====================
    - name: "ğŸ” Post-execution Verification Section Header"
      ansible.builtin.debug:
        msg: "==================== æ“ä½œå¾Œé©—è­‰ ===================="

    - name: "ğŸ” Verify DHCP Configuration"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ server_id }}/reserved-address/{{ dhcp_target_id }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: dhcp_verification
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: 
        - dhcp_enabled
        - dhcp_result is defined
        - dhcp_result.status == 200

    - name: "âœ… DHCP Verification Result"
      ansible.builtin.debug:
        msg: "âœ… DHCPé©—è­‰é€šé | ç•¶å‰MAC: {{ (dhcp_verification.json.results | first).mac }} | ç•¶å‰æè¿°: {{ (dhcp_verification.json.results | first).description }}"
      when: 
        - dhcp_enabled
        - dhcp_verification is defined
        - dhcp_verification.json is defined
        - dhcp_verification.json.results | length > 0

    - name: "ğŸ” Verify Address Deletion"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/firewall/address/{{ firewall_address_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: [200, 404]
        timeout: "{{ connection_timeout }}"
      register: address_verification
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: 
        - firewall_enabled
        - address_delete_result is defined
        - address_delete_result.status == 200

    - name: "âœ… Address Deletion Verification"
      ansible.builtin.debug:
        msg: "{{ 'âœ… Addressåˆªé™¤é©—è­‰é€šéï¼ˆ404 Not Foundï¼‰' if address_verification.status == 404 else 'âš ï¸ Addresså¯èƒ½ä»å­˜åœ¨ï¼ˆ200 OKï¼‰' }}"
      when: 
        - firewall_enabled
        - address_verification is defined

    - name: "ğŸ” Verify Address Group Update"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/firewall/addrgrp/{{ address_group_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
        timeout: "{{ connection_timeout }}"
      register: group_verification
      retries: "{{ api_retries }}"
      delay: "{{ api_delay }}"
      when: 
        - firewall_enabled
        - address_in_group
        - group_update_result is defined
        - group_update_result.status == 200

    - name: "âœ… Address Group Verification"
      ansible.builtin.debug:
        msg: "âœ… Address Groupé©—è­‰é€šé | Group: {{ address_group_name }} | ç•¶å‰Membersæ•¸: {{ (group_verification.json.results | first).member | length }} | Addresså·²ç§»é™¤: {{ firewall_address_name not in (group_verification.json.results | first).member | map(attribute='name') | list }}"
      when: 
        - firewall_enabled
        - group_verification is defined
        - group_verification.json is defined
        - group_verification.json.results is defined
        - group_verification.json.results | length > 0

    # ==================== æœ€çµ‚æ‘˜è¦å€å¡Š ====================
    - name: "ğŸ“Š Final Summary Section Header"
      ansible.builtin.debug:
        msg: "==================== æœ€çµ‚æ‘˜è¦ ===================="

    - name: "ğŸ“Š Integrated Operation Results"
      ansible.builtin.debug:
        msg: "ğŸ“Š æ•´åˆæ“ä½œçµæœ | MAC: {{ delete_mac }} | DHCP: {{ dhcp_status }} | Firewall: {{ firewall_status }}"
      vars:
        dhcp_status: "{{ 'âœ…æˆåŠŸ' if (dhcp_enabled and dhcp_result is defined and dhcp_result.status == 200) else ('â­ï¸è·³é' if not dhcp_enabled else 'âŒå¤±æ•—') }}"
        firewall_status: "{{ 'âœ…æˆåŠŸ' if (firewall_enabled and address_delete_result is defined and address_delete_result.status == 200) else ('â­ï¸è·³é' if not firewall_enabled else 'âŒå¤±æ•—') }}"

    - name: "ğŸ“Š DHCP Summary"
      ansible.builtin.debug:
        msg: "ğŸ“Š DHCPæ‘˜è¦ | Server: {{ server_id }} ({{ server_info.dhcp_description | default('N/A') }}) | {{ dhcp_original_mac }}â†’{{ dhcp_reserved_mac }} | æè¿°: Reserved"
      when: dhcp_enabled

    - name: "ğŸ“Š Firewall Summary"
      ansible.builtin.debug:
        msg: "ğŸ“Š Firewallæ‘˜è¦ | Address: {{ firewall_address_name }} | Group: {{ address_group_name }} | Groupæ›´æ–°: {{ group_status }} | Addressåˆªé™¤: {{ address_status }}"
      vars:
        group_status: "{{ 'âœ…æˆåŠŸ' if (address_in_group and group_update_result is defined and group_update_result.status == 200) else ('â­ï¸è·³é' if not address_in_group else 'âŒå¤±æ•—') }}"
        address_status: "{{ 'âœ…æˆåŠŸ' if (address_delete_result is defined and address_delete_result.status == 200) else 'âŒå¤±æ•—' }}"
      when: firewall_enabled

    - name: "ğŸ“… Completion Information"
      ansible.builtin.debug:
        msg: "ğŸ“… å®Œæˆæ™‚é–“: {{ ansible_date_time.iso8601 }} | ç‰ˆæœ¬: v6.0"
