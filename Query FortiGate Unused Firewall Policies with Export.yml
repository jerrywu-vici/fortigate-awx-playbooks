---
- name: Query FortiGate Unused Firewall Policies (READ ONLY)
  hosts: localhost
  gather_facts: false
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"
    current_timestamp: "{{ ansible_date_time.epoch | int }}"
    threshold_timestamp: "{{ (current_timestamp | int) - ((months_threshold | default('6') | int) * 30 * 24 * 3600) }}"
    unused_policies: []
    never_used_policies: []
    total_policies: 0
    active_policies: 0
    read_only_mode: true

  tasks:
    # =================== å®‰å…¨æª¢æŸ¥ ===================
    - name: å®‰å…¨æé†’ - æ­¤playbookç‚ºåªè®€æ¨¡å¼
      debug:
        msg: |
          âš ï¸  å®‰å…¨æé†’ âš ï¸
          æ­¤playbookåƒ…åŸ·è¡ŒæŸ¥è©¢å’Œå ±å‘Šç”Ÿæˆï¼Œä¸æœƒå°FortiGateé€²è¡Œä»»ä½•è®Šæ›´
          æ‰€æœ‰ç”Ÿæˆçš„CLIå‘½ä»¤éœ€è¦äººå·¥å¯©æŸ¥å¾Œæ‰‹å‹•åŸ·è¡Œ
          ==========================================

    - name: é©—è­‰åªè®€æ¨¡å¼
      assert:
        that:
          - read_only_mode | default(true) | bool
          - not (auto_cleanup | default(false) | bool)
        fail_msg: "æ­¤playbookå¿…é ˆåœ¨åªè®€æ¨¡å¼ä¸‹é‹è¡Œ"
        success_msg: "âœ… å®‰å…¨æª¢æŸ¥é€šéï¼Œåªè®€æ¨¡å¼å·²ç¢ºèª"

    # =================== è³‡æ–™æ”¶é›†éšæ®µ ===================
    - name: æŸ¥è©¢æ‰€æœ‰Firewall Policyè¨­å®š
      uri:
        url: "{{ fortigate_api_url }}/api/v2/cmdb/firewall/{{ policy_type | default('policy') }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
          format: "name|policyid|srcintf|dstintf|srcaddr|dstaddr|service|action|status|logtraffic|comments"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('60') | int }}"
        status_code: [200]
      register: policy_config_result
      retries: "{{ fortigate_api_retries | default('3') | int }}"
      delay: "{{ fortigate_api_delay | default('5') | int }}"

    - name: é¡¯ç¤ºæ‰¾åˆ°çš„Policyæ•¸é‡
      debug:
        msg: "æ‰¾åˆ° {{ policy_config_result.json.results | length }} å€‹firewall policy"

    - name: è¨­å®šç¸½policyæ•¸é‡
      set_fact:
        total_policies: "{{ policy_config_result.json.results | length }}"

    # =================== æŸ¥è©¢Policyçµ±è¨ˆè³‡è¨Š ===================
    - name: æŸ¥è©¢Policyä½¿ç”¨çµ±è¨ˆï¼ˆæ‰¹æ¬¡è™•ç†ï¼‰
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/firewall/policy/select"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
          policyid: "{{ item.policyid }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('30') | int }}"
        status_code: [200, 424]  # 424è¡¨ç¤ºpolicyä¸å­˜åœ¨æˆ–ç„¡çµ±è¨ˆè³‡æ–™
      register: policy_stats_results
      loop: "{{ policy_config_result.json.results | default([]) }}"
      failed_when: false
      retries: 2
      delay: 1
      when: policy_config_result.json.results | length > 0

    - name: é¡¯ç¤ºçµ±è¨ˆæŸ¥è©¢é€²åº¦
      debug:
        msg: "å·²æŸ¥è©¢ {{ policy_stats_results.results | length }} å€‹policyçš„ä½¿ç”¨çµ±è¨ˆ"

    # =================== è³‡æ–™è™•ç†éšæ®µ ===================
    - name: è™•ç†Policyè³‡æ–™ä¸¦è­˜åˆ¥æœªä½¿ç”¨çš„Policy
      set_fact:
        processed_policies: |
          [
          {% for config in policy_config_result.json.results %}
          {% set policy_id = config.policyid %}
          {% set stats_result = policy_stats_results.results | selectattr('item.policyid', 'equalto', policy_id) | first | default({}) %}
          {% set stats_data = stats_result.json | default({}) %}
          {% set last_used = stats_data.last_used | default(0) %}
          {% set hit_count = stats_data.hit_count | default(0) %}
          {% set bytes_count = stats_data.bytes | default(0) %}
          {% set packets_count = stats_data.packets | default(0) %}
          
          {
            "policy_id": "{{ policy_id }}",
            "name": "{{ config.name | default('Policy_' + policy_id) }}",
            "status": "{{ config.status | default('enable') }}",
            "action": "{{ config.action | default('accept') }}",
            "srcintf": {{ config.srcintf | default([]) | to_json }},
            "dstintf": {{ config.dstintf | default([]) | to_json }},
            "srcaddr": {{ config.srcaddr | default([]) | to_json }},
            "dstaddr": {{ config.dstaddr | default([]) | to_json }},
            "service": {{ config.service | default([]) | to_json }},
            "logtraffic": "{{ config.logtraffic | default('disable') }}",
            "comments": "{{ config.comments | default('') }}",
            "last_used": {{ last_used }},
            "last_used_readable": "{{ 'Never' if last_used == 0 else (last_used | int | strftime('%Y-%m-%d %H:%M:%S')) }}",
            "hit_count": {{ hit_count }},
            "bytes": {{ bytes_count }},
            "packets": {{ packets_count }},
            "days_since_last_used": {{ ((current_timestamp | int) - (last_used | int)) // 86400 if last_used | int > 0 else -1 }},
            "is_unused": {{ (last_used | int > 0 and last_used | int < threshold_timestamp | int) or (last_used | int == 0 and include_never_used | default(true)) }},
            "is_never_used": {{ last_used | int == 0 }},
            "is_enabled": {{ config.status | default('enable') == 'enable' }}
          }{% if not loop.last %},{% endif %}
          {% endfor %}
          ]

    - name: éæ¿¾å‡ºæœªä½¿ç”¨çš„Policy
      set_fact:
        unused_policies: "{{ processed_policies | selectattr('is_unused', 'equalto', true) | list }}"
        never_used_policies: "{{ processed_policies | selectattr('is_never_used', 'equalto', true) | list }}"
        active_policies: "{{ processed_policies | selectattr('is_enabled', 'equalto', true) | length }}"

    # æ‡‰ç”¨é¡å¤–éæ¿¾æ¢ä»¶
    - name: æ‡‰ç”¨é€²éšéæ¿¾æ¢ä»¶
      set_fact:
        filtered_unused_policies: |
          {% set filtered = [] %}
          {% for policy in unused_policies %}
          {% set skip_policy = false %}
          
          {# æ’é™¤æŒ‡å®šçš„policy ID #}
          {% if filter_options.exclude_policy_ids | default([]) and policy.policy_id in filter_options.exclude_policy_ids %}
          {% set skip_policy = true %}
          {% endif %}
          
          {# æœ€å°policy IDéæ¿¾ #}
          {% if filter_options.min_policy_id | default('') != '' and policy.policy_id | int < filter_options.min_policy_id | int %}
          {% set skip_policy = true %}
          {% endif %}
          
          {# æœ€å¤§policy IDéæ¿¾ #}
          {% if filter_options.max_policy_id | default('') != '' and policy.policy_id | int > filter_options.max_policy_id | int %}
          {% set skip_policy = true %}
          {% endif %}
          
          {# Policyåç¨±æ¨¡å¼éæ¿¾ #}
          {% if filter_options.policy_name_pattern | default('') != '' and not (policy.name | regex_search(filter_options.policy_name_pattern)) %}
          {% set skip_policy = true %}
          {% endif %}
          
          {# æ˜¯å¦åŒ…å«åœç”¨çš„policy #}
          {% if not include_disabled | default(false) and not policy.is_enabled %}
          {% set skip_policy = true %}
          {% endif %}
          
          {% if not skip_policy %}
          {% set _ = filtered.append(policy) %}
          {% endif %}
          {% endfor %}
          {{ filtered }}

    # =================== è¼¸å‡ºéšæ®µ ===================
    - name: é¡¯ç¤ºçµ±è¨ˆæ‘˜è¦
      debug:
        msg: |
          ========= FortiGate Unused Policy æŸ¥è©¢çµæœ =========
          VDOM: {{ vdom_name | default('root') }}
          æŸ¥è©¢é–¾å€¼: {{ months_threshold | default('6') }} å€‹æœˆ
          ç¸½Policyæ•¸é‡: {{ total_policies }}
          å•Ÿç”¨çš„Policy: {{ active_policies }}
          è¶…é{{ months_threshold }}å€‹æœˆæœªä½¿ç”¨: {{ (filtered_unused_policies | rejectattr('is_never_used', 'equalto', true) | list | length) }}
          å¾æœªä½¿ç”¨é: {{ (filtered_unused_policies | selectattr('is_never_used', 'equalto', true) | list | length) }}
          ç¬¦åˆæ¢ä»¶ç¸½æ•¸: {{ filtered_unused_policies | length }}
          ===============================================

    # è¡¨æ ¼æ ¼å¼è¼¸å‡º
    - name: è¡¨æ ¼æ ¼å¼è¼¸å‡ºæœªä½¿ç”¨çš„Policy
      debug:
        msg: |
          {% set unused_long_term = filtered_unused_policies | rejectattr('is_never_used', 'equalto', true) | list %}
          {% set unused_never = filtered_unused_policies | selectattr('is_never_used', 'equalto', true) | list %}
          
          {% if unused_long_term | length > 0 %}
          =================== è¶…é{{ months_threshold }}å€‹æœˆæœªä½¿ç”¨çš„Policy ===================
          | Policy ID | Policy Name                | Status  | Last Used          | Days Ago | Hit Count | Action |
          |-----------|----------------------------|---------|--------------------|---------|-----------:|--------|
          {% for policy in unused_long_term %}
          | {{ "%-9s" | format(policy.policy_id) }} | {{ "%-26s" | format(policy.name[:26]) }} | {{ "%-7s" | format(policy.status) }} | {{ "%-18s" | format(policy.last_used_readable[:18]) }} | {{ "%7s" | format(policy.days_since_last_used) }} | {{ "%9s" | format(policy.hit_count) }} | {{ "%-6s" | format(policy.action) }} |
          {% endfor %}
          {% endif %}
          
          {% if unused_never | length > 0 and include_never_used | default(true) %}
          =================== å¾æœªä½¿ç”¨éçš„Policy ===================
          | Policy ID | Policy Name                | Status  | Hit Count | Action | Comments                |
          |-----------|----------------------------|---------|----------:|--------|-------------------------|
          {% for policy in unused_never %}
          | {{ "%-9s" | format(policy.policy_id) }} | {{ "%-26s" | format(policy.name[:26]) }} | {{ "%-7s" | format(policy.status) }} | {{ "%9s" | format(policy.hit_count) }} | {{ "%-6s" | format(policy.action) }} | {{ "%-23s" | format(policy.comments[:23]) }} |
          {% endfor %}
          {% endif %}
      when: output_format | default("table") == "table"

    # JSONæ ¼å¼è¼¸å‡º
    - name: JSONæ ¼å¼è¼¸å‡º
      debug:
        var: filtered_unused_policies
      when: output_format | default("table") == "json"

    # CSVæ ¼å¼è¼¸å‡º
    - name: CSVæ ¼å¼è¼¸å‡º
      debug:
        msg: |
          policy_id,name,status,action,last_used,days_since_last_used,hit_count,bytes,packets,srcintf,dstintf,srcaddr,dstaddr,service,comments
          {% for policy in filtered_unused_policies %}
          {{ policy.policy_id }},"{{ policy.name | replace('"', '""') }}",{{ policy.status }},{{ policy.action }},{{ policy.last_used_readable }},{{ policy.days_since_last_used }},{{ policy.hit_count }},{{ policy.bytes }},{{ policy.packets }},"{{ policy.srcintf | join(';') }}","{{ policy.dstintf | join(';') }}","{{ policy.srcaddr | join(';') }}","{{ policy.dstaddr | join(';') }}","{{ policy.service | join(';') }}","{{ policy.comments | replace('"', '""') }}"
          {% endfor %}
      when: output_format | default("table") == "csv"

    # =================== æª”æ¡ˆåŒ¯å‡ºï¼ˆAWX Artifactsï¼‰ ===================
    - name: å»ºç«‹artifactsç›®éŒ„
      file:
        path: "{{ playbook_dir }}/artifacts"
        state: directory
      when: export_to_file | default(false) | bool

    - name: åŒ¯å‡ºCSVæ ¼å¼å ±å‘Š
      copy:
        content: |
          # FortiGate Unused Policy Report
          # Generated: {{ ansible_date_time.iso8601 }}
          # VDOM: {{ vdom_name | default('root') }}
          # Threshold: {{ months_threshold | default('6') }} months
          # Total Policies: {{ total_policies }}
          # Unused Policies Found: {{ filtered_unused_policies | length }}
          
          policy_id,name,status,action,last_used,days_since_last_used,hit_count,bytes,packets,srcintf,dstintf,srcaddr,dstaddr,service,comments
          {% for policy in filtered_unused_policies %}
          {{ policy.policy_id }},"{{ policy.name | replace('"', '""') }}",{{ policy.status }},{{ policy.action }},{{ policy.last_used_readable }},{{ policy.days_since_last_used }},{{ policy.hit_count }},{{ policy.bytes }},{{ policy.packets }},"{{ policy.srcintf | join(';') }}","{{ policy.dstintf | join(';') }}","{{ policy.srcaddr | join(';') }}","{{ policy.dstaddr | join(';') }}","{{ policy.service | join(';') }}","{{ policy.comments | replace('"', '""') }}"
          {% endfor %}
        dest: "{{ playbook_dir }}/artifacts/unused_policies_{{ ansible_date_time.epoch }}.csv"
      when: export_to_file | default(false) | bool

    - name: åŒ¯å‡ºJSONæ ¼å¼å ±å‘Š
      copy:
        content: |
          {
            "report_info": {
              "generated_at": "{{ ansible_date_time.iso8601 }}",
              "vdom": "{{ vdom_name | default('root') }}",
              "threshold_months": {{ months_threshold | default('6') }},
              "total_policies": {{ total_policies }},
              "unused_policies_count": {{ filtered_unused_policies | length }}
            },
            "unused_policies": {{ filtered_unused_policies | to_nice_json }}
          }
        dest: "{{ playbook_dir }}/artifacts/unused_policies_{{ ansible_date_time.epoch }}.json"
      when: export_to_file | default(false) | bool

    # =================== ç”Ÿæˆæ¸…ç†è…³æœ¬ï¼ˆåƒ…ä¾›åƒè€ƒï¼‰ ===================
    - name: ç”Ÿæˆæ¸…ç†å»ºè­°è…³æœ¬ï¼ˆåƒ…ä¾›åƒè€ƒï¼Œä¸æœƒè‡ªå‹•åŸ·è¡Œï¼‰
      copy:
        content: |
          #!/bin/bash
          # âš ï¸âš ï¸âš ï¸ é‡è¦å®‰å…¨æé†’ âš ï¸âš ï¸âš ï¸
          # æ­¤è…³æœ¬ç”±AWXè‡ªå‹•ç”Ÿæˆï¼Œåƒ…ä¾›åƒè€ƒ
          # è«‹å‹™å¿…äººå·¥å¯©æŸ¥æ¯å€‹Policyå¾Œå†åŸ·è¡Œ
          # å»ºè­°å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒé©—è­‰
          # ================================
          
          echo "æ­¤è…³æœ¬ä¸æœƒè‡ªå‹•åŸ·è¡Œï¼Œè«‹äººå·¥è¤‡è£½ä»¥ä¸‹å‘½ä»¤åˆ°FortiGate CLI"
          echo "å»ºè­°åŸ·è¡Œæ­¥é©Ÿï¼š"
          echo "1. ä»”ç´°å¯©æŸ¥æ¯å€‹è¦åœç”¨çš„Policy"
          echo "2. å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒåŸ·è¡Œ"
          echo "3. åšå¥½å‚™ä»½"
          echo "4. åˆ†æ‰¹æ¬¡åŸ·è¡Œï¼Œè§€å¯Ÿå½±éŸ¿"
          echo "================================"
          echo ""
          
          # ä»¥ä¸‹ç‚ºå»ºè­°å‘½ä»¤ï¼Œè«‹äººå·¥è¤‡è£½åŸ·è¡Œï¼š
          
          echo "# === ç¬¬ä¸€éšæ®µï¼šåœç”¨é•·æœŸæœªä½¿ç”¨çš„Policy ==="
          {% for policy in (filtered_unused_policies | rejectattr('is_never_used', 'equalto', true) | selectattr('is_enabled', 'equalto', true) | list) %}
          echo "# Policy {{ policy.policy_id }}: {{ policy.name }}"
          echo "# æœ€å¾Œä½¿ç”¨: {{ policy.last_used_readable }}"
          echo "# æœªä½¿ç”¨å¤©æ•¸: {{ policy.days_since_last_used }}"
          echo "# ä¾†æº: {{ policy.srcaddr | join(',') }}"
          echo "# ç›®çš„: {{ policy.dstaddr | join(',') }}"
          echo "# æœå‹™: {{ policy.service | join(',') }}"
          echo ""
          echo "config firewall policy"
          echo "    edit {{ policy.policy_id }}"
          echo "        set status disable"
          echo "        set comments \"{{ policy.comments }} [DISABLED-{{ ansible_date_time.date }}-UNUSED-{{ policy.days_since_last_used }}DAYS]\""
          echo "    next"
          echo "end"
          echo "echo 'Policy {{ policy.policy_id }} å·²åœç”¨ï¼Œè«‹è§€å¯Ÿæ˜¯å¦æœ‰å½±éŸ¿'"
          echo "sleep 5"
          echo ""
          {% endfor %}
          
          echo ""
          echo "# === ç¬¬äºŒéšæ®µï¼šè§€å¯ŸæœŸå¾Œè€ƒæ…®åˆªé™¤ï¼ˆéœ€è¦é¡å¤–ç¢ºèªï¼‰ ==="
          {% for policy in (filtered_unused_policies | selectattr('is_never_used', 'equalto', true) | list)[:5] %}
          echo "# å¾æœªä½¿ç”¨çš„Policy {{ policy.policy_id }}: {{ policy.name }}"
          echo "# å»ºè­°å…ˆåœç”¨è§€å¯Ÿ30å¤©å¾Œå†è€ƒæ…®åˆªé™¤"
          echo "# config firewall policy"
          echo "#     delete {{ policy.policy_id }}"
          echo "# end"
          echo ""
          {% endfor %}
          
          echo "================================"
          echo "âš ï¸ åŸ·è¡Œå‰è«‹ç¢ºèªï¼š"
          echo "1. å·²åšå¥½è¨­å®šå‚™ä»½"
          echo "2. åœ¨ç¶­è­·æ™‚é–“çª—å£åŸ·è¡Œ"
          echo "3. æœ‰å›å¾©è¨ˆåŠƒ"
          echo "4. ç›¸é—œäººå“¡å·²çŸ¥æ‚‰"
          echo "================================"
        dest: "{{ playbook_dir }}/artifacts/MANUAL_cleanup_commands_{{ ansible_date_time.epoch }}.sh"
        mode: '0644'  # æ³¨æ„ï¼šè¨­ç‚ºåªè®€ï¼Œé˜²æ­¢æ„å¤–åŸ·è¡Œ
      when: 
        - export_to_file | default(false) | bool
        - filtered_unused_policies | length > 0

    - name: é¡¯ç¤ºartifactsæª”æ¡ˆä½ç½®
      debug:
        msg: |
          ========= åŒ¯å‡ºæª”æ¡ˆå®Œæˆ =========
          æª”æ¡ˆå·²å„²å­˜åˆ°AWX artifactsç›®éŒ„:
          - unused_policies_{{ ansible_date_time.epoch }}.csv
          - unused_policies_{{ ansible_date_time.epoch }}.json
          - MANUAL_cleanup_commands_{{ ansible_date_time.epoch }}.sh
          
          æ‚¨å¯ä»¥åœ¨AWX Jobè©³æƒ…é é¢çš„"Artifacts"å€å¡Šä¸‹è¼‰é€™äº›æª”æ¡ˆ
          =============================
      when: export_to_file | default(false) | bool

    # =================== æœ€çµ‚å®‰å…¨æé†’ ===================
    - name: âš ï¸ æœ€çµ‚å®‰å…¨æé†’
      debug:
        msg: |
          ========= âš ï¸ é‡è¦å®‰å…¨æé†’ âš ï¸ =========
          
          æ­¤æŸ¥è©¢å·²å®Œæˆï¼Œæ‰¾åˆ° {{ filtered_unused_policies | length }} å€‹ç¬¦åˆæ¢ä»¶çš„Policy
          
          {% if export_to_file | default(false) | bool %}
          ç”Ÿæˆçš„æª”æ¡ˆåŒ…å«ï¼š
          1. ğŸ“Š åˆ†æå ±å‘Š (unused_policies_xxx.csv/json)
          2. ğŸ”§ CLIè…³æœ¬ (MANUAL_cleanup_commands_xxx.sh)
          {% endif %}
          
          âš ï¸ é‡è¦ï¼š
          - æ‰€æœ‰CLIå‘½ä»¤éƒ½éœ€è¦äººå·¥å¯©æŸ¥å’ŒåŸ·è¡Œ
          - å»ºè­°åˆ†éšæ®µåŸ·è¡Œï¼Œæ¯éšæ®µé–“éš”è§€å¯Ÿ
          - åŸ·è¡Œå‰è«‹åšå¥½å‚™ä»½å’Œå›å¾©è¨ˆåŠƒ
          - åœ¨ç¶­è­·æ™‚é–“çª—å£åŸ·è¡Œ
          
          âŒ æ­¤playbookçµ•ä¸æœƒè‡ªå‹•åŸ·è¡Œä»»ä½•è®Šæ›´
          âœ… æ‰€æœ‰è®Šæ›´éƒ½éœ€è¦äººå·¥ç¢ºèªå’ŒåŸ·è¡Œ
          =====================================
