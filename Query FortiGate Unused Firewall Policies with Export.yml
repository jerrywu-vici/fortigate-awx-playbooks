---
- name: Query FortiGate Unused Firewall Policies (Fixed Export)
  hosts: localhost
  gather_facts: true
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"
    # ä½¿ç”¨å¤šç¨®artifactsè·¯å¾‘å˜—è©¦
    artifacts_dir: "{{ ansible_job_id | default('default') }}"

  tasks:
    # ... å‰é¢çš„æŸ¥è©¢é‚è¼¯ä¿æŒä¸è®Š ...

    # =================== å»ºç«‹artifactsç›®éŒ„ï¼ˆå¤šç¨®è·¯å¾‘ï¼‰ ===================
    - name: å»ºç«‹artifactsç›®éŒ„ï¼ˆæ–¹æ³•1 - æ¨™æº–è·¯å¾‘ï¼‰
      file:
        path: "/tmp/artifacts"
        state: directory
        mode: '0755'
      ignore_errors: true
      when: export_to_file | default(false) | bool

    - name: å»ºç«‹artifactsç›®éŒ„ï¼ˆæ–¹æ³•2 - å·¥ä½œç›®éŒ„ï¼‰
      file:
        path: "{{ playbook_dir }}/artifacts"  
        state: directory
        mode: '0755'
      ignore_errors: true
      when: export_to_file | default(false) | bool

    - name: å»ºç«‹artifactsç›®éŒ„ï¼ˆæ–¹æ³•3 - jobç›®éŒ„ï¼‰
      file:
        path: "/tmp/{{ ansible_job_id | default('awx') }}"
        state: directory
        mode: '0755'
      ignore_errors: true
      when: export_to_file | default(false) | bool

    # =================== æª¢æŸ¥å¯ç”¨çš„ç›®éŒ„ ===================
    - name: æª¢æŸ¥artifactsç›®éŒ„
      stat:
        path: "{{ item }}"
      register: dir_check
      loop:
        - "/tmp/artifacts"
        - "{{ playbook_dir }}/artifacts"
        - "/tmp/{{ ansible_job_id | default('awx') }}"
      when: export_to_file | default(false) | bool

    - name: è¨­å®šå¯ç”¨çš„artifactsè·¯å¾‘
      set_fact:
        final_artifacts_dir: "{{ item.item }}"
      loop: "{{ dir_check.results | default([]) }}"
      when: 
        - export_to_file | default(false) | bool
        - item.stat.exists | default(false)
        - final_artifacts_dir is not defined

    - name: é¡¯ç¤ºä½¿ç”¨çš„artifactsç›®éŒ„
      debug:
        msg: "ä½¿ç”¨artifactsç›®éŒ„: {{ final_artifacts_dir | default('/tmp/artifacts') }}"
      when: export_to_file | default(false) | bool

    # =================== åŒ¯å‡ºæª”æ¡ˆåˆ°å¤šå€‹ä½ç½® ===================
    - name: åŒ¯å‡ºPolicyæ¸…å–®CSVï¼ˆå¤šå€‹ä½ç½®ï¼‰
      copy:
        content: |
          # FortiGate Policy Analysis Report
          # Generated: {{ ansible_date_time.iso8601 }}
          # VDOM: {{ vdom_name | default('root') }}
          # Total Policies: {{ total_policies }}
          # Enabled Policies: {{ enabled_count }}
          # Listed Policies: {{ filtered_policies | length }}
          
          policy_id,name,status,action,srcintf,dstintf,srcaddr,dstaddr,service,logtraffic,comments
          {% for policy in filtered_policies %}
          {{ policy.policy_id }},"{{ policy.name | replace('"', '""') }}",{{ policy.status }},{{ policy.action }},"{{ policy.srcintf }}","{{ policy.dstintf }}","{{ policy.srcaddr }}","{{ policy.dstaddr }}","{{ policy.service }}",{{ policy.logtraffic }},"{{ policy.comments | replace('"', '""') }}"
          {% endfor %}
        dest: "{{ item }}/policy_analysis_{{ ansible_date_time.epoch }}.csv"
        mode: '0644'
      loop:
        - "/tmp/artifacts"
        - "{{ playbook_dir }}/artifacts"
        - "/tmp"
      ignore_errors: true
      when: export_to_file | default(false) | bool

    - name: ç”ŸæˆPolicyå¯©æŸ¥å ±å‘Šï¼ˆå¤šå€‹ä½ç½®ï¼‰
      copy:
        content: |
          FortiGate Policy å¯©æŸ¥å ±å‘Š
          ========================
          
          åŸºæœ¬è³‡è¨Š:
          - ç”Ÿæˆæ™‚é–“: {{ ansible_date_time.iso8601 }}
          - VDOM: {{ vdom_name | default('root') }}
          - FortiGate: {{ fortigate_host }}
          - AWX Job ID: {{ ansible_job_id | default('N/A') }}
          
          çµ±è¨ˆæ‘˜è¦:
          - ç¸½Policyæ•¸é‡: {{ total_policies }}
          - å•Ÿç”¨Policyæ•¸é‡: {{ enabled_count }}
          - åœç”¨Policyæ•¸é‡: {{ total_policies | int - enabled_count | int }}
          - æœ¬æ¬¡åˆ†æPolicyæ•¸é‡: {{ filtered_policies | length }}
          
          Policy è©³ç´°æ¸…å–®:
          {% for policy in filtered_policies %}
          
          {{ loop.index }}. Policy {{ policy.policy_id }}: {{ policy.name }}
             ç‹€æ…‹: {{ policy.status }}
             å‹•ä½œ: {{ policy.action }}
             ä¾†æºä»‹é¢: {{ policy.srcintf }}
             ç›®çš„ä»‹é¢: {{ policy.dstintf }}
             ä¾†æºåœ°å€: {{ policy.srcaddr }}
             ç›®çš„åœ°å€: {{ policy.dstaddr }}
             æœå‹™: {{ policy.service }}
             æ—¥èªŒè¨˜éŒ„: {{ policy.logtraffic }}
             å‚™è¨»: {{ policy.comments }}
          {% endfor %}
          
          å»ºè­°æ¸…ç†CLIå‘½ä»¤:
          ========================
          # è«‹äººå·¥å¯©æŸ¥å¾ŒåŸ·è¡Œï¼Œå‹™å¿…å…ˆå‚™ä»½è¨­å®š
          
          # å‚™ä»½è¨­å®š
          execute backup config management-station comment "policy-review-{{ ansible_date_time.date }}"
          
          # åœç”¨Policyç¯„ä¾‹å‘½ä»¤
          config firewall policy
          {% for policy in filtered_policies[:5] %}
              # Policy {{ policy.policy_id }}: {{ policy.name }}
              # edit {{ policy.policy_id }}
              #     set status disable
              #     set comments "{{ policy.comments }} [REVIEW-{{ ansible_date_time.date }}]"
              # next
          {% endfor %}
          end
          
          æ³¨æ„äº‹é …:
          ========================
          âš ï¸ æ‰€æœ‰è®Šæ›´è«‹åœ¨ç¶­è­·æ™‚é–“çª—å£åŸ·è¡Œ
          âš ï¸ å»ºè­°å…ˆåœç”¨è§€å¯Ÿï¼Œç¢ºèªç„¡å½±éŸ¿å¾Œå†åˆªé™¤
          âš ï¸ ä¿æŒè®Šæ›´è¨˜éŒ„ä»¥ä¾¿å¿…è¦æ™‚å›å¾©
        dest: "{{ item }}/policy_review_report_{{ ansible_date_time.epoch }}.txt"
        mode: '0644'
      loop:
        - "/tmp/artifacts"
        - "{{ playbook_dir }}/artifacts"
        - "/tmp"
      ignore_errors: true
      when: export_to_file | default(false) | bool

    # =================== ç›´æ¥åœ¨Jobè¼¸å‡ºä¸­é¡¯ç¤ºæª”æ¡ˆå…§å®¹ï¼ˆå‚™é¸æ–¹æ¡ˆï¼‰ ===================
    - name: é¡¯ç¤ºCSVå…§å®¹ï¼ˆä¾›è¤‡è£½ä½¿ç”¨ï¼‰
      debug:
        msg: |
          ========= CSVæª”æ¡ˆå…§å®¹ (å¯ç›´æ¥è¤‡è£½) =========
          policy_id,name,status,action,srcintf,dstintf,srcaddr,dstaddr,service,logtraffic,comments
          {% for policy in filtered_policies %}
          {{ policy.policy_id }},"{{ policy.name | replace('"', '""') }}",{{ policy.status }},{{ policy.action }},"{{ policy.srcintf }}","{{ policy.dstintf }}","{{ policy.srcaddr }}","{{ policy.dstaddr }}","{{ policy.service }}",{{ policy.logtraffic }},"{{ policy.comments | replace('"', '""') }}"
          {% endfor %}
          ========= CSVæª”æ¡ˆå…§å®¹çµæŸ =========
          
          æ‚¨å¯ä»¥è¤‡è£½ä¸Šè¿°å…§å®¹ä¸¦å„²å­˜ç‚º .csv æª”æ¡ˆ
      when: 
        - export_to_file | default(false) | bool
        - show_content_in_log | default(false) | bool

    # =================== æª¢æŸ¥æª”æ¡ˆæ˜¯å¦æˆåŠŸå»ºç«‹ ===================
    - name: æª¢æŸ¥åŒ¯å‡ºæª”æ¡ˆç‹€æ…‹
      stat:
        path: "{{ item }}/policy_analysis_{{ ansible_date_time.epoch }}.csv"
      register: file_check
      loop:
        - "/tmp/artifacts"
        - "{{ playbook_dir }}/artifacts"
        - "/tmp"
      when: export_to_file | default(false) | bool

    - name: é¡¯ç¤ºæª”æ¡ˆå»ºç«‹ç‹€æ…‹
      debug:
        msg: |
          æª”æ¡ˆå»ºç«‹ç‹€æ…‹æª¢æŸ¥:
          {% for result in file_check.results %}
          - {{ result.item }}/policy_analysis_{{ ansible_date_time.epoch }}.csv: {{ 'âœ… å­˜åœ¨' if result.stat.exists else 'âŒ ä¸å­˜åœ¨' }}
          {% if result.stat.exists %}
            æª”æ¡ˆå¤§å°: {{ result.stat.size }} bytes
          {% endif %}
          {% endfor %}
      when: export_to_file | default(false) | bool

    # =================== æä¾›ä¸‹è¼‰æŒ‡å¼• ===================
    - name: ä¸‹è¼‰æŒ‡å¼•
      debug:
        msg: |
          ğŸ“ æª”æ¡ˆåŒ¯å‡ºå®Œæˆï¼è«‹å˜—è©¦ä»¥ä¸‹æ–¹å¼å–å¾—æª”æ¡ˆï¼š
          
          æ–¹æ³•1 - AWX Artifacts:
          - åˆ°AWX Jobè©³æƒ…é é¢æŸ¥çœ‹ "Artifacts" å€å¡Š
          - å¦‚æœæ²’æœ‰Artifactså€å¡Šï¼Œè«‹æª¢æŸ¥AWXè¨­å®š
          
          æ–¹æ³•2 - ç›´æ¥å¾å®¹å™¨è¤‡è£½:
          docker exec -it <awx_task_container> ls -la /tmp/artifacts/
          docker cp <awx_task_container>:/tmp/artifacts/policy_analysis_{{ ansible_date_time.epoch }}.csv .
          
          æ–¹æ³•3 - æŸ¥çœ‹Jobè¼¸å‡º:
          {% if show_content_in_log | default(false) %}
          - ä¸Šæ–¹å·²é¡¯ç¤ºCSVå…§å®¹ï¼Œå¯ç›´æ¥è¤‡è£½ä½¿ç”¨
          {% else %}
          - é‡æ–°åŸ·è¡ŒJobä¸¦è¨­å®š show_content_in_log: true ä¾†é¡¯ç¤ºæª”æ¡ˆå…§å®¹
          {% endif %}
          
          æª”æ¡ˆåç¨±:
          - policy_analysis_{{ ansible_date_time.epoch }}.csv
          - policy_review_report_{{ ansible_date_time.epoch }}.txt
      when: export_to_file | default(false) | bool

    # =================== æœ€çµ‚å ±å‘Š ===================
    - name: æŸ¥è©¢å®Œæˆå ±å‘Š
      debug:
        msg: |
          ğŸ¯ Policyåˆ†æå®Œæˆï¼
          
          ğŸ“ˆ è™•ç†çµæœ:
          - åˆ†æäº† {{ total_policies }} å€‹Policy
          - ç¬¦åˆæ¢ä»¶çš„Policy: {{ filtered_policies | length }} å€‹
          
          {% if export_to_file | default(false) | bool %}
          ğŸ“ åŒ¯å‡ºç‹€æ…‹: æª”æ¡ˆå·²å˜—è©¦åŒ¯å‡ºåˆ°å¤šå€‹ä½ç½®
          æ™‚é–“æˆ³è¨˜: {{ ansible_date_time.epoch }}
          {% endif %}
          
          âš ï¸ å¦‚ç„¡æ³•ä¸‹è¼‰æª”æ¡ˆï¼Œè«‹è¨­å®š show_content_in_log: true é‡æ–°åŸ·è¡Œ
