---
- name: Query FortiGate Firewall Policies (Clean Version)
  hosts: localhost
  gather_facts: true
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"

  tasks:
    # =================== å®‰å…¨æª¢æŸ¥ ===================
    - name: å®‰å…¨æé†’
      debug:
        msg: "ğŸ” é–‹å§‹æŸ¥è©¢FortiGate Policy (åªè®€æ¨¡å¼)"

    # =================== è³‡æ–™æ”¶é›†éšæ®µ ===================
    - name: æŸ¥è©¢æ‰€æœ‰Firewall Policyè¨­å®š
      uri:
        url: "{{ fortigate_api_url }}/api/v2/cmdb/firewall/{{ policy_type | default('policy') }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('60') | int }}"
      register: policy_config_result
      retries: "{{ fortigate_api_retries | default('3') | int }}"
      delay: "{{ fortigate_api_delay | default('5') | int }}"

    - name: é¡¯ç¤ºPolicyæŸ¥è©¢çµæœ
      debug:
        msg: "âœ… æ‰¾åˆ° {{ policy_config_result.json.results | length }} å€‹Policy"

    # =================== è³‡æ–™è™•ç† ===================
    - name: åˆå§‹åŒ–è®Šæ•¸
      set_fact:
        all_policies: "{{ policy_config_result.json.results | default([]) }}"
        total_policies: "{{ policy_config_result.json.results | length }}"

    - name: è¨ˆç®—Policyçµ±è¨ˆ
      set_fact:
        enabled_count: "{{ all_policies | selectattr('status', 'equalto', 'enable') | list | length }}"
        disabled_count: "{{ all_policies | selectattr('status', 'equalto', 'disable') | list | length }}"

    # =================== æ‡‰ç”¨éæ¿¾æ¢ä»¶ï¼ˆç°¡åŒ–ç‰ˆï¼‰ ===================
    - name: éæ¿¾Policyåˆ—è¡¨
      set_fact:
        filtered_policies: "{{ final_list }}"
      vars:
        exclude_ids: "{{ filter_options.exclude_policy_ids | default([]) | map('string') | list }}"
        min_id: "{{ filter_options.min_policy_id | default('') }}"
        max_id: "{{ filter_options.max_policy_id | default('') }}"
        final_list: |
          [
          {% for policy in all_policies %}
          {% set policy_id_str = policy.policyid | string %}
          {% set skip_policy = false %}
          
          {# æ‡‰ç”¨éæ¿¾æ¢ä»¶ #}
          {% if exclude_ids and policy_id_str in exclude_ids %}
          {% set skip_policy = true %}
          {% endif %}
          
          {% if min_id != '' and policy.policyid | int < min_id | int %}
          {% set skip_policy = true %}
          {% endif %}
          
          {% if max_id != '' and policy.policyid | int > max_id | int %}
          {% set skip_policy = true %}
          {% endif %}
          
          {% if not include_disabled | default(false) and policy.status | default('enable') != 'enable' %}
          {% set skip_policy = true %}
          {% endif %}
          
          {% if not skip_policy %}
          {
            "policy_id": "{{ policy.policyid }}",
            "name": "{{ policy.name | default('Policy_' + (policy.policyid | string)) }}",
            "status": "{{ policy.status | default('enable') }}",
            "action": "{{ policy.action | default('accept') }}",
            "srcintf": "{{ policy.srcintf | default([]) | join(',') }}",
            "dstintf": "{{ policy.dstintf | default([]) | join(',') }}",
            "srcaddr": "{{ policy.srcaddr | default([]) | join(',') }}",
            "dstaddr": "{{ policy.dstaddr | default([]) | join(',') }}",
            "service": "{{ policy.service | default([]) | join(',') }}",
            "logtraffic": "{{ policy.logtraffic | default('disable') }}",
            "comments": "{{ policy.comments | default('') }}",
            "is_enabled": {{ policy.status | default('enable') == 'enable' }}
          }{% if not loop.last %},{% endif %}
          {% endif %}
          {% endfor %}
          ]

    # =================== çµæœæ‘˜è¦ ===================
    - name: é¡¯ç¤ºåˆ†ææ‘˜è¦
      debug:
        msg: |
          ========= FortiGate Policy åˆ†ææ‘˜è¦ =========
          VDOM: {{ vdom_name | default('root') }}
          æŸ¥è©¢æ™‚é–“: {{ ansible_date_time.iso8601 }}
          
          ğŸ“Š çµ±è¨ˆçµæœ:
          - ç¸½Policyæ•¸é‡: {{ total_policies }}
          - å•Ÿç”¨çš„Policy: {{ enabled_count }}
          - åœç”¨çš„Policy: {{ disabled_count }}
          - ç¬¦åˆéæ¿¾æ¢ä»¶: {{ filtered_policies | length }}
          
          ğŸ” éæ¿¾è¨­å®š:
          {% if filter_options.exclude_policy_ids | default([]) | length > 0 %}
          - æ’é™¤Policy ID: {{ filter_options.exclude_policy_ids | join(', ') }}
          {% endif %}
          {% if filter_options.min_policy_id | default('') != '' %}
          - æœ€å°Policy ID: {{ filter_options.min_policy_id }}
          {% endif %}
          {% if filter_options.max_policy_id | default('') != '' %}
          - æœ€å¤§Policy ID: {{ filter_options.max_policy_id }}
          {% endif %}
          - åŒ…å«åœç”¨Policy: {{ include_disabled | default(false) }}
          ==========================================

    # =================== é¡¯ç¤ºPolicyæ¸…å–® ===================
    - name: é¡¯ç¤ºPolicyæ¸…å–®æ‘˜è¦
      debug:
        msg: |
          ========= Policy æ¸…å–®æ‘˜è¦ (å‰10ç­†) =========
          {% for policy in filtered_policies[:10] %}
          {{ "%2d" | format(loop.index) }}. Policy {{ policy.policy_id }}: {{ policy.name[:35] }}
              ç‹€æ…‹: {{ policy.status }} | å‹•ä½œ: {{ policy.action }}
              ä¾†æº: {{ policy.srcaddr[:40] }}{{ '...' if policy.srcaddr | length > 40 else '' }}
              ç›®çš„: {{ policy.dstaddr[:40] }}{{ '...' if policy.dstaddr | length > 40 else '' }}
              æœå‹™: {{ policy.service[:25] }}{{ '...' if policy.service | length > 25 else '' }}
          {% endfor %}
          {% if filtered_policies | length > 10 %}
          
          ... é‚„æœ‰ {{ filtered_policies | length - 10 }} ç­†Policy
          {% endif %}
          =======================================
      when: filtered_policies | length > 0

    # =================== CSVå…§å®¹è¼¸å‡º ===================
    - name: å®Œæ•´CSVå…§å®¹
      debug:
        msg: |
          ========= å®Œæ•´CSVå…§å®¹ =========
          
          ## å»ºè­°æª”å: fortigate_policies_{{ ansible_date_time.epoch }}.csv
          
          policy_id,name,status,action,srcintf,dstintf,srcaddr,dstaddr,service,logtraffic,comments
          {% for policy in filtered_policies %}
          {{ policy.policy_id }},"{{ policy.name | replace('"', '""') }}",{{ policy.status }},{{ policy.action }},"{{ policy.srcintf }}","{{ policy.dstintf }}","{{ policy.srcaddr }}","{{ policy.dstaddr }}","{{ policy.service }}",{{ policy.logtraffic }},"{{ policy.comments | replace('"', '""') }}"
          {% endfor %}
          
          ========= CSVå…§å®¹çµæŸ =========
          
          ä½¿ç”¨æ–¹æ³•:
          1. è¤‡è£½ä¸Šè¿°CSVå…§å®¹
          2. é–‹å•ŸExcelæˆ–è¨˜äº‹æœ¬
          3. è²¼ä¸Šå…§å®¹ä¸¦å„²å­˜ç‚º.csvæª”æ¡ˆ
      when: 
        - filtered_policies | length > 0
        - show_csv | default(true) | bool

    # =================== è©³ç´°å ±å‘Šè¼¸å‡º ===================
    - name: è©³ç´°åˆ†æå ±å‘Š
      debug:
        msg: |
          ========= è©³ç´°åˆ†æå ±å‘Š =========
          
          ## åŸºæœ¬è³‡è¨Š
          - å ±å‘Šç”Ÿæˆæ™‚é–“: {{ ansible_date_time.iso8601 }}
          - FortiGateä¸»æ©Ÿ: {{ fortigate_host }}
          - VDOM: {{ vdom_name | default('root') }}
          
          ## çµ±è¨ˆæ‘˜è¦
          - ç¸½Policyæ•¸é‡: {{ total_policies }}
          - å•Ÿç”¨Policy: {{ enabled_count }} ({{ (enabled_count|int * 100 / total_policies|int) | round(1) }}%)
          - åœç”¨Policy: {{ disabled_count }} ({{ (disabled_count|int * 100 / total_policies|int) | round(1) }}%)
          - æœ¬æ¬¡åˆ†æ: {{ filtered_policies | length }} å€‹Policy
          
          ## Policyè©³ç´°è³‡è¨Š
          {% for policy in filtered_policies %}
          
          {{ loop.index }}. Policy {{ policy.policy_id }}: {{ policy.name }}
             - ç‹€æ…‹: {{ policy.status }}
             - å‹•ä½œ: {{ policy.action }}
             - ä¾†æºä»‹é¢: {{ policy.srcintf }}
             - ç›®çš„ä»‹é¢: {{ policy.dstintf }}
             - ä¾†æºåœ°å€: {{ policy.srcaddr }}
             - ç›®çš„åœ°å€: {{ policy.dstaddr }}
             - æœå‹™: {{ policy.service }}
             - è¨˜éŒ„æµé‡: {{ policy.logtraffic }}
             - å‚™è¨»: {{ policy.comments }}
          {% endfor %}
          
          ## å»ºè­°ç®¡ç†å‘½ä»¤
          
          ### å‚™ä»½è¨­å®š
          execute backup config management-station comment "policy-analysis-{{ ansible_date_time.date }}"
          
          ### Policyç®¡ç†ç¯„ä¾‹ (è«‹æ ¹æ“šéœ€è¦ä¿®æ”¹)
          config firewall policy
          {% for policy in filtered_policies[:5] %}
          {% if policy.status == 'enable' %}
              # Policy {{ policy.policy_id }}: {{ policy.name }}
              # ç”¨é€”æª¢æŸ¥ - ä¾†æº: {{ policy.srcaddr }} -> ç›®çš„: {{ policy.dstaddr }}
              # edit {{ policy.policy_id }}
              #     set status disable
              #     set comments "{{ policy.comments }} [ANALYSIS-{{ ansible_date_time.date }}]"
              # next
          {% endif %}
          {% endfor %}
          end
          
          ## æ³¨æ„äº‹é …
          âš ï¸ æ‰€æœ‰Policyè®Šæ›´è«‹åœ¨ç¶­è­·æ™‚é–“çª—å£åŸ·è¡Œ
          âš ï¸ å»ºè­°å…ˆåœç”¨è§€å¯Ÿï¼Œç¢ºèªç„¡å½±éŸ¿å¾Œå†è€ƒæ…®åˆªé™¤
          âš ï¸ å‹™å¿…ä¿ç•™è®Šæ›´è¨˜éŒ„ä»¥ä¾¿å›å¾©
          
          ========= å ±å‘ŠçµæŸ =========
      when: 
        - filtered_policies | length > 0
        - show_detailed_report | default(true) | bool

    # =================== ç®¡ç†è…³æœ¬è¼¸å‡º ===================
    - name: ç®¡ç†è…³æœ¬
      debug:
        msg: |
          ========= FortiGateç®¡ç†è…³æœ¬ =========
          
          ## å»ºè­°æª”å: fortigate_management_{{ ansible_date_time.epoch }}.cli
          
          # FortiGate Policyç®¡ç†è…³æœ¬
          # ç”Ÿæˆæ™‚é–“: {{ ansible_date_time.iso8601 }}
          # 
          # ä½¿ç”¨å‰è«‹å‹™å¿…:
          # 1. å‚™ä»½ç¾æœ‰è¨­å®š
          # 2. åœ¨æ¸¬è©¦ç’°å¢ƒé©—è­‰
          # 3. é¸æ“‡é©ç•¶çš„ç¶­è­·æ™‚é–“çª—å£
          
          # === ç³»çµ±è³‡è¨Šæª¢æŸ¥ ===
          get system status
          get system performance status
          
          # === è¨­å®šå‚™ä»½ ===
          execute backup config management-station comment "before-policy-changes-{{ ansible_date_time.date }}"
          
          # === Policyæª¢æŸ¥å‘½ä»¤ ===
          show firewall policy
          diagnose firewall iprope show 100000
          
          # === Policyåœç”¨ç¯„ä¾‹ (è«‹æ ¹æ“šåˆ†æçµæœé¸æ“‡åŸ·è¡Œ) ===
          config firewall policy
          {% for policy in filtered_policies[:10] %}
          {% if policy.status == 'enable' %}
              # Policy {{ policy.policy_id }}: {{ policy.name }}
              # æª¢æŸ¥é …ç›®: {{ policy.srcaddr }} -> {{ policy.dstaddr }} ({{ policy.service }})
              # å»ºè­°: å…ˆåœç”¨è§€å¯Ÿ30å¤©ï¼Œç¢ºèªç„¡å½±éŸ¿å¾Œæ±ºå®šæ˜¯å¦åˆªé™¤
              # 
              # edit {{ policy.policy_id }}
              #     set status disable
              #     set comments "{{ policy.comments }} [DISABLED-{{ ansible_date_time.date }}-FOR-REVIEW]"
              # next
              # 
          {% endif %}
          {% endfor %}
          end
          
          # === é©—è­‰å‘½ä»¤ ===
          show firewall policy | grep disable
          
          # === ç›£æ§å»ºè­° ===
          # 1. è§€å¯Ÿç³»çµ±log: execute log display
          # 2. æª¢æŸ¥ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸
          # 3. ç¢ºèªæ‡‰ç”¨æœå‹™é‹ä½œç‹€æ³
          # 4. æ”¶é›†ä½¿ç”¨è€…å›é¥‹
          
          ========= è…³æœ¬çµæŸ =========
      when: 
        - filtered_policies | length > 0
        - show_management_script | default(true) | bool

    # =================== æœ€çµ‚å ±å‘Š ===================
    - name: ä»»å‹™å®Œæˆå ±å‘Š
      debug:
        msg: |
          ğŸ¯ FortiGate Policyåˆ†æå®Œæˆï¼
          
          ğŸ“Š åŸ·è¡Œæ‘˜è¦:
          - æŸ¥è©¢äº† {{ total_policies }} å€‹Policy
          - åˆ†æäº† {{ filtered_policies | length }} å€‹ç¬¦åˆæ¢ä»¶çš„Policy
          - å•Ÿç”¨ç‹€æ…‹: {{ enabled_count }} å€‹
          - åœç”¨ç‹€æ…‹: {{ disabled_count }} å€‹
          
          ğŸ“‹ å·²æä¾›å…§å®¹:
          {% if show_csv | default(true) %}âœ… CSVæ ¼å¼è³‡æ–™ (å¯åŒ¯å…¥Excel){% else %}âŒ CSVè¼¸å‡ºå·²åœç”¨{% endif %}
          {% if show_detailed_report | default(true) %}âœ… è©³ç´°åˆ†æå ±å‘Š{% else %}âŒ è©³ç´°å ±å‘Šå·²åœç”¨{% endif %}
          {% if show_management_script | default(true) %}âœ… ç®¡ç†CLIè…³æœ¬{% else %}âŒ ç®¡ç†è…³æœ¬å·²åœç”¨{% endif %}
          
          ğŸ’¡ ä½¿ç”¨å»ºè­°:
          1. è¤‡è£½éœ€è¦çš„å…§å®¹åˆ°æª”æ¡ˆä¸­å„²å­˜
          2. ä»”ç´°å¯©æŸ¥æ¯å€‹Policyçš„å¿…è¦æ€§
          3. åˆ¶å®šåˆ†éšæ®µçš„æ¸…ç†è¨ˆåŠƒ
          4. åœ¨ç¶­è­·æ™‚é–“çª—å£åŸ·è¡Œè®Šæ›´
          
          âš ï¸ å®‰å…¨æé†’:
          - æ‰€æœ‰è®Šæ›´éƒ½éœ€è¦äººå·¥ç¢ºèª
          - å»ºè­°å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒé©—è­‰
          - å‹™å¿…æº–å‚™å¥½å›å¾©è¨ˆåŠƒ
