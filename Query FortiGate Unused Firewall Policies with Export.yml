---
- name: Query FortiGate Firewall Policies (Complete Version)
  hosts: localhost
  gather_facts: true
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"

  tasks:
    # =================== å®‰å…¨æª¢æŸ¥ ===================
    - name: å®‰å…¨æé†’
      debug:
        msg: "ğŸ” é–‹å§‹æŸ¥è©¢FortiGate Policy (åªè®€æ¨¡å¼)"

    # =================== è³‡æ–™æ”¶é›†éšæ®µ ===================
    - name: æŸ¥è©¢æ‰€æœ‰Firewall Policyè¨­å®š
      uri:
        url: "{{ fortigate_api_url }}/api/v2/cmdb/firewall/{{ policy_type | default('policy') }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('60') | int }}"
      register: policy_config_result
      retries: "{{ fortigate_api_retries | default('3') | int }}"
      delay: "{{ fortigate_api_delay | default('5') | int }}"

    - name: é¡¯ç¤ºPolicyæŸ¥è©¢çµæœ
      debug:
        msg: "âœ… æ‰¾åˆ° {{ policy_config_result.json.results | length }} å€‹Policy"

    # =================== è³‡æ–™è™•ç† ===================
    - name: åˆå§‹åŒ–è®Šæ•¸
      set_fact:
        all_policies: "{{ policy_config_result.json.results | default([]) }}"
        total_policies: "{{ policy_config_result.json.results | length }}"
        enabled_count: 0
        disabled_count: 0
        filtered_policies: []

    - name: è¨ˆç®—å•Ÿç”¨å’Œåœç”¨çš„Policyæ•¸é‡
      set_fact:
        enabled_count: "{{ all_policies | selectattr('status', 'equalto', 'enable') | list | length }}"
        disabled_count: "{{ all_policies | selectattr('status', 'equalto', 'disable') | list | length }}"

    # =================== æ‡‰ç”¨éæ¿¾æ¢ä»¶ ===================
    - name: è™•ç†Policyä¸¦æ‡‰ç”¨éæ¿¾æ¢ä»¶
      set_fact:
        filtered_policies: "{{ filtered_policies + [processed_policy] }}"
      vars:
        processed_policy:
          policy_id: "{{ item.policyid }}"
          name: "{{ item.name | default('Policy_' + (item.policyid | string)) }}"
          status: "{{ item.status | default('enable') }}"
          action: "{{ item.action | default('accept') }}"
          srcintf: "{{ item.srcintf | default([]) | join(',') }}"
          dstintf: "{{ item.dstintf | default([]) | join(',') }}"
          srcaddr: "{{ item.srcaddr | default([]) | join(',') }}"
          dstaddr: "{{ item.dstaddr | default([]) | join(',') }}"
          service: "{{ item.service | default([]) | join(',') }}"
          logtraffic: "{{ item.logtraffic | default('disable') }}"
          comments: "{{ item.comments | default('') }}"
          is_enabled: "{{ item.status | default('enable') == 'enable' }}"
      loop: "{{ all_policies }}"
      when: 
        - filter_condition | default(true)
      vars:
        filter_condition: |
          {{
            (not filter_options.exclude_policy_ids | default([]) or item.policyid | string not in filter_options.exclude_policy_ids) and
            (not filter_options.min_policy_id | default('') or item.policyid | int >= filter_options.min_policy_id | int) and
            (not filter_options.max_policy_id | default('') or item.policyid | int <= filter_options.max_policy_id | int) and
            (include_disabled | default(false) or item.status | default('enable') == 'enable')
          }}

    # =================== çµæœæ‘˜è¦ ===================
    - name: é¡¯ç¤ºåˆ†ææ‘˜è¦
      debug:
        msg: |
          ========= FortiGate Policy åˆ†ææ‘˜è¦ =========
          VDOM: {{ vdom_name | default('root') }}
          æŸ¥è©¢æ™‚é–“: {{ ansible_date_time.iso8601 }}
          
          ğŸ“Š çµ±è¨ˆçµæœ:
          - ç¸½Policyæ•¸é‡: {{ total_policies }}
          - å•Ÿç”¨çš„Policy: {{ enabled_count }}
          - åœç”¨çš„Policy: {{ disabled_count }}
          - ç¬¦åˆéæ¿¾æ¢ä»¶: {{ filtered_policies | length }}
          
          ğŸ” éæ¿¾æ¢ä»¶:
          {% if filter_options.exclude_policy_ids | default([]) | length > 0 %}
          - æ’é™¤Policy ID: {{ filter_options.exclude_policy_ids | join(', ') }}
          {% endif %}
          {% if filter_options.min_policy_id | default('') != '' %}
          - æœ€å°Policy ID: {{ filter_options.min_policy_id }}
          {% endif %}
          {% if filter_options.max_policy_id | default('') != '' %}
          - æœ€å¤§Policy ID: {{ filter_options.max_policy_id }}
          {% endif %}
          - åŒ…å«åœç”¨Policy: {{ include_disabled | default(false) }}
          ==========================================

    # =================== é¡¯ç¤ºPolicyåˆ—è¡¨ ===================
    - name: é¡¯ç¤ºPolicyæ¸…å–®ï¼ˆå‰15ç­†ï¼‰
      debug:
        msg: |
          ========= Policy æ¸…å–® (å‰15ç­†) =========
          {% for policy in filtered_policies[:15] %}
          {{ "%2d" | format(loop.index) }}. Policy {{ policy.policy_id }}: {{ policy.name[:40] }}
              ç‹€æ…‹: {{ policy.status }} | å‹•ä½œ: {{ policy.action }}
              ä»‹é¢: {{ policy.srcintf }} -> {{ policy.dstintf }}
              åœ°å€: {{ policy.srcaddr[:50] }}{{ '...' if policy.srcaddr | length > 50 else '' }}
                 -> {{ policy.dstaddr[:50] }}{{ '...' if policy.dstaddr | length > 50 else '' }}
              æœå‹™: {{ policy.service[:30] }}{{ '...' if policy.service | length > 30 else '' }}
              {% if policy.comments %}å‚™è¨»: {{ policy.comments[:40] }}{{ '...' if policy.comments | length > 40 else '' }}{% endif %}
          {% endfor %}
          {% if filtered_policies | length > 15 %}
          
          âš ï¸ é‚„æœ‰ {{ filtered_policies | length - 15 }} ç­†Policyæœªé¡¯ç¤º
          {% endif %}
          ======================================
      when: filtered_policies | length > 0

    # =================== ç›´æ¥è¼¸å‡ºå®Œæ•´å…§å®¹ï¼ˆä¸»è¦æ–¹æ¡ˆï¼‰ ===================
    - name: å®Œæ•´CSVå…§å®¹è¼¸å‡º
      debug:
        msg: |
          ========= å®Œæ•´CSVå…§å®¹ (å¯ç›´æ¥è¤‡è£½ä½¿ç”¨) =========
          
          ## æª”æ¡ˆåç¨±å»ºè­°: fortigate_policy_analysis_{{ ansible_date_time.epoch }}.csv
          
          policy_id,name,status,action,srcintf,dstintf,srcaddr,dstaddr,service,logtraffic,comments
          {% for policy in filtered_policies %}
          {{ policy.policy_id }},"{{ policy.name | replace('"', '""') }}",{{ policy.status }},{{ policy.action }},"{{ policy.srcintf }}","{{ policy.dstintf }}","{{ policy.srcaddr }}","{{ policy.dstaddr }}","{{ policy.service }}",{{ policy.logtraffic }},"{{ policy.comments | replace('"', '""') }}"
          {% endfor %}
          
          ========= CSVå…§å®¹çµæŸ =========
      when: 
        - filtered_policies | length > 0
        - export_csv_content | default(true) | bool

    - name: å®Œæ•´åˆ†æå ±å‘Šè¼¸å‡º
      debug:
        msg: |
          ========= å®Œæ•´åˆ†æå ±å‘Š =========
          
          FortiGate Policy åˆ†æå ±å‘Š
          ç”Ÿæˆæ™‚é–“: {{ ansible_date_time.iso8601 }}
          VDOM: {{ vdom_name | default('root') }}
          FortiGate: {{ fortigate_host }}
          
          çµ±è¨ˆæ‘˜è¦:
          - ç¸½Policyæ•¸é‡: {{ total_policies }}
          - å•Ÿç”¨Policyæ•¸é‡: {{ enabled_count }}
          - åœç”¨Policyæ•¸é‡: {{ disabled_count }}
          - åˆ†æPolicyæ•¸é‡: {{ filtered_policies | length }}
          
          Policy è©³ç´°æ¸…å–®:
          {% for policy in filtered_policies %}
          
          {{ loop.index }}. Policy {{ policy.policy_id }}: {{ policy.name }}
             ç‹€æ…‹: {{ policy.status }}
             å‹•ä½œ: {{ policy.action }}
             ä¾†æºä»‹é¢: {{ policy.srcintf }}
             ç›®çš„ä»‹é¢: {{ policy.dstintf }}
             ä¾†æºåœ°å€: {{ policy.srcaddr }}
             ç›®çš„åœ°å€: {{ policy.dstaddr }}
             æœå‹™: {{ policy.service }}
             æ—¥èªŒè¨˜éŒ„: {{ policy.logtraffic }}
             å‚™è¨»: {{ policy.comments }}
          {% endfor %}
          
          å»ºè­°CLIå‘½ä»¤ (è«‹äººå·¥å¯©æŸ¥å¾ŒåŸ·è¡Œ):
          ========================================
          # å‚™ä»½è¨­å®š
          execute backup config management-station comment "policy-review-{{ ansible_date_time.date }}"
          
          # åœç”¨Policyç¯„ä¾‹ (è«‹æ ¹æ“šéœ€è¦ä¿®æ”¹)
          config firewall policy
          {% for policy in filtered_policies[:10] %}
          {% if policy.status == 'enable' %}
              # Policy {{ policy.policy_id }}: {{ policy.name }}
              # edit {{ policy.policy_id }}
              #     set status disable
              #     set comments "{{ policy.comments }} [REVIEW-{{ ansible_date_time.date }}]"
              # next
          {% endif %}
          {% endfor %}
          end
          
          æ³¨æ„äº‹é …:
          âš ï¸ æ‰€æœ‰è®Šæ›´è«‹åœ¨ç¶­è­·æ™‚é–“çª—å£åŸ·è¡Œ
          âš ï¸ å»ºè­°å…ˆåœç”¨è§€å¯Ÿï¼Œç¢ºèªç„¡å½±éŸ¿å¾Œå†åˆªé™¤
          
          ========= å ±å‘ŠçµæŸ =========
      when: 
        - filtered_policies | length > 0
        - export_full_report | default(true) | bool

    # =================== æª”æ¡ˆåŒ¯å‡ºå˜—è©¦ï¼ˆå¯é¸ï¼‰ ===================
    - name: å˜—è©¦å»ºç«‹artifactsç›®éŒ„
      file:
        path: "/tmp/artifacts"
        state: directory
        mode: '0755'
      ignore_errors: true
      when: try_file_export | default(false) | bool

    - name: å˜—è©¦åŒ¯å‡ºCSVæª”æ¡ˆ
      copy:
        content: |
          policy_id,name,status,action,srcintf,dstintf,srcaddr,dstaddr,service,logtraffic,comments
          {% for policy in filtered_policies %}
          {{ policy.policy_id }},"{{ policy.name | replace('"', '""') }}",{{ policy.status }},{{ policy.action }},"{{ policy.srcintf }}","{{ policy.dstintf }}","{{ policy.srcaddr }}","{{ policy.dstaddr }}","{{ policy.service }}",{{ policy.logtraffic }},"{{ policy.comments | replace('"', '""') }}"
          {% endfor %}
        dest: "/tmp/artifacts/policy_analysis_{{ ansible_date_time.epoch }}.csv"
        mode: '0644'
      ignore_errors: true
      when: try_file_export | default(false) | bool

    # =================== æœ€çµ‚å ±å‘Š ===================
    - name: å®Œæˆå ±å‘Š
      debug:
        msg: |
          ğŸ¯ Policyåˆ†æå®Œæˆï¼
          
          ğŸ“ˆ è™•ç†çµæœ:
          - ç¸½å…±åˆ†æ: {{ total_policies }} å€‹Policy
          - ç¬¦åˆæ¢ä»¶: {{ filtered_policies | length }} å€‹Policy
          - å•Ÿç”¨ç‹€æ…‹: {{ enabled_count }} å€‹
          - åœç”¨ç‹€æ…‹: {{ disabled_count }} å€‹
          
          ğŸ“‹ ä½¿ç”¨å»ºè­°:
          1. è¤‡è£½ä¸Šæ–¹çš„CSVå…§å®¹åˆ°Excelæˆ–æ–‡å­—æª”æ¡ˆ
          2. æ ¹æ“šåˆ†æå ±å‘Šè­˜åˆ¥éœ€è¦è™•ç†çš„Policy
          3. åœ¨ç¶­è­·æ™‚é–“çª—å£åŸ·è¡Œå»ºè­°çš„CLIå‘½ä»¤
          
          âš ï¸ é‡è¦æé†’:
          - æ‰€æœ‰Policyè®Šæ›´éƒ½æ‡‰è©²å…ˆæ¸¬è©¦
          - å‹™å¿…å…ˆå‚™ä»½è¨­å®š
          - å»ºè­°åˆ†éšæ®µåŸ·è¡Œè®Šæ›´
