---
- name: Query FortiGate Unused Firewall Policies (READ ONLY)
  hosts: localhost
  gather_facts: false
  vars:
    # æ˜ç¢ºæ¨™ç¤ºç‚ºåªè®€æ¨¡å¼
    read_only_mode: true
    
  tasks:
    # =================== å®‰å…¨æª¢æŸ¥ ===================
    - name: å®‰å…¨æé†’ - æ­¤playbookç‚ºåªè®€æ¨¡å¼
      debug:
        msg: |
          âš ï¸  å®‰å…¨æé†’ âš ï¸
          æ­¤playbookåƒ…åŸ·è¡ŒæŸ¥è©¢å’Œå ±å‘Šç”Ÿæˆï¼Œä¸æœƒå°FortiGateé€²è¡Œä»»ä½•è®Šæ›´
          æ‰€æœ‰ç”Ÿæˆçš„CLIå‘½ä»¤éœ€è¦äººå·¥å¯©æŸ¥å¾Œæ‰‹å‹•åŸ·è¡Œ
          ==========================================

    # ... æŸ¥è©¢é‚è¼¯ä¿æŒä¸è®Š ...

    # =================== åªç”Ÿæˆè…³æœ¬ï¼Œä¸åŸ·è¡Œ ===================
    - name: ç”Ÿæˆæ¸…ç†å»ºè­°è…³æœ¬ï¼ˆåƒ…ä¾›åƒè€ƒï¼Œä¸æœƒè‡ªå‹•åŸ·è¡Œï¼‰
      copy:
        content: |
          #!/bin/bash
          # âš ï¸âš ï¸âš ï¸ é‡è¦å®‰å…¨æé†’ âš ï¸âš ï¸âš ï¸
          # æ­¤è…³æœ¬ç”±AWXè‡ªå‹•ç”Ÿæˆï¼Œåƒ…ä¾›åƒè€ƒ
          # è«‹å‹™å¿…äººå·¥å¯©æŸ¥æ¯å€‹Policyå¾Œå†åŸ·è¡Œ
          # å»ºè­°å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒé©—è­‰
          # ================================
          
          echo "æ­¤è…³æœ¬ä¸æœƒè‡ªå‹•åŸ·è¡Œï¼Œè«‹äººå·¥è¤‡è£½ä»¥ä¸‹å‘½ä»¤åˆ°FortiGate CLI"
          echo "å»ºè­°åŸ·è¡Œæ­¥é©Ÿï¼š"
          echo "1. ä»”ç´°å¯©æŸ¥æ¯å€‹è¦åœç”¨çš„Policy"
          echo "2. å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒåŸ·è¡Œ"
          echo "3. åšå¥½å‚™ä»½"
          echo "4. åˆ†æ‰¹æ¬¡åŸ·è¡Œï¼Œè§€å¯Ÿå½±éŸ¿"
          echo "================================"
          echo ""
          
          # ä»¥ä¸‹ç‚ºå»ºè­°å‘½ä»¤ï¼Œè«‹äººå·¥è¤‡è£½åŸ·è¡Œï¼š
          
          echo "# === ç¬¬ä¸€éšæ®µï¼šåœç”¨é•·æœŸæœªä½¿ç”¨çš„Policy ==="
          {% for policy in (filtered_unused_policies | rejectattr('is_never_used', 'equalto', true) | selectattr('is_enabled', 'equalto', true) | list) %}
          echo "# Policy {{ policy.policy_id }}: {{ policy.name }}"
          echo "# æœ€å¾Œä½¿ç”¨: {{ policy.last_used_readable }}"
          echo "# æœªä½¿ç”¨å¤©æ•¸: {{ policy.days_since_last_used }}"
          echo "# ä¾†æº: {{ policy.srcaddr | join(',') }}"
          echo "# ç›®çš„: {{ policy.dstaddr | join(',') }}"
          echo "# æœå‹™: {{ policy.service | join(',') }}"
          echo ""
          echo "config firewall policy"
          echo "    edit {{ policy.policy_id }}"
          echo "        set status disable"
          echo "        set comments \"{{ policy.comments }} [DISABLED-{{ ansible_date_time.date }}-UNUSED-{{ policy.days_since_last_used }}DAYS]\""
          echo "    next"
          echo "end"
          echo "echo 'Policy {{ policy.policy_id }} å·²åœç”¨ï¼Œè«‹è§€å¯Ÿæ˜¯å¦æœ‰å½±éŸ¿'"
          echo "sleep 5"
          echo ""
          {% endfor %}
          
          echo ""
          echo "# === ç¬¬äºŒéšæ®µï¼šè§€å¯ŸæœŸå¾Œè€ƒæ…®åˆªé™¤ï¼ˆéœ€è¦é¡å¤–ç¢ºèªï¼‰ ==="
          {% for policy in (filtered_unused_policies | selectattr('is_never_used', 'equalto', true) | list)[:5] %}
          echo "# å¾æœªä½¿ç”¨çš„Policy {{ policy.policy_id }}: {{ policy.name }}"
          echo "# å»ºè­°å…ˆåœç”¨è§€å¯Ÿ30å¤©å¾Œå†è€ƒæ…®åˆªé™¤"
          echo "# config firewall policy"
          echo "#     delete {{ policy.policy_id }}"
          echo "# end"
          echo ""
          {% endfor %}
          
          echo "================================"
          echo "âš ï¸ åŸ·è¡Œå‰è«‹ç¢ºèªï¼š"
          echo "1. å·²åšå¥½è¨­å®šå‚™ä»½"
          echo "2. åœ¨ç¶­è­·æ™‚é–“çª—å£åŸ·è¡Œ"
          echo "3. æœ‰å›å¾©è¨ˆåŠƒ"
          echo "4. ç›¸é—œäººå“¡å·²çŸ¥æ‚‰"
          echo "================================"
        dest: "{{ playbook_dir }}/artifacts/MANUAL_cleanup_commands_{{ ansible_date_time.epoch }}.sh"
        mode: '0644'  # æ³¨æ„ï¼šè¨­ç‚ºåªè®€ï¼Œé˜²æ­¢æ„å¤–åŸ·è¡Œ
      when: 
        - export_to_file | default(false) | bool
        - filtered_unused_policies | length > 0

    - name: ç”Ÿæˆåˆ†éšæ®µåŸ·è¡Œè¨ˆåŠƒ
      copy:
        content: |
          # FortiGate Policyæ¸…ç†åŸ·è¡Œè¨ˆåŠƒ
          # ç”Ÿæˆæ™‚é–“: {{ ansible_date_time.iso8601 }}
          # 
          # âš ï¸ é‡è¦ï¼šæ­¤ç‚ºå»ºè­°åŸ·è¡Œè¨ˆåŠƒï¼Œè«‹æ ¹æ“šå¯¦éš›ç’°å¢ƒèª¿æ•´
          
          ## ç¬¬ä¸€éšæ®µï¼šæº–å‚™å·¥ä½œï¼ˆå»ºè­°åŸ·è¡Œæ™‚é–“ï¼š1-2å¤©ï¼‰
          1. å‚™ä»½ç•¶å‰è¨­å®š
             execute backup config management-station comment "pre-policy-cleanup-{{ ansible_date_time.date }}"
          
          2. è¨˜éŒ„ç•¶å‰Policyçµ±è¨ˆ
             get system status
             diagnose firewall iprope show 100000
          
          ## ç¬¬äºŒéšæ®µï¼šåœç”¨é«˜é¢¨éšªPolicyï¼ˆå»ºè­°åŸ·è¡Œæ™‚é–“ï¼š3-7å¤©ï¼‰
          # å…ˆåœç”¨å¾æœªä½¿ç”¨éçš„Policy
          {% set never_used = filtered_unused_policies | selectattr('is_never_used', 'equalto', true) | list %}
          {% for policy in never_used[:3] %}
          config firewall policy
              edit {{ policy.policy_id }}
                  set status disable
                  set comments "{{ policy.comments }} [PHASE2-DISABLED-{{ ansible_date_time.date }}]"
              next
          end
          # ç­‰å¾…24å°æ™‚ï¼Œè§€å¯Ÿç³»çµ±ç‹€æ³
          {% endfor %}
          
          ## ç¬¬ä¸‰éšæ®µï¼šåœç”¨é•·æœŸæœªä½¿ç”¨Policyï¼ˆå»ºè­°åŸ·è¡Œæ™‚é–“ï¼š7-14å¤©ï¼‰
          {% set long_unused = filtered_unused_policies | rejectattr('is_never_used', 'equalto', true) | list %}
          {% for policy in long_unused[:5] %}
          config firewall policy
              edit {{ policy.policy_id }}
                  set status disable
                  set comments "{{ policy.comments }} [PHASE3-DISABLED-{{ ansible_date_time.date }}]"
              next
          end
          # æ¯åœç”¨ä¸€å€‹Policyå¾Œè§€å¯Ÿ12å°æ™‚
          {% endfor %}
          
          ## ç¬¬å››éšæ®µï¼šæ¸…ç†ç¢ºèªï¼ˆå»ºè­°åŸ·è¡Œæ™‚é–“ï¼š30å¤©å¾Œï¼‰
          # åœ¨åœç”¨30å¤©å¾Œï¼Œå¦‚ç„¡å•é¡Œï¼Œå¯è€ƒæ…®åˆªé™¤
          # è«‹å†æ¬¡ç¢ºèªé€™äº›Policyç¢ºå¯¦ä¸éœ€è¦
          
          ## ç·Šæ€¥å›å¾©ç¨‹åº
          # å¦‚ç™¼ç¾å•é¡Œï¼Œç«‹å³å•Ÿç”¨ç›¸é—œPolicyï¼š
          # config firewall policy
          #     edit <policy_id>
          #         set status enable
          #     next
          # end
          
          ## ç›£æ§è¦é»
          1. æª¢æŸ¥é˜²ç«ç‰†logæ˜¯å¦æœ‰è¢«æ‹’çµ•çš„é€£ç·š
          2. æª¢æŸ¥æ‡‰ç”¨ç³»çµ±æ˜¯å¦æ­£å¸¸é‹ä½œ
          3. æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰é€£ç·šå•é¡ŒæŠ•è¨´
          4. ç›£æ§ç¶²è·¯æµé‡æ˜¯å¦ç•°å¸¸
        dest: "{{ playbook_dir }}/artifacts/execution_plan_{{ ansible_date_time.epoch }}.txt"
      when: 
        - export_to_file | default(false) | bool
        - filtered_unused_policies | length > 0

    - name: âš ï¸ æœ€çµ‚å®‰å…¨æé†’
      debug:
        msg: |
          ========= âš ï¸ é‡è¦å®‰å…¨æé†’ âš ï¸ =========
          
          æ­¤æŸ¥è©¢å·²å®Œæˆï¼Œç”Ÿæˆçš„æª”æ¡ˆåŒ…å«ï¼š
          1. ğŸ“Š åˆ†æå ±å‘Š (unused_policies_xxx.csv/json)
          2. ğŸ“ åŸ·è¡Œè¨ˆåŠƒ (execution_plan_xxx.txt)  
          3. ğŸ”§ CLIè…³æœ¬ (MANUAL_cleanup_commands_xxx.sh)
          
          âš ï¸ é‡è¦ï¼š
          - æ‰€æœ‰CLIå‘½ä»¤éƒ½éœ€è¦äººå·¥å¯©æŸ¥å’ŒåŸ·è¡Œ
          - å»ºè­°åˆ†éšæ®µåŸ·è¡Œï¼Œæ¯éšæ®µé–“éš”è§€å¯Ÿ
          - åŸ·è¡Œå‰è«‹åšå¥½å‚™ä»½å’Œå›å¾©è¨ˆåŠƒ
          - åœ¨ç¶­è­·æ™‚é–“çª—å£åŸ·è¡Œ
          
          âŒ æ­¤playbookçµ•ä¸æœƒè‡ªå‹•åŸ·è¡Œä»»ä½•è®Šæ›´
          âœ… æ‰€æœ‰è®Šæ›´éƒ½éœ€è¦äººå·¥ç¢ºèªå’ŒåŸ·è¡Œ
          =====================================
    # é˜²æ­¢æ„å¤–åŸ·è¡Œçš„é¡å¤–æª¢æŸ¥
    - name: ç¢ºèªä¸æœƒè‡ªå‹•åŸ·è¡Œè®Šæ›´
      fail:
        msg: |
          âŒ å®‰å…¨æª¢æŸ¥å¤±æ•—ï¼
          æª¢æ¸¬åˆ°å¯èƒ½çš„è‡ªå‹•åŸ·è¡Œè¨­å®šã€‚
          æ­¤playbookè¨­è¨ˆç‚ºåªè®€æ¨¡å¼ï¼Œä¸æ‡‰åŒ…å«ä»»ä½•è‡ªå‹•åŸ·è¡ŒåŠŸèƒ½ã€‚
      when: 
        - auto_execute is defined
        - auto_execute | bool

    - name: é©—è­‰åªè®€æ¨¡å¼
      assert:
        that:
          - read_only_mode | default(true) | bool
          - not (auto_cleanup | default(false) | bool)
        fail_msg: "æ­¤playbookå¿…é ˆåœ¨åªè®€æ¨¡å¼ä¸‹é‹è¡Œ"
        success_msg: "âœ… å®‰å…¨æª¢æŸ¥é€šéï¼Œåªè®€æ¨¡å¼å·²ç¢ºèª"
