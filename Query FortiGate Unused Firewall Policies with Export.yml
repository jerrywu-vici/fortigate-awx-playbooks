---
- name: Query FortiGate Unused Firewall Policies (Fixed)
  hosts: localhost
  gather_facts: true  # æ”¹ç‚ºtrueä»¥ç²å–æ™‚é–“è®Šæ•¸
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"
    current_timestamp: "{{ ansible_date_time.epoch | int }}"
    threshold_timestamp: "{{ (ansible_date_time.epoch | int) - ((months_threshold | default('6') | int) * 30 * 24 * 3600) }}"

  tasks:
    # =================== å®‰å…¨æª¢æŸ¥ ===================
    - name: å®‰å…¨æé†’ - æ­¤playbookç‚ºåªè®€æ¨¡å¼
      debug:
        msg: "ğŸ” é–‹å§‹æŸ¥è©¢FortiGate Policy (åªè®€æ¨¡å¼)"

    # =================== è³‡æ–™æ”¶é›†éšæ®µ ===================
    - name: æŸ¥è©¢æ‰€æœ‰Firewall Policyè¨­å®š
      uri:
        url: "{{ fortigate_api_url }}/api/v2/cmdb/firewall/{{ policy_type | default('policy') }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('60') | int }}"
      register: policy_config_result
      retries: "{{ fortigate_api_retries | default('3') | int }}"
      delay: "{{ fortigate_api_delay | default('5') | int }}"

    - name: é¡¯ç¤ºPolicyæŸ¥è©¢çµæœ
      debug:
        msg: "âœ… æ‰¾åˆ° {{ policy_config_result.json.results | length }} å€‹Policy"

    # =================== ç°¡åŒ–è³‡æ–™è™•ç† ===================
    - name: åˆ†æPolicyè³‡æ–™ 
      set_fact:
        all_policies: "{{ policy_config_result.json.results | default([]) }}"
        total_policies: "{{ policy_config_result.json.results | length }}"

    - name: çµ±è¨ˆå•Ÿç”¨çš„Policy
      set_fact:
        enabled_policies: "{{ all_policies | selectattr('status', 'equalto', 'enable') | list }}"
        enabled_count: "{{ all_policies | selectattr('status', 'equalto', 'enable') | list | length }}"

    # =================== æ‡‰ç”¨éæ¿¾æ¢ä»¶ ===================
    - name: æ‡‰ç”¨åŸºæœ¬éæ¿¾æ¢ä»¶
      set_fact:
        filtered_policies: "{{ selected_policies }}"
      vars:
        exclude_ids: "{{ filter_options.exclude_policy_ids | default([]) | map('string') | list }}"
        min_id: "{{ filter_options.min_policy_id | default('') }}"
        max_id: "{{ filter_options.max_policy_id | default('') }}"
        selected_policies: |
          [
          {% for policy in all_policies %}
          {% set skip = false %}
          {% set policy_id_str = policy.policyid | string %}
          
          {# æ’é™¤æŒ‡å®šID #}
          {% if exclude_ids and policy_id_str in exclude_ids %}
          {% set skip = true %}
          {% endif %}
          
          {# æœ€å°IDéæ¿¾ #}
          {% if min_id != '' and policy.policyid | int < min_id | int %}
          {% set skip = true %}
          {% endif %}
          
          {# æœ€å¤§IDéæ¿¾ #}
          {% if max_id != '' and policy.policyid | int > max_id | int %}
          {% set skip = true %}
          {% endif %}
          
          {# æ˜¯å¦åŒ…å«åœç”¨çš„policy #}
          {% if not include_disabled | default(false) and policy.status | default('enable') != 'enable' %}
          {% set skip = true %}
          {% endif %}
          
          {% if not skip %}
          {
            "policy_id": "{{ policy.policyid }}",
            "name": "{{ policy.name | default('Policy_' + (policy.policyid | string)) }}",
            "status": "{{ policy.status | default('enable') }}",
            "action": "{{ policy.action | default('accept') }}",
            "srcintf": "{{ policy.srcintf | default([]) | join(',') }}",
            "dstintf": "{{ policy.dstintf | default([]) | join(',') }}",
            "srcaddr": "{{ policy.srcaddr | default([]) | join(',') }}",
            "dstaddr": "{{ policy.dstaddr | default([]) | join(',') }}",
            "service": "{{ policy.service | default([]) | join(',') }}",
            "logtraffic": "{{ policy.logtraffic | default('disable') }}",
            "comments": "{{ policy.comments | default('') }}",
            "is_enabled": {{ policy.status | default('enable') == 'enable' }}
          }{% if not loop.last %},{% endif %}
          {% endif %}
          {% endfor %}
          ]

    # =================== å¦‚æœéœ€è¦æŸ¥è©¢ä½¿ç”¨çµ±è¨ˆï¼ˆå¯é¸ï¼‰ ===================
    - name: æŸ¥è©¢Policyä½¿ç”¨çµ±è¨ˆï¼ˆå‰5å€‹ä½œç‚ºç¤ºä¾‹ï¼‰
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/firewall/policy/select"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
          policyid: "{{ item.policy_id }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('15') | int }}"
        status_code: [200, 424]
      register: sample_stats
      loop: "{{ filtered_policies[:5] }}"
      failed_when: false
      no_log: true
      when: 
        - check_statistics | default(false) | bool
        - filtered_policies | length > 0

    - name: é¡¯ç¤ºçµ±è¨ˆæŸ¥è©¢çµæœ
      debug:
        msg: "çµ±è¨ˆæŸ¥è©¢å®Œæˆï¼Œæ‰¾åˆ° {{ sample_stats.results | selectattr('status', 'equalto', 200) | list | length }} å€‹Policyæœ‰çµ±è¨ˆè³‡æ–™"
      when: 
        - check_statistics | default(false) | bool
        - sample_stats is defined

    # =================== çµæœæ‘˜è¦ ===================
    - name: é¡¯ç¤ºåˆ†ææ‘˜è¦
      debug:
        msg: |
          ========= FortiGate Policy åˆ†ææ‘˜è¦ =========
          VDOM: {{ vdom_name | default('root') }}
          æŸ¥è©¢æ™‚é–“: {{ ansible_date_time.iso8601 }}
          
          ğŸ“Š çµ±è¨ˆçµæœ:
          - ç¸½Policyæ•¸é‡: {{ total_policies }}
          - å•Ÿç”¨çš„Policy: {{ enabled_count }}
          - åœç”¨çš„Policy: {{ total_policies | int - enabled_count | int }}
          - ç¬¦åˆéæ¿¾æ¢ä»¶: {{ filtered_policies | length }}
          
          ğŸ” éæ¿¾æ¢ä»¶:
          {% if filter_options.exclude_policy_ids | default([]) | length > 0 %}
          - æ’é™¤Policy ID: {{ filter_options.exclude_policy_ids | join(', ') }}
          {% endif %}
          {% if filter_options.min_policy_id | default('') != '' %}
          - æœ€å°Policy ID: {{ filter_options.min_policy_id }}
          {% endif %}
          {% if filter_options.max_policy_id | default('') != '' %}
          - æœ€å¤§Policy ID: {{ filter_options.max_policy_id }}
          {% endif %}
          - åŒ…å«åœç”¨Policy: {{ include_disabled | default(false) }}
          
          ==========================================

    # =================== é¡¯ç¤ºPolicyåˆ—è¡¨ ===================
    - name: é¡¯ç¤ºPolicyæ¸…å–®ï¼ˆå‰15ç­†ï¼‰
      debug:
        msg: |
          ========= Policy æ¸…å–® (å‰15ç­†) =========
          {% for policy in filtered_policies[:15] %}
          {{ "%2d" | format(loop.index) }}. Policy {{ policy.policy_id }}: {{ policy.name[:40] }}
              ç‹€æ…‹: {{ policy.status }} | å‹•ä½œ: {{ policy.action }}
              ä»‹é¢: {{ policy.srcintf }} -> {{ policy.dstintf }}
              åœ°å€: {{ (policy.srcaddr[:30] + '...') if policy.srcaddr | length > 30 else policy.srcaddr }} 
                 -> {{ (policy.dstaddr[:30] + '...') if policy.dstaddr | length > 30 else policy.dstaddr }}
              æœå‹™: {{ (policy.service[:30] + '...') if policy.service | length > 30 else policy.service }}
              {% if policy.comments %}å‚™è¨»: {{ (policy.comments[:50] + '...') if policy.comments | length > 50 else policy.comments }}{% endif %}
          {% endfor %}
          {% if filtered_policies | length > 15 %}
          
          âš ï¸ é‚„æœ‰ {{ filtered_policies | length - 15 }} ç­†Policyæœªé¡¯ç¤º
          å®Œæ•´æ¸…å–®è«‹æŸ¥çœ‹åŒ¯å‡ºçš„CSVæª”æ¡ˆ
          {% endif %}
          ======================================
      when: filtered_policies | length > 0

    # =================== æª”æ¡ˆåŒ¯å‡º ===================
    - name: å»ºç«‹artifactsç›®éŒ„
      file:
        path: "{{ playbook_dir }}/artifacts"
        state: directory
      when: export_to_file | default(false) | bool

    - name: åŒ¯å‡ºPolicyæ¸…å–®CSV
      copy:
        content: |
          # FortiGate Policy Analysis Report
          # Generated: {{ ansible_date_time.iso8601 }}
          # VDOM: {{ vdom_name | default('root') }}
          # Total Policies: {{ total_policies }}
          # Enabled Policies: {{ enabled_count }}
          # Listed Policies: {{ filtered_policies | length }}
          
          policy_id,name,status,action,srcintf,dstintf,srcaddr,dstaddr,service,logtraffic,comments
          {% for policy in filtered_policies %}
          {{ policy.policy_id }},"{{ policy.name | replace('"', '""') }}",{{ policy.status }},{{ policy.action }},"{{ policy.srcintf }}","{{ policy.dstintf }}","{{ policy.srcaddr }}","{{ policy.dstaddr }}","{{ policy.service }}",{{ policy.logtraffic }},"{{ policy.comments | replace('"', '""') }}"
          {% endfor %}
        dest: "{{ playbook_dir }}/artifacts/policy_analysis_{{ ansible_date_time.epoch }}.csv"
      when: export_to_file | default(false) | bool

    - name: ç”ŸæˆPolicyå¯©æŸ¥å ±å‘Š
      copy:
        content: |
          FortiGate Policy å¯©æŸ¥å ±å‘Š
          ========================
          
          åŸºæœ¬è³‡è¨Š:
          - ç”Ÿæˆæ™‚é–“: {{ ansible_date_time.iso8601 }}
          - VDOM: {{ vdom_name | default('root') }}
          - FortiGate: {{ fortigate_host }}
          
          çµ±è¨ˆæ‘˜è¦:
          - ç¸½Policyæ•¸é‡: {{ total_policies }}
          - å•Ÿç”¨Policyæ•¸é‡: {{ enabled_count }}
          - åœç”¨Policyæ•¸é‡: {{ total_policies | int - enabled_count | int }}
          - æœ¬æ¬¡åˆ†æPolicyæ•¸é‡: {{ filtered_policies | length }}
          
          Policy è©³ç´°æ¸…å–®:
          {% for policy in filtered_policies %}
          
          {{ loop.index }}. Policy {{ policy.policy_id }}: {{ policy.name }}
             ç‹€æ…‹: {{ policy.status }}
             å‹•ä½œ: {{ policy.action }}
             ä¾†æºä»‹é¢: {{ policy.srcintf }}
             ç›®çš„ä»‹é¢: {{ policy.dstintf }}
             ä¾†æºåœ°å€: {{ policy.srcaddr }}
             ç›®çš„åœ°å€: {{ policy.dstaddr }}
             æœå‹™: {{ policy.service }}
             æ—¥èªŒè¨˜éŒ„: {{ policy.logtraffic }}
             å‚™è¨»: {{ policy.comments }}
          {% endfor %}
          
          å»ºè­°å¯©æŸ¥é …ç›®:
          ========================
          1. æª¢è¦–æ¯å€‹Policyçš„å¿…è¦æ€§
          2. ç¢ºèªä¾†æºå’Œç›®çš„åœ°å€æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
          3. æª¢æŸ¥æœå‹™è¨­å®šæ˜¯å¦éæ–¼å¯¬é¬†
          4. è©•ä¼°æ˜¯å¦å¯ä»¥åˆä½µç›¸ä¼¼çš„Policy
          5. è€ƒæ…®å•Ÿç”¨æ—¥èªŒè¨˜éŒ„ä»¥ä¾¿å¾ŒçºŒåˆ†æ
          
          æ¸…ç†å»ºè­°CLIå‘½ä»¤:
          ========================
          # è«‹æ ¹æ“šå¯©æŸ¥çµæœé¸æ“‡åŸ·è¡Œï¼Œå‹™å¿…å…ˆå‚™ä»½è¨­å®š
          
          # å‚™ä»½è¨­å®š
          execute backup config management-station comment "policy-review-{{ ansible_date_time.date }}"
          
          # åœç”¨ç‰¹å®šPolicyçš„ç¯„ä¾‹å‘½ä»¤ï¼ˆè«‹ä¿®æ”¹Policy IDï¼‰
          config firewall policy
              # è«‹æ ¹æ“šå¯©æŸ¥çµæœå–æ¶ˆä¸‹é¢å‘½ä»¤çš„è¨»è§£ä¸¦ä¿®æ”¹Policy ID
              # edit <POLICY_ID>
              #     set status disable
              #     set comments "Disabled during review {{ ansible_date_time.date }}"
              # next
          end
          
          æ³¨æ„äº‹é …:
          ========================
          âš ï¸ æ‰€æœ‰è®Šæ›´è«‹åœ¨ç¶­è­·æ™‚é–“çª—å£åŸ·è¡Œ
          âš ï¸ å»ºè­°å…ˆåœç”¨è§€å¯Ÿï¼Œç¢ºèªç„¡å½±éŸ¿å¾Œå†åˆªé™¤
          âš ï¸ ä¿æŒè®Šæ›´è¨˜éŒ„ä»¥ä¾¿å¿…è¦æ™‚å›å¾©
        dest: "{{ playbook_dir }}/artifacts/policy_review_report_{{ ansible_date_time.epoch }}.txt"
      when: export_to_file | default(false) | bool

    # =================== æœ€çµ‚å ±å‘Š ===================
    - name: æŸ¥è©¢å®Œæˆå ±å‘Š
      debug:
        msg: |
          ğŸ¯ Policyåˆ†æå®Œæˆï¼
          
          ğŸ“ˆ è™•ç†çµæœ:
          - åˆ†æäº† {{ total_policies }} å€‹Policy
          - ç¬¦åˆæ¢ä»¶çš„Policy: {{ filtered_policies | length }} å€‹
          {% if enabled_count != total_policies %}
          - ç™¼ç¾ {{ total_policies | int - enabled_count | int }} å€‹å·²åœç”¨çš„Policy
          {% endif %}
          
          {% if export_to_file | default(false) | bool %}
          ğŸ“ åŒ¯å‡ºæª”æ¡ˆ:
          - policy_analysis_{{ ansible_date_time.epoch }}.csv (CSVæ ¼å¼è³‡æ–™)
          - policy_review_report_{{ ansible_date_time.epoch }}.txt (è©³ç´°å ±å‘Š)
          
          è«‹åˆ°AWX Jobçš„Artifactså€å¡Šä¸‹è¼‰æª”æ¡ˆ
          {% endif %}
          
          ğŸ’¡ å¾ŒçºŒå»ºè­°:
          1. å¯©æŸ¥åŒ¯å‡ºçš„Policyæ¸…å–®
          2. è­˜åˆ¥ä¸å¿…è¦æˆ–éæ™‚çš„Policy
          3. è©•ä¼°Policyæ•´åˆçš„å¯èƒ½æ€§  
          4. åœ¨ç¶­è­·æ™‚é–“åŸ·è¡Œå¿…è¦çš„è®Šæ›´
          
          âš ï¸ é‡è¦æé†’: ä»»ä½•Policyè®Šæ›´éƒ½æ‡‰å…ˆæ¸¬è©¦ä¸¦åšå¥½å›å¾©æº–å‚™
