---
- name: Query FortiGate Unused Firewall Policies (Optimized)
  hosts: localhost
  gather_facts: false
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"
    current_timestamp: "{{ ansible_date_time.epoch | int }}"
    threshold_timestamp: "{{ (current_timestamp | int) - ((months_threshold | default('6') | int) * 30 * 24 * 3600) }}"

  tasks:
    # =================== å®‰å…¨æª¢æŸ¥ ===================
    - name: å®‰å…¨æé†’ - æ­¤playbookç‚ºåªè®€æ¨¡å¼
      debug:
        msg: "ğŸ” é–‹å§‹æŸ¥è©¢FortiGateæœªä½¿ç”¨çš„Policy (åªè®€æ¨¡å¼)"

    # =================== è³‡æ–™æ”¶é›†éšæ®µ ===================
    - name: æŸ¥è©¢æ‰€æœ‰Firewall Policyè¨­å®š
      uri:
        url: "{{ fortigate_api_url }}/api/v2/cmdb/firewall/{{ policy_type | default('policy') }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('60') | int }}"
      register: policy_config_result
      retries: "{{ fortigate_api_retries | default('3') | int }}"
      delay: "{{ fortigate_api_delay | default('5') | int }}"

    - name: é¡¯ç¤ºPolicyæŸ¥è©¢é€²åº¦
      debug:
        msg: "âœ… æ‰¾åˆ° {{ policy_config_result.json.results | length }} å€‹Policyï¼Œé–‹å§‹åˆ†æ..."

    # =================== ä½¿ç”¨Pythonè…³æœ¬è™•ç†è³‡æ–™ ===================
    - name: å‰µå»ºè‡¨æ™‚Pythonè…³æœ¬
      copy:
        content: |
          #!/usr/bin/env python3
          import json
          import sys
          from datetime import datetime
          
          def main():
              # å¾ç’°å¢ƒè®Šæ•¸è®€å–è³‡æ–™
              configs_str = """{{ policy_config_result.json.results | to_json }}"""
              threshold = {{ threshold_timestamp }}
              current_time = {{ current_timestamp }}
              include_never = {{ include_never_used | default(true) | to_json }}
              months_threshold = {{ months_threshold | default('6') }}
              
              try:
                  configs = json.loads(configs_str)
              except:
                  print(json.dumps({"error": "Failed to parse config data"}))
                  return
              
              unused_policies = []
              summary = {
                  'total': len(configs),
                  'enabled': 0,
                  'unused_long_term': 0,
                  'unused_never': 0,
                  'total_unused': 0
              }
              
              for config in configs:
                  policy_id = str(config.get('policyid', ''))
                  is_enabled = config.get('status', 'enable') == 'enable'
                  
                  if is_enabled:
                      summary['enabled'] += 1
                  
                  # ç°¡åŒ–ç‰ˆï¼šå‡è¨­æ²’æœ‰çµ±è¨ˆè³‡æ–™ï¼Œæ‰€æœ‰Policyéƒ½ç®—"å¾æœªä½¿ç”¨"
                  # åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œæ‚¨éœ€è¦å–®ç¨æŸ¥è©¢çµ±è¨ˆè³‡æ–™
                  last_used = 0
                  hit_count = 0
                  is_never_used = True
                  is_old_unused = False
                  
                  # åˆ¤æ–·æ˜¯å¦ç‚ºæœªä½¿ç”¨
                  is_unused = is_old_unused or (is_never_used and include_never)
                  
                  if is_unused:
                      days_ago = -1  # è¡¨ç¤ºå¾æœªä½¿ç”¨
                      
                      policy_data = {
                          'policy_id': policy_id,
                          'name': config.get('name', f'Policy_{policy_id}'),
                          'status': config.get('status', 'enable'),
                          'action': config.get('action', 'accept'),
                          'srcintf': ','.join(config.get('srcintf', [])),
                          'dstintf': ','.join(config.get('dstintf', [])),
                          'srcaddr': ','.join(config.get('srcaddr', [])),
                          'dstaddr': ','.join(config.get('dstaddr', [])),
                          'service': ','.join(config.get('service', [])),
                          'comments': config.get('comments', ''),
                          'last_used': last_used,
                          'last_used_readable': 'Never',
                          'hit_count': hit_count,
                          'days_since_last_used': days_ago,
                          'is_never_used': is_never_used,
                          'is_enabled': is_enabled
                      }
                      
                      unused_policies.append(policy_data)
                      summary['total_unused'] += 1
                      summary['unused_never'] += 1
              
              result = {
                  'unused_policies': unused_policies,
                  'summary': summary
              }
              
              print(json.dumps(result))
          
          if __name__ == "__main__":
              main()
        dest: "/tmp/analyze_policies.py"
        mode: '0755'

    - name: åŸ·è¡ŒPolicyåˆ†æè…³æœ¬
      command: python3 /tmp/analyze_policies.py
      register: analysis_output

    - name: è§£æåˆ†æçµæœ
      set_fact:
        analysis_result: "{{ analysis_output.stdout | from_json }}"

    # =================== ç°¡åŒ–ç‰ˆï¼šé€å€‹æŸ¥è©¢çµ±è¨ˆï¼ˆå¯é¸ï¼‰ ===================
    - name: æŸ¥è©¢å‰5å€‹Policyçš„çµ±è¨ˆè³‡æ–™ä½œç‚ºç¤ºä¾‹
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/firewall/policy/select"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
          policyid: "{{ item.policyid }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('15') | int }}"
        status_code: [200, 424]
      register: sample_stats
      loop: "{{ policy_config_result.json.results[:5] }}"
      failed_when: false
      no_log: true
      when: 
        - policy_config_result.json.results | length > 0
        - detailed_analysis | default(false) | bool

    # =================== æ‡‰ç”¨ç°¡å–®éæ¿¾æ¢ä»¶ ===================
    - name: æ‡‰ç”¨åŸºæœ¬éæ¿¾æ¢ä»¶
      set_fact:
        filtered_policies: "{{ final_filtered }}"
      vars:
        exclude_ids: "{{ filter_options.exclude_policy_ids | default([]) | map('string') | list }}"
        min_id_str: "{{ filter_options.min_policy_id | default('') }}"
        max_id_str: "{{ filter_options.max_policy_id | default('') }}"
        final_filtered: |
          [
          {% for policy in analysis_result.unused_policies %}
          {% set skip = false %}
          {% if exclude_ids and policy.policy_id in exclude_ids %}
          {% set skip = true %}
          {% endif %}
          {% if min_id_str != '' and policy.policy_id | int < min_id_str | int %}
          {% set skip = true %}
          {% endif %}
          {% if max_id_str != '' and policy.policy_id | int > max_id_str | int %}
          {% set skip = true %}
          {% endif %}
          {% if not include_disabled | default(false) and not policy.is_enabled %}
          {% set skip = true %}
          {% endif %}
          {% if not skip %}
          {{ policy | to_json }}{% if not loop.last %},{% endif %}
          {% endif %}
          {% endfor %}
          ]

    # =================== çµæœæ‘˜è¦ ===================
    - name: é¡¯ç¤ºåˆ†ææ‘˜è¦
      debug:
        msg: |
          ========= FortiGate Policy åˆ†ææ‘˜è¦ =========
          VDOM: {{ vdom_name | default('root') }}
          
          ğŸ“Š çµ±è¨ˆçµæœ:
          - ç¸½Policyæ•¸é‡: {{ analysis_result.summary.total }}
          - å•Ÿç”¨çš„Policy: {{ analysis_result.summary.enabled }}
          - æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„Policy: {{ filtered_policies | length }}
          
          âš ï¸ æ³¨æ„: æ­¤æŸ¥è©¢åŸºæ–¼Policyè¨­å®šï¼ŒæœªåŒ…å«è©³ç´°ä½¿ç”¨çµ±è¨ˆ
          {% if not detailed_analysis | default(false) %}
          å¦‚éœ€è©³ç´°çµ±è¨ˆåˆ†æï¼Œè«‹è¨­å®š detailed_analysis: true
          {% endif %}
          ==========================================

    # =================== é¡¯ç¤ºPolicyåˆ—è¡¨ï¼ˆé™åˆ¶é¡¯ç¤ºæ•¸é‡ï¼‰ ===================
    - name: é¡¯ç¤ºPolicyæ¸…å–®ï¼ˆå‰20ç­†ï¼‰
      debug:
        msg: |
          ========= Policy æ¸…å–® (å‰20ç­†) =========
          {% for policy in filtered_policies[:20] %}
          {{ "%2d" | format(loop.index) }}. Policy {{ policy.policy_id }}: {{ policy.name }}
              ç‹€æ…‹: {{ policy.status }} | å‹•ä½œ: {{ policy.action }}
              ä¾†æº: {{ policy.srcintf }} -> {{ policy.dstintf }}
              åœ°å€: {{ policy.srcaddr }} -> {{ policy.dstaddr }}
              æœå‹™: {{ policy.service }}
              {% if policy.comments %}å‚™è¨»: {{ policy.comments }}{% endif %}
          {% endfor %}
          {% if filtered_policies | length > 20 %}
          
          âš ï¸ é‚„æœ‰ {{ filtered_policies | length - 20 }} ç­†Policyæœªé¡¯ç¤º
          å®Œæ•´æ¸…å–®è«‹æŸ¥çœ‹åŒ¯å‡ºçš„CSVæª”æ¡ˆ
          {% endif %}
          ======================================
      when: filtered_policies | length > 0

    # =================== æª”æ¡ˆåŒ¯å‡º ===================
    - name: å»ºç«‹artifactsç›®éŒ„
      file:
        path: "{{ playbook_dir }}/artifacts"
        state: directory
      when: export_to_file | default(false) | bool

    - name: åŒ¯å‡ºPolicyæ¸…å–®CSV
      copy:
        content: |
          # FortiGate Policy List - {{ ansible_date_time.iso8601 }}
          # VDOM: {{ vdom_name | default('root') }}
          # Total Policies: {{ analysis_result.summary.total }}
          # Listed Policies: {{ filtered_policies | length }}
          
          policy_id,name,status,action,srcintf,dstintf,srcaddr,dstaddr,service,comments
          {% for policy in filtered_policies %}
          {{ policy.policy_id }},"{{ policy.name | replace('"', '""') }}",{{ policy.status }},{{ policy.action }},"{{ policy.srcintf }}","{{ policy.dstintf }}","{{ policy.srcaddr }}","{{ policy.dstaddr }}","{{ policy.service }}","{{ policy.comments | replace('"', '""') }}"
          {% endfor %}
        dest: "{{ playbook_dir }}/artifacts/policy_list_{{ ansible_date_time.epoch }}.csv"
      when: export_to_file | default(false) | bool

    - name: ç”ŸæˆPolicyç®¡ç†è…³æœ¬
      copy:
        content: |
          # FortiGate Policy Management Script
          # Generated: {{ ansible_date_time.iso8601 }}
          # VDOM: {{ vdom_name | default('root') }}
          
          # âš ï¸ é‡è¦ï¼šæ­¤è…³æœ¬åƒ…ä¾›åƒè€ƒï¼Œè«‹äººå·¥å¯©æŸ¥å¾ŒåŸ·è¡Œ
          
          # === å‚™ä»½ç•¶å‰è¨­å®š ===
          execute backup config management-station comment "policy-review-{{ ansible_date_time.date }}"
          
          # === åœç”¨æŒ‡å®šPolicyï¼ˆè«‹æ ¹æ“šéœ€è¦é¸æ“‡åŸ·è¡Œï¼‰ ===
          config firewall policy
          {% for policy in filtered_policies[:10] %}
              # Policy {{ policy.policy_id }}: {{ policy.name }}
              # ä¾†æº: {{ policy.srcaddr }} -> ç›®çš„: {{ policy.dstaddr }}
              # edit {{ policy.policy_id }}
              #     set status disable
              #     set comments "{{ policy.comments }} [REVIEW-{{ ansible_date_time.date }}]"
              # next
          {% endfor %}
          end
          
          # === æª¢æŸ¥å‘½ä»¤ ===
          # æª¢æŸ¥Policyç‹€æ…‹
          show firewall policy
          
          # æª¢æŸ¥Policyçµ±è¨ˆ
          diagnose firewall iprope show 100000
        dest: "{{ playbook_dir }}/artifacts/policy_management_{{ ansible_date_time.epoch }}.cli"
        mode: '0644'
      when: 
        - export_to_file | default(false) | bool
        - filtered_policies | length > 0

    # =================== æ¸…ç†è‡¨æ™‚æª”æ¡ˆ ===================
    - name: æ¸…ç†è‡¨æ™‚è…³æœ¬
      file:
        path: "/tmp/analyze_policies.py"
        state: absent

    # =================== æœ€çµ‚å ±å‘Š ===================
    - name: æŸ¥è©¢å®Œæˆå ±å‘Š
      debug:
        msg: |
          ğŸ¯ PolicyæŸ¥è©¢å®Œæˆï¼
          
          ğŸ“ˆ çµæœæ‘˜è¦:
          - ç¸½Policyæ•¸é‡: {{ analysis_result.summary.total }}
          - å•Ÿç”¨Policyæ•¸é‡: {{ analysis_result.summary.enabled }}
          - ç¬¦åˆæ¢ä»¶Policy: {{ filtered_policies | length }}
          
          {% if export_to_file | default(false) | bool %}
          ğŸ“ åŒ¯å‡ºæª”æ¡ˆ:
          - policy_list_{{ ansible_date_time.epoch }}.csv
          - policy_management_{{ ansible_date_time.epoch }}.cli
          
          è«‹åˆ°AWX Jobçš„Artifactså€å¡Šä¸‹è¼‰æª”æ¡ˆ
          {% endif %}
          
          ğŸ’¡ å»ºè­°å¾ŒçºŒå‹•ä½œ:
          1. å¯©æŸ¥åŒ¯å‡ºçš„Policyæ¸…å–®
          2. è­˜åˆ¥ç¢ºå¯¦ä¸éœ€è¦çš„Policy
          3. åœ¨ç¶­è­·æ™‚é–“çª—å£æ¸¬è©¦åœç”¨
          4. è§€å¯Ÿå½±éŸ¿å¾Œæ±ºå®šæ˜¯å¦åˆªé™¤
          
          âš ï¸ æ‰€æœ‰è®Šæ›´è«‹å‹™å¿…äººå·¥ç¢ºèªå¾ŒåŸ·è¡Œ
