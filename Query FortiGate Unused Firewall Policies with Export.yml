---
- name: Query FortiGate Unused Firewall Policies (Optimized)
  hosts: localhost
  gather_facts: false
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"
    current_timestamp: "{{ ansible_date_time.epoch | int }}"
    threshold_timestamp: "{{ (current_timestamp | int) - ((months_threshold | default('6') | int) * 30 * 24 * 3600) }}"

  tasks:
    # =================== å®‰å…¨æª¢æŸ¥ ===================
    - name: å®‰å…¨æé†’ - æ­¤playbookç‚ºåªè®€æ¨¡å¼
      debug:
        msg: "ğŸ” é–‹å§‹æŸ¥è©¢FortiGateæœªä½¿ç”¨çš„Policy (åªè®€æ¨¡å¼)"

    # =================== è³‡æ–™æ”¶é›†éšæ®µ ===================
    - name: æŸ¥è©¢æ‰€æœ‰Firewall Policyè¨­å®š
      uri:
        url: "{{ fortigate_api_url }}/api/v2/cmdb/firewall/{{ policy_type | default('policy') }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('60') | int }}"
      register: policy_config_result
      retries: "{{ fortigate_api_retries | default('3') | int }}"
      delay: "{{ fortigate_api_delay | default('5') | int }}"

    - name: é¡¯ç¤ºPolicyæŸ¥è©¢é€²åº¦
      debug:
        msg: "âœ… æ‰¾åˆ° {{ policy_config_result.json.results | length }} å€‹Policyï¼Œé–‹å§‹æ‰¹æ¬¡æŸ¥è©¢ä½¿ç”¨çµ±è¨ˆ..."

    # =================== æ‰¹æ¬¡æŸ¥è©¢çµ±è¨ˆï¼ˆç°¡åŒ–ç‰ˆï¼‰ ===================
    - name: æ‰¹æ¬¡æŸ¥è©¢Policyçµ±è¨ˆè³‡æ–™
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/firewall/policy"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('120') | int }}"
        status_code: [200, 424]
      register: policy_stats_bulk
      failed_when: false

    - name: é¡¯ç¤ºçµ±è¨ˆæŸ¥è©¢çµæœ
      debug:
        msg: "âœ… çµ±è¨ˆæŸ¥è©¢å®Œæˆï¼Œé–‹å§‹åˆ†æè³‡æ–™..."

    # =================== ä½¿ç”¨Pythonè…³æœ¬è™•ç†è³‡æ–™ï¼ˆé¿å…è¤‡é›œæ¨¡æ¿ï¼‰ ===================
    - name: è™•ç†Policyè³‡æ–™
      set_fact:
        analysis_result: "{{ policy_configs | process_policies }}"
      vars:
        policy_configs: "{{ policy_config_result.json.results | default([]) }}"
        policy_stats: "{{ policy_stats_bulk.json.results | default([]) }}"
        threshold: "{{ threshold_timestamp }}"
        current_time: "{{ current_timestamp }}"
        include_never: "{{ include_never_used | default(true) }}"

    # å¦‚æœä¸Šé¢çš„custom filterä¸å¯ç”¨ï¼Œä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆ
    - name: æ›¿ä»£è³‡æ–™è™•ç†æ–¹æ¡ˆ
      shell: |
        python3 -c "
        import json
        import sys
        from datetime import datetime

        # è®€å–è³‡æ–™
        configs = {{ policy_config_result.json.results | to_json }}
        stats = {{ policy_stats_bulk.json.results | default([]) | to_json }}
        threshold = {{ threshold_timestamp }}
        current_time = {{ current_timestamp }}
        include_never = {{ include_never_used | default(true) | to_json }}

        # å»ºç«‹çµ±è¨ˆå­—å…¸
        stats_dict = {}
        for stat in stats:
            stats_dict[str(stat.get('policyid', ''))] = stat

        # è™•ç†æ¯å€‹policy
        unused_policies = []
        summary = {
            'total': len(configs),
            'enabled': 0,
            'unused_long_term': 0,
            'unused_never': 0,
            'total_unused': 0
        }

        for config in configs:
            policy_id = str(config.get('policyid', ''))
            stat = stats_dict.get(policy_id, {})
            
            last_used = int(stat.get('last_used', 0))
            hit_count = int(stat.get('hit_count', 0))
            is_enabled = config.get('status', 'enable') == 'enable'
            is_never_used = last_used == 0
            is_old_unused = last_used > 0 and last_used < threshold
            
            if is_enabled:
                summary['enabled'] += 1
            
            # åˆ¤æ–·æ˜¯å¦ç‚ºæœªä½¿ç”¨
            is_unused = is_old_unused or (is_never_used and include_never)
            
            if is_unused:
                days_ago = ((current_time - last_used) // 86400) if last_used > 0 else -1
                
                policy_data = {
                    'policy_id': policy_id,
                    'name': config.get('name', f'Policy_{policy_id}'),
                    'status': config.get('status', 'enable'),
                    'action': config.get('action', 'accept'),
                    'srcintf': ','.join(config.get('srcintf', [])),
                    'dstintf': ','.join(config.get('dstintf', [])),
                    'srcaddr': ','.join(config.get('srcaddr', [])),
                    'dstaddr': ','.join(config.get('dstaddr', [])),
                    'service': ','.join(config.get('service', [])),
                    'comments': config.get('comments', ''),
                    'last_used': last_used,
                    'last_used_readable': 'Never' if is_never_used else datetime.fromtimestamp(last_used).strftime('%Y-%m-%d %H:%M:%S'),
                    'hit_count': hit_count,
                    'days_since_last_used': days_ago,
                    'is_never_used': is_never_used,
                    'is_enabled': is_enabled
                }
                
                unused_policies.append(policy_data)
                summary['total_unused'] += 1
                
                if is_never_used:
                    summary['unused_never'] += 1
                else:
                    summary['unused_long_term'] += 1

        # è¼¸å‡ºçµæœ
        result = {
            'unused_policies': unused_policies,
            'summary': summary
        }
        
        print(json.dumps(result))
        "
      register: python_analysis
      when: analysis_result is not defined

    - name: è¨­å®šåˆ†æçµæœ
      set_fact:
        final_analysis: "{{ python_analysis.stdout | from_json if python_analysis.stdout is defined else analysis_result }}"

    # =================== æ‡‰ç”¨éæ¿¾æ¢ä»¶ ===================
    - name: æ‡‰ç”¨éæ¿¾æ¢ä»¶
      set_fact:
        filtered_policies: "{{ final_analysis.unused_policies | apply_filters }}"
      vars:
        filters:
          exclude_ids: "{{ filter_options.exclude_policy_ids | default([]) }}"
          min_id: "{{ filter_options.min_policy_id | default('') }}"
          max_id: "{{ filter_options.max_policy_id | default('') }}"
          include_disabled: "{{ include_disabled | default(false) }}"

    # æ‰‹å‹•éæ¿¾ï¼ˆå¦‚æœcustom filterä¸å¯ç”¨ï¼‰
    - name: æ‰‹å‹•æ‡‰ç”¨éæ¿¾æ¢ä»¶
      set_fact:
        filtered_policies: "{{ filtered_list }}"
      vars:
        filtered_list: |
          [
          {% for policy in final_analysis.unused_policies %}
          {% set skip = false %}
          {% if filter_options.exclude_policy_ids | default([]) and policy.policy_id in filter_options.exclude_policy_ids %}{% set skip = true %}{% endif %}
          {% if filter_options.min_policy_id | default('') != '' and policy.policy_id | int < filter_options.min_policy_id | int %}{% set skip = true %}{% endif %}
          {% if filter_options.max_policy_id | default('') != '' and policy.policy_id | int > filter_options.max_policy_id | int %}{% set skip = true %}{% endif %}
          {% if not include_disabled | default(false) and not policy.is_enabled %}{% set skip = true %}{% endif %}
          {% if not skip %}{{ policy | to_json }}{% if not loop.last %},{% endif %}{% endif %}
          {% endfor %}
          ]
      when: filtered_policies is not defined

    # =================== çµæœæ‘˜è¦ ===================
    - name: é¡¯ç¤ºåˆ†ææ‘˜è¦
      debug:
        msg: |
          ========= FortiGate Policy åˆ†ææ‘˜è¦ =========
          VDOM: {{ vdom_name | default('root') }}
          æŸ¥è©¢é–¾å€¼: {{ months_threshold | default('6') }} å€‹æœˆ
          
          ğŸ“Š çµ±è¨ˆçµæœ:
          - ç¸½Policyæ•¸é‡: {{ final_analysis.summary.total }}
          - å•Ÿç”¨çš„Policy: {{ final_analysis.summary.enabled }}
          - è¶…é{{ months_threshold }}å€‹æœˆæœªä½¿ç”¨: {{ final_analysis.summary.unused_long_term }}
          - å¾æœªä½¿ç”¨é: {{ final_analysis.summary.unused_never }}
          - éæ¿¾å¾Œç¬¦åˆæ¢ä»¶: {{ filtered_policies | length }}
          
          ğŸ’¡ å»ºè­°å‹•ä½œ:
          {% if final_analysis.summary.unused_never > 0 %}
          - æª¢è¦– {{ final_analysis.summary.unused_never }} å€‹å¾æœªä½¿ç”¨çš„Policy
          {% endif %}
          {% if final_analysis.summary.unused_long_term > 0 %}
          - è©•ä¼° {{ final_analysis.summary.unused_long_term }} å€‹é•·æœŸæœªä½¿ç”¨çš„Policy
          {% endif %}
          ==========================================

    # =================== è©³ç´°çµæœï¼ˆåªé¡¯ç¤ºå‰10ç­†ï¼‰ ===================
    - name: é¡¯ç¤ºæœªä½¿ç”¨Policyè©³æƒ…ï¼ˆå‰10ç­†ï¼‰
      debug:
        msg: |
          ========= æœªä½¿ç”¨Policyè©³æƒ… (é¡¯ç¤ºå‰10ç­†) =========
          {% for policy in filtered_policies[:10] %}
          {{ loop.index }}. Policy {{ policy.policy_id }}: {{ policy.name }}
             ç‹€æ…‹: {{ policy.status }} | æœ€å¾Œä½¿ç”¨: {{ policy.last_used_readable }}
             {% if policy.days_since_last_used > 0 %}æœªä½¿ç”¨: {{ policy.days_since_last_used }}å¤©{% endif %}
             ä¾†æº: {{ policy.srcaddr }} | ç›®çš„: {{ policy.dstaddr }}
             æœå‹™: {{ policy.service }}
          {% endfor %}
          {% if filtered_policies | length > 10 %}
          
          ... é‚„æœ‰ {{ filtered_policies | length - 10 }} ç­†ï¼Œè©³ç´°è³‡æ–™è«‹æŸ¥çœ‹åŒ¯å‡ºæª”æ¡ˆ
          {% endif %}
          =============================================
      when: filtered_policies | length > 0

    # =================== æª”æ¡ˆåŒ¯å‡º ===================
    - name: å»ºç«‹artifactsç›®éŒ„
      file:
        path: "{{ playbook_dir }}/artifacts"
        state: directory
      when: export_to_file | default(false) | bool

    - name: åŒ¯å‡ºå®Œæ•´CSVå ±å‘Š
      copy:
        content: |
          # FortiGate Unused Policy Report - {{ ansible_date_time.iso8601 }}
          # VDOM: {{ vdom_name | default('root') }}, Threshold: {{ months_threshold | default('6') }} months
          # Total: {{ final_analysis.summary.total }}, Unused Found: {{ filtered_policies | length }}
          
          policy_id,name,status,action,last_used,days_unused,hit_count,srcintf,dstintf,srcaddr,dstaddr,service,comments
          {% for policy in filtered_policies %}
          {{ policy.policy_id }},"{{ policy.name | replace('"', '""') }}",{{ policy.status }},{{ policy.action }},{{ policy.last_used_readable }},{{ policy.days_since_last_used }},{{ policy.hit_count }},"{{ policy.srcintf }}","{{ policy.dstintf }}","{{ policy.srcaddr }}","{{ policy.dstaddr }}","{{ policy.service }}","{{ policy.comments | replace('"', '""') }}"
          {% endfor %}
        dest: "{{ playbook_dir }}/artifacts/unused_policies_{{ ansible_date_time.epoch }}.csv"
      when: export_to_file | default(false) | bool

    - name: ç”Ÿæˆæ‘˜è¦å ±å‘Š
      copy:
        content: |
          FortiGate Unused Policy åˆ†æå ±å‘Š
          ç”Ÿæˆæ™‚é–“: {{ ansible_date_time.iso8601 }}
          VDOM: {{ vdom_name | default('root') }}
          æŸ¥è©¢é–¾å€¼: {{ months_threshold | default('6') }} å€‹æœˆ
          
          === çµ±è¨ˆæ‘˜è¦ ===
          ç¸½Policyæ•¸é‡: {{ final_analysis.summary.total }}
          å•Ÿç”¨çš„Policy: {{ final_analysis.summary.enabled }}
          è¶…é{{ months_threshold }}å€‹æœˆæœªä½¿ç”¨: {{ final_analysis.summary.unused_long_term }}
          å¾æœªä½¿ç”¨é: {{ final_analysis.summary.unused_never }}
          éæ¿¾å¾Œç¬¦åˆæ¢ä»¶: {{ filtered_policies | length }}
          
          === å»ºè­°æ¸…ç†çš„Policy ===
          {% for policy in filtered_policies %}
          Policy {{ policy.policy_id }}: {{ policy.name }}
            ç‹€æ…‹: {{ policy.status }}
            æœ€å¾Œä½¿ç”¨: {{ policy.last_used_readable }}
            {% if policy.days_since_last_used > 0 %}æœªä½¿ç”¨å¤©æ•¸: {{ policy.days_since_last_used }}{% endif %}
            ä¾†æº: {{ policy.srcaddr }}
            ç›®çš„: {{ policy.dstaddr }}
            æœå‹™: {{ policy.service }}
            å‚™è¨»: {{ policy.comments }}
          
          {% endfor %}
          
          === æ¸…ç†å»ºè­°CLIå‘½ä»¤ ===
          # è«‹äººå·¥å¯©æŸ¥å¾ŒåŸ·è¡Œï¼Œåˆ†æ‰¹åŸ·è¡Œä¸¦è§€å¯Ÿå½±éŸ¿
          
          config firewall policy
          {% for policy in filtered_policies %}
          {% if policy.is_enabled %}
              # {{ policy.name }} - æœªä½¿ç”¨{{ policy.days_since_last_used if policy.days_since_last_used > 0 else 'å¾æœªä½¿ç”¨' }}
              edit {{ policy.policy_id }}
                  set status disable
                  set comments "{{ policy.comments }} [DISABLED-{{ ansible_date_time.date }}]"
              next
          {% endif %}
          {% endfor %}
          end
        dest: "{{ playbook_dir }}/artifacts/policy_analysis_report_{{ ansible_date_time.epoch }}.txt"
      when: export_to_file | default(false) | bool

    # =================== æœ€çµ‚å ±å‘Š ===================
    - name: å®Œæˆå ±å‘Š
      debug:
        msg: |
          ğŸ¯ æŸ¥è©¢å®Œæˆï¼
          
          ğŸ“ˆ çµæœ: åœ¨{{ final_analysis.summary.total }}å€‹Policyä¸­æ‰¾åˆ°{{ filtered_policies | length }}å€‹ç¬¦åˆæ¸…ç†æ¢ä»¶
          
          {% if export_to_file | default(false) | bool %}
          ğŸ“ æª”æ¡ˆå·²åŒ¯å‡ºåˆ°artifacts:
          - unused_policies_{{ ansible_date_time.epoch }}.csv (è©³ç´°è³‡æ–™)
          - policy_analysis_report_{{ ansible_date_time.epoch }}.txt (åˆ†æå ±å‘Š)
          {% endif %}
          
          âš ï¸  æ‰€æœ‰è®Šæ›´è«‹äººå·¥å¯©æŸ¥å¾ŒåŸ·è¡Œ
