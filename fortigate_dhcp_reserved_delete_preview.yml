---
# =============================================================================
# FortiGate DHCP Reserved Address Delete Preview Playbook
# 
# åŠŸèƒ½èªªæ˜ï¼š
# 1. æ ¹æ“šMACåœ°å€æœå°‹æ—¢æœ‰DHCP reserved-addressé…ç½®
# 2. é¡¯ç¤ºå³å°‡è¢«åˆªé™¤/é‚„åŸçš„é…ç½®è©³æƒ…
# 3. è¨ˆç®—é‚„åŸå¾Œçš„ä¿ç•™MACæ ¼å¼
# 4. åƒ…ä¾›é è¦½ï¼Œä¸åŸ·è¡Œä»»ä½•è®Šæ›´æ“ä½œ
# 
# ä½œè€…ï¼šVICI Network Team
# ç‰ˆæœ¬ï¼šv3.2 - PreviewåŠŸèƒ½ï¼ˆç”¨æ–¼Workflowï¼‰
# =============================================================================

- name: FortiGate DHCP Delete Preview - Step 1
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # =======================================================================
    # è®Šæ•¸å®šç¾©å€
    # =======================================================================
    
    # ç”¨æˆ¶è¼¸å…¥åƒæ•¸ï¼ˆå¾AWX Surveyç²å–ï¼‰  
    delete_mac: "{{ delete_mac_param }}"
    
    # FortiGateç³»çµ±åƒæ•¸
    dhcp_server_id: "{{ server_id | default('3') }}"
    
    # FortiGateé€£æ¥åƒæ•¸ï¼ˆå¾AWX Credentialè‡ªå‹•æ³¨å…¥ï¼‰
    fortigate_host: "{{ fortigate_host }}"
    fortigate_token: "{{ fortigate_access_token }}"
    vdom_name: "{{ fortigate_vdom | default('root') }}"
    
  tasks:
    # =======================================================================
    # æ­¥é©Ÿ1ï¼šåƒæ•¸é©—è­‰
    # =======================================================================
    
    - name: "ğŸ” Validate AWX Credential Parameters"
      ansible.builtin.fail:
        msg: |
          âŒ ç¼ºå°‘å¿…è¦çš„FortiGate Credentialåƒæ•¸ï¼è«‹ç¢ºä¿å·²æ­£ç¢ºè¨­å®šFortiGate Credentialã€‚
      when: fortigate_host is not defined or fortigate_token is not defined

    - name: "ğŸ“‹ Display Preview Parameters"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ“‹ FortiGate DHCP Delete Preview
          ==========================================
          ğŸ” é è¦½æ¨¡å¼ï¼šåƒ…é¡¯ç¤ºé…ç½®ï¼Œä¸åŸ·è¡Œè®Šæ›´
          ğŸ—‘ï¸ è¦æª¢æŸ¥çš„MACåœ°å€: {{ delete_mac }}
          ğŸ·ï¸  DHCP Server ID: {{ dhcp_server_id }}
          ğŸŒ FortiGate Host: {{ fortigate_host }}
          ğŸ  VDOM: {{ vdom_name }}
          ==========================================

    # =======================================================================
    # æ­¥é©Ÿ2ï¼šç²å–ç•¶å‰DHCPé…ç½®
    # =======================================================================
    
    - name: "ğŸ” Get Current DHCP Reserved Addresses"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: false
        status_code: 200
      register: existing_reservations

    - name: "ğŸ“Š Display All Current Configurations"
      ansible.builtin.debug:
        msg: |
          ğŸ“‹ ç•¶å‰DHCP Server {{ dhcp_server_id }} æ‰€æœ‰é…ç½®ï¼š
          {% if existing_reservations.json.results | length > 0 %}
          {% for addr in existing_reservations.json.results %}
          - ID: {{ addr.id }}, IP: {{ addr.ip }}, MAC: {{ addr.mac }}, æè¿°: {{ addr.description | default('ç„¡') }}
          {% endfor %}
          {% else %}
          ï¼ˆç›®å‰æ²’æœ‰ä»»ä½•reserved-addressé…ç½®ï¼‰
          {% endif %}

    # =======================================================================
    # æ­¥é©Ÿ3ï¼šæœå°‹ç›®æ¨™MAC
    # =======================================================================

    - name: "ğŸ” Search for Target MAC Address"
      ansible.builtin.set_fact:
        target_object: "{{ item }}"
      loop: "{{ existing_reservations.json.results }}"
      when:
        - target_object is not defined
        - item.mac.lower() == delete_mac.lower()
      loop_control:
        label: "æœå°‹ MAC {{ item.mac }}"

    - name: "âŒ MAC Not Found - Cannot Proceed"
      ansible.builtin.fail:
        msg: |
          âŒâŒâŒ é è¦½å¤±æ•—ï¼šæœªæ‰¾åˆ°æŒ‡å®šçš„MACåœ°å€ï¼âŒâŒâŒ
          
          ğŸ” æœå°‹çš„MAC: {{ delete_mac }}
          ğŸ“‹ åœ¨DHCP Server {{ dhcp_server_id }} ä¸­æœªæ‰¾åˆ°æ­¤MAC
          
          ğŸ’¡ è«‹æª¢æŸ¥ï¼š
          1. MACåœ°å€æ ¼å¼æ˜¯å¦æ­£ç¢º (XX:XX:XX:XX:XX:XX)
          2. MACåœ°å€æ˜¯å¦ç¢ºå¯¦å­˜åœ¨
          3. DHCP Server IDæ˜¯å¦æ­£ç¢º
          
          ğŸ“‹ ç•¶å‰å­˜åœ¨çš„MACåœ°å€ï¼š
          {% if existing_reservations.json.results | length > 0 %}
          {% for addr in existing_reservations.json.results %}
          - {{ addr.mac }} (IP: {{ addr.ip }})
          {% endfor %}
          {% else %}
          (ç„¡ä»»ä½•é…ç½®)
          {% endif %}
          
          âš ï¸ Workflowå°‡åœæ­¢ï¼Œä¸æœƒç¹¼çºŒåŸ·è¡Œåˆªé™¤æ“ä½œ
      when: target_object is not defined

    # =======================================================================
    # æ­¥é©Ÿ4ï¼šè¨ˆç®—é‚„åŸé…ç½®
    # =======================================================================

    - name: "ğŸ§® Calculate Reserved Configuration"
      ansible.builtin.set_fact:
        ip_fourth_octet: "{{ target_object.ip.split('.')[3] }}"
        reserved_mac: "ff:ff:ff:ff:f1:{{ '%02d' | format(target_object.ip.split('.')[3] | int) }}"
      when: target_object is defined

    # =======================================================================
    # æ­¥é©Ÿ5ï¼šé¡¯ç¤ºè©³ç´°é è¦½ä¿¡æ¯
    # =======================================================================

    - name: "ğŸ“‹ Display Delete Preview Details"
      ansible.builtin.debug:
        msg: |
          âœ…âœ…âœ… æ‰¾åˆ°ç›®æ¨™MACé…ç½®ï¼âœ…âœ…âœ…
          
          ==========================================
          ğŸ“Š åˆªé™¤æ“ä½œé è¦½
          ==========================================
          
          ğŸ¯ æ‰¾åˆ°çš„é…ç½®ï¼š
          - é…ç½®ID: {{ target_object.id }}
          - IPåœ°å€: {{ target_object.ip }}
          - ç•¶å‰MAC: {{ target_object.mac }}
          - ç•¶å‰æè¿°: {{ target_object.description | default('(ç©ºç™½)') }}
          
          ğŸ”„ åŸ·è¡Œåˆªé™¤å¾Œçš„é…ç½®ï¼š
          - é…ç½®ID: {{ target_object.id }} (ä¸è®Š)
          - IPåœ°å€: {{ target_object.ip }} (ä¸è®Š)
          - é‚„åŸå¾ŒMAC: {{ reserved_mac }}
          - é‚„åŸå¾Œæè¿°: Reserved
          
          ğŸ“ é‚„åŸè¦å‰‡èªªæ˜ï¼š
          1. IPåœ°å€ä¿æŒä¸è®Š: {{ target_object.ip }}
          2. MACåœ°å€é‚„åŸè¦å‰‡: ff:ff:ff:ff:f1:{{ '%02d' | format(ip_fourth_octet | int) }}
             - IPç¬¬å››æ®µ: {{ ip_fourth_octet }}
             - å°æ‡‰MAC: {{ reserved_mac }}
          3. æè¿°çµ±ä¸€è¨­ç‚º: Reserved
          
          âš ï¸ æ­¤æ“ä½œå°‡æ°¸ä¹…ä¿®æ”¹FortiGateé…ç½®ï¼
          ==========================================

    - name: "ğŸ“¢ Next Step Instructions"
      ansible.builtin.debug:
        msg: |
          ğŸš€ğŸš€ğŸš€ é è¦½å®Œæˆï¼Œæº–å‚™åŸ·è¡Œç¢ºèª ğŸš€ğŸš€ğŸš€
          
          ğŸ“‹ ä¸‹ä¸€æ­¥èªªæ˜ï¼š
          1. âœ… é è¦½å·²å®Œæˆï¼ŒæœªåŸ·è¡Œä»»ä½•è®Šæ›´
          2. ğŸ” è«‹ä»”ç´°æª¢æŸ¥ä¸Šè¿°é…ç½®ä¿¡æ¯
          3. âš ï¸ å¦‚æœç¢ºèªè¦åŸ·è¡Œåˆªé™¤æ“ä½œï¼ŒWorkflowå°‡è‡ªå‹•ç¹¼çºŒ
          4. ğŸš« å¦‚æœä¸æƒ³åŸ·è¡Œï¼Œè«‹æ‰‹å‹•åœæ­¢Workflow
          
          ğŸ’¡ æé†’ï¼š
          - MAC {{ delete_mac }} å°‡è¢«é‚„åŸç‚º {{ reserved_mac }}
          - æè¿°å°‡å¾ "{{ target_object.description | default('(ç©ºç™½)') }}" æ”¹ç‚º "Reserved"
          - IP {{ target_object.ip }} ä¿æŒä¸è®Š
          
          ğŸ¯ æº–å‚™å‚³éåƒæ•¸çµ¦åŸ·è¡Œæ­¥é©Ÿ...

    # =======================================================================
    # æ­¥é©Ÿ6ï¼šè¨­å®šWorkflowè®Šæ•¸ï¼ˆå‚³éçµ¦ä¸‹ä¸€æ­¥ï¼‰
    # =======================================================================

    - name: "ğŸ“¤ Set Workflow Variables for Next Step"
      ansible.builtin.set_stats:
        data:
          # å‚³éçµ¦ä¸‹ä¸€å€‹Job Templateçš„è®Šæ•¸
          confirmed_delete_mac: "{{ delete_mac }}"
          confirmed_target_id: "{{ target_object.id }}"
          confirmed_target_ip: "{{ target_object.ip }}"
          confirmed_reserved_mac: "{{ reserved_mac }}"
          confirmed_original_mac: "{{ target_object.mac }}"
          confirmed_original_description: "{{ target_object.description | default('') }}"
          confirmed_server_id: "{{ dhcp_server_id }}"
          preview_completed: "yes"
