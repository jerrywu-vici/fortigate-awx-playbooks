---
- name: FortiGate DHCP Delete Preview for Workflow
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    delete_mac: "{{ delete_mac_param }}"
    dhcp_server_id: "{{ server_id | default('3') }}"
    fortigate_host: "{{ fortigate_host }}"
    fortigate_token: "{{ fortigate_access_token }}"
    vdom_name: "{{ fortigate_vdom | default('root') }}"
    
  tasks:
    - name: "ğŸ” Get Current DHCP Reserved Addresses"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: false
        status_code: 200
      register: existing_reservations

    - name: "ğŸ” Search for Target MAC"
      ansible.builtin.set_fact:
        target_object: "{{ item }}"
      loop: "{{ existing_reservations.json.results }}"
      when:
        - target_object is not defined
        - item.mac.lower() == delete_mac.lower()

    - name: "âŒ MAC Not Found"
      ansible.builtin.fail:
        msg: "æœªæ‰¾åˆ°MAC: {{ delete_mac }}"
      when: target_object is not defined

    - name: "ğŸ§® Calculate Reserved MAC"
      ansible.builtin.set_fact:
        reserved_mac: "ff:ff:ff:ff:f1:{{ '%02d' | format(target_object.ip.split('.')[3] | int) }}"

    - name: "ğŸ“‹ Display Preview Information"
      ansible.builtin.debug:
        msg: |
          âœ… æ‰¾åˆ°è¦åˆªé™¤çš„MACé…ç½®ï¼š
          
          ğŸ“Š ç•¶å‰é…ç½®ï¼š
          - ID: {{ target_object.id }}
          - IP: {{ target_object.ip }}
          - MAC: {{ target_object.mac }}
          - æè¿°: {{ target_object.description | default('ç„¡') }}
          
          ğŸ”„ åˆªé™¤å¾Œå°‡è®Šç‚ºï¼š
          - IP: {{ target_object.ip }} (ä¸è®Š)
          - MAC: {{ reserved_mac }}
          - æè¿°: Reserved

    # é‡è¦ï¼šè¨­å®šworkflowè®Šæ•¸ä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
    - name: "ğŸ“¤ Set Workflow Variables"
      ansible.builtin.set_stats:
        data:
          wf_target_id: "{{ target_object.id }}"
          wf_target_ip: "{{ target_object.ip }}"  
          wf_original_mac: "{{ target_object.mac }}"
          wf_reserved_mac: "{{ reserved_mac }}"
          wf_original_desc: "{{ target_object.description | default('') }}"
          wf_server_id: "{{ dhcp_server_id }}"
          wf_delete_mac: "{{ delete_mac }}"
