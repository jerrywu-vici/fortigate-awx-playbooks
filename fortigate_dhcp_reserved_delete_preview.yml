---
- name: FortiGate DHCP Delete Preview for Workflow v3.3
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    delete_mac: "{{ delete_mac_param }}"
    dhcp_server_id: "{{ server_id | default('3') }}"
    fortigate_host: "{{ fortigate_host }}"
    fortigate_token: "{{ fortigate_access_token }}"
    vdom_name: "{{ fortigate_vdom | default('root') }}"
    
  tasks:
    - name: "ğŸ” Validate Credentials"
      ansible.builtin.fail:
        msg: "ç¼ºå°‘FortiGate Credentialåƒæ•¸"
      when: fortigate_host is not defined or fortigate_token is not defined

    - name: "ğŸ“‹ Display Preview Parameters"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ“‹ FortiGate DHCP Delete é è¦½ v3.3
          ==========================================
          ğŸ” é è¦½æ¨¡å¼ï¼šé¡¯ç¤ºé…ç½®ï¼Œç­‰å¾…äººå·¥ç¢ºèª
          ğŸ—‘ï¸ ç›®æ¨™MAC: {{ delete_mac }}
          ğŸ·ï¸  DHCP Server ID: {{ dhcp_server_id }}
          ğŸŒ FortiGate Host: {{ fortigate_host }}
          ==========================================

    - name: "ğŸ” Get Current DHCP Reserved Addresses"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: false
        status_code: 200
      register: existing_reservations

    - name: "ğŸ“Š Display All Current Configurations"
      ansible.builtin.debug:
        msg: |
          ğŸ“‹ ç•¶å‰DHCP Server {{ dhcp_server_id }} æ‰€æœ‰é…ç½®ï¼š
          {% if existing_reservations.json.results | length > 0 %}
          {% for addr in existing_reservations.json.results %}
          - ID: {{ addr.id }}, IP: {{ addr.ip }}, MAC: {{ addr.mac }}, æè¿°: {{ addr.description | default('ç„¡') }}
          {% endfor %}
          {% else %}
          ï¼ˆç›®å‰æ²’æœ‰ä»»ä½•reserved-addressé…ç½®ï¼‰
          {% endif %}

    - name: "ğŸ” Search for Target MAC"
      ansible.builtin.set_fact:
        target_object: "{{ item }}"
      loop: "{{ existing_reservations.json.results }}"
      when:
        - target_object is not defined
        - item.mac.lower() == delete_mac.lower()
      loop_control:
        label: "æœå°‹ MAC {{ item.mac }}"

    - name: "âŒ MAC Not Found"
      ansible.builtin.fail:
        msg: |
          âŒâŒâŒ æœªæ‰¾åˆ°æŒ‡å®šçš„MACåœ°å€ï¼âŒâŒâŒ
          
          ğŸ” æœå°‹çš„MAC: {{ delete_mac }}
          ğŸ“‹ åœ¨DHCP Server {{ dhcp_server_id }} ä¸­æœªæ‰¾åˆ°æ­¤MAC
          
          ğŸ“‹ ç•¶å‰å­˜åœ¨çš„MACåœ°å€ï¼š
          {% if existing_reservations.json.results | length > 0 %}
          {% for addr in existing_reservations.json.results %}
          - {{ addr.mac }} (IP: {{ addr.ip }})
          {% endfor %}
          {% else %}
          (ç„¡ä»»ä½•é…ç½®)
          {% endif %}
      when: target_object is not defined

    - name: "ğŸ§® Calculate Reserved MAC Address (Final Corrected Version)"
      ansible.builtin.set_fact:
        ip_fourth_octet: "{{ target_object.ip.split('.')[3] }}"
        # IPç¬¬å››ç¢¼çš„ç¬¬ä¸€ä½æ•¸å­—
        first_digit: "{{ target_object.ip.split('.')[3][0] }}"
        # IPç¬¬å››ç¢¼çš„å¾Œå…©ä½æ•¸å­—  
        last_two_digits: "{{ target_object.ip.split('.')[3][1:] }}"
        # çµ„æˆæœ€çµ‚MAC: ff:ff:ff:ff:f{ç¬¬ä¸€ä½}:{å¾Œå…©ä½}
        reserved_mac: "ff:ff:ff:ff:f{{ target_object.ip.split('.')[3][0] }}:{{ target_object.ip.split('.')[3][1:] }}"
      when: target_object is defined

    - name: "ğŸ“‹ Display MAC Calculation Details"
      ansible.builtin.debug:
        msg: |
          ğŸ§® MACåœ°å€è¨ˆç®—è©³æƒ…ï¼ˆæ­£ç¢ºç‰ˆæœ¬ï¼‰ï¼š
          - å®Œæ•´IP: {{ target_object.ip }}
          - IPç¬¬å››ç¢¼: {{ ip_fourth_octet }} (ä¸‰ä½æ•¸å­—)
          - ç¬¬ä¸€ä½æ•¸å­—: {{ first_digit }}
          - å¾Œå…©ä½æ•¸å­—: {{ last_two_digits }}
          - æœ€çµ‚MAC: {{ reserved_mac }}
          
          ğŸ“ è¨ˆç®—è¦å‰‡é©—è­‰ï¼š
          - MACæ ¼å¼: ff:ff:ff:ff:fX:XX
          - X = IPç¬¬å››ç¢¼çš„ç¬¬ä¸€ä½æ•¸å­— ({{ first_digit }})
          - XX = IPç¬¬å››ç¢¼çš„å¾Œå…©ä½æ•¸å­— ({{ last_two_digits }})
          - ç¯„ä¾‹: IP 192.168.250.103 â†’ MAC ff:ff:ff:ff:f1:03

    - name: "ğŸ“Š Display Delete Preview"
      ansible.builtin.debug:
        msg: |
          âœ…âœ…âœ… æ‰¾åˆ°ç›®æ¨™MACé…ç½®ï¼âœ…âœ…âœ…
          
          ==========================================
          ğŸ“Š åˆªé™¤æ“ä½œé è¦½
          ==========================================
          
          ğŸ¯ ç•¶å‰é…ç½®ï¼š
          - é…ç½®ID: {{ target_object.id }}
          - IPåœ°å€: {{ target_object.ip }}
          - ç•¶å‰MAC: {{ target_object.mac }}
          - ç•¶å‰æè¿°: "{{ target_object.description | default('(ç©ºç™½)') }}"
          
          ğŸ”„ åˆªé™¤å¾Œé…ç½®ï¼š
          - é…ç½®ID: {{ target_object.id }} (ä¸è®Š)
          - IPåœ°å€: {{ target_object.ip }} (ä¸è®Š)
          - é‚„åŸMAC: {{ reserved_mac }}
          - é‚„åŸæè¿°: "Reserved"
          
          ğŸ“ é‚„åŸè¦å‰‡èªªæ˜ï¼š
          1. IPåœ°å€ä¿æŒä¸è®Š: {{ target_object.ip }}
          2. MACåœ°å€é‚„åŸè¦å‰‡: 
             - æ ¼å¼: ff:ff:ff:ff:fX:XX
             - IPç¬¬å››ç¢¼: {{ ip_fourth_octet }}
             - X = ç¬¬ä¸€ä½æ•¸å­—: {{ first_digit }}
             - XX = å¾Œå…©ä½æ•¸å­—: {{ last_two_digits }}
             - çµæœ: {{ reserved_mac }}
          3. æè¿°çµ±ä¸€è¨­ç‚º: "Reserved"
          
          âš ï¸ æ­¤æ“ä½œå°‡æ°¸ä¹…ä¿®æ”¹FortiGateé…ç½®ï¼
          ==========================================

    - name: "ğŸ“¤ Set Workflow Variables for Next Step"
      ansible.builtin.set_stats:
        data:
          wf_target_id: "{{ target_object.id }}"
          wf_target_ip: "{{ target_object.ip }}"
          wf_original_mac: "{{ target_object.mac }}"
          wf_reserved_mac: "{{ reserved_mac }}"
          wf_original_desc: "{{ target_object.description | default('') }}"
          wf_server_id: "{{ dhcp_server_id }}"
          wf_delete_mac: "{{ delete_mac }}"
          wf_ip_fourth_octet: "{{ ip_fourth_octet }}"
          wf_first_digit: "{{ first_digit }}"
          wf_last_two_digits: "{{ last_two_digits }}"

    - name: "ğŸ¯ Preview Complete - Waiting for Approval"
      ansible.builtin.debug:          
        msg: |
          ğŸ“‹ğŸ“‹ğŸ“‹ é è¦½éšæ®µå®Œæˆ ğŸ“‹ğŸ“‹ğŸ“‹
          
          âœ… é…ç½®åˆ†æå®Œæˆï¼Œç­‰å¾…äººå·¥ç¢ºèª
          ğŸ”„ Workflowå°‡æš«åœåœ¨Approval Node
          âš ï¸ è«‹ä»”ç´°æª¢æŸ¥ä¸Šè¿°ä¿¡æ¯å¾Œæ±ºå®šæ˜¯å¦ç¹¼çºŒåŸ·è¡Œ
          
          ğŸ“Š é è¦½æ‘˜è¦ï¼š
          - ç›®æ¨™MAC: {{ delete_mac }}
          - å°æ‡‰IP: {{ target_object.ip }}
          - é‚„åŸMAC: {{ reserved_mac }}
          - è¦å‰‡: IP{{ ip_fourth_octet }} â†’ f{{ first_digit }}:{{ last_two_digits }}
          
          ğŸš€ ç¢ºèªç„¡èª¤è«‹åœ¨AWXä¸­æ‰¹å‡†æ“ä½œ
          ğŸš« å¦‚æœ‰ç–‘æ…®è«‹æ‹’çµ•æ“ä½œ
