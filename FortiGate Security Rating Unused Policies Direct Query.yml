---
- name: Extract FortiGate Security Rating Unused Policies (Fixed Slice)
  hosts: localhost
  gather_facts: false
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"

  tasks:
    - name: ğŸ¯ å–å¾— Security Rating è³‡æ–™
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/security-rating"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          report_type: "TopologyReport"
          id: "{{ security_rating_id | default('1757052908321') }}"
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
      register: security_rating_data

    - name: ğŸ“‹ é¡¯ç¤ºåŸºæœ¬è³‡è¨Š
      debug:
        msg: |
          âœ… Status: {{ security_rating_data.status }}
          ğŸ“Š Response Keys: {{ security_rating_data.json.keys()|list }}
          ğŸ“ˆ Results Count: {{ security_rating_data.json.results|length if security_rating_data.json.results is defined else 0 }}
          ğŸ¢ Devices Count: {{ security_rating_data.json.devices|length if security_rating_data.json.devices is defined else 0 }}

    - name: ğŸ” åˆ†æ Results çµæ§‹
      debug:
        msg: |
          ========= ğŸ“Š Results åˆ†æ =========
          {% if security_rating_data.json.results is defined %}
          {% for result in security_rating_data.json.results %}
          {% if loop.index <= 3 %}
          
          ğŸ“‹ Result {{ loop.index }}:
          {% if result is mapping %}
          - Type: Dictionary
          - Keys: {{ result.keys()|list }}
          {% if result.name is defined %}
          - Name: {{ result.name }}
          {% endif %}
          {% if result.category is defined %}
          - Category: {{ result.category }}
          {% endif %}
          {% if result.checkName is defined %}
          - Check Name: {{ result.checkName }}
          {% endif %}
          {% else %}
          - Type: String/Other
          - Value: {{ result }}
          {% endif %}
          
          {% endif %}
          {% endfor %}
          {% if security_rating_data.json.results|length > 3 %}
          ... (showing 3 of {{ security_rating_data.json.results|length }})
          {% endif %}
          {% endif %}
          =================================

    - name: ğŸ¢ åˆ†æ Devices è³‡æ–™
      debug:
        msg: |
          ========= ğŸ¢ Devices åˆ†æ =========
          {% if security_rating_data.json.devices is defined %}
          
          ğŸ“Š è¨­å‚™ç¸½æ•¸: {{ security_rating_data.json.devices|length }}
          
          {% for device in security_rating_data.json.devices %}
          {% if loop.index <= 2 %}
          
          ğŸ“± Device {{ loop.index }}:
          {% if device is mapping %}
          - Keys: {{ device.keys()|list }}
          {% if device.deviceName is defined %}
          - Name: {{ device.deviceName }}
          {% endif %}
          {% if device.serialNumber is defined %}
          - Serial: {{ device.serialNumber }}
          {% endif %}
          {% endif %}
          
          {% endif %}
          {% endfor %}
          {% endif %}
          ===============================

    # å°ˆé–€å°‹æ‰¾ unused policy ç›¸é—œè³‡æ–™
    - name: ğŸ¯ æœå°‹æ‰€æœ‰æ¬„ä½ä¸­çš„ Unused Policy è³‡è¨Š
      debug:
        msg: |
          ========= ğŸ” æ·±åº¦æœå°‹ Unused Policies =========
          
          {% set found_policies = [] %}
          
          ğŸ” æœå°‹ Results ä¸­çš„ Policy è³‡è¨Š:
          {% if security_rating_data.json.results is defined %}
          {% for result in security_rating_data.json.results %}
          {% if result is mapping %}
          {% if 'unused' in result|string|lower or 'policy' in result|string|lower %}
          
          ğŸ¯ åœ¨ Results ä¸­æ‰¾åˆ°å¯èƒ½çš„ Policy è³‡è¨Š:
          {% if result.checkName is defined %}
          - Check Name: {{ result.checkName }}
          {% endif %}
          {% if result.category is defined %}
          - Category: {{ result.category }}
          {% endif %}
          {% if result.deviceResults is defined %}
          - Device Results: {{ result.deviceResults|length }} å€‹è¨­å‚™
          
          {% for deviceResult in result.deviceResults %}
          {% if deviceResult.details is defined %}
          ğŸ¯ Device Details æ‰¾åˆ°ï¼
          {% if deviceResult.details.policies is defined %}
          ğŸ“‹ Policies: {{ deviceResult.details.policies|length }} å€‹
          {% for policy in deviceResult.details.policies %}
          {% if loop.index <= 5 %}
          - Policy {{ policy.id if policy.id is defined else 'N/A' }}: Last Used {{ policy.lastUsed if policy.lastUsed is defined else 'Never' }}
          {% endif %}
          {% endfor %}
          {% endif %}
          {% endif %}
          {% endfor %}
          
          {% endif %}
          {% endif %}
          {% endif %}
          {% endfor %}
          {% endif %}
          
          ğŸ” æœå°‹ Devices ä¸­çš„ Policy è³‡è¨Š:
          {% if security_rating_data.json.devices is defined %}
          {% for device in security_rating_data.json.devices %}
          {% if device is mapping and device.deviceResults is defined %}
          {% for deviceResult in device.deviceResults %}
          {% if deviceResult is mapping and 'unused' in deviceResult|string|lower %}
          
          ğŸ¯ åœ¨ Device Results ä¸­æ‰¾åˆ° Unused è³‡è¨Š:
          Device: {{ device.deviceName if device.deviceName is defined else 'Unknown' }}
          
          {% endif %}
          {% endfor %}
          {% endif %}
          {% endfor %}
          {% endif %}
          ==========================================

    # å¦‚æœä¸Šé¢æ²’æ‰¾åˆ°ï¼Œé¡¯ç¤ºæ›´è©³ç´°çš„çµæ§‹
    - name: ğŸ“ å¦‚æœæ²’æ‰¾åˆ°ï¼Œé¡¯ç¤ºè©³ç´°çµæ§‹
      debug:
        msg: |
          ========= ğŸ“ è©³ç´°çµæ§‹åˆ†æ =========
          
          {% if security_rating_data.json.results is defined %}
          ğŸ” ç¬¬ä¸€å€‹ Result çš„å®Œæ•´çµæ§‹:
          {% for result in security_rating_data.json.results %}
          {% if loop.index == 1 and result is mapping %}
          {{ result | to_nice_json }}
          {% endif %}
          {% if loop.index == 1 %}
          {% break %}
          {% endif %}
          {% endfor %}
          {% endif %}
          
          {% if security_rating_data.json.devices is defined %}
          ğŸ” ç¬¬ä¸€å€‹ Device çš„å®Œæ•´çµæ§‹:
          {% for device in security_rating_data.json.devices %}
          {% if loop.index == 1 and device is mapping %}
          {{ device | to_nice_json }}
          {% endif %}
          {% if loop.index == 1 %}
          {% break %}
          {% endif %}
          {% endfor %}
          {% endif %}
          ===================================

    - name: ğŸ’¡ ä¸‹ä¸€æ­¥å»ºè­°
      debug:
        msg: |
          ğŸ’¡ æ ¹æ“šAPIå›æ‡‰åˆ†æ:
          
          âœ… API æˆåŠŸå–å¾—è³‡æ–™
          ğŸ“Š å…±æœ‰ {{ security_rating_data.json.results|length if security_rating_data.json.results is defined else 0 }} å€‹æª¢æŸ¥çµæœ
          ğŸ¢ å…±æœ‰ {{ security_rating_data.json.devices|length if security_rating_data.json.devices is defined else 0 }} å€‹è¨­å‚™
          
          ğŸ” å°‹æ‰¾ç­–ç•¥:
          1. æª¢æŸ¥ results[] ä¸­æ˜¯å¦æœ‰ checkName åŒ…å« "Unused Policies"
          2. åˆ†æ deviceResults[].details.policies çµæ§‹
          3. å°‹æ‰¾åŒ…å« policy ID å’Œ lastUsed æ™‚é–“çš„è³‡æ–™
          
          ğŸ“‹ å¦‚æœä»æœªæ‰¾åˆ°ï¼Œå¯èƒ½éœ€è¦:
          - ç¢ºèªGUIä¸­çš„åˆ†æå·²å®Œæˆ
          - å˜—è©¦ä¸åŒçš„ report_type åƒæ•¸
          - æª¢æŸ¥æ˜¯å¦éœ€è¦ç‰¹å®šçš„æ¬Šé™æˆ–æˆæ¬Š
