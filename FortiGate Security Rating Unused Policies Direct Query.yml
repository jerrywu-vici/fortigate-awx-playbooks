---
- name: Fixed FortiGate Security Rating Deep Exploration
  hosts: localhost
  gather_facts: true
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"

  tasks:
    - name: æ·±å…¥æ¢ç´¢ Security Rating
      debug:
        msg: "ğŸ” ä¿®æ­£ç‰ˆï¼šæ·±å…¥æ¢ç´¢ Security Rating å¯¦éš›è³‡æ–™..."

    # =================== æ¸¬è©¦ä¸åŒçš„ Security Rating åƒæ•¸ ===================
    - name: æ¸¬è©¦ Security Rating çš„ä¸åŒåƒæ•¸çµ„åˆ
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/security-rating"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body: "{{ item.params }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('30') | int }}"
        status_code: [200, 400, 404]
      register: security_rating_tests
      loop:
        - name: "åŸºæœ¬æŸ¥è©¢"
          params:
            vdom: "{{ vdom_name | default('root') }}"
        - name: "æŸ¥è©¢çµæœ"
          params:
            vdom: "{{ vdom_name | default('root') }}"
            action: "get"
        - name: "æŸ¥è©¢è³‡æ–™"
          params:
            vdom: "{{ vdom_name | default('root') }}"
            format: "json"
        - name: "æŸ¥è©¢è©•åˆ†"
          params:
            vdom: "{{ vdom_name | default('root') }}"
            scope: "all"
        - name: "æŸ¥è©¢å„ªåŒ–å»ºè­°"
          params:
            vdom: "{{ vdom_name | default('root') }}"
            category: "optimization"
        - name: "æŸ¥è©¢æœªä½¿ç”¨è³‡æº"
          params:
            vdom: "{{ vdom_name | default('root') }}"
            category: "unused"
        - name: "æŸ¥è©¢Policyå»ºè­°"
          params:
            vdom: "{{ vdom_name | default('root') }}"
            type: "policy"
        - name: "æŸ¥è©¢è©³ç´°è³‡æ–™"
          params:
            vdom: "{{ vdom_name | default('root') }}"
            details: "true"
      failed_when: false

    - name: é¡¯ç¤º Security Rating æ¸¬è©¦çµæœï¼ˆä¿®æ­£ç‰ˆï¼‰
      debug:
        msg: |
          ========= {{ item.item.name }} =========
          åƒæ•¸: {{ item.item.params }}
          ç‹€æ…‹ç¢¼: {{ item.status }}
          {% if item.status == 200 %}
          å›æ‡‰é•·åº¦: {{ (item.json | string) | length }} å­—å…ƒ
          {% if item.json is defined and item.json.results is defined %}
          çµæœç­†æ•¸: {{ item.json.results | length }}
          {% elif item.json is defined %}
          ä¸»è¦æ¬„ä½: {{ item.json.keys() | list }}
          {% endif %}
          {% if item.json != security_rating_tests.results[0].json %}
          ğŸ¯ èˆ‡åŸºæœ¬æŸ¥è©¢å›æ‡‰ä¸åŒï¼
          {% endif %}
          {% elif item.status == 400 %}
          éŒ¯èª¤: {{ item.json.error | default('åƒæ•¸éŒ¯èª¤') }}
          {% endif %}
          ================================
      loop: "{{ security_rating_tests.results }}"

    # =================== æ¢ç´¢å…¶ä»–å¯èƒ½çš„ç«¯é» ===================
    - name: æ¢ç´¢å…¶ä»– Security Rating ç›¸é—œç«¯é»
      uri:
        url: "{{ fortigate_api_url }}{{ item }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('30') | int }}"
        status_code: [200, 400, 404, 500]
      register: other_endpoints
      loop:
        - "/api/v2/monitor/system/security-rating/results"
        - "/api/v2/monitor/system/security-rating/recommendations"
        - "/api/v2/monitor/system/security-rating/unused-policies"
        - "/api/v2/monitor/system/security-rating/optimization"
        - "/api/v2/monitor/firewall/security-rating"
        - "/api/v2/monitor/system/csf/security-rating"
      failed_when: false

    - name: é¡¯ç¤ºå…¶ä»–ç«¯é»çµæœ
      debug:
        msg: |
          ========= {{ item.item }} =========
          ç‹€æ…‹: {{ item.status }}
          {% if item.status == 200 %}
          âœ… æˆåŠŸè¨ªå•ï¼
          {% if item.json is defined %}
          {% if item.json.results is defined %}
          çµæœæ•¸é‡: {{ item.json.results | length }}
          {% endif %}
          å›æ‡‰çµæ§‹: {{ item.json.keys() | list }}
          {% endif %}
          {% elif item.status == 400 %}
          âš ï¸ ç«¯é»å­˜åœ¨ï¼Œåƒæ•¸å•é¡Œ: {{ item.json.error | default('æœªçŸ¥éŒ¯èª¤') }}
          {% elif item.status == 404 %}
          âŒ ç«¯é»ä¸å­˜åœ¨
          {% endif %}
          =============================
      loop: "{{ other_endpoints.results }}"

    # =================== è©³ç´°é¡¯ç¤ºæœ‰æ•¸æ“šçš„å›æ‡‰ ===================
    - name: é¡¯ç¤ºæˆåŠŸå›æ‡‰çš„è©³ç´°å…§å®¹
      debug:
        msg: |
          ========= è©³ç´°å›æ‡‰å…§å®¹: {{ item.item if item.item is string else item.url }} =========
          {% if item.json is defined %}
          {% if item.json | length > 5 %}
          å®Œæ•´JSONå›æ‡‰:
          {{ item.json | to_nice_json }}
          {% else %}
          å›æ‡‰å…§å®¹: {{ item.json }}
          {% endif %}
          {% endif %}
          ===================================================
      loop: "{{ (security_rating_tests.results + other_endpoints.results) }}"
      when: 
        - item.status == 200
        - item.json is defined
        - item.json != security_rating_tests.results[0].json  # æ’é™¤é‡è¤‡çš„éœæ…‹å›æ‡‰

    # =================== å˜—è©¦æŸ¥è©¢ç³»çµ±è³‡è¨Š ===================
    - name: æŸ¥è©¢ç³»çµ±ç‰ˆæœ¬å’ŒåŠŸèƒ½
      uri:
        url: "{{ fortigate_api_url }}{{ item }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('30') | int }}"
        status_code: [200, 400, 404]
      register: system_info
      loop:
        - "/api/v2/monitor/system/status"
        - "/api/v2/monitor/license/status"
        - "/api/v2/cmdb/system/global"
      failed_when: false

    - name: é¡¯ç¤ºç³»çµ±è³‡è¨Š
      debug:
        msg: |
          ========= ç³»çµ±è³‡è¨Š =========
          {% for result in system_info.results %}
          {% if result.status == 200 %}
          
          {{ result.item }}:
          {% if result.json.version is defined %}
          ç‰ˆæœ¬: {{ result.json.version }}
          {% endif %}
          {% if result.json.build is defined %}
          Build: {{ result.json.build }}
          {% endif %}
          {% if 'security' in (result.json | string | lower) %}
          ğŸ” åŒ…å« Security ç›¸é—œè³‡è¨Š
          {% endif %}
          {% if 'rating' in (result.json | string | lower) %}
          ğŸ” åŒ…å« Rating ç›¸é—œè³‡è¨Š
          {% endif %}
          {% endif %}
          {% endfor %}
          =========================

    # =================== å˜—è©¦ä¸åŒçš„ monitor API ===================
    - name: æ¢ç´¢ monitor API é¡åˆ¥
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/{{ item }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('15') | int }}"
        status_code: [200, 400, 404]
      register: monitor_categories
      loop:
        - "system"
        - "firewall" 
        - "log"
      failed_when: false

    - name: é¡¯ç¤º monitor API é¡åˆ¥
      debug:
        msg: |
          ========= Monitor API é¡åˆ¥ =========
          {% for result in monitor_categories.results %}
          {% if result.status == 200 %}
          
          /api/v2/monitor/{{ result.item }}:
          {% if result.json.results is defined %}
          å¯ç”¨å­é¡åˆ¥æ•¸é‡: {{ result.json.results | length }}
          å­é¡åˆ¥åˆ—è¡¨:
          {% for subcat in result.json.results[:10] %}
          - {{ subcat.name | default(subcat) }}
          {% endfor %}
          {% if result.json.results | length > 10 %}
          ... é‚„æœ‰ {{ result.json.results | length - 10 }} å€‹
          {% endif %}
          {% endif %}
          {% endif %}
          {% endfor %}
          ================================

    # =================== ç¸½çµæ¢ç´¢çµæœ ===================
    - name: ç¸½çµæ¢ç´¢çµæœ
      debug:
        msg: |
          ğŸ¯ Security Rating æ¢ç´¢ç¸½çµ
          
          ğŸ“Š æ¸¬è©¦çµæœ:
          - Security Rating åŸºç¤ API å¯è¨ªå•
          - æ¸¬è©¦äº† {{ security_rating_tests.results | length }} ç¨®åƒæ•¸çµ„åˆ
          - æ¸¬è©¦äº† {{ other_endpoints.results | length }} å€‹ç›¸é—œç«¯é»
          
          ğŸ“ ç™¼ç¾:
          {% set successful = [] %}
          {% set different_responses = [] %}
          {% for result in (security_rating_tests.results + other_endpoints.results) %}
          {% if result.status == 200 %}
          {% set _ = successful.append(result) %}
          {% if result.json != security_rating_tests.results[0].json %}
          {% set _ = different_responses.append(result) %}
          {% endif %}
          {% endif %}
          {% endfor %}
          
          - æˆåŠŸè¨ªå•: {{ successful | length }} å€‹ç«¯é»
          - æœ‰ä¸åŒå›æ‡‰: {{ different_responses | length }} å€‹ç«¯é»
          
          ğŸ’¡ ä¸‹ä¸€æ­¥å»ºè­°:
          {% if different_responses | length == 0 %}
          - æ‰€æœ‰å›æ‡‰éƒ½æ˜¯ç›¸åŒçš„éœæ…‹å¸¸æ•¸
          - å¯èƒ½éœ€è¦åœ¨ FortiGate GUI ä¸­å…ˆå•Ÿå‹• Security Rating
          - æˆ–è€…è©²åŠŸèƒ½éœ€è¦ç‰¹å®šæˆæ¬Š
          - å»ºè­°ä½¿ç”¨å‚³çµ±æ–¹å¼æŸ¥è©¢ Policy çµ±è¨ˆ
          {% else %}
          - ç™¼ç¾äº† {{ different_responses | length }} å€‹æœ‰å¯¦éš›è³‡æ–™çš„ç«¯é»
          - å¯ä»¥é€²ä¸€æ­¥åˆ†æé€™äº›ç«¯é»çš„è³‡æ–™çµæ§‹
          {% endif %}
          
          ğŸ”§ æ›¿ä»£æ–¹æ¡ˆ:
          - ä½¿ç”¨ /api/v2/monitor/firewall/policy/select é€ä¸€æŸ¥è©¢
          - æˆ–ä½¿ç”¨ CLI å‘½ä»¤å–å¾—çµ±è¨ˆè³‡æ–™
