---
- name: Extract FortiGate Security Rating Unused Policies Data (Fixed)
  hosts: localhost
  gather_facts: false
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"

  tasks:
    - name: ğŸ¯ å–å¾— Security Rating è³‡æ–™
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/security-rating"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          report_type: "TopologyReport"
          id: "{{ security_rating_id | default('1757052908321') }}"
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
      register: security_rating_data

    - name: ğŸ“‹ é¡¯ç¤ºåŸºæœ¬è³‡è¨Š
      debug:
        msg: |
          âœ… Status: {{ security_rating_data.status }}
          ğŸ“Š Response Keys: {{ security_rating_data.json.keys()|list }}
          ğŸ“ˆ Results Count: {{ security_rating_data.json.results|length if security_rating_data.json.results is defined else 0 }}
          ğŸ¢ Devices Count: {{ security_rating_data.json.devices|length if security_rating_data.json.devices is defined else 0 }}
          ğŸ¯ Security Rating Results: {{ security_rating_data.json.securityRatingResults|length if security_rating_data.json.securityRatingResults is defined else 0 }}

    - name: ğŸ” åˆ†æ Results çµæ§‹ (å‰3ç­†)
      debug:
        msg: |
          ========= ğŸ“Š Results åˆ†æ =========
          {% if security_rating_data.json.results is defined %}
          {% for result in security_rating_data.json.results[:3] %}
          
          ğŸ“‹ Result {{ loop.index }}:
          {% if result is mapping %}
          - Type: Dictionary
          - Keys: {{ result.keys()|list }}
          {% if result.name is defined %}
          - Name: {{ result.name }}
          {% endif %}
          {% if result.category is defined %}
          - Category: {{ result.category }}
          {% endif %}
          {% if result.description is defined %}
          - Description: {{ result.description }}
          {% endif %}
          {% else %}
          - Type: {{ result|type_debug }}
          - Value: {{ result }}
          {% endif %}
          
          {% endfor %}
          {% if security_rating_data.json.results|length > 3 %}
          ... (showing 3 of {{ security_rating_data.json.results|length }})
          {% endif %}
          {% endif %}
          =================================

    - name: ğŸ¯ åˆ†æ Security Rating Results
      debug:
        msg: |
          ========= ğŸ¯ Security Rating Results =========
          {% if security_rating_data.json.securityRatingResults is defined %}
          {% for result in security_rating_data.json.securityRatingResults[:3] %}
          
          ğŸ“Š Rating Result {{ loop.index }}:
          {% if result is mapping %}
          - Keys: {{ result.keys()|list }}
          {% if result.device is defined %}
          - Device: {{ result.device }}
          {% endif %}
          {% if result.recommendations is defined %}
          - Recommendations Count: {{ result.recommendations|length }}
          {% endif %}
          {% else %}
          - Value: {{ result }}
          {% endif %}
          
          {% endfor %}
          {% endif %}
          ========================================

    - name: ğŸ” å°‹æ‰¾ Unused Policies ç›¸é—œè³‡æ–™
      debug:
        msg: |
          ========= ğŸ” æœå°‹ Unused Policies =========
          
          {% set found_unused = [] %}
          
          {% if security_rating_data.json.results is defined %}
          {% for result in security_rating_data.json.results %}
          {% if result is mapping and ('unused' in result|string|lower or 'policy' in result|string|lower) %}
          {% set _ = found_unused.append(result) %}
          {% endif %}
          {% endfor %}
          {% endif %}
          
          {% if security_rating_data.json.securityRatingResults is defined %}
          {% for result in security_rating_data.json.securityRatingResults %}
          {% if result is mapping and result.recommendations is defined %}
          {% for rec in result.recommendations %}
          {% if rec is mapping and ('unused' in rec|string|lower or 'policy' in rec|string|lower) %}
          {% set _ = found_unused.append(rec) %}
          {% endif %}
          {% endfor %}
          {% endif %}
          {% endfor %}
          {% endif %}
          
          {% if found_unused|length > 0 %}
          ğŸ¯ æ‰¾åˆ° {{ found_unused|length }} å€‹ç›¸é—œé …ç›®:
          {% for item in found_unused[:3] %}
          
          ğŸ“‹ é …ç›® {{ loop.index }}:
          {{ item | to_nice_json }}
          
          {% endfor %}
          {% else %}
          âš ï¸ æœªåœ¨æ˜é¡¯ä½ç½®æ‰¾åˆ° unused policies è³‡æ–™
          {% endif %}
          ======================================

    - name: ğŸ¢ åˆ†æ Devices è³‡æ–™ (å°‹æ‰¾ Policy è³‡è¨Š)
      debug:
        msg: |
          ========= ğŸ¢ Devices åˆ†æ =========
          {% if security_rating_data.json.devices is defined %}
          
          ğŸ“Š è¨­å‚™ç¸½æ•¸: {{ security_rating_data.json.devices|length }}
          
          {% for device in security_rating_data.json.devices[:2] %}
          ğŸ“± Device {{ loop.index }}:
          {% if device is mapping %}
          - Keys: {{ device.keys()|list }}
          {% if device.serialNumber is defined %}
          - Serial: {{ device.serialNumber }}
          {% endif %}
          {% if device.deviceName is defined %}
          - Name: {{ device.deviceName }}
          {% endif %}
          {% if device.recommendations is defined %}
          - Recommendations: {{ device.recommendations|length }}
          
          ğŸ” æª¢æŸ¥ Recommendations:
          {% for rec in device.recommendations[:3] %}
          {% if rec is mapping and ('unused' in rec|string|lower or 'policy' in rec|string|lower) %}
          ğŸ¯ æ‰¾åˆ° Policy ç›¸é—œæ¨è–¦ï¼
          {{ rec | to_nice_json }}
          {% endif %}
          {% endfor %}
          {% endif %}
          {% endif %}
          
          {% endfor %}
          {% endif %}
          ===============================

    - name: ğŸ“ å®Œæ•´è³‡æ–™çµæ§‹å±•ç¤º (é—œéµéƒ¨åˆ†)
      debug:
        msg: |
          ========= ğŸ“ å®Œæ•´è³‡æ–™çµæ§‹ =========
          
          ğŸ” å¦‚æœä¸Šé¢æ²’æ‰¾åˆ° unused policiesï¼Œè«‹æª¢æŸ¥å®Œæ•´çµæ§‹:
          
          ğŸ“Š æ‰€æœ‰å¯èƒ½åŒ…å« policy è³‡è¨Šçš„æ¬„ä½:
          {% for key, value in security_rating_data.json.items() %}
          {% if 'policy' in key|lower or 'recommendation' in key|lower or 'result' in key|lower %}
          - {{ key }}: {{ value|type_debug }} ({{ value|length if value is iterable and value is not string else 'N/A' }})
          {% endif %}
          {% endfor %}
          
          ğŸ’¡ å»ºè­°ä¸‹ä¸€æ­¥:
          1. æª¢æŸ¥ devices[].recommendations ä¸­æ˜¯å¦æœ‰ unused policies
          2. æŸ¥çœ‹ securityRatingResults[].recommendations
          3. åˆ†æ results[] é™£åˆ—ä¸­çš„å…·é«”å…§å®¹
          ===================================
