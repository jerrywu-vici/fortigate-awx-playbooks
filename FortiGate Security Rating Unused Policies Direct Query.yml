---
- name: Deep Dive FortiGate Security Rating Unused Policies
  hosts: localhost
  gather_facts: true
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"

  tasks:
    - name: æ·±å…¥æ¢ç´¢ Security Rating
      debug:
        msg: "ğŸ” æ·±å…¥æ¢ç´¢ Security Rating å¯¦éš›è³‡æ–™..."

    # =================== å˜—è©¦ä¸åŒçš„ Security Rating åƒæ•¸ ===================
    - name: æ¸¬è©¦ Security Rating çš„ä¸åŒåƒæ•¸çµ„åˆ
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/security-rating"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body: "{{ item.params }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('30') | int }}"
        status_code: [200, 400, 404]
      register: security_rating_tests
      loop:
        - name: "åŸºæœ¬æŸ¥è©¢"
          params:
            vdom: "{{ vdom_name | default('root') }}"
        - name: "æŸ¥è©¢çµæœ"
          params:
            vdom: "{{ vdom_name | default('root') }}"
            action: "get"
        - name: "æŸ¥è©¢è³‡æ–™"
          params:
            vdom: "{{ vdom_name | default('root') }}"
            format: "json"
        - name: "æŸ¥è©¢è©•åˆ†"
          params:
            vdom: "{{ vdom_name | default('root') }}"
            scope: "all"
        - name: "æŸ¥è©¢å„ªåŒ–å»ºè­°"
          params:
            vdom: "{{ vdom_name | default('root') }}"
            category: "optimization"
        - name: "æŸ¥è©¢æœªä½¿ç”¨è³‡æº"
          params:
            vdom: "{{ vdom_name | default('root') }}"
            category: "unused"
        - name: "æŸ¥è©¢Policyå»ºè­°"
          params:
            vdom: "{{ vdom_name | default('root') }}"
            type: "policy"
        - name: "æŸ¥è©¢è©³ç´°è³‡æ–™"
          params:
            vdom: "{{ vdom_name | default('root') }}"
            details: "true"
      failed_when: false

    - name: é¡¯ç¤º Security Rating æ¸¬è©¦çµæœ
      debug:
        msg: |
          ========= {{ item.item.name }} =========
          åƒæ•¸: {{ item.item.params }}
          ç‹€æ…‹: {{ item.status }}
          {% if item.status == 200 %}
          {% if item.json != security_rating_tests.results[0].json %}
          ğŸ¯ ç™¼ç¾ä¸åŒçš„å›æ‡‰å…§å®¹!
          {% endif %}
          å›æ‡‰å¤§å°: {{ item.content | length }} å­—å…ƒ
          {% if item.json is defined and item.json.results is defined %}
          çµæœç­†æ•¸: {{ item.json.results | length }}
          {% endif %}
          {% endif %}
          ================================
      loop: "{{ security_rating_tests.results }}"
      when: item.status == 200

    # =================== æ¢ç´¢å…¶ä»–å¯èƒ½çš„ Security Rating ç«¯é» ===================
    - name: æ¢ç´¢å…¶ä»– Security Rating ç›¸é—œç«¯é»
      uri:
        url: "{{ fortigate_api_url }}{{ item }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('30') | int }}"
        status_code: [200, 400, 404, 500]
      register: other_endpoints_test
      loop:
        - "/api/v2/monitor/system/security-rating/results"
        - "/api/v2/monitor/system/security-rating/data"  
        - "/api/v2/monitor/system/security-rating/score"
        - "/api/v2/monitor/system/security-rating/recommendations"
        - "/api/v2/monitor/system/security-rating/unused-policies"
        - "/api/v2/monitor/system/security-rating/optimization"
        - "/api/v2/monitor/system/security-rating/assessment"
        - "/api/v2/monitor/firewall/security-rating"
        - "/api/v2/monitor/system/csf/security-rating"
        - "/api/v2/monitor/log/security-rating"
      failed_when: false

    - name: é¡¯ç¤ºå…¶ä»–ç«¯é»æ¸¬è©¦çµæœ  
      debug:
        msg: |
          ========= {{ item.item }} =========
          ç‹€æ…‹: {{ item.status }}
          {% if item.status == 200 %}
          âœ… æˆåŠŸ! å›æ‡‰å¤§å°: {{ item.content | length }} å­—å…ƒ
          {% if item.json is defined %}
          {% if item.json.results is defined %}
          çµæœæ•¸é‡: {{ item.json.results | length }}
          {% endif %}
          ä¸»è¦æ¬„ä½: {{ item.json.keys() | list }}
          {% endif %}
          {% elif item.status == 400 %}
          âš ï¸ ç«¯é»å­˜åœ¨ä½†åƒæ•¸ä¸æ­£ç¢º
          {% elif item.status == 404 %}
          âŒ ç«¯é»ä¸å­˜åœ¨
          {% endif %}
          ============================
      loop: "{{ other_endpoints_test.results }}"

    # =================== å˜—è©¦ POST æ–¹æ³•è§¸ç™¼ Security Rating ===================
    - name: å˜—è©¦è§¸ç™¼ Security Rating è¨ˆç®—
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/security-rating"
        method: POST
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          vdom: "{{ vdom_name | default('root') }}"
          action: "start"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('30') | int }}"
        status_code: [200, 400, 404, 405]
      register: security_rating_trigger
      failed_when: false

    - name: é¡¯ç¤ºè§¸ç™¼çµæœ
      debug:
        msg: |
          ========= Security Rating è§¸ç™¼æ¸¬è©¦ =========
          ç‹€æ…‹: {{ security_rating_trigger.status }}
          {% if security_rating_trigger.status == 200 %}
          âœ… æˆåŠŸè§¸ç™¼ Security Rating è¨ˆç®—
          å›æ‡‰: {{ security_rating_trigger.json | default('ç„¡JSONå›æ‡‰') }}
          {% elif security_rating_trigger.status == 405 %}
          â„¹ï¸ ä¸æ”¯æ´ POST æ–¹æ³•
          {% endif %}
          ======================================

    # =================== æ¢ç´¢ CSF (Security Fabric) ç›¸é—œ ===================
    - name: æ¢ç´¢ Security Fabric ç«¯é»
      uri:
        url: "{{ fortigate_api_url }}{{ item }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('30') | int }}"
        status_code: [200, 400, 404]
      register: csf_endpoints_test
      loop:
        - "/api/v2/monitor/system/csf"
        - "/api/v2/monitor/system/csf/pending"
        - "/api/v2/monitor/system/csf/fabric-device"
        - "/api/v2/cmdb/system/csf"
      failed_when: false

    # =================== å˜—è©¦æŸ¥è©¢ç³»çµ±ç‹€æ…‹å’ŒåŠŸèƒ½ ===================
    - name: æŸ¥è©¢ç³»çµ±åŠŸèƒ½ç‹€æ…‹
      uri:
        url: "{{ fortigate_api_url }}{{ item }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('30') | int }}"
        status_code: [200, 400, 404]
      register: system_status_test
      loop:
        - "/api/v2/monitor/system/status"
        - "/api/v2/monitor/system/feature-select"
        - "/api/v2/monitor/license/status"
        - "/api/v2/monitor/system/feature"
      failed_when: false

    - name: æª¢æŸ¥ç³»çµ±æ˜¯å¦æ”¯æ´ Security Rating
      debug:
        msg: |
          ========= ç³»çµ±åŠŸèƒ½æª¢æŸ¥ =========
          {% for result in system_status_test.results %}
          {% if result.status == 200 %}
          
          {{ result.item }} å›æ‡‰:
          {% if result.json is defined %}
          {% if 'security' in result.json | string | lower %}
          ğŸ” ç™¼ç¾ Security ç›¸é—œåŠŸèƒ½
          {% endif %}
          {% if 'rating' in result.json | string | lower %}
          ğŸ¯ ç™¼ç¾ Rating ç›¸é—œåŠŸèƒ½  
          {% endif %}
          {% if result.json.results is defined %}
          åŠŸèƒ½æ•¸é‡: {{ result.json.results | length }}
          {% endif %}
          {% endif %}
          {% endif %}
          {% endfor %}
          ============================

    # =================== å˜—è©¦æŸ¥è©¢ Policy ç›¸é—œçš„å„ªåŒ–å»ºè­° ===================
    - name: æ¢ç´¢ Policy å„ªåŒ–ç›¸é—œç«¯é»
      uri:
        url: "{{ fortigate_api_url }}{{ item }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: "{{ fortigate_timeout | default('30') | int }}"
        status_code: [200, 400, 404]
      register: policy_optimization_test
      loop:
        - "/api/v2/monitor/firewall/policy-lookup"
        - "/api/v2/monitor/firewall/policy-match"
        - "/api/v2/monitor/system/sandbox/stats"
        - "/api/v2/monitor/firewall/consolidated-policy"
        - "/api/v2/monitor/log/policy-archive"
      failed_when: false

    # =================== é¡¯ç¤ºæ‰€æœ‰æˆåŠŸçš„ç«¯é»å®Œæ•´è³‡æ–™ ===================
    - name: åˆ—å‡ºæ‰€æœ‰ç™¼ç¾çš„æœ‰ç”¨ç«¯é»
      set_fact:
        successful_endpoints: "{{ all_successful }}"
      vars:
        all_successful: |
          [
          {% for test_group in [security_rating_tests.results, other_endpoints_test.results, csf_endpoints_test.results, system_status_test.results, policy_optimization_test.results] %}
          {% for result in test_group %}
          {% if result.status == 200 %}
          {
            "endpoint": "{{ result.url | default(result.item) }}",
            "status": {{ result.status }},
            "content_length": {{ result.content | length }},
            "has_results": {{ result.json.results is defined }},
            "result_count": {{ result.json.results | length if result.json.results is defined else 0 }},
            "keys": {{ result.json.keys() | list if result.json is defined else [] }}
          },
          {% endif %}
          {% endfor %}
          {% endfor %}
          ]

    - name: ç¸½çµæ¢ç´¢ç™¼ç¾
      debug:
        msg: |
          ğŸ¯ FortiGate Security Rating æ·±åº¦æ¢ç´¢å®Œæˆ!
          
          ğŸ“Š ç™¼ç¾æ‘˜è¦:
          - æˆåŠŸè¨ªå•çš„ç«¯é»: {{ successful_endpoints | length }}
          - Security Rating åŸºç¤ç«¯é»å¯è¨ªå•ä½†åªè¿”å›éœæ…‹å¸¸æ•¸
          - éœ€è¦é€²ä¸€æ­¥æ¸¬è©¦ç‰¹å®šåƒæ•¸æˆ–è§¸ç™¼æ©Ÿåˆ¶
          
          ğŸ’¡ ä¸‹ä¸€æ­¥å»ºè­°:
          1. æª¢æŸ¥ FortiGate GUI ä¸­æ˜¯å¦å·²å•Ÿç”¨ Security Rating
          2. ç¢ºèªæ˜¯å¦æœ‰ç›¸é—œæˆæ¬Š
          3. æŸ¥çœ‹ FortiGate æ–‡æª”ä¸­ Security Rating çš„å…·é«” API ç”¨æ³•
          4. å¯èƒ½éœ€è¦å…ˆåœ¨ GUI ä¸­åŸ·è¡Œä¸€æ¬¡ Security Rating åˆ†æ
          
          ğŸ”§ æ›¿ä»£æ–¹æ¡ˆ:
          å¦‚æœå…§å»ºçš„ Security Rating API ä¸æ˜“å–å¾—è³‡æ–™ï¼Œ
          æˆ‘å€‘å¯ä»¥ç¹¼çºŒä½¿ç”¨ä¹‹å‰çš„æ–¹æ³•é€ä¸€æŸ¥è©¢ Policy ä½¿ç”¨çµ±è¨ˆ
          
          âš ï¸ é‡è¦ç™¼ç¾:
          {{ successful_endpoints | selectattr('has_results', 'equalto', true) | list | length }} å€‹ç«¯é»æœ‰å¯¦éš›è³‡æ–™çµæ§‹
