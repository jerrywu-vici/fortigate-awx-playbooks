---
- name: Collect FortiGate Security Rating Unused Policies
  hosts: localhost
  gather_facts: false
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"

  tasks:
    - name: æ”¶é›† Security Rating è³‡è¨Š
      debug:
        msg: "ğŸ” å˜—è©¦æ”¶é›† Security Rating Unused Policies è³‡æ–™"

    # å˜—è©¦æœ€æœ‰å¯èƒ½çš„å¹¾å€‹ç«¯é»
    - name: æ¸¬è©¦ Security Rating ç«¯é»
      uri:
        url: "{{ fortigate_api_url }}{{ item }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
        status_code: [200, 400, 404]
      register: endpoint_tests
      loop:
        - "/api/v2/monitor/system/security-rating"
        - "/api/v2/monitor/system/security-rating/results" 
        - "/api/v2/monitor/system/csf/security-rating"
        - "/api/v2/monitor/system/csf"
      failed_when: false

    # é¡¯ç¤ºç°¡æ½”çµæœ
    - name: é¡¯ç¤ºç«¯é»æ¸¬è©¦çµæœ
      debug:
        msg: |
          {{ item.item }}: {{ 'âœ…' if item.status == 200 else 'âŒ' }} ({{ item.status }})
          {% if item.status == 200 and item.json.results is defined %}
          - æœ‰resultsè³‡æ–™: {{ item.json.results | length }} ç­†
          {% elif item.status == 200 %}
          - å›æ‡‰æ¬„ä½: {{ item.json.keys() | list }}
          {% endif %}
      loop: "{{ endpoint_tests.results }}"

    # å˜—è©¦CSFç›¸é—œçš„unused policiesæŸ¥è©¢
    - name: æ¸¬è©¦ CSF Unused Policies æŸ¥è©¢
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/csf"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
          action: "{{ item }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
        status_code: [200, 400, 404]
      register: csf_action_tests
      loop:
        - "get-security-rating"
        - "get-unused-policies" 
        - "security-rating"
        - "unused-policy"
      failed_when: false

    - name: é¡¯ç¤º CSF æŸ¥è©¢çµæœ
      debug:
        msg: |
          CSF Action "{{ item.item }}": {{ 'âœ…' if item.status == 200 else 'âŒ' }} ({{ item.status }})
          {% if item.status == 200 and item.json != endpoint_tests.results[0].json %}
          ğŸ¯ ç™¼ç¾ä¸åŒçš„å›æ‡‰!
          {% endif %}
      loop: "{{ csf_action_tests.results }}"

    # å˜—è©¦POSTæ–¹æ³•è§¸ç™¼æˆ–å–å¾—çµæœ
    - name: å˜—è©¦å–å¾— Security Rating çµæœ
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/security-rating"
        method: POST
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          vdom: "{{ vdom_name | default('root') }}"
          action: "get-results"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
        status_code: [200, 400, 404, 405]
      register: post_test
      failed_when: false

    - name: é¡¯ç¤º POST æ¸¬è©¦çµæœ
      debug:
        msg: |
          POST Security Rating: {{ 'âœ…' if post_test.status == 200 else 'âŒ' }} ({{ post_test.status }})
          {% if post_test.status == 200 %}
          ğŸ¯ POST æˆåŠŸ! å¯èƒ½æ‰¾åˆ°äº†æ­£ç¢ºæ–¹æ³•
          {% endif %}

    # é¡¯ç¤ºä»»ä½•æœ‰å¯¦éš›è³‡æ–™çš„å›æ‡‰
    - name: é¡¯ç¤ºæœ‰è³‡æ–™çš„å›æ‡‰å…§å®¹
      debug:
        msg: |
          ========= ç™¼ç¾è³‡æ–™: {{ item.url | default(item.item) }} =========
          {{ item.json | to_nice_json }}
          =============================================
      loop: "{{ endpoint_tests.results + csf_action_tests.results + [post_test] }}"
      when: 
        - item.status == 200
        - item.json is defined
        - item.json | length > 5
        - "'STATIC' not in (item.json | string)"

    # ç¸½çµç™¼ç¾
    - name: ç¸½çµæ”¶é›†çµæœ
      debug:
        msg: |
          ğŸ¯ Security Rating è³‡è¨Šæ”¶é›†å®Œæˆ
          
          ğŸ“Š æ¸¬è©¦çµæœ:
          - GET ç«¯é»æˆåŠŸ: {{ endpoint_tests.results | selectattr('status', 'equalto', 200) | list | length }}/{{ endpoint_tests.results | length }}
          - CSF ActionæˆåŠŸ: {{ csf_action_tests.results | selectattr('status', 'equalto', 200) | list | length }}/{{ csf_action_tests.results | length }}
          - POST æ¸¬è©¦: {{ 'æˆåŠŸ' if post_test.status == 200 else 'å¤±æ•—' }}
          
          ğŸ’¡ ä¸‹ä¸€æ­¥:
          {% set has_data = false %}
          {% for item in endpoint_tests.results + csf_action_tests.results + [post_test] %}
          {% if item.status == 200 and item.json is defined and item.json | length > 5 and 'STATIC' not in (item.json | string) %}
          {% set has_data = true %}
          {% endif %}
          {% endfor %}
          {% if has_data %}
          - âœ… æ‰¾åˆ°æœ‰å¯¦éš›è³‡æ–™çš„ç«¯é»ï¼Œå¯ä»¥é€²ä¸€æ­¥åˆ†æ
          {% else %}
          - âš ï¸ å°šæœªæ‰¾åˆ°unused policiesè³‡æ–™ï¼Œå¯èƒ½éœ€è¦ï¼š
            1. åœ¨GUIä¸­å…ˆåŸ·è¡ŒSecurity Ratingåˆ†æ  
            2. æª¢æŸ¥æ˜¯å¦æœ‰ç›¸é—œæˆæ¬Š
            3. å˜—è©¦å…¶ä»–APIè·¯å¾‘
          {% endif %}
