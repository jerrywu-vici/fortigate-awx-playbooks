---
- name: Simplified FortiGate Security Analysis
  hosts: localhost
  gather_facts: false
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"

  tasks:
    - name: ğŸ” æ¸¬è©¦ CSF ç«¯é»
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/csf"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
          action: "{{ item }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
      register: csf_results
      loop:
        - "get-security-rating"
        - "get-unused-policies" 
        - "security-rating"
        - "unused-policy"

    - name: ğŸ“‹ ç°¡æ½”é¡¯ç¤º CSF çµæœ
      debug:
        msg: |
          ğŸ¯ Action: {{ item.item }}
          âœ… Status: {{ item.status }}
          ğŸ“Š Has Results: {{ 'Yes (' + (item.json.results|length|string) + ')' if item.json.results is defined and item.json.results|length > 0 else 'No' }}
          ğŸ”‘ Keys: {{ item.json.keys()|list|join(', ') if item.json is defined else 'None' }}
      loop: "{{ csf_results.results }}"
      when: item.status == 200

    # åªé¡¯ç¤ºæœ‰å¯¦éš›è³‡æ–™çš„å…§å®¹
    - name: ğŸ¯ é¡¯ç¤ºæœ‰è³‡æ–™çš„å›æ‡‰
      debug:
        msg: |
          ========= {{ item.item }} çš„è³‡æ–™ =========
          {% if item.json.results is defined and item.json.results|length > 0 %}
          ğŸ“‹ æ‰¾åˆ° {{ item.json.results|length }} ç­†è³‡æ–™
          
          ğŸ” ç¬¬ä¸€ç­†è³‡æ–™çš„æ¬„ä½:
          {{ item.json.results[0].keys()|list|join(', ') }}
          
          ğŸ“Š ç¯„ä¾‹è³‡æ–™:
          {% for key, value in item.json.results[0].items() %}
          - {{ key }}: {{ value }}
          {% endfor %}
          {% else %}
          ğŸ“‹ å›æ‡‰å…§å®¹:
          {% for key, value in item.json.items() %}
          - {{ key }}: {{ value }}
          {% endfor %}
          {% endif %}
          =====================================
      loop: "{{ csf_results.results }}"
      when: 
        - item.status == 200
        - item.json is defined
        - (item.json.results is defined and item.json.results|length > 0) or (item.json.keys()|list|length > 0)

    # æ¸¬è©¦ç›´æ¥çš„ policy çµ±è¨ˆç«¯é»
    - name: ğŸ¯ æ¸¬è©¦ Policy çµ±è¨ˆç«¯é»
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/firewall/policy"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded  
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
        status_code: [200, 400, 404]
      register: policy_stats
      failed_when: false

    - name: ğŸ“Š Policy çµ±è¨ˆçµæœ
      debug:
        msg: |
          ğŸ¯ Policy Monitor API: {{ 'âœ…' if policy_stats.status == 200 else 'âŒ' }} ({{ policy_stats.status }})
          {% if policy_stats.status == 200 and policy_stats.json.results is defined %}
          ğŸ“‹ æ‰¾åˆ° {{ policy_stats.json.results|length }} æ¢ policies
          
          ğŸ” Policy æ¬„ä½:
          {{ policy_stats.json.results[0].keys()|list|join(', ') if policy_stats.json.results|length > 0 else 'No policies' }}
          
          ğŸ“Š æœ‰ bytes/packets çš„ policies:
          {% set policies_with_stats = policy_stats.json.results | selectattr('bytes', 'defined') | list %}
          {{ policies_with_stats|length }} / {{ policy_stats.json.results|length }}
          
          {% if policies_with_stats|length > 0 %}
          ğŸ” ç¯„ä¾‹ (æœ‰æµé‡çµ±è¨ˆ):
          {% for policy in policies_with_stats[:2] %}
          - Policy: {{ policy.name | default('N/A') }} | Bytes: {{ policy.bytes | default(0) }} | Packets: {{ policy.packets | default(0) }}
          {% endfor %}
          {% endif %}
          {% endif %}
      when: policy_stats.status == 200

    # ç¸½çµç™¼ç¾
    - name: ğŸ¯ ç¸½çµç™¼ç¾
      debug:
        msg: |
          ========= ğŸ¯ åˆ†æç¸½çµ =========
          
          âœ… CSF æˆåŠŸç«¯é»: {{ csf_results.results | selectattr('status', 'equalto', 200) | list | length }}/4
          âœ… Policy API: {{ 'æˆåŠŸ' if policy_stats.status == 200 else 'å¤±æ•—' }}
          
          ğŸ“Š ç™¼ç¾çš„è³‡æ–™:
          {% set found_data = false %}
          {% for item in csf_results.results %}
          {% if item.status == 200 and item.json.results is defined and item.json.results|length > 0 %}
          {% set found_data = true %}
          - {{ item.item }}: {{ item.json.results|length }} ç­†
          {% endif %}
          {% endfor %}
          {% if policy_stats.status == 200 and policy_stats.json.results is defined %}
          {% set found_data = true %}
          - Policy Monitor: {{ policy_stats.json.results|length }} ç­†
          {% endif %}
          
          ğŸ’¡ ä¸‹ä¸€æ­¥å»ºè­°:
          {% if found_data %}
          âœ… æ‰¾åˆ°è³‡æ–™ï¼Œå¯ä»¥é€²ä¸€æ­¥åˆ†ææ˜¯å¦åŒ…å« unused policy è³‡è¨Š
          {% else %}
          âš ï¸ éœ€è¦åœ¨ FortiGate GUI ä¸­å…ˆåŸ·è¡Œ Security Rating åˆ†æ
          {% endif %}
          ==============================
