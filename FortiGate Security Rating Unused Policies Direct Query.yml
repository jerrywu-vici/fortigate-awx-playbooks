---
- name: Deep Analysis FortiGate Security Rating API
  hosts: localhost
  gather_facts: false
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"

  tasks:
    - name: ðŸ” æ·±åº¦åˆ†æžæˆåŠŸçš„ CSF ç«¯é»ž
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/csf"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
          action: "{{ item }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
      register: csf_detailed
      loop:
        - "get-security-rating"
        - "get-unused-policies" 
        - "security-rating"
        - "unused-policy"

    - name: ðŸ“Š åˆ†æž CSF å›žæ‡‰çµæ§‹
      debug:
        msg: |
          ========= CSF Action: {{ item.item }} =========
          Status: {{ item.status }}
          Response Keys: {{ item.json.keys() | list if item.json is defined else 'No JSON' }}
          
          {% if item.json.results is defined %}
          ðŸ“‹ Results çµæ§‹:
          - Count: {{ item.json.results | length }}
          - Sample Keys: {{ item.json.results[0].keys() | list if item.json.results | length > 0 else 'Empty' }}
          {% endif %}
          
          {% if item.json.status is defined %}
          ðŸ“‹ Status: {{ item.json.status }}
          {% endif %}
          
          {% if item.json.message is defined %}
          ðŸ“‹ Message: {{ item.json.message }}
          {% endif %}
          
          ðŸ” å®Œæ•´å›žæ‡‰: {{ item.json | to_nice_json }}
          ==========================================
      loop: "{{ csf_detailed.results }}"
      when: item.status == 200

    # å˜—è©¦ Policy ç›¸é—œçš„ç›´æŽ¥æŸ¥è©¢
    - name: ðŸŽ¯ æ¸¬è©¦ç›´æŽ¥ Policy ç«¯é»ž
      uri:
        url: "{{ fortigate_api_url }}{{ item }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
        status_code: [200, 400, 404]
      register: policy_tests
      loop:
        - "/api/v2/monitor/firewall/policy"
        - "/api/v2/monitor/firewall/policy/usage"
        - "/api/v2/monitor/system/policy-statistics"
        - "/api/v2/cmdb/firewall/policy"
      failed_when: false

    - name: ðŸ“ˆ é¡¯ç¤º Policy ç«¯é»žçµæžœ
      debug:
        msg: |
          {{ item.item }}: {{ 'âœ…' if item.status == 200 else 'âŒ' }} ({{ item.status }})
          {% if item.status == 200 and item.json.results is defined %}
          - Results: {{ item.json.results | length }} policies
          {% elif item.status == 200 %}
          - Keys: {{ item.json.keys() | list }}
          {% endif %}
      loop: "{{ policy_tests.results }}"

    # å¦‚æžœæ‰¾åˆ°policyè³‡æ–™ï¼Œåˆ†æžusageè³‡è¨Š
    - name: ðŸ” åˆ†æž Policy Usage è³‡æ–™
      debug:
        msg: |
          ========= Policy Usage Analysis =========
          {% set policies_found = false %}
          {% for test in policy_tests.results %}
          {% if test.status == 200 and test.json.results is defined %}
          {% set policies_found = true %}
          ðŸ“‹ å¾ž {{ test.item }} æ‰¾åˆ° {{ test.json.results | length }} æ¢ policies
          
          {% for policy in test.json.results[:3] %}
          Policy {{ policy.policyid | default('N/A') }}:
          - Name: {{ policy.name | default('N/A') }}
          - Last Used: {{ policy.last_used | default('Never') }}
          - Bytes: {{ policy.bytes | default(0) }}
          - Packets: {{ policy.packets | default(0) }}
          {% endfor %}
          {% if test.json.results | length > 3 %}
          ... (showing first 3 of {{ test.json.results | length }})
          {% endif %}
          {% endif %}
          {% endfor %}
          
          {% if not policies_found %}
          âš ï¸ å°šæœªåœ¨ç›´æŽ¥ policy ç«¯é»žæ‰¾åˆ° usage è³‡æ–™
          {% endif %}
          ==========================================
      when: policy_tests.results | selectattr('status', 'equalto', 200) | list | length > 0
