---
- name: FortiGate Unused Policies Extractor (Complete Solution)
  hosts: localhost
  gather_facts: false
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"
    
  tasks:
    - name: ğŸ¯ ç²å–æ‰€æœ‰ Policy è³‡æ–™
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/firewall/policy"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
      register: all_policies

    - name: ğŸ“Š ç¸½é«”çµ±è¨ˆ
      debug:
        msg: |
          ========= ğŸ“Š Policy çµ±è¨ˆç¸½è¦½ =========
          ğŸ¢ VDOM: {{ vdom_name | default('root') }}
          ğŸ“‹ ç¸½ Policies: {{ all_policies.json.results | length }}
          ğŸ¯ æ­£åœ¨åˆ†æ unused policies...
          ====================================

    - name: ğŸ” ç¯©é¸å’Œåˆ†æ Unused Policies
      set_fact:
        unused_policies: "{{ all_policies.json.results | selectattr('bytes', 'equalto', 0) | selectattr('packets', 'equalto', 0) | list }}"
        used_policies: "{{ all_policies.json.results | rejectattr('bytes', 'equalto', 0) | list + all_policies.json.results | rejectattr('packets', 'equalto', 0) | list | unique }}"

    - name: ğŸ“‹ é¡¯ç¤º Unused Policies æ¸…å–®
      debug:
        msg: |
          ========= ğŸ¯ Unused Policies æ¸…å–® =========
          
          ğŸ“Š Unused Policies: {{ unused_policies | length }} / {{ all_policies.json.results | length }}
          ğŸ“Š Used Policies: {{ (all_policies.json.results | length) - (unused_policies | length) }}
          
          {% if unused_policies | length > 0 %}
          ğŸ” è©³ç´°æ¸…å–®:
          
          | Policy ID | Last Used | First Used | Hit Count | Session Count |
          |-----------|-----------|------------|-----------|---------------|
          {% for policy in unused_policies | sort(attribute='policyid') %}
          | {{ policy.policyid | string | ljust(9) }} | {{ 'Never' if policy.last_used == 0 else (policy.last_used | int | strftime('%Y-%m-%d %H:%M:%S')) | ljust(9) }} | {{ 'Never' if policy.first_used == 0 else (policy.first_used | int | strftime('%Y-%m-%d %H:%M:%S')) | ljust(10) }} | {{ policy.hit_count | string | ljust(9) }} | {{ policy.session_count | string | ljust(13) }} |
          {% endfor %}
          
          ğŸ¯ Summary:
          {% set never_used = unused_policies | selectattr('last_used', 'equalto', 0) | list %}
          {% set old_unused = unused_policies | rejectattr('last_used', 'equalto', 0) | list %}
          
          - Never Used: {{ never_used | length }} policies
          - Previously Used: {{ old_unused | length }} policies
          
          {% if never_used | length > 0 %}
          ğŸ“‹ Never Used Policy IDs: {{ never_used | map(attribute='policyid') | list | sort | join(', ') }}
          {% endif %}
          
          {% else %}
          âœ… æ‰€æœ‰ policies éƒ½æœ‰ä½¿ç”¨è¨˜éŒ„ï¼
          {% endif %}
          ==========================================

    - name: ğŸ“ ç²å– Policy åç¨± (å¦‚æœéœ€è¦)
      uri:
        url: "{{ fortigate_api_url }}/api/v2/cmdb/firewall/policy/{{ item.policyid }}"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 10
        status_code: [200, 400, 404]
      register: policy_details
      loop: "{{ unused_policies[:5] }}"  # åªå–å‰5å€‹ä»¥å…å¤ªæ…¢
      failed_when: false
      when: unused_policies | length > 0

    - name: ğŸ“‹ é¡¯ç¤ºè©³ç´° Policy è³‡è¨Š
      debug:
        msg: |
          ========= ğŸ“‹ Unused Policies è©³ç´°è³‡è¨Š =========
          
          {% if policy_details is defined and policy_details.results %}
          {% for result in policy_details.results %}
          {% if result.status == 200 %}
          
          ğŸ” Policy {{ result.item.policyid }}:
          - Name: {{ result.json.results[0].name if result.json.results and result.json.results[0].name is defined else 'N/A' }}
          - Source: {{ result.json.results[0].srcaddr if result.json.results and result.json.results[0].srcaddr is defined else 'N/A' }}
          - Destination: {{ result.json.results[0].dstaddr if result.json.results and result.json.results[0].dstaddr is defined else 'N/A' }}
          - Service: {{ result.json.results[0].service if result.json.results and result.json.results[0].service is defined else 'N/A' }}
          - Action: {{ result.json.results[0].action if result.json.results and result.json.results[0].action is defined else 'N/A' }}
          - Last Used: {{ 'Never' if result.item.last_used == 0 else (result.item.last_used | int | strftime('%Y-%m-%d %H:%M:%S')) }}
          
          {% endif %}
          {% endfor %}
          {% endif %}
          
          ğŸ’¡ å®Œæ•´çš„ unused policies è³‡æ–™å·²æ”¶é›†å®Œæˆï¼
          =============================================

    # ç”Ÿæˆ JSON æ ¼å¼è¼¸å‡º
    - name: ğŸ“¤ ç”Ÿæˆçµæ§‹åŒ–è¼¸å‡º
      debug:
        msg: |
          ========= ğŸ“¤ JSON æ ¼å¼è¼¸å‡º =========
          
          {
            "summary": {
              "total_policies": {{ all_policies.json.results | length }},
              "unused_policies": {{ unused_policies | length }},
              "used_policies": {{ (all_policies.json.results | length) - (unused_policies | length) }},
              "vdom": "{{ vdom_name | default('root') }}",
              "scan_time": "{{ ansible_date_time.iso8601 }}"
            },
            "unused_policies": [
              {% for policy in unused_policies | sort(attribute='policyid') %}
              {
                "policyid": {{ policy.policyid }},
                "bytes": {{ policy.bytes }},
                "packets": {{ policy.packets }},
                "last_used": {{ policy.last_used }},
                "last_used_readable": "{{ 'Never' if policy.last_used == 0 else (policy.last_used | int | strftime('%Y-%m-%d %H:%M:%S')) }}",
                "first_used": {{ policy.first_used }},
                "hit_count": {{ policy.hit_count }},
                "session_count": {{ policy.session_count }}
              }{{ ',' if not loop.last else '' }}
              {% endfor %}
            ]
          }
          ===================================

    - name: ğŸ¯ æœ€çµ‚ç¸½çµ
      debug:
        msg: |
          ========= ğŸ¯ ä»»å‹™å®Œæˆç¸½çµ =========
          
          âœ… æˆåŠŸé€£æ¥ FortiGate API
          âœ… æˆåŠŸç²å– {{ all_policies.json.results | length }} æ¢ policies
          âœ… è­˜åˆ¥å‡º {{ unused_policies | length }} å€‹ unused policies
          
          ğŸ“‹ Unused Policy IDs: 
          {{ unused_policies | map(attribute='policyid') | list | sort | join(', ') if unused_policies | length > 0 else 'ç„¡' }}
          
          ğŸ’¡ è§£æ±ºæ–¹æ¡ˆç¸½çµ:
          1. API ç«¯é»: /api/v2/monitor/firewall/policy
          2. ç¯©é¸æ¢ä»¶: bytes = 0 AND packets = 0  
          3. æ™‚é–“æ¬„ä½: last_used (Unix timestamp)
          4. ç›¸é—œæ¬„ä½: hit_count, session_count
          
          ğŸš€ é€™å€‹ playbook å¯ä»¥å®šæœŸåŸ·è¡Œä¾†ç›£æ§ unused policiesï¼
          ===================================
