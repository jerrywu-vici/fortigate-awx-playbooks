---
- name: Extract FortiGate Security Rating Unused Policies Data
  hosts: localhost
  gather_facts: false
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"

  tasks:
    - name: ğŸ¯ æ¸¬è©¦ç™¼ç¾çš„ Security Rating API
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/security-rating"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          report_type: "TopologyReport"
          id: "{{ security_rating_id | default('1757052908321') }}"
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
      register: security_rating_data

    - name: ğŸ“‹ é¡¯ç¤º Security Rating å›æ‡‰çµæ§‹
      debug:
        msg: |
          ğŸ¯ Security Rating API çµæœ:
          âœ… Status: {{ security_rating_data.status }}
          ğŸ“Š Response Keys: {{ security_rating_data.json.keys()|list if security_rating_data.json is defined else 'No JSON' }}
          
          {% if security_rating_data.json.results is defined %}
          ğŸ“ˆ Results Count: {{ security_rating_data.json.results|length }}
          {% endif %}
      when: security_rating_data.status == 200

    - name: ğŸ” åˆ†æ Security Rating è³‡æ–™çµæ§‹
      debug:
        msg: |
          ========= ğŸ” Security Rating è³‡æ–™åˆ†æ =========
          
          {% if security_rating_data.json.results is defined %}
          ğŸ“Š æ‰¾åˆ° {{ security_rating_data.json.results|length }} ç­†çµæœ
          
          {% for result in security_rating_data.json.results %}
          
          ğŸ“‹ çµæœ {{ loop.index }}:
          - Keys: {{ result.keys()|list }}
          {% if result.recommendations is defined %}
          - æ¨è–¦é …ç›®æ•¸: {{ result.recommendations|length }}
          {% endif %}
          {% if result.unused_policies is defined %}
          ğŸ¯ æ‰¾åˆ° Unused Policiesï¼
          {% endif %}
          
          {% endfor %}
          {% else %}
          ğŸ“‹ å®Œæ•´å›æ‡‰å…§å®¹:
          {{ security_rating_data.json | to_nice_json }}
          {% endif %}
          =============================================
      when: security_rating_data.status == 200

    # å˜—è©¦ä¸åŒçš„ report_type
    - name: ğŸ” æ¸¬è©¦ä¸åŒçš„ Report Type
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/security-rating"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          report_type: "{{ item }}"
          id: "{{ security_rating_id | default('1757052908321') }}"
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
        status_code: [200, 400, 404]
      register: report_type_tests
      loop:
        - "SecurityReport"
        - "PolicyReport"
        - "UnusedPolicyReport"
        - "ComplianceReport"
        - "RecommendationReport"
      failed_when: false

    - name: ğŸ“Š é¡¯ç¤ºä¸åŒ Report Type çµæœ
      debug:
        msg: |
          ğŸ¯ {{ item.item }}: {{ 'âœ…' if item.status == 200 else 'âŒ' }} ({{ item.status }})
          {% if item.status == 200 and item.json.results is defined %}
          ğŸ“ˆ Results: {{ item.json.results|length }}
          {% endif %}
      loop: "{{ report_type_tests.results }}"

    # å˜—è©¦ä¸ä½¿ç”¨ ID åƒæ•¸
    - name: ğŸ” æ¸¬è©¦ä¸å¸¶ ID çš„è«‹æ±‚
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/security-rating"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          report_type: "TopologyReport"
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
        status_code: [200, 400, 404]
      register: no_id_test
      failed_when: false

    - name: ğŸ“‹ é¡¯ç¤ºä¸å¸¶IDçš„çµæœ
      debug:
        msg: |
          ğŸ¯ ä¸å¸¶IDçš„è«‹æ±‚: {{ 'âœ…' if no_id_test.status == 200 else 'âŒ' }} ({{ no_id_test.status }})
          {% if no_id_test.status == 200 %}
          ğŸ“Š èˆ‡å¸¶IDçµæœç›¸åŒ: {{ 'æ˜¯' if no_id_test.json == security_rating_data.json else 'å¦' }}
          {% endif %}

    # æå– Unused Policies è³‡æ–™
    - name: ğŸ¯ æå– Unused Policies è³‡æ–™
      debug:
        msg: |
          ========= ğŸ¯ Unused Policies è³‡æ–™ =========
          
          {% set found_unused = false %}
          {% for test_result in [security_rating_data] + report_type_tests.results + [no_id_test] %}
          {% if test_result.status == 200 and test_result.json is defined %}
          
          {% if test_result.json.results is defined %}
          {% for result in test_result.json.results %}
          {% if result.recommendations is defined %}
          {% for rec in result.recommendations %}
          {% if 'unused' in rec|string|lower or 'policy' in rec|string|lower %}
          {% set found_unused = true %}
          
          ğŸ¯ æ‰¾åˆ° Unused Policy æ¨è–¦:
          {{ rec | to_nice_json }}
          
          {% endif %}
          {% endfor %}
          {% endif %}
          {% endfor %}
          {% endif %}
          
          {% endif %}
          {% endfor %}
          
          {% if not found_unused %}
          âš ï¸ åœ¨APIå›æ‡‰ä¸­æœªæ‰¾åˆ°æ˜ç¢ºçš„ unused policies è³‡æ–™
          ğŸ’¡ å¯èƒ½éœ€è¦ï¼š
          1. ç¢ºèª ID åƒæ•¸æ˜¯å¦æ­£ç¢º
          2. æª¢æŸ¥æ˜¯å¦éœ€è¦å…ˆè§¸ç™¼åˆ†æ
          3. å˜—è©¦å…¶ä»– report_type
          {% endif %}
          ==========================================

    # ç”Ÿæˆç•¶å‰æ™‚é–“æˆ³ä½œç‚ºæ–°çš„IDå˜—è©¦
    - name: ğŸ• ç”Ÿæˆæ–°çš„æ™‚é–“æˆ³IDæ¸¬è©¦
      set_fact:
        current_timestamp: "{{ ansible_date_time.epoch }}000"  # è½‰æ›ç‚ºæ¯«ç§’

    - name: ğŸ” ä½¿ç”¨æ–°æ™‚é–“æˆ³æ¸¬è©¦
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/security-rating"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          report_type: "TopologyReport"
          id: "{{ current_timestamp }}"
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
        status_code: [200, 400, 404]
      register: new_timestamp_test
      failed_when: false

    - name: ğŸ“Š ç¸½çµæ‰€æœ‰æ¸¬è©¦çµæœ
      debug:
        msg: |
          ========= ğŸ¯ Security Rating API æ¸¬è©¦ç¸½çµ =========
          
          âœ… åŸå§‹IDæˆåŠŸ: {{ 'æ˜¯' if security_rating_data.status == 200 else 'å¦' }}
          âœ… ä¸åŒreport_typeæˆåŠŸ: {{ report_type_tests.results | selectattr('status', 'equalto', 200) | list | length }}/{{ report_type_tests.results | length }}
          âœ… ä¸å¸¶IDæˆåŠŸ: {{ 'æ˜¯' if no_id_test.status == 200 else 'å¦' }}  
          âœ… æ–°æ™‚é–“æˆ³æˆåŠŸ: {{ 'æ˜¯' if new_timestamp_test.status == 200 else 'å¦' }}
          
          ğŸ¯ ä¸‹ä¸€æ­¥å»ºè­°:
          {% if security_rating_data.status == 200 %}
          1. âœ… APIç«¯é»æœ‰æ•ˆï¼Œæª¢æŸ¥å›æ‡‰ä¸­çš„ unused policies è³‡æ–™
          2. ğŸ” åˆ†æ recommendations æˆ– results çµæ§‹
          3. ğŸ“‹ ç¢ºèªè³‡æ–™æ ¼å¼ä¸¦æå–æ‰€éœ€æ¬„ä½
          {% else %}
          1. âš ï¸ æª¢æŸ¥IDåƒæ•¸æ˜¯å¦éæœŸ
          2. ğŸ”„ åœ¨GUIä¸­é‡æ–°åŸ·è¡ŒSecurity Ratingåˆ†æ
          3. ğŸ“± é‡æ–°æŠ“å–æ–°çš„APIè«‹æ±‚
          {% endif %}
          ===============================================
