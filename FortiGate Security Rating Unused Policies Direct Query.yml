---
- name: Find FortiGate Unused Policies in Security Rating Data
  hosts: localhost
  gather_facts: false
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"

  tasks:
    - name: ğŸ¯ å–å¾— Security Rating è³‡æ–™
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/security-rating"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          report_type: "TopologyReport"
          id: "{{ security_rating_id | default('1757052908321') }}"
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
      register: security_rating_data

    - name: ğŸ“Š åˆ†æé—œéµæ¬„ä½çš„è³‡æ–™é¡å‹å’Œå¤§å°
      debug:
        msg: |
          ========= ğŸ“Š é—œéµæ¬„ä½åˆ†æ =========
          {% for key, value in security_rating_data.json.items() %}
          {% if key in ['devices', 'perDeviceStatistics', 'perCheckStatistics', 'perCategoryStatistics', 'weekHistory', 'statistics'] %}
          
          ğŸ” {{ key }}:
          - Type: {{ value|type_debug }}
          - Size: {{ value|length if value is iterable and value is not string else 'N/A' }}
          {% if value is iterable and value is not string and value|length > 0 %}
          {% set first_item = value[0] if value is sequence else value.values()|list|first %}
          - First Item Type: {{ first_item|type_debug }}
          {% if first_item is mapping %}
          - First Item Keys: {{ first_item.keys()|list }}
          {% endif %}
          {% endif %}
          
          {% endif %}
          {% endfor %}
          ===================================

    - name: ğŸ¢ è©³ç´°åˆ†æç¬¬ä¸€å€‹ Device
      debug:
        msg: |
          ========= ğŸ¢ ç¬¬ä¸€å€‹è¨­å‚™è©³ç´°è³‡æ–™ =========
          {% if security_rating_data.json.devices is defined and security_rating_data.json.devices|length > 0 %}
          {% set first_device = security_rating_data.json.devices[0] %}
          
          ğŸ“± è¨­å‚™è³‡è¨Š:
          {% for key, value in first_device.items() %}
          - {{ key }}: {{ value }}
          {% endfor %}
          
          {% else %}
          âš ï¸ æ²’æœ‰è¨­å‚™è³‡æ–™
          {% endif %}
          ======================================

    - name: ğŸ“ˆ åˆ†æ perDeviceStatistics (å¯èƒ½åŒ…å« Policy çµ±è¨ˆ)
      debug:
        msg: |
          ========= ğŸ“ˆ perDeviceStatistics åˆ†æ =========
          {% if security_rating_data.json.perDeviceStatistics is defined %}
          
          ğŸ“Š çµ±è¨ˆè³‡æ–™é¡å‹: {{ security_rating_data.json.perDeviceStatistics|type_debug }}
          ğŸ“Š çµ±è¨ˆè³‡æ–™å¤§å°: {{ security_rating_data.json.perDeviceStatistics|length if security_rating_data.json.perDeviceStatistics is iterable and security_rating_data.json.perDeviceStatistics is not string else 'N/A' }}
          
          {% if security_rating_data.json.perDeviceStatistics is mapping %}
          ğŸ” çµ±è¨ˆæ¬„ä½:
          {% for key, value in security_rating_data.json.perDeviceStatistics.items() %}
          - {{ key }}: {{ value|type_debug }} ({{ value|length if value is iterable and value is not string else value }})
          {% endfor %}
          {% endif %}
          
          {% endif %}
          ============================================

    - name: ğŸ” æª¢æŸ¥ perCheckStatistics (æª¢æŸ¥çµ±è¨ˆ)
      debug:
        msg: |
          ========= ğŸ” perCheckStatistics åˆ†æ =========
          {% if security_rating_data.json.perCheckStatistics is defined %}
          
          ğŸ“Š æª¢æŸ¥çµ±è¨ˆé¡å‹: {{ security_rating_data.json.perCheckStatistics|type_debug }}
          
          {% if security_rating_data.json.perCheckStatistics is mapping %}
          ğŸ¯ å°‹æ‰¾ Unused Policy ç›¸é—œæª¢æŸ¥:
          {% for check_name, check_data in security_rating_data.json.perCheckStatistics.items() %}
          {% if 'unused' in check_name|lower or 'policy' in check_name|lower %}
          
          ğŸ¯ æ‰¾åˆ°ç›¸é—œæª¢æŸ¥: {{ check_name }}
          - è³‡æ–™: {{ check_data }}
          
          {% endif %}
          {% endfor %}
          
          ğŸ“‹ æ‰€æœ‰æª¢æŸ¥é …ç›®:
          {% for check_name in security_rating_data.json.perCheckStatistics.keys() %}
          - {{ check_name }}
          {% endfor %}
          {% endif %}
          
          {% endif %}
          ===========================================

    # å˜—è©¦ç›´æ¥å­˜å–ç‰¹å®šçš„ unused policy æª¢æŸ¥çµæœ
    - name: ğŸ¯ å˜—è©¦å–å¾— Unused Policy å…·é«”è³‡æ–™
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/security-rating"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          report_type: "TopologyReport"
          id: "{{ security_rating_id | default('1757052908321') }}"
          vdom: "{{ vdom_name | default('root') }}"
          checkName: "unused-policies"  # å˜—è©¦ç‰¹å®šæª¢æŸ¥
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
        status_code: [200, 400, 404]
      register: unused_policy_check
      failed_when: false

    - name: ğŸ“‹ é¡¯ç¤º Unused Policy æª¢æŸ¥çµæœ
      debug:
        msg: |
          ğŸ¯ Unused Policy ç‰¹å®šæª¢æŸ¥: {{ 'âœ…' if unused_policy_check.status == 200 else 'âŒ' }} ({{ unused_policy_check.status }})
          {% if unused_policy_check.status == 200 %}
          ğŸ“Š å›æ‡‰æ¬„ä½: {{ unused_policy_check.json.keys()|list if unused_policy_check.json is defined else 'No JSON' }}
          {% endif %}

    # å˜—è©¦ä½¿ç”¨ CSF API çš„ unused-policy action
    - name: ğŸš€ å˜—è©¦ CSF unused-policy action
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/csf"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
          action: "unused-policy"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
        status_code: [200, 400, 404]
      register: csf_unused_policy
      failed_when: false

    - name: ğŸ“Š é¡¯ç¤º CSF Unused Policy çµæœ
      debug:
        msg: |
          ğŸ¯ CSF unused-policy: {{ 'âœ…' if csf_unused_policy.status == 200 else 'âŒ' }} ({{ csf_unused_policy.status }})
          {% if csf_unused_policy.status == 200 and csf_unused_policy.json is defined %}
          
          ğŸ“‹ CSF å›æ‡‰çµæ§‹:
          {% for key, value in csf_unused_policy.json.items() %}
          - {{ key }}: {{ value|type_debug }} ({{ value|length if value is iterable and value is not string else value }})
          {% endfor %}
          
          {% if csf_unused_policy.json.results is defined %}
          ğŸ¯ CSF Results å…§å®¹:
          {{ csf_unused_policy.json.results | to_nice_json }}
          {% endif %}
          
          {% endif %}

    - name: ğŸ’¡ ç¸½çµå’Œä¸‹ä¸€æ­¥å»ºè­°
      debug:
        msg: |
          ========= ğŸ’¡ åˆ†æç¸½çµ =========
          
          âœ… Security Rating API æˆåŠŸ
          ğŸ“Š ä¸»è¦è³‡æ–™çµæ§‹:
          - results: å­—ä¸²é™£åˆ— (é¡åˆ¥åç¨±)
          - devices: {{ security_rating_data.json.devices|length }} å€‹è¨­å‚™
          - perDeviceStatistics: è¨­å‚™çµ±è¨ˆ
          - perCheckStatistics: æª¢æŸ¥çµ±è¨ˆ
          
          ğŸ” å¯èƒ½çš„ Policy è³‡æ–™ä½ç½®:
          1. perCheckStatistics ä¸­çš„ç‰¹å®šæª¢æŸ¥é …ç›®
          2. CSF API çš„ unused-policy action
          3. éœ€è¦å…¶ä»– report_type åƒæ•¸
          
          ğŸ¯ ä¸‹ä¸€æ­¥å»ºè­°:
          {% if csf_unused_policy.status == 200 %}
          âœ… CSF API æœ‰å›æ‡‰ï¼Œæª¢æŸ¥æ˜¯å¦åŒ…å« policy è³‡æ–™
          {% else %}
          âš ï¸ å¯èƒ½éœ€è¦åœ¨ GUI ä¸­å…ˆåŸ·è¡Œå®Œæ•´çš„ Security Rating åˆ†æ
          {% endif %}
          =============================
