---
- name: Deep Dive FortiGate Unused Policies Discovery  
  hosts: localhost
  gather_facts: false
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"

  tasks:
    - name: ğŸ¯ å–å¾— Security Rating è³‡æ–™
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/security-rating"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          report_type: "TopologyReport"
          id: "{{ security_rating_id | default('1757052908321') }}"
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
      register: security_rating_data

    # æ·±å…¥åˆ†æ perDeviceStatistics (æ¯å€‹è¨­å‚™çš„çµ±è¨ˆè³‡æ–™)
    - name: ğŸ” æ·±å…¥åˆ†æ perDeviceStatistics
      debug:
        msg: |
          ========= ğŸ” è¨­å‚™çµ±è¨ˆåˆ†æ =========
          {% for device_serial, device_stats in security_rating_data.json.perDeviceStatistics.items() %}
          
          ğŸ“± è¨­å‚™: {{ device_serial }}
          ğŸ“Š çµ±è¨ˆé …ç›®: {{ device_stats.keys()|list }}
          {% if device_stats.numRecommendations is defined and device_stats.numRecommendations > 0 %}
          ğŸ¯ æœ‰ {{ device_stats.numRecommendations }} å€‹æ¨è–¦é …ç›®ï¼
          {% endif %}
          {% if device_stats.numFailedChecks is defined and device_stats.numFailedChecks > 0 %}
          âš ï¸ å¤±æ•—æª¢æŸ¥: {{ device_stats.numFailedChecks }}
          {% endif %}
          
          {% endfor %}
          ===================================

    # å°‹æ‰¾åŒ…å« "unused" çš„ perCheckStatistics é …ç›®
    - name: ğŸ¯ æœå°‹æ‰€æœ‰èˆ‡ Unused ç›¸é—œçš„æª¢æŸ¥é …ç›®
      debug:
        msg: |
          ========= ğŸ” Unused ç›¸é—œæª¢æŸ¥æœå°‹ =========
          {% set unused_checks = [] %}
          {% for check_name, check_data in security_rating_data.json.perCheckStatistics.items() %}
          {% if 'unused' in check_name|lower %}
          {% set _ = unused_checks.append({'name': check_name, 'data': check_data}) %}
          {% endif %}
          {% endfor %}
          
          {% if unused_checks|length > 0 %}
          ğŸ¯ æ‰¾åˆ° {{ unused_checks|length }} å€‹ Unused ç›¸é—œæª¢æŸ¥:
          {% for check in unused_checks %}
          
          ğŸ“‹ {{ check.name }}:
          {{ check.data | to_nice_json }}
          
          {% endfor %}
          {% else %}
          âš ï¸ åœ¨ perCheckStatistics ä¸­æœªæ‰¾åˆ°ç›´æ¥åç‚º "unused" çš„æª¢æŸ¥é …ç›®
          {% endif %}
          =========================================

    # å˜—è©¦ç²å–ç‰¹å®šè¨­å‚™çš„è©³ç´°è³‡è¨Š
    - name: ğŸ¢ å˜—è©¦ç²å–å–®ä¸€è¨­å‚™çš„è©³ç´° Security Rating
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/security-rating"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          report_type: "TopologyReport"
          id: "{{ security_rating_id | default('1757052908321') }}"
          vdom: "{{ vdom_name | default('root') }}"
          device: "FG101FTK20002510"  # ä¸»è¦ FortiGate è¨­å‚™
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
        status_code: [200, 400, 404]
      register: device_specific_rating
      failed_when: false

    - name: ğŸ“‹ é¡¯ç¤ºè¨­å‚™ç‰¹å®šçµæœ
      debug:
        msg: |
          ğŸ¯ è¨­å‚™ç‰¹å®šæŸ¥è©¢: {{ 'âœ…' if device_specific_rating.status == 200 else 'âŒ' }} ({{ device_specific_rating.status }})
          {% if device_specific_rating.status == 200 %}
          ğŸ“Š èˆ‡åŸå§‹è³‡æ–™ç›¸åŒ: {{ 'æ˜¯' if device_specific_rating.json == security_rating_data.json else 'å¦' }}
          {% endif %}

    # å˜—è©¦ä¸åŒçš„ report_type ä¾†å°‹æ‰¾ unused policies
    - name: ğŸ” æ¸¬è©¦å¯èƒ½åŒ…å« Policy è³‡è¨Šçš„ report_type
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/system/security-rating"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          report_type: "{{ item }}"
          id: "{{ security_rating_id | default('1757052908321') }}"
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
        status_code: [200, 400, 404]
      register: different_report_types
      loop:
        - "DeviceReport" 
        - "CheckReport"
        - "RecommendationReport"
        - "DetailsReport"
      failed_when: false

    - name: ğŸ“Š é¡¯ç¤ºä¸åŒ Report Type çµæœ
      debug:
        msg: |
          ğŸ” {{ item.item }}: {{ 'âœ…' if item.status == 200 else 'âŒ' }} ({{ item.status }})
          {% if item.status == 200 and item.json != security_rating_data.json %}
          ğŸ¯ æ‰¾åˆ°ä¸åŒçš„å›æ‡‰ï¼å¯èƒ½åŒ…å«ä¸åŒè³‡æ–™
          ğŸ“Š å›æ‡‰å¤§å°: {{ item.json|string|length }} å­—å…ƒ
          ğŸ“‹ ä¸»è¦æ¬„ä½: {{ item.json.keys()|list if item.json is mapping else 'Not a dict' }}
          {% endif %}
      loop: "{{ different_report_types.results }}"

    # å˜—è©¦ç›´æ¥æŸ¥è©¢ policy ç›£æ§ API
    - name: ğŸ¯ å˜—è©¦ç›´æ¥çš„ Policy Monitor API
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/firewall/policy"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
        status_code: [200, 400, 404]
      register: policy_monitor
      failed_when: false

    - name: ğŸ“‹ åˆ†æ Policy Monitor çµæœ
      debug:
        msg: |
          ğŸ¯ Policy Monitor API: {{ 'âœ…' if policy_monitor.status == 200 else 'âŒ' }} ({{ policy_monitor.status }})
          {% if policy_monitor.status == 200 and policy_monitor.json.results is defined %}
          
          ğŸ“Š æ‰¾åˆ° {{ policy_monitor.json.results|length }} æ¢ policies
          
          ğŸ” åˆ†æ Policy æ¬„ä½:
          {% if policy_monitor.json.results|length > 0 %}
          {% set first_policy = policy_monitor.json.results[0] %}
          - Policy æ¬„ä½: {{ first_policy.keys()|list }}
          
          ğŸ“‹ ç¯„ä¾‹ Policy:
          {% for key, value in first_policy.items() %}
          {% if key in ['policyid', 'name', 'bytes', 'packets', 'hit_count', 'last_used', 'first_used'] %}
          - {{ key }}: {{ value }}
          {% endif %}
          {% endfor %}
          
          ğŸ¯ å°‹æ‰¾ Unused Policies (bytes = 0 æˆ– packets = 0):
          {% set unused_policies = [] %}
          {% for policy in policy_monitor.json.results %}
          {% if (policy.bytes is defined and policy.bytes == 0) or (policy.packets is defined and policy.packets == 0) %}
          {% set _ = unused_policies.append(policy) %}
          {% endif %}
          {% endfor %}
          
          {% if unused_policies|length > 0 %}
          ğŸ¯ æ‰¾åˆ° {{ unused_policies|length }} å€‹å¯èƒ½çš„ Unused Policies:
          {% for policy in unused_policies[:5] %}
          - Policy {{ policy.policyid if policy.policyid is defined else 'N/A' }}: {{ policy.name if policy.name is defined else 'N/A' }} (Bytes: {{ policy.bytes if policy.bytes is defined else 'N/A' }}, Packets: {{ policy.packets if policy.packets is defined else 'N/A' }})
          {% endfor %}
          {% if unused_policies|length > 5 %}
          ... (showing 5 of {{ unused_policies|length }})
          {% endif %}
          {% else %}
          ğŸ“‹ æ‰€æœ‰ policies éƒ½æœ‰æµé‡è¨˜éŒ„
          {% endif %}
          
          {% endif %}
          {% endif %}

    - name: ğŸ’¡ æœ€çµ‚ç¸½çµå’Œå»ºè­°
      debug:
        msg: |
          ========= ğŸ’¡ æœ€çµ‚åˆ†æç¸½çµ =========
          
          âœ… å·²æ¸¬è©¦çš„ API ç«¯é»:
          - Security Rating API: æˆåŠŸ
          - CSF unused-policy: æˆåŠŸ (ä½†ä¸»è¦æ˜¯è¨­å‚™è³‡è¨Š)
          - Policy Monitor API: {{ 'æˆåŠŸ' if policy_monitor.status == 200 else 'å¤±æ•—' }}
          
          ğŸ“Š ç™¼ç¾çš„è³‡æ–™:
          {% if policy_monitor.status == 200 and policy_monitor.json.results is defined %}
          - âœ… ç›´æ¥æ‰¾åˆ° {{ policy_monitor.json.results|length }} æ¢ policies è³‡æ–™
          - ğŸ¯ å¯ä»¥é€šé bytes=0 æˆ– packets=0 åˆ¤æ–· unused policies
          {% else %}
          - âš ï¸ å°šæœªæ‰¾åˆ°ç›´æ¥çš„ policy usage è³‡æ–™
          {% endif %}
          
          ğŸ¯ å»ºè­°çš„ Unused Policies æª¢æ¸¬æ–¹æ³•:
          {% if policy_monitor.status == 200 %}
          1. âœ… ä½¿ç”¨ /api/v2/monitor/firewall/policy ç²å–æ‰€æœ‰ policies
          2. ğŸ” ç¯©é¸ bytes=0 å’Œ packets=0 çš„ policies
          3. ğŸ“‹ æª¢æŸ¥ last_used æˆ–ç›¸é—œæ™‚é–“æˆ³æ¬„ä½
          {% else %}
          1. ğŸ“± ç¢ºèªåœ¨ GUI ä¸­èƒ½çœ‹åˆ° unused policies è³‡æ–™
          2. ğŸ”„ ä½¿ç”¨ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·é‡æ–°æŠ“å– API è«‹æ±‚
          3. ğŸ¯ å¯èƒ½éœ€è¦ç‰¹å®šçš„è§¸ç™¼æ¢ä»¶æˆ–åƒæ•¸
          {% endif %}
          ===================================
