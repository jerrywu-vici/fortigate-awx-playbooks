---
- name: FortiGate Unused Policies Extractor (Safe Version)
  hosts: localhost
  gather_facts: false
  vars:
    fortigate_api_url: "https://{{ fortigate_host }}:{{ fortigate_api_port | default('443') }}"
    
  tasks:
    - name: ğŸ¯ ç²å–æ‰€æœ‰ Policy è³‡æ–™
      uri:
        url: "{{ fortigate_api_url }}/api/v2/monitor/firewall/policy"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_access_token }}"
        body_format: form-urlencoded
        body:
          vdom: "{{ vdom_name | default('root') }}"
        validate_certs: "{{ fortigate_validate_certs | default(false) }}"
        timeout: 30
      register: all_policies

    - name: ğŸ” æª¢æŸ¥ç¬¬ä¸€å€‹ Policy çš„æ¬„ä½çµæ§‹
      debug:
        msg: |
          ========= ğŸ” Policy æ¬„ä½çµæ§‹åˆ†æ =========
          {% if all_policies.json.results | length > 0 %}
          ğŸ“‹ ç¬¬ä¸€å€‹ Policy çš„å¯ç”¨æ¬„ä½:
          {{ all_policies.json.results[0].keys() | list }}
          
          ğŸ“Š ç¯„ä¾‹è³‡æ–™:
          {% for key, value in all_policies.json.results[0].items() %}
          - {{ key }}: {{ value }}
          {% endfor %}
          {% endif %}
          =========================================

    - name: ğŸ” å®‰å…¨ç¯©é¸ Unused Policies
      set_fact:
        unused_policies: "{{ all_policies.json.results | selectattr('bytes', 'defined') | selectattr('packets', 'defined') | selectattr('bytes', 'equalto', 0) | selectattr('packets', 'equalto', 0) | list }}"

    - name: ğŸ“Š Policy çµ±è¨ˆç¸½è¦½
      debug:
        msg: |
          ========= ğŸ“Š Policy çµ±è¨ˆç¸½è¦½ =========
          ğŸ¢ VDOM: {{ vdom_name | default('root') }}
          ğŸ“‹ ç¸½ Policies: {{ all_policies.json.results | length }}
          ğŸ¯ Unused Policies: {{ unused_policies | length }}
          ğŸ“Š Used Policies: {{ (all_policies.json.results | length) - (unused_policies | length) }}
          
          {% if all_policies.json.results | length > 0 %}
          ğŸ“ˆ Unused æ¯”ä¾‹: {{ ((unused_policies | length / all_policies.json.results | length) * 100) | round(1) }}%
          {% endif %}
          ====================================

    - name: ğŸ¯ é¡¯ç¤º Unused Policies æ¸…å–®
      debug:
        msg: |
          ========= ğŸ¯ Unused Policies è©³ç´°æ¸…å–® =========
          
          {% if unused_policies | length > 0 %}
          {% for policy in unused_policies | sort(attribute='policyid') %}
          
          ğŸ“‹ Policy {{ policy.policyid | default('N/A') }}:
          - Bytes: {{ policy.bytes | default('N/A') }}
          - Packets: {{ policy.packets | default('N/A') }}  
          - Hit Count: {{ policy.hit_count | default('N/A') }}
          - Session Count: {{ policy.session_count | default('N/A') }}
          - Active Sessions: {{ policy.active_sessions | default('N/A') }}
          - Last Used: {{ 'Never' if (policy.last_used | default(0)) == 0 else ((policy.last_used | int) | strftime('%Y-%m-%d %H:%M:%S')) }}
          - First Used: {{ 'Never' if (policy.first_used | default(0)) == 0 else ((policy.first_used | int) | strftime('%Y-%m-%d %H:%M:%S')) }}
          {% if policy.session_last_used is defined %}
          - Session Last Used: {{ 'Never' if policy.session_last_used == 0 else (policy.session_last_used | int | strftime('%Y-%m-%d %H:%M:%S')) }}
          {% endif %}
          
          {% endfor %}
          {% else %}
          âœ… æ‰€æœ‰ policies éƒ½æœ‰ä½¿ç”¨è¨˜éŒ„ï¼
          {% endif %}
          ===============================================

    - name: ğŸ“‹ Unused Policies æ‘˜è¦
      debug:
        msg: |
          ========= ğŸ“‹ Unused Policies æ‘˜è¦ =========
          
          {% if unused_policies | length > 0 %}
          {% set never_used = unused_policies | selectattr('last_used', 'defined') | selectattr('last_used', 'equalto', 0) | list %}
          {% set old_unused = unused_policies | selectattr('last_used', 'defined') | rejectattr('last_used', 'equalto', 0) | list %}
          
          ğŸ“Š åˆ†é¡çµ±è¨ˆ:
          - Never Used: {{ never_used | length }} policies
          - Previously Used (ä½†ç¾åœ¨æœªä½¿ç”¨): {{ old_unused | length }} policies
          
          {% if never_used | length > 0 %}
          ğŸ“‹ Never Used Policy IDs: 
          {{ never_used | map(attribute='policyid') | list | sort | join(', ') }}
          {% endif %}
          
          ğŸ“‹ All Unused Policy IDs:
          {{ unused_policies | map(attribute='policyid') | list | sort | join(', ') }}
          
          {% else %}
          âœ… æ²’æœ‰ç™¼ç¾ unused policies
          {% endif %}
          =========================================

    # ç”Ÿæˆå®‰å…¨çš„ CSV æ ¼å¼è¼¸å‡º
    - name: ğŸ“„ ç”Ÿæˆ CSV æ ¼å¼è¼¸å‡º
      debug:
        msg: |
          ========= ğŸ“„ CSV æ ¼å¼è¼¸å‡º =========
          
          Policy ID,Bytes,Packets,Hit Count,Session Count,Active Sessions,Last Used,First Used,Status
          {% for policy in unused_policies | sort(attribute='policyid') %}
          {{ policy.policyid | default('N/A') }},{{ policy.bytes | default(0) }},{{ policy.packets | default(0) }},{{ policy.hit_count | default('N/A') }},{{ policy.session_count | default('N/A') }},{{ policy.active_sessions | default('N/A') }},"{{ 'Never' if (policy.last_used | default(0)) == 0 else ((policy.last_used | int) | strftime('%Y-%m-%d %H:%M:%S')) }}","{{ 'Never' if (policy.first_used | default(0)) == 0 else ((policy.first_used | int) | strftime('%Y-%m-%d %H:%M:%S')) }}","{{ 'Never Used' if (policy.last_used | default(0)) == 0 else 'Previously Used' }}"
          {% endfor %}
          
          ===================================

    # ç”Ÿæˆå®‰å…¨çš„ JSON è¼¸å‡º
    - name: ğŸ“¤ ç”Ÿæˆ JSON æ ¼å¼è¼¸å‡º
      debug:
        msg: |
          ========= ğŸ“¤ JSON æ ¼å¼è¼¸å‡º =========
          
          {
            "scan_info": {
              "vdom": "{{ vdom_name | default('root') }}",
              "scan_time": "{{ ansible_date_time.iso8601 }}",
              "fortigate_host": "{{ fortigate_host }}"
            },
            "summary": {
              "total_policies": {{ all_policies.json.results | length }},
              "unused_policies": {{ unused_policies | length }},
              "used_policies": {{ (all_policies.json.results | length) - (unused_policies | length) }}{% if all_policies.json.results | length > 0 %},
              "unused_percentage": {{ ((unused_policies | length / all_policies.json.results | length) * 100) | round(1) }}{% endif %}
            },
            "unused_policy_ids": {{ unused_policies | map(attribute='policyid') | list | sort }},
            "unused_policies_detail": [
              {% for policy in unused_policies | sort(attribute='policyid') %}
              {
                "policyid": {{ policy.policyid | default('null') }},
                "bytes": {{ policy.bytes | default(0) }},
                "packets": {{ policy.packets | default(0) }},
                "hit_count": {{ policy.hit_count | default('null') }},
                "session_count": {{ policy.session_count | default('null') }},
                "active_sessions": {{ policy.active_sessions | default('null') }},
                "last_used_timestamp": {{ policy.last_used | default(0) }},
                "last_used_readable": "{{ 'Never' if (policy.last_used | default(0)) == 0 else ((policy.last_used | int) | strftime('%Y-%m-%d %H:%M:%S')) }}",
                "first_used_timestamp": {{ policy.first_used | default(0) }},
                "first_used_readable": "{{ 'Never' if (policy.first_used | default(0)) == 0 else ((policy.first_used | int) | strftime('%Y-%m-%d %H:%M:%S')) }}",
                "status": "{{ 'Never Used' if (policy.last_used | default(0)) == 0 else 'Previously Used' }}"
              }{{ ',' if not loop.last else '' }}
              {% endfor %}
            ]
          }
          ===================================

    # åˆ†æå¯ç”¨çš„æ™‚é–“æ¬„ä½
    - name: ğŸ• åˆ†ææ™‚é–“ç›¸é—œæ¬„ä½
      debug:
        msg: |
          ========= ğŸ• æ™‚é–“æ¬„ä½åˆ†æ =========
          
          {% if unused_policies | length > 0 %}
          {% set sample_policy = unused_policies[0] %}
          
          ğŸ“Š ç¬¬ä¸€å€‹ unused policy çš„æ™‚é–“æ¬„ä½:
          {% for key, value in sample_policy.items() %}
          {% if 'time' in key|lower or 'used' in key|lower or key in ['last_used', 'first_used', 'session_last_used', 'session_first_used'] %}
          - {{ key }}: {{ value }} {% if value != 0 and value is number %}({{ value | int | strftime('%Y-%m-%d %H:%M:%S') }}){% endif %}
          {% endif %}
          {% endfor %}
          
          ğŸ” å»ºè­°ä½¿ç”¨çš„æ™‚é–“æ¬„ä½: last_used, session_last_used
          {% endif %}
          ===================================

    - name: ğŸ¯ åŸ·è¡Œå®Œæˆ
      debug:
        msg: |
          ========= ğŸ¯ ä»»å‹™åŸ·è¡Œå®Œæˆ =========
          
          âœ… æˆåŠŸåˆ†æ FortiGate unused policies
          ğŸ“Š ç¸½å…±æª¢æŸ¥äº† {{ all_policies.json.results | length }} æ¢ policies
          ğŸ¯ è­˜åˆ¥å‡º {{ unused_policies | length }} å€‹ unused policies
          
          {% if unused_policies | length > 0 %}
          ğŸ“‹ Unused Policy IDs: {{ unused_policies | map(attribute='policyid') | list | sort | join(', ') }}
          
          ğŸ’¡ å»ºè­°å¾ŒçºŒå‹•ä½œ:
          1. æª¢æŸ¥é€™äº› policies çš„é…ç½®å’Œç”¨é€”
          2. è€ƒæ…®å°‡å®ƒå€‘è¨­ç‚º disabled è€Œä¸æ˜¯ç›´æ¥åˆªé™¤
          3. å®šæœŸåŸ·è¡Œæ­¤æª¢æŸ¥ä»¥ç¶­æŒ policy æ¸…æ½”åº¦
          {% else %}
          ğŸ‰ å¤ªæ£’äº†ï¼æ²’æœ‰ç™¼ç¾ unused policies
          {% endif %}
          
          ğŸ’¾ è³‡æ–™å·²ä»¥å¤šç¨®æ ¼å¼è¼¸å‡ºï¼Œå¯ç”¨æ–¼é€²ä¸€æ­¥åˆ†æ
          =================================
