---
# =============================================================================
# FortiGate DHCP Reserved Address Delete Preview For Workflow Playbook
# ç”¨é€”ï¼šé è¦½è¦åˆªé™¤çš„MACé…ç½®ï¼Œè¨ˆç®—é‚„åŸå¾Œçš„MACåœ°å€
# è¼¸å‡ºï¼šé¡¯ç¤ºç•¶å‰é…ç½®å’Œé è¨ˆè®Šæ›´å…§å®¹ï¼Œè¨­å®šworkflowè®Šæ•¸
# =============================================================================

- name: FortiGate DHCP Delete Preview For Workflow v3.4
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    delete_mac: "{{ delete_mac_param }}"
    dhcp_server_id: "{{ server_id | default('3') }}"
    fortigate_host: "{{ fortigate_host }}"
    fortigate_token: "{{ fortigate_access_token }}"
    vdom_name: "{{ fortigate_vdom | default('root') }}"
    
  tasks:
    # åƒæ•¸é©—è­‰
    - name: "ğŸ” Validate Credentials"
      ansible.builtin.fail:
        msg: "ç¼ºå°‘FortiGate Credentialåƒæ•¸"
      when: fortigate_host is not defined or fortigate_token is not defined

    # é¡¯ç¤ºé è¦½åƒæ•¸ï¼ˆå–®è¡Œæ ¼å¼ï¼‰
    - name: "ğŸ“‹ FortiGate DHCP Delete Preview v3.4"
      ansible.builtin.debug:
        msg: "===========================================" 

    - name: "ğŸ“‹ Preview Parameters"
      ansible.builtin.debug:
        msg: "ğŸ” é è¦½æ¨¡å¼ | ç›®æ¨™MAC: {{ delete_mac }} | DHCP Server: {{ dhcp_server_id }} | Host: {{ fortigate_host }}"

    # ç²å–DHCPé…ç½®
    - name: "ğŸ” Get Current DHCP Reserved Addresses"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: false
        status_code: 200
      register: existing_reservations

    # é¡¯ç¤ºç•¶å‰é…ç½®ï¼ˆä½¿ç”¨loopé€è¡Œé¡¯ç¤ºï¼‰
    - name: "ğŸ“Š Current DHCP Server {{ dhcp_server_id }} Configurations"
      ansible.builtin.debug:
        msg: "ğŸ“‹ ç•¶å‰é…ç½® {{ ansible_loop.index }}/{{ existing_reservations.json.results | length }} - ID: {{ item.id }} | IP: {{ item.ip }} | MAC: {{ item.mac }} | æè¿°: {{ item.description | default('ç„¡') }}"
      loop: "{{ existing_reservations.json.results }}"
      loop_control:
        extended: true
      when: existing_reservations.json.results | length > 0

    - name: "ğŸ“Š No Configurations Found"
      ansible.builtin.debug:
        msg: "âš ï¸ DHCP Server {{ dhcp_server_id }} ç›®å‰æ²’æœ‰ä»»ä½•reserved-addressé…ç½®"
      when: existing_reservations.json.results | length == 0

    # æœå°‹ç›®æ¨™MAC
    - name: "ğŸ” Search for Target MAC"
      ansible.builtin.set_fact:
        target_object: "{{ item }}"
      loop: "{{ existing_reservations.json.results }}"
      when:
        - target_object is not defined
        - item.mac.lower() == delete_mac.lower()

    # MACæœªæ‰¾åˆ°æ™‚çš„éŒ¯èª¤è™•ç†
    - name: "âŒ Target MAC Not Found"
      ansible.builtin.debug:
        msg: "âŒ æœªæ‰¾åˆ°MAC: {{ delete_mac }} åœ¨DHCP Server {{ dhcp_server_id }} ä¸­"
      when: target_object is not defined

    - name: "âŒ Available MAC Addresses"
      ansible.builtin.debug:
        msg: "ğŸ“‹ å¯ç”¨MAC {{ ansible_loop.index }}/{{ existing_reservations.json.results | length }} - {{ item.mac }} (IP: {{ item.ip }})"
      loop: "{{ existing_reservations.json.results }}"
      loop_control:
        extended: true
      when: 
        - target_object is not defined
        - existing_reservations.json.results | length > 0

    - name: "âŒ Stop Execution - MAC Not Found"
      ansible.builtin.fail:
        msg: "æ“ä½œçµ‚æ­¢ï¼šæœªæ‰¾åˆ°æŒ‡å®šçš„MACåœ°å€ {{ delete_mac }}"
      when: target_object is not defined

    # è¨ˆç®—é‚„åŸMAC
    - name: "ğŸ§® Calculate Reserved MAC Address"
      ansible.builtin.set_fact:
        ip_fourth_octet: "{{ target_object.ip.split('.')[3] }}"
        first_digit: "{{ target_object.ip.split('.')[3][0] }}"
        last_two_digits: "{{ target_object.ip.split('.')[3][1:] }}"
        reserved_mac: "ff:ff:ff:ff:f{{ target_object.ip.split('.')[3][0] }}:{{ target_object.ip.split('.')[3][1:] }}"
      when: target_object is defined

    # é¡¯ç¤ºè¨ˆç®—éç¨‹ï¼ˆåˆ†æ­¥é¡¯ç¤ºï¼‰
    - name: "ğŸ§® MAC Calculation Process"
      ansible.builtin.debug:
        msg: "ğŸ§® MACè¨ˆç®— | IP: {{ target_object.ip }} | ç¬¬å››ç¢¼: {{ ip_fourth_octet }} | ç¬¬ä¸€ä½: {{ first_digit }} | å¾Œå…©ä½: {{ last_two_digits }}"

    - name: "ğŸ§® MAC Calculation Result"
      ansible.builtin.debug:
        msg: "ğŸ”§ MACæ ¼å¼: ff:ff:ff:ff:f{{ first_digit }}:{{ last_two_digits }} | çµæœ: {{ reserved_mac }}"

    # é¡¯ç¤ºé è¦½çµæœï¼ˆåˆ†æ®µé¡¯ç¤ºï¼‰
    - name: "âœ… Target Configuration Found"
      ansible.builtin.debug:
        msg: "âœ… æ‰¾åˆ°ç›®æ¨™MACé…ç½® ========================================="

    - name: "ğŸ“Š Current Configuration"
      ansible.builtin.debug:
        msg: "ğŸ“Š ç•¶å‰ | ID: {{ target_object.id }} | IP: {{ target_object.ip }} | MAC: {{ target_object.mac }} | æè¿°: {{ target_object.description | default('ç©ºç™½') }}"

    - name: "ğŸ”„ After Delete Configuration" 
      ansible.builtin.debug:
        msg: "ğŸ”„ é‚„åŸ | ID: {{ target_object.id }} | IP: {{ target_object.ip }} | MAC: {{ reserved_mac }} | æè¿°: Reserved"

    - name: "ğŸ“ MAC Restore Rule"
      ansible.builtin.debug:
        msg: "ğŸ“ è¦å‰‡ | IPç¬¬å››ç¢¼ {{ ip_fourth_octet }} â†’ MAC ff:ff:ff:ff:f{{ first_digit }}:{{ last_two_digits }} | æè¿°çµ±ä¸€ç‚ºReserved"

    - name: "âš ï¸ Configuration Change Warning"
      ansible.builtin.debug:
        msg: "âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ°¸ä¹…ä¿®æ”¹FortiGateé…ç½®ï¼è«‹åœ¨Approval Nodeä¸­ä»”ç´°ç¢ºèªå¾Œå†æ‰¹å‡†åŸ·è¡Œã€‚"

    # è¨­å®šworkflowè®Šæ•¸
    - name: "ğŸ“¤ Set Workflow Variables"
      ansible.builtin.set_stats:
        data:
          wf_target_id: "{{ target_object.id }}"
          wf_target_ip: "{{ target_object.ip }}"
          wf_original_mac: "{{ target_object.mac }}"
          wf_reserved_mac: "{{ reserved_mac }}"
          wf_original_desc: "{{ target_object.description | default('') }}"
          wf_server_id: "{{ dhcp_server_id }}"
          wf_delete_mac: "{{ delete_mac }}"
          wf_ip_fourth_octet: "{{ ip_fourth_octet }}"
          wf_first_digit: "{{ first_digit }}"
          wf_last_two_digits: "{{ last_two_digits }}"

    - name: "ğŸ¯ Preview Complete"
      ansible.builtin.debug:
        msg: "ğŸ¯ é è¦½å®Œæˆ | ç­‰å¾…äººå·¥ç¢ºèª | MAC {{ delete_mac }} â†’ {{ reserved_mac }} | IP {{ target_object.ip }}"
