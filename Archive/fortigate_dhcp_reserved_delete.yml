---
# =============================================================================
# FortiGate DHCP Reserved Address Delete Playbook v3.0
# 
# åŠŸèƒ½èªªæ˜ï¼š
# 1. æ ¹æ“šMACåœ°å€æœå°‹æ—¢æœ‰DHCP reserved-addressé…ç½®
# 2. å°‡æŒ‡å®šMACçš„è¨­å®šé‚„åŸç‚ºä¿ç•™ç‹€æ…‹(Reserved)
# 3. è‡ªå‹•è¨ˆç®—ä¿ç•™MACæ ¼å¼ (ff:ff:ff:ff:f1:XX)
# 4. è¦æ±‚ç”¨æˆ¶ç¢ºèªå¾ŒåŸ·è¡Œé‚„åŸæ“ä½œ
# 
# ä½œè€…ï¼šVICI Network Team
# ç‰ˆæœ¬ï¼šv3.0 - DeleteåŠŸèƒ½
# =============================================================================

- name: FortiGate DHCP Reserved Address Delete v3.0
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # =======================================================================
    # è®Šæ•¸å®šç¾©å€
    # =======================================================================
    
    # ç”¨æˆ¶è¼¸å…¥åƒæ•¸ï¼ˆå¾AWX Surveyç²å–ï¼‰  
    delete_mac: "{{ delete_mac_param }}"
    
    # FortiGateç³»çµ±åƒæ•¸
    dhcp_server_id: "{{ server_id | default('3') }}"
    
    # FortiGateé€£æ¥åƒæ•¸ï¼ˆå¾AWX Credentialè‡ªå‹•æ³¨å…¥ï¼‰
    fortigate_host: "{{ fortigate_host }}"
    fortigate_token: "{{ fortigate_access_token }}"
    vdom_name: "{{ fortigate_vdom | default('root') }}"
    
  tasks:
    # =======================================================================
    # æ­¥é©Ÿ1ï¼šåƒæ•¸é©—è­‰
    # =======================================================================
    
    - name: "ğŸ” Validate AWX Credential Parameters"
      ansible.builtin.fail:
        msg: |
          âŒ ç¼ºå°‘å¿…è¦çš„FortiGate Credentialåƒæ•¸ï¼è«‹ç¢ºä¿å·²æ­£ç¢ºè¨­å®šFortiGate Credentialã€‚
      when: fortigate_host is not defined or fortigate_token is not defined

    - name: "ğŸ“‹ Display Input Parameters"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ“‹ FortiGate DHCP Delete åŠŸèƒ½
          ==========================================
          ğŸ—‘ï¸ è¦åˆªé™¤çš„MACåœ°å€: {{ delete_mac }}
          ğŸ·ï¸  DHCP Server ID: {{ dhcp_server_id }}
          ğŸŒ FortiGate Host: {{ fortigate_host }}
          ğŸ  VDOM: {{ vdom_name }}
          ==========================================

    # =======================================================================
    # æ­¥é©Ÿ2ï¼šç²å–ç•¶å‰DHCPé…ç½®
    # =======================================================================
    
    - name: "ğŸ” Get Current DHCP Reserved Addresses"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: false
        status_code: 200
      register: existing_reservations

    - name: "ğŸ“Š Display Current Configuration"
      ansible.builtin.debug:
        msg: |
          ğŸ” DHCPé…ç½®ç²å–çµæœï¼š
          - æŸ¥è©¢æˆåŠŸ: {{ existing_reservations.status == 200 }}
          - ä¿ç•™ä½å€æ•¸é‡: {{ existing_reservations.json.results | length }}
          
          ğŸ“‹ ç•¶å‰æ‰€æœ‰reserved-addressé…ç½®ï¼š
          {% if existing_reservations.json.results | length > 0 %}
          {% for addr in existing_reservations.json.results %}
          - ID: {{ addr.id }}, IP: {{ addr.ip }}, MAC: {{ addr.mac }}, æè¿°: {{ addr.description | default('ç„¡') }}
          {% endfor %}
          {% else %}
          ï¼ˆç›®å‰æ²’æœ‰ä»»ä½•reserved-addressé…ç½®ï¼‰
          {% endif %}

    # =======================================================================
    # æ­¥é©Ÿ3ï¼šæœå°‹è¦åˆªé™¤çš„MAC
    # =======================================================================

    - name: "ğŸ” Search for MAC Address to Delete"
      ansible.builtin.set_fact:
        delete_target_object: "{{ item }}"
      loop: "{{ existing_reservations.json.results }}"
      when:
        - delete_target_object is not defined
        - item.mac.lower() == delete_mac.lower()
      loop_control:
        label: "æœå°‹ MAC {{ item.mac }}"

    - name: "âŒ MAC Not Found - Stop Execution"
      ansible.builtin.fail:
        msg: |
          âŒâŒâŒ æœªæ‰¾åˆ°æŒ‡å®šçš„MACåœ°å€ï¼âŒâŒâŒ
          
          ğŸ” æœå°‹çš„MAC: {{ delete_mac }}
          ğŸ“‹ ç›®å‰ä¸¦æ²’æœ‰é€™å€‹MACçš„è¨­å®š
          
          ğŸ’¡ è«‹æª¢æŸ¥ï¼š
          1. MACåœ°å€æ ¼å¼æ˜¯å¦æ­£ç¢º (XX:XX:XX:XX:XX:XX)
          2. MACåœ°å€æ˜¯å¦ç¢ºå¯¦å­˜åœ¨æ–¼DHCP Server {{ dhcp_server_id }} ä¸­
          3. MACåœ°å€å¤§å°å¯«æ˜¯å¦æ­£ç¢º
          
          ğŸ“‹ ç•¶å‰å­˜åœ¨çš„MACåœ°å€ï¼š
          {% for addr in existing_reservations.json.results %}
          - {{ addr.mac }} (IP: {{ addr.ip }})
          {% endfor %}
          
          âš ï¸ æ“ä½œå·²åœæ­¢
      when: delete_target_object is not defined

    - name: "ğŸ“‹ Found MAC Configuration to Delete"
      ansible.builtin.debug:
        msg: |
          âœ…âœ…âœ… æ‰¾åˆ°è¦åˆªé™¤çš„MACé…ç½®ï¼âœ…âœ…âœ…
          
          ğŸ“Š ç•¶å‰é…ç½®è©³æƒ…ï¼š
          - ID: {{ delete_target_object.id }}
          - IPåœ°å€: {{ delete_target_object.ip }}
          - MACåœ°å€: {{ delete_target_object.mac }}
          - æè¿°: {{ delete_target_object.description | default('ç„¡') }}

    # =======================================================================
    # æ­¥é©Ÿ4ï¼šè¨ˆç®—é‚„åŸå¾Œçš„ä¿ç•™MAC
    # =======================================================================

    - name: "ğŸ§® Calculate Reserved MAC Address"
      ansible.builtin.set_fact:
        # æå–IPçš„ç¬¬å››æ®µ
        ip_fourth_octet: "{{ delete_target_object.ip.split('.')[3] }}"
      when: delete_target_object is defined

    - name: "ğŸ”§ Generate Reserved MAC Format"
      ansible.builtin.set_fact:
        # ç”Ÿæˆä¿ç•™MACæ ¼å¼: ff:ff:ff:ff:f1:XX (XXæ˜¯IPç¬¬å››æ®µ)
        reserved_mac: "ff:ff:ff:ff:f1:{{ '%02d' | format(ip_fourth_octet | int) }}"
      when: delete_target_object is defined and ip_fourth_octet is defined

    - name: "ğŸ“‹ Display Calculated Reserved MAC"
      ansible.builtin.debug:
        msg: |
          ğŸ§® è¨ˆç®—é‚„åŸMACåœ°å€ï¼š
          - IPç¬¬å››æ®µ: {{ ip_fourth_octet }}
          - é‚„åŸå¾ŒMAC: {{ reserved_mac }}
          - é‚„åŸè¦å‰‡: ff:ff:ff:ff:f1:{{ '%02d' | format(ip_fourth_octet | int) }}

    # =======================================================================
    # æ­¥é©Ÿ5ï¼šç¢ºèªåˆªé™¤æ“ä½œ
    # =======================================================================

    - name: "âš ï¸ Confirm Delete Operation"
      ansible.builtin.pause:
        prompt: |
          
          ==========================================
          âš ï¸  ç¢ºèªåˆªé™¤æ“ä½œ
          ==========================================
          
          ğŸ“Š å³å°‡é‚„åŸçš„é…ç½®ï¼š
          - ID: {{ delete_target_object.id }}
          - IPåœ°å€: {{ delete_target_object.ip }} (ä¿æŒä¸è®Š)
          - ç•¶å‰MAC: {{ delete_target_object.mac }}
          - é‚„åŸå¾ŒMAC: {{ reserved_mac }}
          - ç•¶å‰æè¿°: {{ delete_target_object.description | default('ç„¡') }}
          - é‚„åŸå¾Œæè¿°: Reserved
          
          ğŸ”„ é‚„åŸè¦å‰‡èªªæ˜ï¼š
          1. IPåœ°å€ä¿æŒä¸è®Š: {{ delete_target_object.ip }}
          2. MACåœ°å€é‚„åŸç‚º: {{ reserved_mac }}
             (æ ¼å¼: ff:ff:ff:ff:f1:XXï¼ŒXXç‚ºIPç¬¬å››æ®µ {{ ip_fourth_octet }})
          3. æè¿°é‚„åŸç‚º: Reserved
          
          âš ï¸ æ­¤æ“ä½œå°‡æœƒæ°¸ä¹…ä¿®æ”¹FortiGateé…ç½®ï¼
          
          è«‹è¼¸å…¥ 'yes' ç¢ºèªåŸ·è¡Œï¼Œæˆ–æŒ‰Enterå–æ¶ˆ:
      register: delete_confirmation

    - name: "ğŸš« User Cancelled Delete Operation"
      ansible.builtin.fail:
        msg: |
          â„¹ï¸â„¹ï¸â„¹ï¸ ç”¨æˆ¶å–æ¶ˆäº†åˆªé™¤æ“ä½œ â„¹ï¸â„¹ï¸â„¹ï¸
          
          ğŸ“‹ æ“ä½œæ‘˜è¦ï¼š
          - æ‰¾åˆ°çš„MAC: {{ delete_mac }}
          - å°æ‡‰çš„IP: {{ delete_target_object.ip }}
          - æ“ä½œç‹€æ…‹: å·²å–æ¶ˆ
          
          ğŸ’¡ é…ç½®ä¿æŒåŸç‹€ï¼Œæœªé€²è¡Œä»»ä½•è®Šæ›´
      when: delete_confirmation.user_input | lower != 'yes'

    # =======================================================================
    # æ­¥é©Ÿ6ï¼šåŸ·è¡Œåˆªé™¤æ“ä½œ
    # =======================================================================

    - name: "ğŸ”§ Execute MAC Delete - Restore to Reserved Configuration"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address/{{ delete_target_object.id }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          ip: "{{ delete_target_object.ip }}"
          mac: "{{ reserved_mac }}"
          description: "Reserved"
        body_format: json
        validate_certs: false
        status_code: 200
      register: delete_result
      when: delete_confirmation.user_input | lower == 'yes'

    - name: "ğŸ‰ MAC Delete Operation Complete"
      ansible.builtin.debug:
        msg: |
          âœ…âœ…âœ… MACåˆªé™¤æ“ä½œæˆåŠŸï¼âœ…âœ…âœ…
          
          ğŸ“‹ é‚„åŸçµæœï¼š
          - é…ç½®ID: {{ delete_target_object.id }}
          - IPåœ°å€: {{ delete_target_object.ip }} (æœªè®Šæ›´)
          - åŸå§‹MAC: {{ delete_target_object.mac }}
          - é‚„åŸå¾ŒMAC: {{ reserved_mac }}
          - åŸå§‹æè¿°: {{ delete_target_object.description | default('ç„¡') }}
          - é‚„åŸå¾Œæè¿°: Reserved
          
          ğŸ¯ FortiGate DHCPé…ç½®å·²æˆåŠŸé‚„åŸç‚ºä¿ç•™ç‹€æ…‹ï¼
      when: 
        - delete_result is defined
        - delete_result.json.revision_changed | default(false)

    - name: "âŒ MAC Delete Operation Failed"
      ansible.builtin.debug:
        msg: |
          âŒâŒâŒ MACåˆªé™¤æ“ä½œå¤±æ•— âŒâŒâŒ
          
          ğŸ“‹ éŒ¯èª¤è©³æƒ…ï¼š
          {{ delete_result.msg | default('æœªçŸ¥éŒ¯èª¤') }}
          
          ğŸ” HTTPç‹€æ…‹ç¢¼: {{ delete_result.status | default('æœªçŸ¥') }}
          
          ğŸ’¡ è«‹æª¢æŸ¥ï¼š
          1. FortiGateé€£æ¥ç‹€æ…‹
          2. API Tokenæ¬Šé™
          3. DHCP Server IDæ˜¯å¦æ­£ç¢º
          4. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸
      when: 
        - delete_result is defined 
        - delete_result is failed

    # =======================================================================
    # æ­¥é©Ÿ7ï¼šæœ€çµ‚åŸ·è¡Œæ‘˜è¦
    # =======================================================================
    
    - name: "ğŸ“Š Final Execution Summary"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ“Š FortiGate DHCP Delete åŸ·è¡Œæ‘˜è¦
          ==========================================
          ğŸ—‘ï¸ åˆªé™¤æ“ä½œçµæœ:
          - åˆªé™¤çš„MAC: {{ delete_mac }}
          - å°æ‡‰çš„IP: {{ delete_target_object.ip }}
          - é‚„åŸå¾ŒMAC: {{ reserved_mac }}
          - ç‹€æ…‹: {{ 'âœ… æˆåŠŸ' if (delete_result is defined and delete_result.json.revision_changed | default(false)) else 'ğŸš« å·²å–æ¶ˆ' if (delete_confirmation.user_input | lower != 'yes') else 'âŒ å¤±æ•—' }}
          
          ğŸ“… åŸ·è¡Œæ™‚é–“: {{ ansible_date_time.iso8601 | default('æœªçŸ¥') }}
          ==========================================
