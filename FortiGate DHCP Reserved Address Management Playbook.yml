---
# =============================================================================
# FortiGate DHCP Reserved Address Management Playbook v3.0
# 
# åŠŸèƒ½èªªæ˜ï¼š
# 1. æ”¯æ´æ–°å¢/ä¿®æ”¹DHCP reserved-address (åŸv2.1åŠŸèƒ½)
# 2. æ–°å¢MACåˆªé™¤åŠŸèƒ½ - å°‡æŒ‡å®šMACçš„è¨­å®šé‚„åŸç‚ºä¿ç•™ç‹€æ…‹
# 3. è‡ªå‹•æª¢æ¸¬MACåœ°å€è¡çªï¼Œé¿å…é‡è¤‡åˆ†é…
# 4. ä½¿ç”¨AWX Surveyé¸æ“‡åŠŸèƒ½é¡å‹
# 
# ä½œè€…ï¼šVICI Network Team
# ç‰ˆæœ¬ï¼šv3.0 - æ–°å¢MACåˆªé™¤åŠŸèƒ½
# =============================================================================

- name: FortiGate DHCP Reserved Address Management v3.0
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # =======================================================================
    # è®Šæ•¸å®šç¾©å€
    # =======================================================================
    
    # åŠŸèƒ½é¸æ“‡åƒæ•¸ï¼ˆå¾AWX Surveyç²å–ï¼‰
    operation_mode: "{{ operation_type }}"         # 1=æ–°å¢ä¿®æ”¹, 2=åˆªé™¤
    
    # æ–°å¢/ä¿®æ”¹åŠŸèƒ½åƒæ•¸ï¼ˆç•¶operation_mode=1æ™‚ä½¿ç”¨ï¼‰
    target_ip: "{{ ip_param | default('') }}"
    target_mac: "{{ mac_param | default('') }}"
    target_description: "{{ desc_param | default('') }}"
    
    # åˆªé™¤åŠŸèƒ½åƒæ•¸ï¼ˆç•¶operation_mode=2æ™‚ä½¿ç”¨ï¼‰
    delete_mac: "{{ delete_mac_param | default('') }}"
    
    # FortiGateç³»çµ±åƒæ•¸
    dhcp_server_id: "{{ server_id | default('3') }}"
    
    # FortiGateé€£æ¥åƒæ•¸ï¼ˆå¾AWX Credentialè‡ªå‹•æ³¨å…¥ï¼‰
    fortigate_host: "{{ fortigate_host }}"
    fortigate_token: "{{ fortigate_access_token }}"
    vdom_name: "{{ fortigate_vdom | default('root') }}"
    
  tasks:
    # =======================================================================
    # æ­¥é©Ÿ0ï¼šCredentialåƒæ•¸é©—è­‰
    # =======================================================================
    
    - name: "ğŸ” Validate AWX Credential Parameters"
      ansible.builtin.fail:
        msg: |
          âŒ ç¼ºå°‘å¿…è¦çš„FortiGate Credentialåƒæ•¸ï¼è«‹ç¢ºä¿å·²æ­£ç¢ºè¨­å®šFortiGate Credentialã€‚
      when: fortigate_host is not defined or fortigate_token is not defined
      tags:
        - validate

    # =======================================================================
    # æ­¥é©Ÿ1ï¼šé¡¯ç¤ºåŠŸèƒ½é¸æ“‡å’Œåƒæ•¸
    # =======================================================================
    
    - name: "ğŸ“‹ Display Function Selection and Input Parameters"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ“‹ FortiGate DHCP Reserved Address ç®¡ç† v3.0
          ==========================================
          ğŸ¯ é¸æ“‡çš„åŠŸèƒ½: {{ 'æ–°å¢/ä¿®æ”¹è¨­å®š' if operation_mode == '1' else 'åˆªé™¤è¨­å®š' if operation_mode == '2' else 'æœªçŸ¥åŠŸèƒ½' }}
          ğŸ·ï¸  DHCP Server ID: {{ dhcp_server_id }}
          ğŸŒ FortiGate Host: {{ fortigate_host }}
          ğŸ  VDOM: {{ vdom_name }}
          
          {% if operation_mode == '1' %}
          ğŸ“ æ–°å¢/ä¿®æ”¹åƒæ•¸:
          - ç›®æ¨™IPåœ°å€: {{ target_ip }}
          - ç›®æ¨™MACåœ°å€: {{ target_mac }}
          - ç›®æ¨™æè¿°: {{ target_description }}
          {% elif operation_mode == '2' %}
          ğŸ—‘ï¸ åˆªé™¤åƒæ•¸:
          - è¦åˆªé™¤çš„MACåœ°å€: {{ delete_mac }}
          {% endif %}
          ==========================================

    # =======================================================================
    # æ­¥é©Ÿ2ï¼šç²å–FortiGateç•¶å‰DHCP reserved-addressé…ç½®
    # =======================================================================
    
    - name: "ğŸ” Get Current DHCP Reserved Addresses"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: false
        status_code: 200
      register: existing_reservations
      tags:
        - get_config

    - name: "ğŸ“Š Display Current Configuration"
      ansible.builtin.debug:
        msg: |
          ğŸ” DHCPé…ç½®ç²å–çµæœï¼š
          - æŸ¥è©¢æˆåŠŸ: {{ existing_reservations.status == 200 }}
          - ä¿ç•™ä½å€æ•¸é‡: {{ existing_reservations.json.results | length }}
          
          ğŸ“‹ ç•¶å‰æ‰€æœ‰reserved-addressé…ç½®ï¼š
          {% if existing_reservations.json.results | length > 0 %}
          {% for addr in existing_reservations.json.results %}
          - ID: {{ addr.id }}, IP: {{ addr.ip }}, MAC: {{ addr.mac }}, æè¿°: {{ addr.description | default('ç„¡') }}
          {% endfor %}
          {% else %}
          ï¼ˆç›®å‰æ²’æœ‰ä»»ä½•reserved-addressé…ç½®ï¼‰
          {% endif %}
      tags:
        - get_config

    # =======================================================================
    # æ¢ä»¶åˆ†æ”¯ï¼šæ–°å¢/ä¿®æ”¹åŠŸèƒ½ (operation_mode == '1')
    # =======================================================================

    - name: "ğŸ” MAC Conflict Detection - Create/Update Function"
      ansible.builtin.set_fact:
        mac_conflict_object: "{{ item }}"
      loop: "{{ existing_reservations.json.results }}"
      when:
        - operation_mode == '1'
        - mac_conflict_object is not defined
        - item.mac.lower() == target_mac.lower()
      loop_control:
        label: "æª¢æŸ¥ MAC {{ item.mac }}"
      tags:
        - create_update

    - name: "ğŸ“‹ MAC Conflict Detection Result - Create/Update Function"
      ansible.builtin.debug:
        msg: |
          ğŸ” MACè¡çªæª¢æ¸¬çµæœ:
          {% if mac_conflict_object is defined %}
          âš ï¸  æ‰¾åˆ°æ—¢æœ‰MACé…ç½®: ID {{ mac_conflict_object.id }}, IP {{ mac_conflict_object.ip }}
          ğŸš« MACè¡çªç‹€æ…‹: {{ 'æ˜¯' if (mac_conflict_object.ip != target_ip) else 'å¦' }}
          {% else %}
          â„¹ï¸  æœªæ‰¾åˆ°æ—¢æœ‰MACé…ç½®ï¼Œç„¡è¡çª
          {% endif %}
      when: operation_mode == '1'
      tags:
        - create_update

    - name: "ğŸš« Stop Execution - MAC Conflict"
      ansible.builtin.fail:
        msg: "MACè¡çªï¼MAC {{ target_mac }} å·²è¢«IP {{ mac_conflict_object.ip }} ä½¿ç”¨ã€‚"
      when: 
        - operation_mode == '1'
        - mac_conflict_object is defined 
        - mac_conflict_object.ip != target_ip
      tags:
        - create_update

    - name: "ğŸ” Find Target IP Configuration"
      ansible.builtin.set_fact:
        target_object_list: "{{ existing_reservations.json.results | selectattr('ip', 'equalto', target_ip) | list }}"
      when: operation_mode == '1'
      tags:
        - create_update

    - name: "ğŸ¯ Determine Operation Type - Create/Update Function"
      ansible.builtin.set_fact:
        create_update_operation_type: >-
          {%- if target_object_list | length > 0 -%}
            æ›´æ–°æ—¢æœ‰é…ç½®
          {%- else -%}
            å‰µå»ºæ–°é…ç½®
          {%- endif -%}
        needs_update: >-
          {%- if target_object_list | length == 0 -%}
            true
          {%- else -%}
            {{
              (target_object_list[0].mac != target_mac) or
              (target_object_list[0].description | default('') != target_description)
            }}
          {%- endif -%}
        target_object: "{{ target_object_list[0] if target_object_list | length > 0 else {} }}"
      when: operation_mode == '1'
      tags:
        - create_update

    - name: "âœ… Configuration Already Up-to-Date"
      ansible.builtin.debug:
        msg: "âœ… ç•¶å‰é…ç½®å·²ç¬¦åˆç›®æ¨™ç‹€æ…‹ï¼Œç„¡éœ€æ›´æ–°ï¼"
      when: 
        - operation_mode == '1'
        - not needs_update
      tags:
        - create_update

    - name: "ğŸ”§ Update Existing DHCP Reserved Address"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address/{{ target_object.id }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          mac: "{{ target_mac }}"
          description: "{{ target_description }}"
        body_format: json
        validate_certs: false
        status_code: 200
      register: update_result
      when: 
        - operation_mode == '1'
        - needs_update 
        - target_object_list | length > 0
      tags:
        - create_update

    - name: "ğŸ†• Create New DHCP Reserved Address"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address"
        method: POST
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          ip: "{{ target_ip }}"
          mac: "{{ target_mac }}"
          description: "{{ target_description }}"
        body_format: json
        validate_certs: false
        status_code: 200
      register: create_result
      when: 
        - operation_mode == '1'
        - needs_update 
        - target_object_list | length == 0
      tags:
        - create_update

    - name: "ğŸ‰ Create/Update Operation Complete"
      ansible.builtin.debug:
        msg: |
          âœ… {{ create_update_operation_type }}æˆåŠŸï¼
          {% if target_object_list | length > 0 %}
          - æ›´æ–°çš„é…ç½®: ID {{ target_object.id }}
          {% endif %}
          - IP: {{ target_ip }}
          - MAC: {{ target_mac }}
          - æè¿°: {{ target_description }}
      when: 
        - operation_mode == '1'
        - needs_update 
        - ((update_result is defined and update_result.json.revision_changed | default(false)) or (create_result is defined and create_result.json.revision_changed | default(false)))
      tags:
        - create_update

    # =======================================================================
    # æ¢ä»¶åˆ†æ”¯ï¼šMACåˆªé™¤åŠŸèƒ½ (operation_mode == '2')
    # =======================================================================

    - name: "ğŸ” Search for MAC Address to Delete"
      ansible.builtin.set_fact:
        delete_target_object: "{{ item }}"
      loop: "{{ existing_reservations.json.results }}"
      when:
        - operation_mode == '2'
        - delete_target_object is not defined
        - item.mac.lower() == delete_mac.lower()
      loop_control:
        label: "æœå°‹ MAC {{ item.mac }}"
      tags:
        - delete

    - name: "âŒ MAC Not Found - Stop Execution"
      ansible.builtin.fail:
        msg: |
          âŒ æœªæ‰¾åˆ°æŒ‡å®šçš„MACåœ°å€ï¼
          
          ğŸ” æœå°‹çš„MAC: {{ delete_mac }}
          ğŸ“‹ ç›®å‰ä¸¦æ²’æœ‰é€™å€‹MACçš„è¨­å®š
          
          ğŸ’¡ è«‹æª¢æŸ¥ï¼š
          1. MACåœ°å€æ ¼å¼æ˜¯å¦æ­£ç¢º (XX:XX:XX:XX:XX:XX)
          2. MACåœ°å€æ˜¯å¦ç¢ºå¯¦å­˜åœ¨æ–¼DHCP Server {{ dhcp_server_id }} ä¸­
          
          âš ï¸ æ“ä½œå·²åœæ­¢
      when: 
        - operation_mode == '2'
        - delete_target_object is not defined
      tags:
        - delete

    - name: "ğŸ“‹ Found MAC Configuration to Delete"
      ansible.builtin.debug:
        msg: |
          âœ… æ‰¾åˆ°è¦åˆªé™¤çš„MACé…ç½®ï¼
          
          ğŸ“Š ç•¶å‰é…ç½®è©³æƒ…ï¼š
          - ID: {{ delete_target_object.id }}
          - IPåœ°å€: {{ delete_target_object.ip }}
          - MACåœ°å€: {{ delete_target_object.mac }}
          - æè¿°: {{ delete_target_object.description | default('ç„¡') }}
      when: 
        - operation_mode == '2'
        - delete_target_object is defined
      tags:
        - delete

    - name: "ğŸ§® Calculate Reserved MAC Address"
      ansible.builtin.set_fact:
        # æå–IPçš„ç¬¬å››æ®µ
        ip_fourth_octet: "{{ delete_target_object.ip.split('.')[3] }}"
        # ç”Ÿæˆä¿ç•™MACæ ¼å¼: ff:ff:ff:ff:f1:XX (XXæ˜¯IPç¬¬å››æ®µ)
        reserved_mac: "ff:ff:ff:ff:f1:{{ '%02d' | format(ip_fourth_octet | int) }}"
      when: 
        - operation_mode == '2'
        - delete_target_object is defined
      tags:
        - delete

    - name: "âš ï¸ Confirm Delete Operation"
      ansible.builtin.pause:
        prompt: |
          
          ==========================================
          âš ï¸  ç¢ºèªåˆªé™¤æ“ä½œ
          ==========================================
          
          ğŸ“Š å³å°‡é‚„åŸçš„é…ç½®ï¼š
          - ID: {{ delete_target_object.id }}
          - IPåœ°å€: {{ delete_target_object.ip }} (ä¿æŒä¸è®Š)
          - ç•¶å‰MAC: {{ delete_target_object.mac }}
          - é‚„åŸå¾ŒMAC: {{ reserved_mac }}
          - ç•¶å‰æè¿°: {{ delete_target_object.description | default('ç„¡') }}
          - é‚„åŸå¾Œæè¿°: Reserved
          
          ğŸ”„ é‚„åŸè¦å‰‡èªªæ˜ï¼š
          1. IPåœ°å€ä¿æŒä¸è®Š: {{ delete_target_object.ip }}
          2. MACåœ°å€é‚„åŸç‚º: {{ reserved_mac }}
             (æ ¼å¼: ff:ff:ff:ff:f1:XXï¼ŒXXç‚ºIPç¬¬å››æ®µ {{ ip_fourth_octet }})
          3. æè¿°é‚„åŸç‚º: Reserved
          
          âš ï¸ æ­¤æ“ä½œå°‡æœƒæ°¸ä¹…ä¿®æ”¹FortiGateé…ç½®ï¼
          
          è«‹è¼¸å…¥ 'yes' ç¢ºèªåŸ·è¡Œï¼Œæˆ–æŒ‰Enterå–æ¶ˆ:
      register: delete_confirmation
      when: 
        - operation_mode == '2'
        - delete_target_object is defined
      tags:
        - delete

    - name: "ğŸš« User Cancelled Delete Operation"
      ansible.builtin.fail:
        msg: |
          â„¹ï¸ ç”¨æˆ¶å–æ¶ˆäº†åˆªé™¤æ“ä½œ
          
          ğŸ“‹ æ“ä½œæ‘˜è¦ï¼š
          - æ‰¾åˆ°çš„MAC: {{ delete_mac }}
          - å°æ‡‰çš„IP: {{ delete_target_object.ip }}
          - æ“ä½œç‹€æ…‹: å·²å–æ¶ˆ
          
          ğŸ’¡ é…ç½®ä¿æŒåŸç‹€ï¼Œæœªé€²è¡Œä»»ä½•è®Šæ›´
      when: 
        - operation_mode == '2'
        - delete_target_object is defined
        - delete_confirmation.user_input | lower != 'yes'
      tags:
        - delete

    - name: "ğŸ”§ Execute MAC Delete - Restore to Reserved Configuration"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address/{{ delete_target_object.id }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          ip: "{{ delete_target_object.ip }}"
          mac: "{{ reserved_mac }}"
          description: "Reserved"
        body_format: json
        validate_certs: false
        status_code: 200
      register: delete_result
      when: 
        - operation_mode == '2'
        - delete_target_object is defined
        - delete_confirmation.user_input | lower == 'yes'
      tags:
        - delete

    - name: "ğŸ‰ MAC Delete Operation Complete"
      ansible.builtin.debug:
        msg: |
          âœ…âœ…âœ… MACåˆªé™¤æ“ä½œæˆåŠŸï¼âœ…âœ…âœ…
          
          ğŸ“‹ é‚„åŸçµæœï¼š
          - é…ç½®ID: {{ delete_target_object.id }}
          - IPåœ°å€: {{ delete_target_object.ip }} (æœªè®Šæ›´)
          - åŸå§‹MAC: {{ delete_target_object.mac }}
          - é‚„åŸå¾ŒMAC: {{ reserved_mac }}
          - åŸå§‹æè¿°: {{ delete_target_object.description | default('ç„¡') }}
          - é‚„åŸå¾Œæè¿°: Reserved
          
          ğŸ¯ FortiGate DHCPé…ç½®å·²æˆåŠŸé‚„åŸç‚ºä¿ç•™ç‹€æ…‹ï¼
      when: 
        - operation_mode == '2'
        - delete_result is defined
        - delete_result.json.revision_changed | default(false)
      tags:
        - delete

    - name: "âŒ MAC Delete Operation Failed"
      ansible.builtin.debug:
        msg: |
          âŒ MACåˆªé™¤æ“ä½œå¤±æ•—
          
          ğŸ“‹ éŒ¯èª¤è©³æƒ…ï¼š
          {{ delete_result.msg | default('æœªçŸ¥éŒ¯èª¤') }}
          
          ğŸ’¡ è«‹æª¢æŸ¥FortiGateé€£æ¥å’Œæ¬Šé™è¨­å®š
      when: 
        - operation_mode == '2'
        - delete_result is defined 
        - delete_result is failed
      tags:
        - delete

    # =======================================================================
    # æœ€çµ‚åŸ·è¡Œæ‘˜è¦
    # =======================================================================
    
    - name: "ğŸ“Š Final Execution Summary"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ“Š FortiGate DHCP é…ç½®åŸ·è¡Œæ‘˜è¦
          ==========================================
          ğŸ¯ åŸ·è¡Œçš„åŠŸèƒ½: {{ 'æ–°å¢/ä¿®æ”¹è¨­å®š' if operation_mode == '1' else 'åˆªé™¤è¨­å®š' if operation_mode == '2' else 'æœªçŸ¥åŠŸèƒ½' }}
          
          {% if operation_mode == '1' %}
          ğŸ“ æ–°å¢/ä¿®æ”¹çµæœ:
          - ç›®æ¨™IP: {{ target_ip }}
          - ç›®æ¨™MAC: {{ target_mac }}
          - ç›®æ¨™æè¿°: {{ target_description }}
          - ç‹€æ…‹: {{ 'âœ… æˆåŠŸ' if (needs_update and ((update_result is defined and update_result.json.revision_changed | default(false)) or (create_result is defined and create_result.json.revision_changed | default(false)))) else 'â„¹ï¸ ç„¡éœ€è®Šæ›´' if not needs_update else 'âŒ å¤±æ•—' }}
          {% elif operation_mode == '2' %}
          ğŸ—‘ï¸ åˆªé™¤çµæœ:
          - åˆªé™¤çš„MAC: {{ delete_mac }}
          {% if delete_target_object is defined %}
          - å°æ‡‰çš„IP: {{ delete_target_object.ip }}
          - é‚„åŸå¾ŒMAC: {{ reserved_mac | default('æœªè¨ˆç®—') }}
          - ç‹€æ…‹: {{ 'âœ… æˆåŠŸ' if (delete_result is defined and delete_result.json.revision_changed | default(false)) else 'ğŸš« å·²å–æ¶ˆ' if (delete_confirmation is defined and delete_confirmation.user_input | lower != 'yes') else 'âŒ å¤±æ•—' }}
          {% else %}
          - ç‹€æ…‹: âŒ æœªæ‰¾åˆ°æŒ‡å®šMAC
          {% endif %}
          {% endif %}
          
          ğŸ“… åŸ·è¡Œæ™‚é–“: {{ ansible_date_time.iso8601 | default('æœªçŸ¥') }}
          ==========================================
      tags:
        - summary
