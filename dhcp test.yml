---
# =============================================================================
# FortiGate DHCP Reserved Address æ™ºèƒ½ç®¡ç† Playbook (REST APIç‰ˆæœ¬)
# 
# åŠŸèƒ½èªªæ˜ï¼š
# 1. æ ¹æ“šæä¾›çš„IPã€MACã€Descriptionåƒæ•¸æ™ºèƒ½æ›´æ–°DHCP reserved-address
# 2. è‡ªå‹•æª¢æ¸¬MACåœ°å€è¡çªï¼Œé¿å…é‡è¤‡åˆ†é…
# 3. æ”¯æŒæ–°å¢å’Œæ›´æ–°æ—¢æœ‰é…ç½®
# 4. ä½¿ç”¨REST APIç›´æ¥èª¿ç”¨ï¼Œé¿å…collectioné¡å‹å•é¡Œ
# 
# ä½œè€…ï¼šVICI Network Team
# ç‰ˆæœ¬ï¼šv2.1 - è®Šæ•¸å®šç¾©ä¿®æ­£ç‰ˆ
# =============================================================================

- name: FortiGate DHCP Reserved Address æ™ºèƒ½ç®¡ç†
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # =======================================================================
    # è®Šæ•¸å®šç¾©å€ï¼ˆä¿®æ­£ç‰ˆï¼‰
    # =======================================================================
    
    # ç”¨æˆ¶è¼¸å…¥åƒæ•¸ï¼ˆå¾AWX Surveyæˆ–Extra Variablesç²å–ï¼‰
    target_ip: "{{ ip_param }}"                    # ç›®æ¨™IPåœ°å€
    target_mac: "{{ mac_param }}"                  # ç›®æ¨™MACåœ°å€
    target_description: "{{ desc_param }}"        # ç›®æ¨™æè¿°
    
    # FortiGateç³»çµ±åƒæ•¸
    dhcp_server_id: "{{ server_id | default('3') }}"  # DHCP Server ID
    
    # FortiGateé€£æ¥åƒæ•¸ï¼ˆå„ªå…ˆå¾AWX credentialç²å–ï¼Œå¦å‰‡å¾ç’°å¢ƒè®Šæ•¸ï¼‰
    fortigate_host: "{{ ansible_host | default(lookup('env', 'FORTIGATE_HOST')) }}"
    fortigate_token: "{{ fortigate_access_token | default(lookup('env', 'FORTIGATE_API_TOKEN')) }}"
    
  tasks:
    # =======================================================================
    # æ­¥é©Ÿ0ï¼šåƒæ•¸é©—è­‰
    # =======================================================================
    
    - name: "ğŸ” é©—è­‰å¿…è¦åƒæ•¸"
      ansible.builtin.fail:
        msg: |
          âŒ ç¼ºå°‘å¿…è¦çš„FortiGateé€£æ¥åƒæ•¸ï¼
          
          è«‹ç¢ºä¿ä»¥ä¸‹åƒæ•¸å·²æ­£ç¢ºè¨­å®šï¼š
          1. FortiGate Host: {{ fortigate_host | default('æœªè¨­å®š') }}
          2. FortiGate API Token: {{ 'å·²è¨­å®š' if fortigate_token else 'æœªè¨­å®š' }}
          
          è¨­å®šæ–¹å¼ï¼š
          - ä½¿ç”¨AWX Credential (æ¨è–¦)
          - æˆ–åœ¨Extra Variablesä¸­è¨­å®š:
            ansible_host: "your_fortigate_ip"
            fortigate_access_token: "your_api_token"
      when: not fortigate_host or not fortigate_token
      tags:
        - validate

    # =======================================================================
    # æ­¥é©Ÿ1ï¼šè¼¸å…¥åƒæ•¸é©—è­‰å’Œé¡¯ç¤º
    # =======================================================================
    
    - name: "ğŸ“‹ é¡¯ç¤ºè¼¸å…¥åƒæ•¸"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ“‹ FortiGate DHCP Reserved Address ç®¡ç†
          ==========================================
          ğŸ¯ ç›®æ¨™IPåœ°å€: {{ target_ip }}
          ğŸ”— ç›®æ¨™MACåœ°å€: {{ target_mac }}
          ğŸ“ ç›®æ¨™æè¿°: {{ target_description }}
          ğŸ·ï¸  DHCP Server ID: {{ dhcp_server_id }}
          ğŸŒ FortiGate Host: {{ fortigate_host }}
          ğŸ”‘ API Token: {{ 'å·²è¨­å®š' if fortigate_token else 'æœªè¨­å®š' }}
          ==========================================

    # =======================================================================
    # æ­¥é©Ÿ2ï¼šç²å–FortiGateç•¶å‰DHCP reserved-addressé…ç½®
    # =======================================================================
    
    - name: "ğŸ” ç²å–æ‰€æœ‰ç¾æœ‰çš„DHCPä¿ç•™ä½å€"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address"
        method: GET
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        validate_certs: false
        status_code: 200
      register: existing_reservations
      tags:
        - get_config

    - name: "ğŸ“Š é¡¯ç¤ºç²å–åˆ°çš„é…ç½®"
      ansible.builtin.debug:
        msg: |
          ğŸ” DHCPé…ç½®ç²å–çµæœï¼š
          - æŸ¥è©¢æˆåŠŸ: {{ existing_reservations.status == 200 }}
          - ä¿ç•™ä½å€æ•¸é‡: {{ existing_reservations.json.results | length }}
          
          ğŸ“‹ ç•¶å‰æ‰€æœ‰reserved-addressé…ç½®ï¼š
          {% if existing_reservations.json.results | length > 0 %}
          {% for addr in existing_reservations.json.results %}
          - ID: {{ addr.id }}, IP: {{ addr.ip }}, MAC: {{ addr.mac }}, æè¿°: {{ addr.description | default('ç„¡') }}
          {% endfor %}
          {% else %}
          ï¼ˆç›®å‰æ²’æœ‰ä»»ä½•reserved-addressé…ç½®ï¼‰
          {% endif %}
      tags:
        - get_config

    # =======================================================================
    # æ­¥é©Ÿ3ï¼šMACè¡çªæª¢æ¸¬é‚è¼¯
    # =======================================================================
    
    - name: "ğŸ” å°‹æ‰¾MACä½å€ç›¸åŒçš„æ—¢æœ‰é…ç½®"
      ansible.builtin.set_fact:
        mac_conflict_object: "{{ item }}"
      loop: "{{ existing_reservations.json.results }}"
      when:
        - mac_conflict_object is not defined  # åªæ‰¾ç¬¬ä¸€å€‹åŒ¹é…çš„
        - item.mac.lower() == target_mac.lower()  # MACåœ°å€æ¯”è¼ƒï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
      loop_control:
        label: "æª¢æŸ¥ MAC {{ item.mac }}"
      tags:
        - conflict_check

    - name: "ğŸ“‹ é¡¯ç¤ºMACè¡çªæª¢æ¸¬çµæœ"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ” MACè¡çªæª¢æ¸¬åˆ†æçµæœ
          ==========================================
          {% if mac_conflict_object is defined %}
          âš ï¸  æ‰¾åˆ°æ—¢æœ‰MACé…ç½®:
             - ID: {{ mac_conflict_object.id }}
             - IP: {{ mac_conflict_object.ip }}
             - MAC: {{ mac_conflict_object.mac }}
             - æè¿°: {{ mac_conflict_object.description | default('ç„¡') }}
          
          ğŸš« MACè¡çªç‹€æ…‹: {{ 'æ˜¯' if (mac_conflict_object.ip != target_ip) else 'å¦' }}
          {% else %}
          â„¹ï¸  æœªæ‰¾åˆ°æ—¢æœ‰MACé…ç½®
          ğŸš« MACè¡çªç‹€æ…‹: å¦
          {% endif %}
          ==========================================
      tags:
        - conflict_check

    # =======================================================================
    # æ­¥é©Ÿ4ï¼šMACè¡çªæ™‚åœæ­¢åŸ·è¡Œ
    # =======================================================================
    
    - name: "ğŸš« MACè¡çªæª¢æ¸¬ - é¡¯ç¤ºéŒ¯èª¤è©³æƒ…"
      ansible.builtin.debug:
        msg:
          - "âŒâŒâŒ MACè¡çªæª¢æ¸¬å¤±æ•—ï¼âŒâŒâŒ"
          - ""
          - "ğŸ”´ è¡çªè©³æƒ…ï¼š"
          - "  - ç›®æ¨™MAC: {{ target_mac }}"
          - "  - ç›®æ¨™IP: {{ target_ip }}"  
          - "  - è¡çªåŸå› : MAC {{ target_mac }} å·²è¢«åˆ†é…çµ¦ IP {{ mac_conflict_object.ip }}"
          - ""
          - "ğŸ’¡ è§£æ±ºæ–¹æ¡ˆï¼š"
          - "  1. ä½¿ç”¨ä¸åŒçš„MACåœ°å€"
          - "  2. æˆ–è€…ç¢ºèªæ˜¯å¦è¦æ›´æ–°æ—¢æœ‰IP {{ mac_conflict_object.ip }} çš„é…ç½®"
          - ""
          - "âš ï¸  ç‚ºé¿å…ç¶²è·¯è¡çªï¼Œæ“ä½œå°‡è¢«çµ‚æ­¢ï¼"
      when: mac_conflict_object is defined and mac_conflict_object.ip != target_ip
      tags:
        - conflict_check

    - name: "ğŸš« åœæ­¢åŸ·è¡Œ - MACè¡çª"
      ansible.builtin.fail:
        msg: "å› MACä½å€è¡çªè€Œåœæ­¢åŸ·è¡Œã€‚MAC {{ target_mac }} å·²è¢«IP {{ mac_conflict_object.ip }} ä½¿ç”¨ã€‚"
      when: mac_conflict_object is defined and mac_conflict_object.ip != target_ip
      tags:
        - conflict_check

    # =======================================================================
    # æ­¥é©Ÿ5ï¼šå°‹æ‰¾ç›®æ¨™IPé…ç½®ï¼Œæ±ºå®šæ˜¯æ–°å¢é‚„æ˜¯æ›´æ–°
    # =======================================================================
    
    - name: "ğŸ” å°‹æ‰¾ç›®æ¨™IPçš„æ—¢æœ‰é…ç½®"
      ansible.builtin.set_fact:
        target_object_list: "{{ existing_reservations.json.results | selectattr('ip', 'equalto', target_ip) | list }}"
      tags:
        - find_target

    - name: "ğŸ¯ æ±ºå®šæ“ä½œé¡å‹"
      ansible.builtin.set_fact:
        # æ±ºå®šæ“ä½œé¡å‹
        operation_type: >-
          {%- if target_object_list | length > 0 -%}
            æ›´æ–°æ—¢æœ‰é…ç½®
          {%- else -%}
            å‰µå»ºæ–°é…ç½®
          {%- endif -%}
        
        # æ±ºå®šæ˜¯å¦éœ€è¦åŸ·è¡Œæ“ä½œ
        needs_update: >-
          {%- if target_object_list | length == 0 -%}
            true
          {%- else -%}
            {{
              (target_object_list[0].mac != target_mac) or
              (target_object_list[0].description | default('') != target_description)
            }}
          {%- endif -%}
        
        # å¦‚æœæ˜¯æ›´æ–°ï¼Œå–å¾—ç›®æ¨™å°è±¡
        target_object: "{{ target_object_list[0] if target_object_list | length > 0 else {} }}"
      tags:
        - find_target

    - name: "ğŸ“‹ é¡¯ç¤ºæ“ä½œè¨ˆç•«"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ“‹ æ“ä½œåŸ·è¡Œè¨ˆç•«
          ==========================================
          ğŸ¯ æ“ä½œé¡å‹: {{ operation_type }}
          ğŸ”„ éœ€è¦æ›´æ–°: {{ 'æ˜¯' if needs_update else 'å¦' }}
          
          {% if target_object_list | length > 0 %}
          ğŸ“Š æ—¢æœ‰é…ç½®:
          - ID: {{ target_object.id }}
          - IP: {{ target_object.ip }}
          - MAC: {{ target_object.mac }}
          - æè¿°: {{ target_object.description | default('ç„¡') }}
          {% endif %}
          
          {% if needs_update %}
          ğŸ“ å°‡è¦åŸ·è¡Œçš„{{ operation_type }}ï¼š
          - IPåœ°å€: {{ target_ip }}
          - MACåœ°å€: {{ target_mac }}
          - æè¿°: {{ target_description }}
          {% else %}
          â„¹ï¸  é…ç½®å·²ç¬¦åˆç›®æ¨™ç‹€æ…‹ï¼Œç„¡éœ€æ›´æ–°
          {% endif %}
          ==========================================
      tags:
        - find_target

    # =======================================================================
    # æ­¥é©Ÿ6ï¼šè·³éä¸å¿…è¦çš„æ›´æ–°
    # =======================================================================
    
    - name: "âœ… é…ç½®å·²æ˜¯æœ€æ–°ç‹€æ…‹"
      ansible.builtin.debug:
        msg:
          - "âœ…âœ…âœ… é…ç½®æª¢æŸ¥å®Œæˆ âœ…âœ…âœ…"
          - ""
          - "ğŸ‰ ç•¶å‰é…ç½®å·²ç¬¦åˆç›®æ¨™ç‹€æ…‹ï¼š"
          - "  - IP: {{ target_ip }}"
          - "  - MAC: {{ target_mac }}"
          - "  - æè¿°: {{ target_description }}"
          - ""
          - "ğŸ’¡ ç„¡éœ€åŸ·è¡Œä»»ä½•è®Šæ›´æ“ä½œï¼"
      when: not needs_update
      tags:
        - skip_update

    # =======================================================================
    # æ­¥é©Ÿ7ï¼šåŸ·è¡Œæ›´æ–°æ—¢æœ‰é…ç½®
    # =======================================================================
    
    - name: "ğŸ”§ æ›´æ–°æ—¢æœ‰DHCPä¿ç•™ä½å€"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address/{{ target_object.id }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          mac: "{{ target_mac }}"
          description: "{{ target_description }}"
        body_format: json
        validate_certs: false
        status_code: 200
      register: update_result
      when: needs_update and target_object_list | length > 0
      tags:
        - execute_update

    # =======================================================================
    # æ­¥é©Ÿ8ï¼šåŸ·è¡Œå‰µå»ºæ–°é…ç½®
    # =======================================================================
    
    - name: "ğŸ†• å‰µå»ºæ–°DHCPä¿ç•™ä½å€"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address"
        method: POST
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          ip: "{{ target_ip }}"
          mac: "{{ target_mac }}"
          description: "{{ target_description }}"
        body_format: json
        validate_certs: false
        status_code: 200
      register: create_result
      when: needs_update and target_object_list | length == 0
      tags:
        - execute_create

    # =======================================================================
    # æ­¥é©Ÿ9ï¼šé¡¯ç¤ºåŸ·è¡Œçµæœ
    # =======================================================================
    
    - name: "ğŸ‰ æ›´æ–°æˆåŠŸ"
      ansible.builtin.debug:
        msg:
          - "âœ…âœ…âœ… æ›´æ–°æ—¢æœ‰é…ç½®æˆåŠŸï¼âœ…âœ…âœ…"
          - ""
          - "ğŸ“‹ æ›´æ–°è©³æƒ…ï¼š"
          - "  - ç›®æ¨™IP: {{ target_ip }}"
          - "  - æ›´æ–°å¾ŒMAC: {{ target_mac }}"
          - "  - æ›´æ–°å¾Œæè¿°: {{ target_description }}"
          - "  - DHCP Server ID: {{ dhcp_server_id }}"
          - ""
          - "ğŸ¯ FortiGateé…ç½®å·²æˆåŠŸæ›´æ–°ï¼"
      when: 
        - needs_update
        - target_object_list | length > 0
        - update_result is defined
        - update_result.json.revision_changed | default(false)
      tags:
        - show_result

    - name: "ğŸ‰ å‰µå»ºæˆåŠŸ"
      ansible.builtin.debug:
        msg:
          - "âœ…âœ…âœ… å‰µå»ºæ–°é…ç½®æˆåŠŸï¼âœ…âœ…âœ…"
          - ""
          - "ğŸ“‹ å‰µå»ºè©³æƒ…ï¼š"
          - "  - æ–°IP: {{ target_ip }}"
          - "  - MAC: {{ target_mac }}"
          - "  - æè¿°: {{ target_description }}"
          - "  - DHCP Server ID: {{ dhcp_server_id }}"
          - ""
          - "ğŸ¯ FortiGateé…ç½®å·²æˆåŠŸå‰µå»ºï¼"
      when: 
        - needs_update
        - target_object_list | length == 0
        - create_result is defined
        - create_result.json.revision_changed | default(false)
      tags:
        - show_result

    # =======================================================================
    # æ­¥é©Ÿ10ï¼šæœ€çµ‚åŸ·è¡Œæ‘˜è¦
    # =======================================================================
    
    - name: "ğŸ“Š åŸ·è¡Œæ‘˜è¦å ±å‘Š"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ“Š FortiGate DHCP é…ç½®åŸ·è¡Œæ‘˜è¦
          ==========================================
          ğŸ¯ ç›®æ¨™é…ç½®:
             - IP: {{ target_ip }}
             - MAC: {{ target_mac }}
             - æè¿°: {{ target_description }}
          
          ğŸ”§ åŸ·è¡Œçµæœ:
             {% if not needs_update %}
             - ç‹€æ…‹: â„¹ï¸  ç„¡éœ€è®Šæ›´ï¼ˆé…ç½®å·²æ˜¯æœ€æ–°ï¼‰
             {% elif target_object_list | length > 0 and update_result is defined and update_result.json.revision_changed | default(false) %}
             - ç‹€æ…‹: âœ… æ›´æ–°æ—¢æœ‰é…ç½®æˆåŠŸ
             - ç›®æ¨™ID: {{ target_object.id }}
             {% elif target_object_list | length == 0 and create_result is defined and create_result.json.revision_changed | default(false) %}
             - ç‹€æ…‹: âœ… å‰µå»ºæ–°é…ç½®æˆåŠŸ
             {% elif (update_result is defined and update_result is failed) or (create_result is defined and create_result is failed) %}
             - ç‹€æ…‹: âŒ åŸ·è¡Œå¤±æ•—
             {% else %}
             - ç‹€æ…‹: âš ï¸  æœªåŸ·è¡Œæ“ä½œ
             {% endif %}
          
          ğŸ“… åŸ·è¡Œæ™‚é–“: {{ ansible_date_time.iso8601 | default('æœªçŸ¥') }}
          ==========================================
      tags:
        - summary
