---
# =============================================================================
# FortiGate DHCP Reserved Address æ™ºèƒ½ç®¡ç† Playbook
# 
# åŠŸèƒ½èªªæ˜ï¼š
# 1. æ ¹æ“šæä¾›çš„IPã€MACã€Descriptionåƒæ•¸æ™ºèƒ½æ›´æ–°DHCP reserved-address
# 2. è‡ªå‹•æª¢æ¸¬MACåœ°å€è¡çªï¼Œé¿å…é‡è¤‡åˆ†é…
# 3. æ”¯æŒæ–°å¢å’Œæ›´æ–°æ—¢æœ‰é…ç½®
# 
# ä½œè€…ï¼šVICI Network Team
# ç‰ˆæœ¬ï¼šv1.1 - ä¿®æ­£selectoråç¨±
# =============================================================================

- name: FortiGate DHCP Reserved Address æ™ºèƒ½ç®¡ç†
  hosts: all
  connection: httpapi
  gather_facts: false
  collections:
    - fortinet.fortios
  
  vars:
    # =======================================================================
    # è®Šæ•¸å®šç¾©å€
    # =======================================================================
    
    # ç”¨æˆ¶è¼¸å…¥åƒæ•¸ï¼ˆå¾AWX Surveyæˆ–Extra Variablesç²å–ï¼‰
    target_ip: "{{ ip_param }}"                    # ç›®æ¨™IPåœ°å€
    target_mac: "{{ mac_param }}"                  # ç›®æ¨™MACåœ°å€
    target_description: "{{ desc_param }}"        # ç›®æ¨™æè¿°
    
    # FortiGateç³»çµ±åƒæ•¸
    dhcp_server_id: "{{ server_id | default(3) }}" # DHCP Server IDï¼ˆé»˜èªç‚º3ï¼‰
    vdom_name: "{{ fortigate_vdom }}"              # VDOMåç¨±ï¼ˆä¾†è‡ªcredentialï¼‰
    api_token: "{{ fortigate_access_token }}"     # API Tokenï¼ˆä¾†è‡ªcredentialï¼‰
    
  tasks:
    # =======================================================================
    # æ­¥é©Ÿ1ï¼šè¼¸å…¥åƒæ•¸é©—è­‰å’Œé¡¯ç¤º
    # =======================================================================
    
    - name: "ğŸ“‹ é¡¯ç¤ºè¼¸å…¥åƒæ•¸"
      debug:
        msg: |
          ==========================================
          ğŸ“‹ FortiGate DHCP Reserved Address ç®¡ç†
          ==========================================
          ğŸ¯ ç›®æ¨™IPåœ°å€: {{ target_ip }}
          ğŸ”— ç›®æ¨™MACåœ°å€: {{ target_mac }}
          ğŸ“ ç›®æ¨™æè¿°: {{ target_description }}
          ğŸ·ï¸  DHCP Server ID: {{ dhcp_server_id }}
          ğŸŒ VDOM: {{ vdom_name }}
          ==========================================

    # =======================================================================
    # æ­¥é©Ÿ2ï¼šç²å–FortiGateç•¶å‰DHCPé…ç½®
    # =======================================================================
    
    - name: "ğŸ” ç²å–FortiGateç•¶å‰DHCP Serveré…ç½®"
      fortinet.fortios.fortios_configuration_fact:
        vdom: "{{ vdom_name }}"
        access_token: "{{ api_token }}"
        selectors:
          - selector: system.dhcp_server           # âœ… ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„selectoråç¨±
            params:
              id: "{{ dhcp_server_id }}"           # æŒ‡å®šserver ID
      register: dhcp_facts
      tags:
        - get_config

    # =======================================================================
    # æ­¥é©Ÿ3ï¼šè§£æç•¶å‰reserved-addressé…ç½®
    # =======================================================================
    
    - name: "ğŸ“Š è§£æDHCPé…ç½®çµæœ"
      debug:
        msg: |
          ğŸ” DHCPé…ç½®æŸ¥è©¢çµæœï¼š
          - æŸ¥è©¢æˆåŠŸ: {{ dhcp_facts is succeeded }}
          - çµæœæ•¸é‡: {{ dhcp_facts.meta.results | length }}
      tags:
        - parse_config

    - name: "ğŸ“Š è§£æç•¶å‰reserved-addressåˆ—è¡¨"
      set_fact:
        # æå–reserved_addressé™£åˆ—ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡è¨­ç‚ºç©ºé™£åˆ—
        current_reserved_addresses: "{{ dhcp_facts.meta.results[0]['reserved-address'] | default([]) }}"
      when: dhcp_facts.meta.results | length > 0
      tags:
        - parse_config

    - name: "ğŸ“Š è¨­å®šç©ºçš„reserved-addressåˆ—è¡¨"
      set_fact:
        current_reserved_addresses: []
      when: dhcp_facts.meta.results | length == 0
      tags:
        - parse_config

    - name: "ğŸ” é¡¯ç¤ºç•¶å‰æ‰€æœ‰reserved-addressé…ç½®"
      debug:
        msg: |
          ç•¶å‰DHCP Server {{ dhcp_server_id }} å…±æœ‰ {{ current_reserved_addresses | length }} å€‹reserved-addressé…ç½®ï¼š
          {% if current_reserved_addresses | length > 0 %}
          {% for addr in current_reserved_addresses %}
          - ID: {{ addr.id }}, IP: {{ addr.ip }}, MAC: {{ addr.mac }}, æè¿°: {{ addr.description | default('ç„¡') }}
          {% endfor %}
          {% else %}
          ï¼ˆç›®å‰æ²’æœ‰ä»»ä½•reserved-addressé…ç½®ï¼‰
          {% endif %}
      tags:
        - parse_config

    # =======================================================================
    # æ­¥é©Ÿ4ï¼šæŸ¥æ‰¾æ—¢æœ‰é…ç½®ï¼ˆæŒ‰IPå’ŒMACåˆ†åˆ¥æŸ¥æ‰¾ï¼‰
    # =======================================================================
    
    - name: "ğŸ” æŸ¥æ‰¾æ—¢æœ‰IPé…ç½®"
      set_fact:
        # æŸ¥æ‰¾æ˜¯å¦æœ‰ç›¸åŒIPçš„é…ç½®
        existing_reservation_by_ip: "{{ current_reserved_addresses | selectattr('ip', 'equalto', target_ip) | list | first | default({}) }}"
      tags:
        - find_existing

    - name: "ğŸ” æŸ¥æ‰¾æ—¢æœ‰MACé…ç½®"
      set_fact:
        # æŸ¥æ‰¾æ˜¯å¦æœ‰ç›¸åŒMACçš„é…ç½®
        existing_reservation_by_mac: "{{ current_reserved_addresses | selectattr('mac', 'equalto', target_mac) | list | first | default({}) }}"
      tags:
        - find_existing

    # =======================================================================
    # æ­¥é©Ÿ5ï¼šMACè¡çªæª¢æ¸¬é‚è¼¯
    # =======================================================================
    
    - name: "âš ï¸  åŸ·è¡ŒMACè¡çªæª¢æ¸¬"
      set_fact:
        # MACè¡çªæ¢ä»¶ï¼š
        # 1. æ‰¾åˆ°æ—¢æœ‰MACé…ç½® ä¸”
        # 2. è©²MACé…ç½®çš„IPèˆ‡ç›®æ¨™IPä¸åŒ
        mac_conflict: >-
          {{
            (existing_reservation_by_mac | length > 0) and 
            (existing_reservation_by_mac.ip != target_ip)
          }}
      tags:
        - conflict_check

    - name: "ğŸ“‹ é¡¯ç¤ºè¡çªæª¢æ¸¬çµæœ"
      debug:
        msg: |
          ==========================================
          ğŸ” è¡çªæª¢æ¸¬åˆ†æçµæœ
          ==========================================
          {% if existing_reservation_by_ip | length > 0 %}
          âœ… æ‰¾åˆ°æ—¢æœ‰IPé…ç½®:
             - ID: {{ existing_reservation_by_ip.id }}
             - IP: {{ existing_reservation_by_ip.ip }}
             - MAC: {{ existing_reservation_by_ip.mac }}
             - æè¿°: {{ existing_reservation_by_ip.description | default('ç„¡') }}
          {% else %}
          â„¹ï¸  æœªæ‰¾åˆ°æ—¢æœ‰IPé…ç½®ï¼ˆå°‡å‰µå»ºæ–°é…ç½®ï¼‰
          {% endif %}
          
          {% if existing_reservation_by_mac | length > 0 %}
          âš ï¸  æ‰¾åˆ°æ—¢æœ‰MACé…ç½®:
             - ID: {{ existing_reservation_by_mac.id }}
             - IP: {{ existing_reservation_by_mac.ip }}
             - MAC: {{ existing_reservation_by_mac.mac }}
             - æè¿°: {{ existing_reservation_by_mac.description | default('ç„¡') }}
          {% else %}
          â„¹ï¸  æœªæ‰¾åˆ°æ—¢æœ‰MACé…ç½®
          {% endif %}
          
          ğŸš« MACè¡çªç‹€æ…‹: {{ 'æ˜¯' if mac_conflict else 'å¦' }}
          ==========================================
      tags:
        - conflict_check

    # =======================================================================
    # æ­¥é©Ÿ6ï¼šMACè¡çªæ™‚åœæ­¢åŸ·è¡Œ
    # =======================================================================
    
    - name: "ğŸš« MACè¡çª - åœæ­¢åŸ·è¡Œ"
      fail:
        msg: |
          âŒâŒâŒ MACè¡çªæª¢æ¸¬å¤±æ•—ï¼âŒâŒâŒ
          
          ğŸ”´ è¡çªè©³æƒ…ï¼š
          - ç›®æ¨™MAC: {{ target_mac }}
          - ç›®æ¨™IP: {{ target_ip }}
          - è¡çªåŸå› : MAC {{ target_mac }} å·²è¢«åˆ†é…çµ¦ IP {{ existing_reservation_by_mac.ip }}
          
          ğŸ’¡ è§£æ±ºæ–¹æ¡ˆï¼š
          1. ä½¿ç”¨ä¸åŒçš„MACåœ°å€
          2. æˆ–è€…ç¢ºèªæ˜¯å¦è¦æ›´æ–°æ—¢æœ‰IP {{ existing_reservation_by_mac.ip }} çš„é…ç½®
          
          âš ï¸  ç‚ºé¿å…ç¶²è·¯è¡çªï¼Œæ“ä½œå·²çµ‚æ­¢ï¼
      when: mac_conflict
      tags:
        - conflict_check

    # =======================================================================
    # æ­¥é©Ÿ7ï¼šæ±ºå®šæ“ä½œé¡å‹ï¼ˆæ–°å¢æˆ–æ›´æ–°ï¼‰
    # =======================================================================
    
    - name: "ğŸ¯ æ±ºå®šæ“ä½œé¡å‹å’Œåƒæ•¸"
      set_fact:
        # åˆ¤æ–·æ˜¯å¦éœ€è¦æ›´æ–°ï¼š
        # 1. æ²’æœ‰æ—¢æœ‰IPé…ç½®ï¼ˆéœ€è¦æ–°å¢ï¼‰æˆ–
        # 2. MACåœ°å€ä¸åŒ æˆ–
        # 3. æè¿°ä¸åŒ
        needs_update: >-
          {{
            (existing_reservation_by_ip | length == 0) or
            (existing_reservation_by_ip.mac != target_mac) or
            (existing_reservation_by_ip.description | default('') != target_description)
          }}
        
        # æ±ºå®šreservation IDï¼š
        # - å¦‚æœæœ‰æ—¢æœ‰IPé…ç½®ï¼Œä½¿ç”¨æ—¢æœ‰ID
        # - å¦‚æœæ²’æœ‰ï¼Œä½¿ç”¨ç•¶å‰æœ€å¤§ID+1ï¼ˆå¦‚æœæ²’æœ‰ä»»ä½•é…ç½®å‰‡å¾1é–‹å§‹ï¼‰
        reservation_id: >-
          {%- if existing_reservation_by_ip | length > 0 -%}
            {{ existing_reservation_by_ip.id }}
          {%- else -%}
            {{ ((current_reserved_addresses | map(attribute='id') | map('int') | list | max) + 1) if current_reserved_addresses else 1 }}
          {%- endif -%}
        
        # æ±ºå®šæ“ä½œé¡å‹
        operation_type: >-
          {%- if existing_reservation_by_ip | length > 0 -%}
            æ›´æ–°æ—¢æœ‰é…ç½®
          {%- else -%}
            å‰µå»ºæ–°é…ç½®
          {%- endif -%}
      tags:
        - determine_action

    - name: "ğŸ“‹ é¡¯ç¤ºæ“ä½œè¨ˆç•«"
      debug:
        msg: |
          ==========================================
          ğŸ“‹ æ“ä½œåŸ·è¡Œè¨ˆç•«
          ==========================================
          ğŸ¯ æ“ä½œé¡å‹: {{ operation_type }}
          ğŸ·ï¸  Reservation ID: {{ reservation_id }}
          ğŸ”„ éœ€è¦æ›´æ–°: {{ 'æ˜¯' if needs_update else 'å¦' }}
          
          {% if needs_update %}
          ğŸ“ å°‡è¦åŸ·è¡Œçš„æ›´æ–°ï¼š
          - IPåœ°å€: {{ target_ip }}
          - MACåœ°å€: {{ target_mac }}
          - æè¿°: {{ target_description }}
          {% else %}
          â„¹ï¸  é…ç½®å·²ç¬¦åˆç›®æ¨™ç‹€æ…‹ï¼Œç„¡éœ€æ›´æ–°
          {% endif %}
          ==========================================
      tags:
        - determine_action

    # =======================================================================
    # æ­¥é©Ÿ8ï¼šè·³éä¸å¿…è¦çš„æ›´æ–°
    # =======================================================================
    
    - name: "âœ… é…ç½®å·²æ˜¯æœ€æ–°ç‹€æ…‹"
      debug:
        msg: |
          âœ…âœ…âœ… é…ç½®æª¢æŸ¥å®Œæˆ âœ…âœ…âœ…
          
          ğŸ‰ ç•¶å‰é…ç½®å·²ç¬¦åˆç›®æ¨™ç‹€æ…‹ï¼š
          - IP: {{ target_ip }}
          - MAC: {{ target_mac }}
          - æè¿°: {{ target_description }}
          
          ğŸ’¡ ç„¡éœ€åŸ·è¡Œä»»ä½•è®Šæ›´æ“ä½œï¼
      when: not needs_update
      tags:
        - skip_update

    # =======================================================================
    # æ­¥é©Ÿ9ï¼šåŸ·è¡ŒDHCPé…ç½®æ›´æ–°
    # =======================================================================
    
    - name: "ğŸ”§ {{ operation_type }} - åŸ·è¡ŒDHCPé…ç½®æ›´æ–°"
      fortinet.fortios.fortios_system_dhcp_server:
        vdom: "{{ vdom_name }}"
        access_token: "{{ api_token }}"
        system_dhcp_server:
          id: "{{ dhcp_server_id }}"           # DHCP Server ID
          reserved_address:                    # âœ… ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„å±¬æ€§åç¨±
            - id: "{{ reservation_id }}"       # Reserved Address ID
              ip: "{{ target_ip }}"            # IPåœ°å€
              mac: "{{ target_mac }}"          # MACåœ°å€
              description: "{{ target_description }}"  # æè¿°
        state: present                         # æ•´å€‹DHCP serverç‹€æ…‹
      register: update_result
      when: needs_update
      tags:
        - execute_update

    # =======================================================================
    # æ­¥é©Ÿ10ï¼šé¡¯ç¤ºåŸ·è¡Œçµæœ
    # =======================================================================
    
    - name: "ğŸ‰ é…ç½®æ›´æ–°æˆåŠŸ"
      debug:
        msg: |
          âœ…âœ…âœ… {{ operation_type }}æˆåŠŸï¼âœ…âœ…âœ…
          
          ğŸ“‹ æ›´æ–°è©³æƒ…ï¼š
          - Reservation ID: {{ reservation_id }}
          - IPåœ°å€: {{ target_ip }}
          - MACåœ°å€: {{ target_mac }}
          - æè¿°: {{ target_description }}
          - DHCP Server ID: {{ dhcp_server_id }}
          
          ğŸ¯ FortiGateé…ç½®å·²æˆåŠŸæ›´æ–°ï¼
      when: needs_update and update_result is succeeded
      tags:
        - show_result

    # =======================================================================
    # æ­¥é©Ÿ11ï¼šè™•ç†æ›´æ–°å¤±æ•—çš„æƒ…æ³
    # =======================================================================
    
    - name: "âŒ é…ç½®æ›´æ–°å¤±æ•—"
      debug:
        msg: |
          âŒâŒâŒ {{ operation_type }}å¤±æ•—ï¼âŒâŒâŒ
          
          ğŸ“‹ éŒ¯èª¤è©³æƒ…ï¼š
          {{ update_result.msg | default('æœªçŸ¥éŒ¯èª¤') }}
          
          ğŸ’¡ è«‹æª¢æŸ¥ï¼š
          1. FortiGate APIæ¬Šé™
          2. DHCP Server IDæ˜¯å¦å­˜åœ¨
          3. ç¶²è·¯é€£æ¥ç‹€æ…‹
      when: needs_update and update_result is failed
      tags:
        - show_result

    # =======================================================================
    # æ­¥é©Ÿ12ï¼šæœ€çµ‚åŸ·è¡Œæ‘˜è¦
    # =======================================================================
    
    - name: "ğŸ“Š åŸ·è¡Œæ‘˜è¦å ±å‘Š"
      debug:
        msg: |
          ==========================================
          ğŸ“Š FortiGate DHCP é…ç½®åŸ·è¡Œæ‘˜è¦
          ==========================================
          ğŸ¯ ç›®æ¨™é…ç½®:
             - IP: {{ target_ip }}
             - MAC: {{ target_mac }}
             - æè¿°: {{ target_description }}
          
          ğŸ”§ åŸ·è¡Œçµæœ:
             {% if needs_update and update_result is succeeded %}
             - ç‹€æ…‹: âœ… {{ operation_type }}æˆåŠŸ
             - Reservation ID: {{ reservation_id }}
             {% elif not needs_update %}
             - ç‹€æ…‹: â„¹ï¸  ç„¡éœ€è®Šæ›´ï¼ˆé…ç½®å·²æ˜¯æœ€æ–°ï¼‰
             {% elif needs_update and update_result is failed %}
             - ç‹€æ…‹: âŒ {{ operation_type }}å¤±æ•—
             {% else %}
             - ç‹€æ…‹: âš ï¸  æœªåŸ·è¡Œæ›´æ–°æ“ä½œ
             {% endif %}
          
          ğŸ“… åŸ·è¡Œæ™‚é–“: {{ ansible_date_time.iso8601 | default('æœªçŸ¥') }}
          ==========================================
      tags:
        - summary
