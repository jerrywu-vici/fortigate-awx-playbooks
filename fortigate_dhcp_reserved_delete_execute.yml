---
- name: FortiGate DHCP Delete Execute for Workflow
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # æ¥æ”¶workflowè®Šæ•¸
    target_id: "{{ wf_target_id }}"
    target_ip: "{{ wf_target_ip }}"
    original_mac: "{{ wf_original_mac }}"
    reserved_mac: "{{ wf_reserved_mac }}"
    dhcp_server_id: "{{ wf_server_id }}"
    fortigate_host: "{{ fortigate_host }}"
    fortigate_token: "{{ fortigate_access_token }}"
    
  tasks:
    - name: "ğŸ”§ Execute Delete Operation"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address/{{ target_id }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          ip: "{{ target_ip }}"
          mac: "{{ reserved_mac }}"
          description: "Reserved"
        body_format: json
        validate_certs: false
        status_code: 200
      register: result

    - name: "ğŸ§® Verify MAC Calculation (Corrected)"
      ansible.builtin.debug:
        msg: |
          ğŸ” MACé‚„åŸè¨ˆç®—é©—è­‰ï¼š
          - IP: {{ target_ip }}
          - IPç¬¬å››ç¢¼: {{ ip_fourth_octet }}
          - ç¬¬ä¸€ä½æ•¸å­—: {{ wf_first_digit }}
          - å¾Œå…©ä½æ•¸å­—: {{ wf_last_two_digits }}
          - é‚„åŸMAC: {{ reserved_mac }}
          - é æœŸMAC: ff:ff:ff:ff:f{{ wf_first_digit }}:{{ wf_last_two_digits }}
          - è¨ˆç®—æ­£ç¢º: {{ 'âœ…' if reserved_mac == 'ff:ff:ff:ff:f' + wf_first_digit + ':' + wf_last_two_digits else 'âŒ' }}
