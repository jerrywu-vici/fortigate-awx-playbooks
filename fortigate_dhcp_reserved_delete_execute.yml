---
# =============================================================================
# FortiGate DHCP Reserved Address Delete Execute Playbook
# 
# åŠŸèƒ½èªªæ˜ï¼š
# 1. æ¥æ”¶ä¾†è‡ªPreviewæ­¥é©Ÿçš„ç¢ºèªåƒæ•¸
# 2. åŸ·è¡Œå¯¦éš›çš„DHCPé…ç½®é‚„åŸæ“ä½œ
# 3. åƒ…åœ¨Workflowä¸­ä½¿ç”¨ï¼Œä¸å–®ç¨åŸ·è¡Œ
# 
# ä½œè€…ï¼šVICI Network Team
# ç‰ˆæœ¬ï¼šv3.2 - ExecuteåŠŸèƒ½ï¼ˆç”¨æ–¼Workflowï¼‰
# =============================================================================

- name: FortiGate DHCP Delete Execute - Step 2
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # =======================================================================
    # è®Šæ•¸å®šç¾©å€ï¼ˆå¾å‰ä¸€æ­¥é©Ÿæ¥æ”¶ï¼‰
    # =======================================================================
    
    # å¾Workflowå‰ä¸€æ­¥é©Ÿæ¥æ”¶çš„åƒæ•¸
    delete_mac: "{{ confirmed_delete_mac }}"
    target_id: "{{ confirmed_target_id }}"
    target_ip: "{{ confirmed_target_ip }}"
    reserved_mac: "{{ confirmed_reserved_mac }}"
    original_mac: "{{ confirmed_original_mac }}"
    original_description: "{{ confirmed_original_description }}"
    dhcp_server_id: "{{ confirmed_server_id }}"
    
    # FortiGateé€£æ¥åƒæ•¸ï¼ˆå¾AWX Credentialè‡ªå‹•æ³¨å…¥ï¼‰
    fortigate_host: "{{ fortigate_host }}"
    fortigate_token: "{{ fortigate_access_token }}"
    vdom_name: "{{ fortigate_vdom | default('root') }}"
    
  tasks:
    # =======================================================================
    # æ­¥é©Ÿ1ï¼šé©—è­‰å¾å‰ä¸€æ­¥é©Ÿæ¥æ”¶çš„åƒæ•¸
    # =======================================================================
    
    - name: "ğŸ” Validate Workflow Parameters"
      ansible.builtin.fail:
        msg: |
          âŒ å¾Workflowå‰ä¸€æ­¥é©Ÿæ¥æ”¶åƒæ•¸å¤±æ•—ï¼
          
          è«‹ç¢ºä¿ï¼š
          1. æ­¤Job Templateåƒ…åœ¨Workflowä¸­åŸ·è¡Œ
          2. å‰ä¸€æ­¥é©Ÿï¼ˆPreviewï¼‰å·²æˆåŠŸå®Œæˆ
          3. Workflowè®Šæ•¸å‚³éæ­£å¸¸
      when: 
        - delete_mac is not defined or
          target_id is not defined or
          target_ip is not defined or
          reserved_mac is not defined

    - name: "ğŸ” Validate Credential Parameters"
      ansible.builtin.fail:
        msg: |
          âŒ ç¼ºå°‘å¿…è¦çš„FortiGate Credentialåƒæ•¸ï¼
      when: fortigate_host is not defined or fortigate_token is not defined

    - name: "ğŸ“‹ Display Execute Parameters"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ“‹ FortiGate DHCP Delete Execute
          ==========================================
          ğŸš€ åŸ·è¡Œæ¨¡å¼ï¼šå°‡åŸ·è¡Œå¯¦éš›çš„é…ç½®è®Šæ›´
          
          ğŸ“Š æ¥æ”¶åˆ°çš„ç¢ºèªåƒæ•¸ï¼š
          - ç›®æ¨™ID: {{ target_id }}
          - ç›®æ¨™IP: {{ target_ip }}
          - åŸå§‹MAC: {{ original_mac }}
          - é‚„åŸMAC: {{ reserved_mac }}
          - åŸå§‹æè¿°: {{ original_description | default('(ç©ºç™½)') }}
          - DHCP Server: {{ dhcp_server_id }}
          
          ğŸŒ é€£æ¥ä¿¡æ¯ï¼š
          - FortiGate Host: {{ fortigate_host }}
          - VDOM: {{ vdom_name }}
          ==========================================

    # =======================================================================
    # æ­¥é©Ÿ2ï¼šåŸ·è¡Œåˆªé™¤æ“ä½œ
    # =======================================================================

    - name: "âš ï¸ Final Confirmation Before Execution"
      ansible.builtin.debug:
        msg: |
          âš ï¸âš ï¸âš ï¸ å³å°‡åŸ·è¡ŒFortiGateé…ç½®è®Šæ›´ âš ï¸âš ï¸âš ï¸
          
          ğŸ“Š è®Šæ›´è©³æƒ…ï¼š
          - é…ç½®ID: {{ target_id }}
          - IPåœ°å€: {{ target_ip }} (ä¿æŒä¸è®Š)
          - MACè®Šæ›´: {{ original_mac }} â†’ {{ reserved_mac }}
          - æè¿°è®Šæ›´: "{{ original_description }}" â†’ "Reserved"
          
          ğŸš€ é–‹å§‹åŸ·è¡ŒAPIå‘¼å«...

    - name: "ğŸ”§ Execute MAC Delete - Restore to Reserved Configuration"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address/{{ target_id }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          ip: "{{ target_ip }}"
          mac: "{{ reserved_mac }}"
          description: "Reserved"
        body_format: json
        validate_certs: false
        status_code: 200
      register: delete_result

    # =======================================================================
    # æ­¥é©Ÿ3ï¼šçµæœè™•ç†
    # =======================================================================

    - name: "ğŸ‰ MAC Delete Operation Successful"
      ansible.builtin.debug:
        msg: |
          âœ…âœ…âœ… MACåˆªé™¤æ“ä½œåŸ·è¡ŒæˆåŠŸï¼âœ…âœ…âœ…
          
          ğŸ“‹ åŸ·è¡Œçµæœè©³æƒ…ï¼š
          - é…ç½®ID: {{ target_id }}
          - IPåœ°å€: {{ target_ip }} âœ… ä¿æŒä¸è®Š
          - MACåœ°å€: {{ original_mac }} â†’ {{ reserved_mac }} âœ… å·²é‚„åŸ
          - æè¿°: "{{ original_description }}" â†’ "Reserved" âœ… å·²æ›´æ–°
          - HTTPç‹€æ…‹: {{ delete_result.status }}
          - é…ç½®å·²è®Šæ›´: {{ delete_result.json.revision_changed | default(false) }}
          
          ğŸ¯ FortiGate DHCPé…ç½®å·²æˆåŠŸé‚„åŸç‚ºä¿ç•™ç‹€æ…‹ï¼
          
          ğŸ“Š APIå›æ‡‰æ‘˜è¦ï¼š
          - è«‹æ±‚æˆåŠŸ: âœ…
          - é…ç½®ç‰ˆæœ¬å·²æ›´æ–°: {{ 'âœ… æ˜¯' if delete_result.json.revision_changed | default(false) else 'âŒ å¦' }}
      when: 
        - delete_result is defined
        - delete_result.status == 200

    - name: "âŒ MAC Delete Operation Failed"
      ansible.builtin.debug:
        msg: |
          âŒâŒâŒ MACåˆªé™¤æ“ä½œåŸ·è¡Œå¤±æ•— âŒâŒâŒ
          
          ğŸ“‹ å¤±æ•—è©³æƒ…ï¼š
          - HTTPç‹€æ…‹ç¢¼: {{ delete_result.status | default('æœªçŸ¥') }}
          - éŒ¯èª¤è¨Šæ¯: {{ delete_result.msg | default('æœªçŸ¥éŒ¯èª¤') }}
          - APIå›æ‡‰: {{ delete_result.json | default('ç„¡å›æ‡‰') }}
          
          ğŸ’¡ å¯èƒ½çš„åŸå› ï¼š
          1. FortiGateé€£æ¥å•é¡Œ
          2. API Tokenæ¬Šé™ä¸è¶³
          3. é…ç½®IDå·²è®Šæ›´
          4. ç¶²è·¯é€£ç·šå•é¡Œ
          5. FortiGateç³»çµ±å¿™ç¢Œ
          
          ğŸ”§ å»ºè­°è™•ç†æ–¹å¼ï¼š
          1. æª¢æŸ¥FortiGateé€£ç·šç‹€æ…‹
          2. é©—è­‰API Tokenæ¬Šé™
          3. é‡æ–°åŸ·è¡ŒPreviewæ­¥é©Ÿç¢ºèªé…ç½®
      when: 
        - delete_result is defined 
        - delete_result.status != 200

    # =======================================================================
    # æ­¥é©Ÿ4ï¼šæœ€çµ‚æ‘˜è¦
    # =======================================================================
    
    - name: "ğŸ“Š Workflow Execution Summary"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ“Š WorkflowåŸ·è¡Œå®Œæ•´æ‘˜è¦
          ==========================================
          
          ğŸ”„ Workflowæ­¥é©Ÿï¼š
          1. âœ… Previewå®Œæˆ - æ‰¾åˆ°ç›®æ¨™MACé…ç½®
          2. {{ 'âœ… Executeå®Œæˆ' if (delete_result.status == 200) else 'âŒ Executeå¤±æ•—' }} - {{ 'é…ç½®å·²é‚„åŸ' if (delete_result.status == 200) else 'é…ç½®æœªè®Šæ›´' }}
          
          ğŸ“Š æœ€çµ‚çµæœï¼š
          - è™•ç†çš„MAC: {{ delete_mac }}
          - å°æ‡‰IP: {{ target_ip }}
          - é‚„åŸç‹€æ…‹: {{ 'âœ… æˆåŠŸ' if (delete_result.status == 200) else 'âŒ å¤±æ•—' }}
          - é…ç½®ID: {{ target_id }}
          
          {% if delete_result.status == 200 %}
          ğŸ¯ æ“ä½œæˆåŠŸå®Œæˆï¼DHCPé…ç½®å·²é‚„åŸç‚ºä¿ç•™ç‹€æ…‹ã€‚
          {% else %}
          âš ï¸ æ“ä½œæœªå®Œæˆï¼Œè«‹æª¢æŸ¥éŒ¯èª¤ä¿¡æ¯ä¸¦é‡è©¦ã€‚
          {% endif %}
          
          ğŸ“… å®Œæˆæ™‚é–“: {{ ansible_date_time.iso8601 | default('æœªçŸ¥') }}
          ==========================================
