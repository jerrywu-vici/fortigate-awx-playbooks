---
- name: FortiGate DHCP Delete Execute for Workflow v3.3
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # =======================================================================
    # æ¥æ”¶workflowè®Šæ•¸ï¼ˆä¿®æ­£ç‰ˆï¼‰
    # =======================================================================
    target_id: "{{ wf_target_id }}"
    target_ip: "{{ wf_target_ip }}"
    original_mac: "{{ wf_original_mac }}"
    reserved_mac: "{{ wf_reserved_mac }}"
    original_desc: "{{ wf_original_desc }}"
    dhcp_server_id: "{{ wf_server_id }}"
    delete_mac: "{{ wf_delete_mac }}"
    
    # âœ… æ–°å¢ï¼šæ¥æ”¶MACè¨ˆç®—ç›¸é—œè®Šæ•¸
    ip_fourth_octet: "{{ wf_ip_fourth_octet }}"
    first_digit: "{{ wf_first_digit }}"
    last_two_digits: "{{ wf_last_two_digits }}"
    
    # FortiGateé€£æ¥åƒæ•¸
    fortigate_host: "{{ fortigate_host }}"
    fortigate_token: "{{ fortigate_access_token }}"
    vdom_name: "{{ fortigate_vdom | default('root') }}"
    
  tasks:
    - name: "ğŸ” Validate Workflow Parameters"
      ansible.builtin.fail:
        msg: |
          âŒ å¾Workflowæ¥æ”¶åƒæ•¸å¤±æ•—ï¼
          æ­¤Job Templateåƒ…æ‡‰åœ¨Workflowä¸­åŸ·è¡Œã€‚
          
          ç¼ºå°‘çš„åƒæ•¸ï¼š
          {% if target_id is not defined %}- wf_target_id{% endif %}
          {% if target_ip is not defined %}- wf_target_ip{% endif %}
          {% if reserved_mac is not defined %}- wf_reserved_mac{% endif %}
          {% if ip_fourth_octet is not defined %}- wf_ip_fourth_octet{% endif %}
      when: 
        - target_id is not defined or
          target_ip is not defined or
          reserved_mac is not defined or
          ip_fourth_octet is not defined

    - name: "ğŸ“‹ Display Execute Parameters"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ“‹ FortiGate DHCP Delete åŸ·è¡Œéšæ®µ v3.3
          ==========================================
          ğŸš€ åŸ·è¡Œæ¨¡å¼ï¼šå°‡åŸ·è¡Œå¯¦éš›çš„é…ç½®è®Šæ›´
          âœ… å·²é€šéäººå·¥ç¢ºèª
          
          ğŸ“Š æ¥æ”¶åˆ°çš„ç¢ºèªåƒæ•¸ï¼š
          - ç›®æ¨™ID: {{ target_id }}
          - ç›®æ¨™IP: {{ target_ip }}
          - åŸå§‹MAC: {{ original_mac }}
          - é‚„åŸMAC: {{ reserved_mac }}
          - åŸå§‹æè¿°: "{{ original_desc }}"
          - IPç¬¬å››ç¢¼: {{ ip_fourth_octet }}
          - ç¬¬ä¸€ä½æ•¸å­—: {{ first_digit }}
          - å¾Œå…©ä½æ•¸å­—: {{ last_two_digits }}
          - DHCP Server: {{ dhcp_server_id }}
          
          ğŸŒ é€£æ¥ä¿¡æ¯ï¼š
          - FortiGate Host: {{ fortigate_host }}
          - VDOM: {{ vdom_name }}
          ==========================================

    - name: "ğŸ§® Verify MAC Calculation (Corrected)"
      ansible.builtin.debug:
        msg: |
          ğŸ” MACé‚„åŸè¨ˆç®—é©—è­‰ï¼š
          - IP: {{ target_ip }}
          - IPç¬¬å››ç¢¼: {{ ip_fourth_octet }}
          - ç¬¬ä¸€ä½æ•¸å­—: {{ first_digit }}
          - å¾Œå…©ä½æ•¸å­—: {{ last_two_digits }}
          - æ¥æ”¶çš„MAC: {{ reserved_mac }}
          - é æœŸMAC: ff:ff:ff:ff:f{{ first_digit }}:{{ last_two_digits }}
          - è¨ˆç®—æ­£ç¢º: {{ 'âœ…' if reserved_mac == 'ff:ff:ff:ff:f' + first_digit + ':' + last_two_digits else 'âŒ' }}
          
          ğŸ“ è¦å‰‡é©—è­‰ï¼š
          - MACæ ¼å¼: ff:ff:ff:ff:fX:XX
          - X (ç¬¬ä¸€ä½): {{ first_digit }}
          - XX (å¾Œå…©ä½): {{ last_two_digits }}
          - çµ„åˆçµæœ: ff:ff:ff:ff:f{{ first_digit }}:{{ last_two_digits }}

    - name: "âš ï¸ Final Confirmation Before Execution"
      ansible.builtin.debug:
        msg: |
          âš ï¸âš ï¸âš ï¸ å³å°‡åŸ·è¡ŒFortiGateé…ç½®è®Šæ›´ âš ï¸âš ï¸âš ï¸
          
          ğŸ“Š è®Šæ›´è©³æƒ…ï¼š
          - é…ç½®ID: {{ target_id }}
          - IPåœ°å€: {{ target_ip }} (ä¿æŒä¸è®Š)
          - MACè®Šæ›´: {{ original_mac }} â†’ {{ reserved_mac }}
          - æè¿°è®Šæ›´: "{{ original_desc }}" â†’ "Reserved"
          
          ğŸ“ é‚„åŸè¦å‰‡ç¢ºèªï¼š
          - IPç¬¬å››ç¢¼: {{ ip_fourth_octet }}
          - MACæ ¼å¼: ff:ff:ff:ff:f{{ first_digit }}:{{ last_two_digits }}
          - è¨ˆç®—çµæœ: {{ reserved_mac }}
          
          ğŸš€ é–‹å§‹åŸ·è¡ŒAPIå‘¼å«...

    - name: "ğŸ”§ Execute MAC Delete - Restore to Reserved Configuration"
      ansible.builtin.uri:
        url: "https://{{ fortigate_host }}/api/v2/cmdb/system.dhcp/server/{{ dhcp_server_id }}/reserved-address/{{ target_id }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ fortigate_token }}"
        body:
          ip: "{{ target_ip }}"
          mac: "{{ reserved_mac }}"
          description: "Reserved"
        body_format: json
        validate_certs: false
        status_code: 200
      register: delete_result

    - name: "ğŸ‰ MAC Delete Operation Successful"
      ansible.builtin.debug:
        msg: |
          âœ…âœ…âœ… MACåˆªé™¤æ“ä½œåŸ·è¡ŒæˆåŠŸï¼âœ…âœ…âœ…
          
          ğŸ“‹ åŸ·è¡Œçµæœè©³æƒ…ï¼š
          - é…ç½®ID: {{ target_id }}
          - IPåœ°å€: {{ target_ip }} âœ… ä¿æŒä¸è®Š
          - MACè®Šæ›´: {{ original_mac }} â†’ {{ reserved_mac }} âœ… å·²é‚„åŸ
          - æè¿°è®Šæ›´: "{{ original_desc }}" â†’ "Reserved" âœ… å·²æ›´æ–°
          - HTTPç‹€æ…‹: {{ delete_result.status }}
          - é…ç½®å·²è®Šæ›´: {{ delete_result.json.revision_changed | default(false) }}
          
          ğŸ“ MACé‚„åŸè¦å‰‡é©—è­‰ï¼š
          - åŸIP: {{ target_ip }}
          - IPç¬¬å››ç¢¼: {{ ip_fourth_octet }}
          - åˆ†è§£: {{ first_digit }} + {{ last_two_digits }}
          - æœ€çµ‚MAC: {{ reserved_mac }}
          - è¦å‰‡: IPç¬¬å››ç¢¼{{ ip_fourth_octet }} â†’ MAC f{{ first_digit }}:{{ last_two_digits }}
          
          ğŸ¯ FortiGate DHCPé…ç½®å·²æˆåŠŸé‚„åŸç‚ºä¿ç•™ç‹€æ…‹ï¼
      when: 
        - delete_result is defined
        - delete_result.status == 200

    - name: "âŒ MAC Delete Operation Failed"
      ansible.builtin.debug:
        msg: |
          âŒâŒâŒ MACåˆªé™¤æ“ä½œåŸ·è¡Œå¤±æ•— âŒâŒâŒ
          
          ğŸ“‹ å¤±æ•—è©³æƒ…ï¼š
          - HTTPç‹€æ…‹ç¢¼: {{ delete_result.status | default('æœªçŸ¥') }}
          - éŒ¯èª¤è¨Šæ¯: {{ delete_result.msg | default('æœªçŸ¥éŒ¯èª¤') }}
          - APIå›æ‡‰: {{ delete_result.json | default('ç„¡å›æ‡‰') }}
          
          ğŸ’¡ å¯èƒ½çš„åŸå› ï¼š
          1. FortiGateé€£æ¥å•é¡Œ
          2. API Tokenæ¬Šé™ä¸è¶³
          3. é…ç½®IDå·²è®Šæ›´
          4. ç¶²è·¯é€£ç·šå•é¡Œ
          5. FortiGateç³»çµ±å¿™ç¢Œ
          
          ğŸ”§ å»ºè­°è™•ç†æ–¹å¼ï¼š
          1. æª¢æŸ¥FortiGateé€£ç·šç‹€æ…‹
          2. é©—è­‰API Tokenæ¬Šé™
          3. é‡æ–°åŸ·è¡ŒPreviewæ­¥é©Ÿç¢ºèªé…ç½®
      when: 
        - delete_result is defined 
        - delete_result.status != 200

    - name: "ğŸ“Š Workflow Execution Summary"
      ansible.builtin.debug:
        msg: |
          ==========================================
          ğŸ“Š WorkflowåŸ·è¡Œå®Œæ•´æ‘˜è¦
          ==========================================
          
          ğŸ”„ åŸ·è¡Œæµç¨‹ï¼š
          1. âœ… Previewå®Œæˆ - æ‰¾åˆ°MAC {{ delete_mac }}
          2. âœ… äººå·¥ç¢ºèª - ç”¨æˆ¶æ‰¹å‡†æ“ä½œ
          3. {{ 'âœ… Executeå®Œæˆ' if (delete_result.status == 200) else 'âŒ Executeå¤±æ•—' }} - {{ 'é…ç½®å·²é‚„åŸ' if (delete_result.status == 200) else 'é…ç½®æœªè®Šæ›´' }}
          
          ğŸ“Š æœ€çµ‚çµæœï¼š
          - è™•ç†çš„MAC: {{ delete_mac }} â†’ {{ reserved_mac }}
          - å°æ‡‰IP: {{ target_ip }}
          - é…ç½®ç‹€æ…‹: {{ 'âœ… å·²é‚„åŸç‚ºReserved' if (delete_result.status == 200) else 'âŒ é‚„åŸå¤±æ•—' }}
          - MACè¦å‰‡: IP{{ ip_fourth_octet }} â†’ f{{ first_digit }}:{{ last_two_digits }}
          
          {% if delete_result.status == 200 %}
          ğŸ¯ æ“ä½œæˆåŠŸå®Œæˆï¼DHCPé…ç½®å·²é‚„åŸç‚ºä¿ç•™ç‹€æ…‹ã€‚
          {% else %}
          âš ï¸ æ“ä½œæœªå®Œæˆï¼Œè«‹æª¢æŸ¥éŒ¯èª¤ä¿¡æ¯ä¸¦é‡è©¦ã€‚
          {% endif %}
          
          ğŸ“… å®Œæˆæ™‚é–“: {{ ansible_date_time.iso8601 | default('æœªçŸ¥') }}
          ==========================================
